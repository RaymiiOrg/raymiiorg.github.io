
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Broken Corrupted Raspberry Pi SD Card - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>                 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Broken Corrupted Raspberry Pi SD Card</h2>
<p><small>Published: <span data-pagefind-meta='date'>09-01-2015</span> | Last update: 13-11-2019 | Author: Remy van Elst | <a href="Broken_Corrupted_Raspberry_Pi_SD_Card.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over three years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">fsck</a>
</li>
<li>
<a href="#toc_1">Scratch Files</a>
</li>
<li>
<a href="#toc_2">Spinrite</a>
</li>
<li>
<a href="#toc_3">Badblocks</a>
</li>
<li>
<a href="#toc_4">Less writing</a>
<ul>
<li>
<a href="#toc_5">tmpfs</a>
</li>
<li>
<a href="#toc_6">Disable swap</a>
</li>
<li>
<a href="#toc_7">fsck at every boot</a>
</li>
<li>
<a href="#toc_8">Remove the GUI</a>
</li>
</ul>
</li>
<li>
<a href="#toc_9">Conclusion</a>
</li>
</ul>

</div><hr><div id="contents">
<p><img src="https://raymii.org/s/inc/img/small-pcs/raspberry-pi.jpg" alt="Pi"></p>

<p>One of my Raspberry Pi&#39;s would not boot up after a reboot. The SD card was
corrupted, sadly beyond repair. This article walks you through the steps I took
to try to fix the SD card, including fsck, badblocks and other filesystem
utilities. It also has tips to reduce the writing on the Raspberry Pi, this to
save SD cards from some amount of wear and thus possible corruption.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>The machine was running as an <a href="http://www.icrobotics.co.uk/wiki/index.php/Turning_the_Raspberry_Pi_Into_an_FM_Transmitter">FM transmitter</a> so that my regular sound
system could play podcasts (Please note that it is probably illegal to transmit
without having your HAM license). I&#39;t would sync up my feeds and, when turned
on, started playing them.</p>

<p>However, after the last reboot it would not start up again. I rigged up the UART
to my machine and found out why, there were files that the system could not
read, therefore init would not boot up.</p>

<p><strong>2019-11-13:</strong> update the fstab entries to use tmpfs instead of none, and add
correct permissions.</p>

<h3 id="toc_0">fsck</h3>

<p>The file system consistency check utility most of the time is able to find and
recover damaged filesystems. My systems do a filesystem check at every boot, and
they get a reboot regularly. The SD card has an ext4 filesystem and is 16 GB in
size.</p>

<p>Since most of the time you can fix broken filesystems with an fsck I hooked up
the card to my machine and started the fsck:</p>

<pre><code># fsck /dev/mmcblk0p2
</code></pre>

<p>And it failed right away:</p>

<pre><code>fsck from util-linux 2.25.2
e2fsck 1.42.12 (29-Aug-2014)
fsck.ext4: Filesystem revision too high while trying to open /dev/mmcblk0p2
The filesystem revision is apparently too high for this version of e2fsck.
(Or the filesystem superblock is corrupt)


The superblock could not be read or does not describe a valid ext2/ext3/ext4
filesystem.  If the device is valid and it really contains an ext2/ext3/ext4
filesystem (and not swap or ufs or something else), then the superblock
is corrupt, and you might try running e2fsck with an alternate superblock:
    e2fsck -b 8193 &lt;device&gt;
 or
    e2fsck -b 32768 &lt;device&gt;
</code></pre>

<p>The superblock contains information about the file system such as the file
system type, size, status, information about other metadata structures, block
counts, inode counts, supported features, maintenance information, and more and
so on (<a href="https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#The_Super_Block">source</a>). It is an important piece of information for the filesystem.</p>

<p>So the card is so broken that the first superblock is not readable. An ext4
filesystem has multiple copies of it&#39;s superblock, so lets find them and use
them to try the fsck again. To find the other superblocks we can use the
following command:</p>

<pre><code>mke2fs -n /dev/mmcblk0p2
</code></pre>

<p>Output</p>

<pre><code>mke2fs 1.42.12 (29-Aug-2014)
/dev/mmcblk0p2 contains a ext4 file system
Proceed anyway? (y,n) y
Creating filesystem with 3794688 4k blocks and 950272 inodes
Filesystem UUID: a56c8a06-9907-41a2-86a0-dd601212880b
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208
</code></pre>

<p>We also need to find the block size, the above command shows it as 4k, which is
4096. With this information we can retry the fsck with the alternate
superblock:</p>

<pre><code>fsck -b 163840 -B 4096 /dev/mmcblk0p2
</code></pre>

<p>Where <code>-b</code> is the alternative superblock and <code>-B</code> is the blocksize.</p>

<p>It didn&#39;t help much, after a lot of questions I decided to automatically fix
everything it found:</p>

<pre><code>fsck from util-linux 2.25.2
e2fsck 1.42.12 (29-Aug-2014)
Superblock has an invalid journal (inode 8).
Clear&lt;y&gt;? yes
*** ext3 journal has been deleted - filesystem is now ext2 only ***

Resize inode not valid.  Recreate&lt;y&gt;? yes
Pass 1: Checking inodes, blocks, and sizes
yInode 1 has EXTENTS_FL flag set on filesystem without extents support.
Clear&lt;y&gt;? yes
Root inode has dtime set (probably due to old mke2fs).  Fix&lt;y&gt;? yes
Quota inode is not in use, but contains data.  Clear&lt;y&gt;? yes
Quota inode is not in use, but contains data.  Clear&lt;y&gt;? yes
Inode 5, i_size is 2305843009213693952, should be 0.  Fix&lt;y&gt;? yes
Inode 5, i_blocks is 131072, should be 0.  Fix&lt;y&gt;? yes
Reserved inode 6 (&lt;The undelete directory inode&gt;) has invalid mode.  Clear&lt;y&gt;? yes
Inode 6 has a bad extended attribute block 2064.  Clear&lt;y&gt;? yes
Inode 6, i_size is 666532745924706320, should be 0.  Fix&lt;y&gt;? yes
Journal inode is not in use, but contains data.  Clear&lt;y&gt;? yes
Reserved inode 9 (&lt;Reserved inode 9&gt;) has invalid mode.  Clear&lt;y&gt;? yes
Reserved inode 10 (&lt;Reserved inode 10&gt;) has invalid mode.  Clear&lt;y&gt;?
Recreate journal&lt;y&gt;? cancelled!
/dev/mmcblk0p2: e2fsck canceled.

/dev/mmcblk0p2: ***** FILE SYSTEM WAS MODIFIED *****
</code></pre>

<p>Adding the <code>-y</code> option to the command will automatically answer yes to
everything:</p>

<pre><code>fsck -y -b 163840 -B 4096 /dev/mmcblk0p2
</code></pre>

<h3 id="toc_1">Scratch Files</h3>

<p>This goes well for a while, but fails after some time with the following error:</p>

<pre><code>Error storing directory block information (inode=5542, block=0, num=33754683): Memory allocation failed

/dev/mmcblk0p2: ***** FILE SYSTEM WAS MODIFIED *****
Recreate journal? yes

Creating journal (32768 blocks):  Done.

*** journal has been re-created - filesystem is now ext3 again ***
e2fsck: aborted
</code></pre>

<p>Searching around on the web results in multiple topics suggesting to add the
following:</p>

<pre><code>[scratch_files]
directory = /var/cache/e2fsck
</code></pre>

<p>To the file <code>/etc/e2fsck.conf</code>. The <a href="http://manpages.ubuntu.com/manpages/precise/man5/e2fsck.conf.5.html">man page</a> describes it like so:</p>

<pre><code>   [scratch_files]
      This  stanza  controls  when  e2fsck will attempt to use scratch
      files to reduce the need for memory.
</code></pre>

<p>Ted Tso explains what this option does on <a href="https://www.redhat.com/archives/ext3-users/2008-June/msg00015.html">this mailinglist topic</a>:</p>

<blockquote>
<p>This will cause e2fsck to store certain data structures which grow large with
backup servers that have a vast number of hard-linked files in /var/cache/e2fsck
instead of in memory. This will slow down e2fsck by approximately 25%, but for
large filesystems where you couldn&#39;t otherwise get e2fsck to complete because
you&#39;re exhausting the 2GB VM per-process limitation for 32-bit systems, it
should allow you to run through to completion.</p>
</blockquote>

<p>You have to create the <code>/var/cache/e2fsck</code> folder if it does not exist yet
before running the fsck:</p>

<pre><code>mkdir -p /var/cache/e2fsck
</code></pre>

<p>The <code>scratch_files</code> stanza has more options, two of which might be important,
<code>set dirinfo</code> and <code>set icount</code>.</p>

<p>You configure <code>set dirinfo</code> to false if your filesystem had an large number of
individual files and not that many directories. You configure <code>set icount</code> to
false if the reverse were true. Otherwise, you configure them both on true.</p>

<p>There was also a good explanation of where the Out of Memory error comes from on
<a href="https://unix.stackexchange.com/a/100805">Stack Exchange</a>, it might not be out of memory.</p>

<p>The <code>scratch_files</code> setting did not improve the check. It still gave the same
error, out of memory.</p>

<p>Even after playing with the dirinfo settings, or adding a 200 GB swapfile the
fsck would still fail. <code>dmesg</code> was also full with these kinds of logs:</p>

<pre><code>[12343.5678] end_request: I/O error, dev mmcblk0, sector 50944
</code></pre>

<h3 id="toc_2">Spinrite</h3>

<p>My last guess would be to try <a href="https://www.grc.com/sr/spinrite.htm">Spinrite</a>. Spinrite is a hard drive recovery
and maintenande utility written by Steve Gibson from <a href="https://grc.com">Gibson Research
Corporation</a>. I configured a KVM VM with the card reader device as a second
block device and tried to run Spinrite on Level 2. However, even spinrite
failed:</p>

<p><a href="https://raymii.org/s/inc/img/spinrite-fail.png"><img src="https://raymii.org/s/inc/img/spinrite-fail.png" alt=""></a></p>

<p>Booting Spinrite on a spare laptop with a cardreader with this SD card gave the
same error. It sees the device, but fails to run on it.</p>

<p>Spinrite has helped me multiple times recover drives, but this one might be to
much for it.</p>

<h3 id="toc_3">Badblocks</h3>

<p>Badblocks is a *NIX utility to search for bad blocks on a device. While it is
not usefull for creating a list of bad blocks on the SD card because SD cards do
not report actual physical addresses (because of wear levelling) it does tell us
if the card is broken or not.</p>

<p>The following badblocks command will scan and report bad blocks for the device.
<strong>It is a destructive write operation, you will lose your data</strong>.</p>

<pre><code>badblocks -o ./badblocks.list -w -s -v -b 4096 -c 16 /dev/mmcblk0
</code></pre>

<p><code>-o</code> to output the badblocks list to the file <code>./badblocks.list</code>, <code>-w</code> for the
write operation, <code>-s</code> to show progress, <code>-v</code> to be verbose, <code>-b 4096</code> for the
blocksize of 4K and <code>-c 16</code> to test 16 blocks at once (default is 64).</p>

<p>It showed me that a lot of writes were failing:</p>

<pre><code>Checking for bad blocks in read-write mode
From block 0 to 3799039
Testing with pattern 0xaa: 0.01% done, 1:57 elapsed. (0/292/0 errors)
^C
Interrupted at block 294
</code></pre>

<p>The error output format means the following:</p>

<pre><code>number of read errors/number of write errors/number of corruption errors
</code></pre>

<p>So most of the writes (292 of 294) failed, meaning the SD card is broken, beyond
repair I guess.</p>

<h3 id="toc_4">Less writing</h3>

<p>This SD card is a lost case. To prevent your Raspberry Pi&#39;s from writing a lot
of data, and thus, wearing the SD card, you can do a couple of things.</p>

<h4 id="toc_5">tmpfs</h4>

<p>The first one is to mount a few folders in RAM as <code>tmpfs</code>. The folders are the
folders where temp files and logging is written to. This means that you won&#39;t
have syslog available, but most of the time that is not a problem.</p>

<p>Edit <code>/etc/fstab</code> and add the following:</p>

<pre><code>tmpfs    /tmp               tmpfs    defaults,noatime,nosuid,size=100m                  0 0
tmpfs    /var/tmp           tmpfs    defaults,noatime,nosuid,size=30m                   0 0
tmpfs    /var/log           tmpfs    defaults,noatime,nosuid,mode=0755,size=100m        0 0
tmpfs    /var/run           tmpfs    defaults,noatime,nosuid,mode=0755,size=2m          0 0
</code></pre>

<p>This will mount the above folders in RAM, with a respectable max size (otherwise
your ram fills up). The <code>noatime</code> option means that the access time of a file is
not updated, saving a lot of writes as well. You should also add the <code>noatime</code>
option to your other partitions, for example on a standard Raspbian:</p>

<pre><code>proc            /proc           proc    defaults          0       0
/dev/mmcblk0p1  /boot           vfat    ro,noatime        0       2
/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1
</code></pre>

<p>Here the <code>/boot</code> partition is also mounted read only (<code>ro</code>). The <code>noatime</code>
option is added.</p>

<p>Issue a <code>mount -a</code> command or reboot the machine to make this active.</p>

<h4 id="toc_6">Disable swap</h4>

<p>Linux divides its physical RAM (random access memory) into chucks of memory
called pages. Swapping is the process whereby a page of memory is copied to the
preconfigured space on the hard disk, called swap space, to free up that page of
memory. The combined sizes of the physical memory and the swap space is the
amount of virtual memory available.</p>

<p>Swappig causes a lot of writes to the SD card. You would want to turn it off to
save writes. The downside of this is that when there is not enough RAM available
the linux OOM killer will randomly kill processes to save RAM.</p>

<p>Raspbian by default has a swap file, dynamically managed by the <code>dphsys-
swapfile</code> utility. You can turn off this utility by issueing the following
commands:</p>

<pre><code>dphys-swapfile swapoff
dphys-swapfile uninstall
update-rc.d dphys-swapfile remove
</code></pre>

<p>After a reboot the swap will be gone, which you can check with the <code>free -m</code>
command:</p>

<pre><code>             total       used       free     shared    buffers     cached
Mem:           484        243        241          0         42        162
-/+ buffers/cache:         38        446
Swap:            0          0          0
</code></pre>

<h4 id="toc_7">fsck at every boot</h4>

<p>My Raspberry Pi&#39;s have a cronjob which reboots them once every seven days. This
to apply kernel updates and just a general good procedure to see if all still
works after a reboot. By default, fsck checks a filesystem every 30 boots
(counted individually for each partition). I decided to change this to every
boot, so problems will be found and possibly fixed earlier.</p>

<p>To set up an fsck at every boot, execute the following command:</p>

<pre><code>tune2fs -c 1 /dev/sda1
</code></pre>

<p>Where <code>/dev/sda1</code> is the device or partition.</p>

<h4 id="toc_8">Remove the GUI</h4>

<p>I don&#39;t use the Raspbian GUI so I decided to remove everything GUI related. The
best way to do this is to remove <code>libx11</code> and all it&#39;s dependencies, that being
all the GUI applications:</p>

<pre><code>apt-get purge --auto-remove &#39;libx11-.*&#39;
</code></pre>

<p>This lowers the amount of disk space used, the amount of packages updated and
the amount of services running on the machine, saving both RAM and disk space.</p>

<h3 id="toc_9">Conclusion</h3>

<p>This SD card was so corrupt I threw it away. The Raspberry Pi was reinstalled
and the <code>pifm</code> software was set up again. The music came from another machine,
so that did not have to be copied again.</p>

<p>With the tips above you might be able to save your SD card if it ever gets
corrupted. These tips also work on regular disks and SSD&#39;s.</p>
Tags: <a href="../tags/badblocks.html">badblocks</a>
, <a href="../tags/blog.html">blog</a>
, <a href="../tags/ext4.html">ext4</a>
, <a href="../tags/filesystem.html">filesystem</a>
, <a href="../tags/fsck.html">fsck</a>
, <a href="../tags/mkfs.html">mkfs</a>
, <a href="../tags/raspberry-pi.html">raspberry-pi</a>
, <a href="../tags/sd.html">sd</a>
, <a href="../tags/swap.html">swap</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    