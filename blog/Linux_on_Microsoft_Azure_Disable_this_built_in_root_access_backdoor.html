
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Linux on Microsoft Azure? Disable this built-in root-access backdoor (wa-linux-agent) - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Linux on Microsoft Azure? Disable this built-in root-access backdoor (wa-linux-agent)</h2>
<p><small>Published: <span data-pagefind-meta='date'>22-08-2018</span> | Author: Remy van Elst | <a href="Linux_on_Microsoft_Azure_Disable_this_built_in_root_access_backdoor.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over six years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">The backdoor</a>
<ul>
<li>
<a href="#toc_1">Remote command execution as root</a>
</li>
<li>
<a href="#toc_2">Remote SSH key injection, user password reset and SSH configuration reset</a>
</li>
</ul>
</li>
<li>
<a href="#toc_3">Impact and implications</a>
</li>
<li>
<a href="#toc_4">Removing the agent/backdoor</a>
</li>
<li>
<a href="#toc_5">Logging?</a>
</li>
<li>
<a href="#toc_6">What is this (wa-linux-agent)?</a>
</li>
<li>
<a href="#toc_7">OpenStack / QEMU</a>
</li>
</ul>

</div><hr><div id="contents">
<p><img src="https://raymii.org/s/inc/img/azure-logo.png" alt=""></p>

<p>Are you running Linux on Microsoft Azure? Then by default anyone with access to
your Azure portal can run commands as root in your VM, reset SSH keys, user
passwords and SSH configuration. This article explains what the backdoor is,
what it is meant to do, how it can be disabled and removed and what the
implications are.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below. It means the world to me if you  show your appreciation and you'll help pay the server costs:</b><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">GitHub Sponsorship</a><br><br> <a href="https://pcbway.com/g/e7yQRg">PCBWay referral link (You get $5, I get $20 after you've placed an order)</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocea referral link  ($200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!)</a><br><br> </p>

<p>Azure is Microsoft&#39;s Cloud platform. It provides virtual machines and related
datacenter virtualization, next to software as a service (hosted stuff like
databases). I currently work on a project where an hosted application platform
is built on Azure using Linux (Ubuntu, CentOS), and recently found out about
this backdoor. Or, useful feature, since it&#39;s not just a blatant and deliberate
backdoor</p>

<p>I have no idea how the situation on Windows on Azure is, and have not researched
this.</p>

<h3 id="toc_0">The backdoor</h3>

<p>Azure, as any other good Cloud provider, has images which you use to create new
VM&#39;s (sometimes calles VPSes, instances, droplets). It speeds up the rollout of
new VM&#39;s, because mounting an ISO and manually installing a VM is time-
consuming. In that image, they often change stuff to make it run better on their
cloud. When I created images for an OpenStack provider, we pre-installed <code>cloud-
init</code> and <code>haveged</code> for example. Microsoft does that as well, they install their
own agent, the <code>wa-linux-agent</code>. Later on in this article I explain what this
agent is meant to do. It is not just a backdoor, it provides actual useful
features. One of those features is root access outside of the VM.</p>

<p>In the <a href="https://portal.azure.com">Azure portal</a> one can login and configure their Azure cloud. For this
project I use Ansible and Terraform, so I don&#39;t have to regularly interact with
this webpage (which is kind of slow to work with). However, I also have a
personal Azure account for playing around, which is where I found this feature.</p>

<p>Via the Azure portal one can execute commands as root inside a VM and change SSH
keys, user passwords and SSH configuration.</p>

<p>I&#39;ll let the pictures speak for themself:</p>

<h4 id="toc_1">Remote command execution as root</h4>

<p><img src="https://raymii.org/s/inc/img/azure-backdoor-2.png" alt=""></p>

<h4 id="toc_2">Remote SSH key injection, user password reset and SSH configuration reset</h4>

<p><img src="https://raymii.org/s/inc/img/azure-backdoor-2.png" alt=""></p>

<p>You can read more on the backdoor feature <a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/vmaccess">here</a> (<a href="http://web.archive.org/web/20180822113038/https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/vmaccess">mirror</a>) and <a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/linux/run-command">here</a> (<a href="http://web.archive.org/web/20180822121145/https://docs.microsoft.com/en-gb/azure/virtual-machines/linux/run-command">mirror</a>), Microsoft is very transparent about this, quoting from the pages:</p>

<blockquote>
<p>Scripts run by default as elevated user on Linux</p>

<p>Think of the Azure VMAccess extension as that KVM switch that allows you to
access the console to reset access to Linux or perform disk level maintenance.</p>
</blockquote>

<p>Microsoft puts this feature in a positive way so that it looks less like a
backdoor:</p>

<pre><code>The disk on your Linux VM is showing errors. You somehow reset the root password for your Linux VM or accidentally deleted your SSH private key. If that happened back in the days of the datacenter, you would need to drive there and then open the KVM to get at the server console. Think of the Azure VMAccess extension as that KVM switch that allows you to access the console to reset access to Linux or perform disk level maintenance.

This article shows you how to use the Azure VMAccess Extension to check or repair a disk, reset user access, manage administrative user accounts, or update the SSH configuration on Linux when they are running as Azure Resource Manager virtual machines. 
</code></pre>

<p>For command execution as well:</p>

<pre><code>This capability is useful in all scenarios where you want to run a script within a virtual machines, and is one of the only ways to troubleshoot and remediate a virtual machine that doesn&#39;t have the RDP or SSH port open due to improper network or administrative user configuration.
</code></pre>

<p>I believe that this is a useful feature. I however also am of the opinion that
this is a backdoor. It is not made obvious that this agent is running in your VM
or that it provides root access. Only after looking (in the output of <code>ps aux</code>
and in the Microsoft docs) I found out what it is and what risks are connected
to it. Took me a good hour.</p>

<p>A tickbox when deploying VM&#39;s (or API flag) to disable this agent would be nice.</p>

<h3 id="toc_3">Impact and implications</h3>

<p>Anybody with access to VM&#39;s in the Azure portal is able to execute commands as
root inside any VM they have access to.</p>

<p>This also means anybody working for or on Microsoft (Azure) is able to run
commands as root inside your VM. (They can already take a live snapshot of your
VM with RAM included, but that is a know risk you take when using a cloud/VPS
provider. So consider all your private keys, certificates and data compromised
as soon as you don&#39;t control the entire chain of equipment).</p>

<p>Microsoft Azure however is audited regularly and <a href="http://web.archive.org/web/20180822121005/https://www.microsoft.com/en-us/TrustCenter/Compliance/ISO-IEC-27001">has an ISO 27001
certificate</a>, so let&#39;s hope they don&#39;t abuse this power.</p>

<p>If you are the only one with an Azure portal account, the impact is probably not
that bad.</p>

<p>If you have multiple people working on a project, (multiple people having access
to the portal), the risk is larger. Any one of those people (and all that had
access to the portal in the past, like contractors or employees that moved on),
has (had) root access to all your VM&#39;s.</p>

<p>Any one (or all) of your VM&#39;s could be compromised. Maybe your manager has
access to the portal but not SSH, or not root, and want&#39;s to put you in a bad
position. Installing that rootkit or cryptocoin miner under your account and
removing all the logging just got way easier.</p>

<h3 id="toc_4">Removing the agent/backdoor</h3>

<p>The agent is just a package, so using your package manager you can remove it:</p>

<pre><code># dpkg -l | grep walinuxagent
ii  walinuxagent                        2.2.21+really2.2.20-0ubuntu1~16.04.1       amd64        Windows Azure Linux Agent


# rpm -qa | grep LinuxAgent
WALinuxAgent-2.2.18-1.el7.centos.noarch
</code></pre>

<p>On Debian/Ubuntu:</p>

<pre><code>apt-get purge walinuxagent
</code></pre>

<p>On CentOS/RHEL:</p>

<pre><code>yum remove WALinuxAgent
</code></pre>

<p>If you just want to stop the service (for example, to see what the impact is),
you can do so using your init system of choice:</p>

<p>CentOS/RHEL:</p>

<pre><code># systemctl list-unit-files | grep agent
waagent.service                               enabled 

systemctl disable waagent
systelctl stop waagent
</code></pre>

<p>Debian/Ubuntu:</p>

<pre><code># systemctl list-unit-files | grep agent
walinuxagent.service                       enabled 

systemctl stop walinuxagent
systemctl disable walinuxagent
</code></pre>

<p><a href="https://www.reddit.com/user/bureado">This guy</a> on Reddit, who claims to work on azure, took the time to write a comprehensive response with more workarounds and possible fixes for this issue. <strong><a href="https://www.reddit.com/r/linux/comments/99dd5a/linux_on_microsoft_azure_disable_this_builtin/e4n1wr5/">Quoting verbatim</a>:</strong></p>

<p>I believe your commentary has more to do with <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/">RBAC</a> than with the agent,
but I&#39;m trying to better understand your concerns.</p>

<p>Even if you remove <a href="https://github.com/azure/walinuxagent">waagent</a> (link to the code on GitHub, thanks for mentioning the code is open source in your post) from an Azure VM, an administrator in your subscription could lock you out with a firewall rule, can restart or stop the VM or can delete it altogether. </p>

<p>If your primary partition isn&#39;t encrypted, they can stop the VM and attach that
disk to another running VM they control and change user passwords, SSH
configuration, etc. And without getting into those weeds, even without <code>waagent</code>
you can pass custom data to <code>cloud-init</code> (<code>cloud-init</code> and <code>waagent</code> aren&#39;t
mutually exclusive in Azure) using, say, the Azure CLI.</p>

<p>In an organizational setting (a team, a company) it&#39;s likely you as the VM
operator have been granted <em>less</em> permissions than the administrator of the
subscription, so it&#39;d actually be expected that they (the administrator) can
perform operations on your VM. Your subscription (your team) shouldn&#39;t be an
adversarial scenario, but there are still ways the team can use RBAC here.</p>

<p>If you run <code>az provider operation list</code> you&#39;ll see that adding an extension to a
virtualMachine is an operation you can actually <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/custom-roles">write a custom role for</a>.
If you&#39;re trying to enforce rather than delegate, you can also use a custom
<a href="https://docs.microsoft.com/en-us/azure/azure-policy/create-manage-policy">Azure Policy</a>. All of those methods are enforced at the API level, so the
end result is the same whether you use the portal, the CLI or 3rd party tools
like Ansible or Terraform.</p>

<p>It&#39;s also worth mentioning that when you run a custom script from the portal,
the operation is not only logged in the VM but also in the Activity Log for that
resource in Azure itself - even if that was someone else in your team that is a
subscription administrator.</p>

<p>If you open up SSH and have concerns that someone could manipulate SSH or PAM
configuration from outside the VM, there are Azure features such as <a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-just-in-time">just in
time access</a> that are designed to help you exactly with that. But I still
think your commentary has more to do with RBAC than it has with <code>waagent</code> or the
<code>VMAccess</code> extension. Other redditors have commented, like you did, that there&#39;s
a troubleshooting aspect to this. It is true that many features you see in the
portal such as the ability to reset SSH configuration, run a particular command
or see the serial console output are used for troubleshooting (including when
guided by our own Linux Support Escalation team) but there are also there for
composability.</p>

<p>By that I mean someone that has heavily automated/scripted their Linux setup in Azure and instead of maintaining their own custom image (a <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-upload-generic">documented scenario</a> including extensive discussion on the agent) they rely on standard images and attach extensions with custom scripts, <code>cloud-init</code> custom data, pulling SSH keys from Azure Key Vault (or using a third-party tool like Hashicorp&#39;s Vault) or using the <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/login-using-aad">AAD login extension</a> (in preview, and not much to do with the AD we love to hate) You said it&#39;s not made obvious this agent runs in the VM, and imply that the backdoor nature is concealed. </p>

<p>I personally always make the point to introduce the agent at any public
presentation (including recently at OSCON) so I&#39;m genuinely interested in your
suggestions for changes in documentation, portal prompts, etc., so people are
more aware that this agent is running and how it helps them? I work on Azure.</p>

<p>(Edit - adding details on Azure Policy and Activity Log)</p>

<p><strong>End quote.</strong></p>

<h3 id="toc_5">Logging?</h3>

<p>When executing a command, the following appears on Ubuntu in
<code>/var/log/waagent.log</code>:</p>

<pre><code>2018/08/22 11:58:07.546949 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Target handler state: enabled
2018/08/22 11:58:07.657715 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] [Enable] current handler state is: enabled
2018/08/22 11:58:07.769027 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Update settings file: 1.settings
2018/08/22 11:58:07.883364 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Enable extension [./vmaccess.py -enable]
2018/08/22 11:58:08 VMAccess started to handle.
2018/08/22 11:58:08 [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] cwd is /var/lib/waagent/Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1
2018/08/22 11:58:08 [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Change log file to /var/log/azure/Microsoft.OSTCExtensions.VMAccessForLinux/1.4.7.1/extension.log
2018/08/22 11:58:10.012703 INFO Event: name=Microsoft.OSTCExtensions.VMAccessForLinux, op=Enable, message=Launch command succeeded: ./vmaccess.py -enable, duration=2025
2018/08/22 11:58:10.161467 INFO [Microsoft.CPlat.Core.RunCommandLinux-1.0.0] Target handler state: enabled
2018/08/22 11:58:10.212205 INFO [Microsoft.CPlat.Core.RunCommandLinux-1.0.0] [Enable] current handler state is: enabled
2018/08/22 11:58:10.262973 INFO [Microsoft.CPlat.Core.RunCommandLinux-1.0.0] Update settings file: 1.settings
2018/08/22 11:58:10.313158 INFO [Microsoft.CPlat.Core.RunCommandLinux-1.0.0] Enable extension [bin/run-command-shim enable]
2018/08/22 11:58:11.444806 INFO Event: name=Microsoft.CPlat.Core.RunCommandLinux, op=Enable, message=Launch command succeeded: bin/run-command-shim enable, duration=1031
2018/08/22 11:58:11.704326 INFO Event: name=WALinuxAgent, op=ProcessGoalState, message=Incarnation 5, duration=4836
</code></pre>

<p>When changing an SSH key, the following is in that same log:</p>

<pre><code>2018/08/22 11:27:00.603980 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Target handler state: enabled
2018/08/22 11:27:00.713193 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] [Enable] current handler state is: notinstalled
2018/08/22 11:27:01.042711 INFO Event: name=Microsoft.OSTCExtensions.VMAccessForLinux, op=Download, message=Download succeeded, duration=0
2018/08/22 11:27:01.364254 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Initialize extension directory
2018/08/22 11:27:01.509190 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Update settings file: 0.settings
2018/08/22 11:27:01.656294 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Install extension [./vmaccess.py -install]
2018/08/22 11:27:05 VMAccess started to handle.
2018/08/22 11:27:05 [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] cwd is /var/lib/waagent/Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1
2018/08/22 11:27:05 [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Change log file to /var/log/azure/Microsoft.OSTCExtensions.VMAccessForLinux/1.4.7.1/extension.log
2018/08/22 11:27:05.788982 INFO Event: name=Microsoft.OSTCExtensions.VMAccessForLinux, op=Install, message=Launch command succeeded: ./vmaccess.py -install, duration=0
2018/08/22 11:27:06.105463 INFO [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Enable extension [./vmaccess.py -enable]
2018/08/22 11:27:06 VMAccess started to handle.
2018/08/22 11:27:06 [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] cwd is /var/lib/waagent/Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1
2018/08/22 11:27:06 [Microsoft.OSTCExtensions.VMAccessForLinux-1.4.7.1] Change log file to /var/log/azure/Microsoft.OSTCExtensions.VMAccessForLinux/1.4.7.1/extension.log
2018/08/22 11:27:08.271645 INFO Event: name=Microsoft.OSTCExtensions.VMAccessForLinux, op=Enable, message=Launch command succeeded: ./vmaccess.py -enable, duration=0
2018/08/22 11:27:08.438678 INFO Event: name=WALinuxAgent, op=ProcessGoalState, message=Incarnation 2, duration=8933
</code></pre>

<p>Since this is a root access backdoor, the logging on the VM can be compromised.
If you have a centralized logging system, now would be a good time to check if
any of your VM&#39;s could have been exploited with this feature.</p>

<h3 id="toc_6">What is this (wa-linux-agent)?</h3>

<p>This agent is a piece of software created by Microsoft to make life in &quot;the
cloud&quot; easier. OpenStack and Digital Ocean for example have a comparable piece
of software called <a href="https://wiki.archlinux.org/index.php/Cloud-init">cloud-init</a> and the <code>qemu-guest-agent</code>. The code is open
source, can be found <a href="https://github.com/Azure/WALinuxAgent">here on github</a>.</p>

<p>You can read more on the backdoor feature <a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/vmaccess">here</a> (<a href="http://web.archive.org/web/20180822113038/https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/vmaccess">mirror</a>) and <a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/linux/run-command">here</a> (<a href="http://web.archive.org/web/20180822121145/https://docs.microsoft.com/en-gb/azure/virtual-machines/linux/run-command">mirror</a>).</p>

<p>It states the following features:</p>

<ul>
<li><p>Image Provisioning</p>

<ul>
<li>Creation of a user account</li>
<li>Configuring SSH authentication types</li>
<li>Deployment of SSH public keys and key pairs</li>
<li>Setting the host name</li>
<li>Publishing the host name to the platform DNS</li>
<li>Reporting SSH host key fingerprint to the platform</li>
<li>Resource Disk Management</li>
<li>Formatting and mounting the resource disk</li>
<li>Configuring swap space</li>
</ul></li>
<li><p>Networking</p>

<ul>
<li>Manages routes to improve compatibility with platform DHCP servers</li>
<li>Ensures the stability of the network interface name</li>
</ul></li>
<li><p>Kernel</p>

<ul>
<li>Configure virtual NUMA (disable for kernel &lt;2.6.37)</li>
<li>Consume Hyper-V entropy for /dev/random</li>
<li>Configure SCSI timeouts for the root device (which could be remote)</li>
</ul></li>
<li><p>Diagnostics</p>

<ul>
<li>Console redirection to the serial port</li>
</ul></li>
<li><p>SCVMM Deployments</p>

<ul>
<li>Detect and bootstrap the VMM agent for Linux when running in a System Center Virtual Machine Manager 2012R2 environment</li>
</ul></li>
<li><p>VM Extension</p>

<ul>
<li>Inject component authored by Microsoft and Partners into Linux VM (IaaS) to enable software and configuration automation</li>
<li>VM Extension reference implementation on <a href="https://github.com/Azure/azure-linux-extensions">GitHub</a></li>
</ul></li>
</ul>

<h3 id="toc_7">OpenStack / QEMU</h3>

<p>OpenStack/QEMU also has an agent, which could be in the image your cloud
provider uses. It&#39;s the <a href="https://wiki.libvirt.org/page/Qemu_guest_agent">qemu-guest-agent</a>. More information on <a href="https://wiki.qemu.org/Features/GuestAgent">the
features here</a>.</p>

<p>Since OpenStack is not as widespread as Azure and cloud-providers all build
their own images, the impact of this is much lower.</p>

<p>The OpenStack provider I used to work for included this in their images (since
it can help freeze the VM when a snapshot is made, to keep data consistent).</p>

<p>Using the <a href="https://raymii.org/s/tutorials/OpenStack_nova_get_-_password_set_-_password_and_post_encrypted_password_to_metadata_service.html">nova set-password</a> command one can reset a user password via this
agent.</p>

<p>Following the <a href="https://github.com/openstack/nova/blob/master/nova/virt/libvirt/guest.py#L506">nova</a> <a href="https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L2072">source code</a> we can see that in the case of
Libvirt (KVM/QEMU) it calls <a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainSetUserPassword">virDomainSetUserPassword</a>.</p>

<p>Bottom line, inspect the software running in your VM before you put it in
production. Check daemons and agents you don&#39;t know, check for rouge SSH
keys/users, make use of the firewall, build multiple layers of security, defense
in depth, and most important, use your head.</p>
Tags: <a href="../tags/azure.html">azure</a>
, <a href="../tags/backdoor.html">backdoor</a>
, <a href="../tags/blog.html">blog</a>
, <a href="../tags/cloud.html">cloud</a>
, <a href="../tags/microsoft.html">microsoft</a>
, <a href="../tags/openstack.html">openstack</a>
, <a href="../tags/qemu.html">qemu</a>
, <a href="../tags/qemu-guest-agent.html">qemu-guest-agent</a>
, <a href="../tags/security.html">security</a>
, <a href="../tags/ssh.html">ssh</a>
, <a href="../tags/ubuntu.html">ubuntu</a>
, <a href="../tags/wa-linux-agent.html">wa-linux-agent</a>
, <a href="../tags/waagent.html">waagent</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    