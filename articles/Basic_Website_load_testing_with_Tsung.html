
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Distributed load testing with Tsung - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,b'iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC'" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Distributed load testing with Tsung</h2>
<p><small>Published: <span data-pagefind-meta='date'>13-04-2017</span> | Author: Remy van Elst | <a href="Basic_Website_load_testing_with_Tsung.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over seven years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Preface</a>
</li>
<li>
<a href="#toc_1">Tsung configuration</a>
<ul>
<li>
<a href="#toc_2">Installation</a>
</li>
<li>
<a href="#toc_3">Header</a>
</li>
<li>
<a href="#toc_4">Clients</a>
</li>
<li>
<a href="#toc_5">Servers</a>
</li>
<li>
<a href="#toc_6">Load progression</a>
</li>
<li>
<a href="#toc_7">Options</a>
</li>
<li>
<a href="#toc_8">Sessions</a>
<ul>
<li>
<a href="#toc_9">Random variables</a>
</li>
<li>
<a href="#toc_10">Dynamic variables from a file (usernames and passwords)</a>
</li>
<li>
<a href="#toc_11">Checking the servers response</a>
</li>
</ul>
</li>
<li>
<a href="#toc_12">Closing the XML</a>
</li>
</ul>
</li>
<li>
<a href="#toc_13">Running a test</a>
</li>
<li>
<a href="#toc_14">Distributed setup</a>
</li>
<li>
<a href="#toc_15">Proxy recorder</a>
</li>
<li>
<a href="#toc_16">Complete example configuration</a>
</li>
<li>
<a href="#toc_17">Conclusion</a>
</li>
</ul>

</div><hr><div id="contents">
<h3 id="toc_0">Preface</h3>

<p><img src="https://raymii.org/s/inc/img/tsung_logo_non_official.png" alt=""></p>

<p>At $dayjob I manage a large OpenStack Cloud. Next to that I also build high-
performance and redundant clusters for customers. Think multiple datacenters,
<code>haproxy</code>, <code>galera</code> or <code>postgres</code> or mysql replication, <code>drbd</code> with <code>nfs</code> or
<code>glusterfs</code> and all sorts of software that can (and sometimes cannot) be
clustered (<code>redis</code>, <code>rabbitmq</code> etc.). Our customers deploy their application on
there and when one or a few components fail, their application stays up.
Hypervisors, disks, switches, routers, all can fail without actual service
downtime. Next to building such clusters, we also monitor and manage them.</p>

<p>When we build such a cluster (fully automated with Ansible) we do a basic load
test. We do this not for benchmarking or application flow testing, but to
optimize the cluster components. Simple things like the <code>mpm</code> workers or threads
in Apache or more advanced topics like MySQL or DRBD. Optimization there depends
on the specifications of the servers used and the load patterns.</p>

<p>Tsung is a high-performance but simple to configure and use piece of software
written in Erlang. Configuration is done in a simple readable XML file. Tsung
can be run distributed as well for large setups. It has good reporting and a
live web interface for status and reports during a test.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>I&#39;m by no means a load-testing expert. User flow, parsing the results and such
are not my cup of tea. I do however understand server performance and
optimization. These load tests are ment to help me and my team to have a general
idea of that the clients setup is able to handle. For example, high-load
clusters benefit from several extra IP addresses just for monitoring. Sockets in
linux are per IP, and when the IP&#39;s and conntrack are exhausted, the monitoring
IP will still work. We found that during one of these load tests where the load
was relatively low, but all the monitoring failed (because of conntrack).</p>

<h3 id="toc_1">Tsung configuration</h3>

<p>The tsung configuration file consists out of several different parts. We&#39;ll
cover them here, but first we must install the software. The version of <code>tsung</code>
that I&#39;m using is 1.6.0. We&#39;ll talk in detail about the configuration file. The
entire file can be found at the bottom of this page as a whole.</p>

<h4 id="toc_2">Installation</h4>

<p>Tsung can be installed via <code>apt</code>:</p>

<pre><code>apt-get install tsung
</code></pre>

<p>Under Ubuntu 16.04 and 17.04 I did get strange erlang errors complaining about
<code>enoent</code>. It appears in the Ubuntu package something was missing. Manually
compiling <code>tsung</code> with the classical</p>

<pre><code>./configure
make
make install
</code></pre>

<p>fixed those errors.</p>

<h4 id="toc_3">Header</h4>

<p>Tsung configuration is xml, so first we need to place the header:</p>

<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE tsung SYSTEM &quot;/usr/share/tsung/tsung-1.0.dtd&quot;&gt;
&lt;tsung loglevel=&quot;notice&quot; version=&quot;1.0&quot;&gt;
</code></pre>

<h4 id="toc_4">Clients</h4>

<p>The clients are the servers that execute the actual load test. If you have a
distributed setup (see below) then you define them here:</p>

<pre><code>&lt;clients&gt;
  &lt;client host=&quot;ts2&quot; maxusers=&quot;30000&quot; weight=&quot;2&quot; /&gt;
  &lt;client host=&quot;ts3&quot; weight=&quot;1&quot; /&gt;
&lt;/clients&gt;
</code></pre>

<p><code>ts3</code> will do a maximum amount of users and client <code>ts2</code> will be used twice as
much as client <code>ts3</code> due to the weight. You can omit those two options.</p>

<p>If you want to execute the test from your local workstation you can use the
following configuration:</p>

<pre><code>&lt;clients&gt;
  &lt;client host=&quot;localhost&quot; use_controller_vm=&quot;true&quot;/&gt;
&lt;/clients&gt;
</code></pre>

<h4 id="toc_5">Servers</h4>

<p>The servers are the endpoints where the clients will send the requests to. This
will be either the hostname or IP address of the server you are going to test.</p>

<pre><code>&lt;servers&gt;
  &lt;server host=&quot;example.org&quot; port=&quot;443&quot; type=&quot;ssl&quot;&gt;&lt;/server&gt;
&lt;/servers&gt;
</code></pre>

<p>Servers can have a <code>weight</code> as well.</p>

<p><code>type</code> can be any of the following:</p>

<ul>
<li>tcp</li>
<li>ssl </li>
<li>udp </li>
<li>tcp6</li>
<li>ssl6 </li>
<li>udp6</li>
<li>websocket </li>
</ul>

<p>For HTTP you need to use <code>tcp</code>, for HTTPS you need to use <code>ssl</code>. If you use
multiple servers based on IP address and they use virtual hosts, for every
request (see below) you need to also define the <code>HTTP Host:</code> header in the
configuration section for that request:</p>

<pre><code>&lt;request&gt;
  &lt;http url=&quot;/bla&quot; method=&quot;POST&quot; contents=&quot;bla=blu&amp;amp;name=glop&quot;&gt;
    &lt;www_authenticate userid=&quot;Aladdin&quot; passwd=&quot;open sesame&quot;/&gt;
    &lt;http_header name=&quot;Cache-Control&quot; value=&quot;no-cache&quot;/&gt;
    &lt;http_header name=&quot;Host&quot; value=&quot;example.org&quot;/&gt;
  &lt;/http&gt;
&lt;/request&gt;
</code></pre>

<p>For more information on <code>servers</code> and <code>clients</code> <a href="http://tsung.erlang-projects.org/user_manual/conf-client-server.html">see here</a>.</p>

<h4 id="toc_6">Load progression</h4>

<p>The load test is split up into several phases. Each phase has a duration and a
number of visitors. During these phases the sessions will be executed. A basic
load setup I use often is one where there are the number of users increases:</p>

<pre><code>&lt;load&gt;
  &lt;!-- 50 users a second for 3 minutes == 9000 sessions --&gt;
  &lt;arrivalphase phase=&quot;1&quot; duration=&quot;3&quot; unit=&quot;minute&quot;&gt;
    &lt;users arrivalrate=&quot;50&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
  &lt;/arrivalphase&gt;
  &lt;!-- 100 users a second for 3 minutes == 18000 sessions --&gt;
  &lt;arrivalphase phase=&quot;2&quot; duration=&quot;3&quot; unit=&quot;minute&quot;&gt;
    &lt;users arrivalrate=&quot;100&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
  &lt;/arrivalphase&gt;
  &lt;!-- 200 users a second for 6 minutes == 72000 sessions --&gt;
  &lt;arrivalphase phase=&quot;3&quot; duration=&quot;6&quot; unit=&quot;minute&quot;&gt;
    &lt;users arrivalrate=&quot;200&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
  &lt;/arrivalphase&gt;
&lt;/load&gt;
</code></pre>

<p>You can define as many phases as you please. If you want to test a maximum
number of users per phase, use the <code>maxnumber=&quot;&quot;</code> option:</p>

<pre><code>&lt;load&gt;
  &lt;arrivalphase phase=&quot;1&quot; duration=&quot;3&quot; unit=&quot;minute&quot;&gt;
    &lt;users maxnumber=&quot;100&quot; arrivalrate=&quot;2&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
  &lt;/arrivalphase&gt;
&lt;/load&gt;
</code></pre>

<p>There will be a maximum of 100 users in the three minutes setup.</p>

<p>Phases are done in order of the number. First phase 1, then 2, then 3 and so on.
These phases can also be looped. More information on phases and load progression
<a href="http://tsung.erlang-projects.org/user_manual/conf-load.html">can be found here</a>.</p>

<h4 id="toc_7">Options</h4>

<p>Per test we can define options. These are mostly used for <code>xmpp</code> testing, the
only option we have for HTTP is the user agent. Multiple user agents can be
setup and given a probability:</p>

<pre><code>&lt;options&gt;
  &lt;option type=&quot;ts_http&quot; name=&quot;user_agent&quot;&gt;
    &lt;user_agent probability=&quot;20&quot;&gt;Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/532.0 (KHTML, like Gecko) Chrome/4.0.201.1 Safari/532.0&lt;/user_agent&gt;
    &lt;user_agent probability=&quot;30&quot;&gt;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0&lt;/user_agent&gt;
    &lt;user_agent probability=&quot;50&quot;&gt;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&lt;/user_agent&gt;
  &lt;/option&gt;
&lt;/options&gt;
</code></pre>

<p>Chrome will be 20% of the visits, Firefox 30 and the rest is Internet Explorer.
The probability must add up to 100.</p>

<p>A few more options like SSL Ciphers and global timeouts can be set, <a href="http://tsung.erlang-projects.org/user_manual/conf-options.html">see
here</a> for details.</p>

<h4 id="toc_8">Sessions</h4>

<p>Sessions define the content of the scenario itself. They describe the requests
to execute. Multiple types of requests can be given, next to the basic HTTP GET
and POST requests. WEBDAV is supported as well as basic, oauth and digest
authentication, HTTP headers and more.</p>

<p>This article limits itself to HTTP website testing. For XMPP and the other types
supported by Tsung, please <a href="http://tsung.erlang-projects.org/user_manual/conf-sessions.html">consult the documentation</a>.</p>

<p>Before we dive in to all the configuration, lets think about what our goal is
here. We want to simulate a visitor with a web browser. Browsers normally do not
just get a page over and over again. They request the page, but also all the
content included, like javascript, stylesheets and images. Once a page is
loaded, they stop doing stuff while the human reads the page, until a new link
is clicked and the whole thing starts over. Include a search or a POST reqeust
here and there and you&#39;ve got something much more complex than just a <code>curl</code>
loop in your shell.</p>

<p>A very nice feature of Tsung is support for so called Transactions. Transactions
are a way to group several requests. In the statistics these requests will be
shown as a group, like here below in the image:</p>

<p><img src="https://raymii.org/s/inc/img/tsung2.png" alt=""></p>

<p>In the picture I&#39;ve defined two transactions. One to get the index page
including javascript, css, the logo image and the custom web fonts, and one to
get an actual article including all of the above plus the images in the article.</p>

<p>Using transactions your can understand your statistics better. You can also find
out bottlenecks easier. Let&#39;s say your index page and your articles are cached
by <code>varnish</code> or <code>nginx</code>, but your product list is not. With the transactions you
can probably see that the caching works for the first to. The latter group, the
product list, will have a lower performance.</p>

<p>So let&#39;s define our first session with two transactions. Use your favorite
browser and the Proxy Recorder from Tsung (see below) or open up the development
tools and copy the URL&#39;s of all the requests. You can have multiple sessions as
well, after this session we will add another one that does a website search.</p>

<pre><code>&lt;sessions&gt;
  &lt;session name=&quot;http&quot; weight=&quot;10&quot; type=&quot;ts_http&quot;&gt;
    &lt;thinktime value=&quot;2&quot; random=&quot;true&quot;&gt;&lt;/thinktime&gt;
    &lt;transaction name=&quot;index_request&quot;&gt;
      &lt;request&gt;
        &lt;http url=&quot;/&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
      &lt;/request&gt;
      &lt;request&gt;
        &lt;http url=&quot;/s/&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
      &lt;/request&gt;
      &lt;request&gt;
        &lt;http url=&quot;/inc/css/custom-first.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt;
       &lt;/request&gt;
      &lt;request&gt;
        &lt;http url=&quot;/inc/css/light.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt;
       &lt;/request&gt;
      &lt;request&gt;
        &lt;http url=&quot;//inc/js/toc.js&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
      &lt;/request&gt;
      &lt;request&gt;
        &lt;http url=&quot;/inc/img/resistor-50.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
      &lt;/request&gt;
      &lt;request&gt;
        &lt;http url=&quot;/inc/css/raleway.ttf&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
      &lt;/request&gt;
    &lt;/transaction&gt;
  &lt;/session&gt;
&lt;/sessions&gt;
</code></pre>

<p>The weight can be defined here as well, just as a probability. I prefer to use
weight due to a more even distribution, probability is still a chance-based
calculation. A probablity of 10 and 90 doesn&#39;t mean that 10% of the requests
will be as you specified, just that is has a 10% change. A weight of 1 and 10
will mean that there will be 10 times more requests absolute.</p>

<p>Thinktime is a random pause with a maximum of 2 seconds between requests.</p>

<p>The actual requests are self explanatory, an URL is defined. I use relative
URL&#39;s, but you can also use absolute URL&#39;s. Do note that the absolute URL
overrides the server for the rest of the sessions, until you define another
absolute URL.</p>

<p>Here is an example of a POST request wich submits data and does a HTTP Basic
login:</p>

<pre><code>&lt;request&gt;
  &lt;http url=&quot;/migration/new&quot; method=&quot;POST&quot; contents=&quot;server=www1&amp;amp;name=dave&amp;amp;reason=maintenance&quot;&gt;
    &lt;www_authenticate userid=&quot;dave@example.org&quot; passwd=&quot;hunter2&quot;/&gt;
    &lt;http_header name=&quot;Cache-Control&quot; value=&quot;no-cache&quot;/&gt;
    &lt;http_header name=&quot;Host&quot; value=&quot;www.example.org&quot;/&gt;
  &lt;/http&gt;
&lt;/request&gt;
</code></pre>

<p>You can add a cookie to a request. I haven&#39;t found a way to do a POST and use
the cookie you get from that yet. You also need to define the cookie during
every request:</p>

<pre><code>&lt;request&gt;
  &lt;http url=&quot;/s/&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;
    &lt;add_cookie key=&quot;admin&quot; value=&quot;1&quot;/&gt;
  &lt;/http&gt; 
&lt;/request&gt;
</code></pre>

<p>Here is the second transaction which gets an article page from here, including
all the images.</p>

<pre><code>&lt;transaction name=&quot;article_request&quot;&gt;
  &lt;request&gt; &lt;http url=&quot;/s/blog/Burn_in_testing_for_Hypervisor_and_Storage_servers.html&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/inc/css/custom-first.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/inc/css/light.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/inc/js/toc.js&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/inc/img/resistor-50.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/inc/css/raleway.ttf&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/busy-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/automate-all-the-things.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/empty-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/iops-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/iops-zfs.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/busy-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/busy-compute2.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
  &lt;request&gt; &lt;http url=&quot;/s/inc/img/notification-memory.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
&lt;/transaction&gt;
</code></pre>

<h5 id="toc_9">Random variables</h5>

<p>Static content mostly works just fine and probably comes from a caching layer.
One thing we always do is something dynamic to let the requests fall through the
cache and go to the application, <code>php</code>, <code>django</code> or <code>rails</code> for example. 90% of
the time we can use the search feature of the tested application, the other 10%
we do POST requests or have the development team build a special testing page.</p>

<p>Tsung can do a few more tricks and even allows you to write custom Erlang
scripts for more magic. We use but a simple part of that to get a random string
for the searches. If the site has a GET based search page, this is easy.</p>

<p>Using <code>dynvars</code> we can create a random string. Tsung has multiple types of
random strings. First, and in my experience the fastest, is a numeric only ID.
Append <code>subst=&quot;true&quot;</code> to the <code>&lt;request&gt;</code> for a dynamic variable request.</p>

<p>One thing to remember is that all dynamic variables must be prefixed with an
underscore (<code>_</code>) in the requests. If you define a variable named <code>example_var</code>,
in your request you need to call it via <code>%%_example_var%%</code>.</p>

<p>In your request you can call this by adding <code>%%ts_user_server:get_unique_id%%</code>
in the request URL. For example:</p>

<pre><code>&lt;http url=&quot;/zoeken/?q=%%ts_user_server:get_unique_id%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt;
</code></pre>

<p>Will result in the following in your logs:</p>

<pre><code>215.83.32.40 - - [14/Apr/2017:16:21:06 +0200] &quot;GET /zoeken/?q=15375 HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/532.0 (KHTML, like Gecko) Chrome/4.0.201.1 Safari/532.0&quot;

215.83.32.40 - - [14/Apr/2017:16:21:09 +0200] &quot;GET /zoeken/?q=15522 HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0&quot;

215.83.32.40 - - [14/Apr/2017:16:21:09 +0200] &quot;GET /zoeken/?q=15532 HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0&quot;
</code></pre>

<p>The parameter is different for every single request.</p>

<p>The next parameter is <code>urandom_string</code>. According to the documentation this
string is faster than <code>random_string</code> but not truly random. It is also the same
for the entire session. In the <code>&lt;session&gt;</code>, define the variable:</p>

<pre><code>&lt;setdynvars sourcetype=&quot;urandom_string&quot; length=&quot;20&quot;&gt;
  &lt;var name=&quot;urndstring1&quot; /&gt;
&lt;/setdynvars&gt;
</code></pre>

<p>In your request:</p>

<pre><code>&lt;http url=&quot;/zoeken/?q_random=%%_rndstring1%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
</code></pre>

<p>In your logs:</p>

<pre><code>215.83.32.38 - - [14/Apr/2017:16:08:52 +0200] &quot;GET /zoeken/?q_urand=qxvmvtglimieyhemzlxc HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&quot;

215.83.32.40 - - [14/Apr/2017:16:08:53 +0200] &quot;GET /zoeken/?q_urand=qxvmvtglimieyhemzlxc HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0&quot;

215.83.32.40 - - [14/Apr/2017:16:08:54 +0200] &quot;GET /zoeken/?q_urand=qxvmvtglimieyhemzlxc HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&quot;
</code></pre>

<p>The same parameter is sent for every request. This can be a problem if your
search results are cached, only the first search will be slow until the cache
expires.</p>

<p>The last random method is <code>random_string</code>. This is slower to generate but is
different for each request.</p>

<p>In your session:</p>

<pre><code>&lt;setdynvars sourcetype=&quot;random_string&quot; length=&quot;13&quot;&gt;
  &lt;var name=&quot;rndstring1&quot; /&gt;
&lt;/setdynvars&gt;
</code></pre>

<p>In your request:</p>

<pre><code>&lt;http url=&quot;/zoeken/?q_random=%%_rndstring1%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
</code></pre>

<p>In your logs:</p>

<pre><code>215.83.32.38 - - [14/Apr/2017:16:08:52 +0200] &quot;GET /zoeken/?q_rand=jrekkkrqrobiq HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&quot;

215.83.32.38 - - [14/Apr/2017:16:08:52 +0200] &quot;GET /zoeken/?q_rand=shypceesbeyth HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&quot;

215.83.32.40 - - [14/Apr/2017:16:08:53 +0200] &quot;GET /zoeken/?q_rand=hwfhuubmgvejb HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0&quot;

215.83.32.40 - - [14/Apr/2017:16:08:54 +0200] &quot;GET /zoeken/?q_rand=egidgqflijzul HTTP/1.1&quot; 200 308 &quot;-&quot; &quot;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&quot;
</code></pre>

<p>The parameter here is different.</p>

<p>Do be carefull with these random or dynamic requests that fall through the cache
to your application. We mostly make 10% of the scenario requests of this type,
our experience is that more will bring every application to a grinding halt.
Regular user traffic (non-bots) also most of the time doesn&#39;t do that many
things that cannot be cached. Take a forum for example, only the post-request
that submits a topic or reply cannot be cached, but a user won&#39;t send 1500 new
topics in a few minutes. All the other parts, even dynamic stuff like profile
pages or user-generated content can be cached. Maybe not in <code>varnish</code>, but in a
key-value store like <code>redis</code> instead of directly coming from your database.</p>

<p>Here is a session that utilizes the three different random string methods:</p>

<pre><code>&lt;session name=&quot;zoeken&quot; weight=&quot;1&quot; type=&quot;ts_http&quot;&gt;
  &lt;setdynvars sourcetype=&quot;random_string&quot; length=&quot;13&quot;&gt;
    &lt;!-- different for each request --&gt;
    &lt;var name=&quot;rndstring1&quot; /&gt;
  &lt;/setdynvars&gt;
  &lt;setdynvars sourcetype=&quot;urandom_string&quot; length=&quot;20&quot;&gt;
    &lt;!-- the same for each request --&gt;
    &lt;var name=&quot;urndstring1&quot; /&gt;
  &lt;/setdynvars&gt;
  &lt;request subst=&quot;true&quot;&gt; 
    &lt;http url=&quot;/zoeken/?q_id=%%ts_user_server:get_unique_id%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
  &lt;/request&gt;
  &lt;request subst=&quot;true&quot;&gt; 
    &lt;http url=&quot;/zoeken/?q_random=%%_rndstring1%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
  &lt;/request&gt;
  &lt;request subst=&quot;true&quot;&gt; 
    &lt;http url=&quot;/zoeken/?q_urandom=%%_urndstring1%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; 
  &lt;/request&gt;
  &lt;thinktime value=&quot;20&quot; random=&quot;true&quot;&gt;&lt;/thinktime&gt;
&lt;/session&gt;
</code></pre>

<h5 id="toc_10">Dynamic variables from a file (usernames and passwords)</h5>

<p>The <a href="http://tsung.erlang-projects.org/user_manual/conf-advanced-features.html">manual</a> has another example where you can read a <code>csv</code> file with
usernames and passwords and use those for a request. This is a good way to test
if your application has a rate-limiting feature, to make sure users cannot just
brute-force their way in.</p>

<p>The <code>userlist.csv</code> file:</p>

<pre><code>user1;password1
user2;password2
</code></pre>

<p>The dynvar:</p>

<pre><code>&lt;setdynvars sourcetype=&quot;file&quot; fileid=&quot;userlist.csv&quot; delimiter=&quot;;&quot; order=&quot;iter&quot;&gt;
 &lt;var name=&quot;username&quot; /&gt;
 &lt;var name=&quot;user_password&quot; /&gt;
&lt;/setdynvars&gt; 
</code></pre>

<p>The request:</p>

<pre><code>&lt;request subst=&quot;true&quot;&gt;
  &lt;http url=&#39;/login/&#39; version=&#39;1.0&#39;
    contents=&#39;username=%%_username%%&amp;amp;password=%%_user_password%%&amp;amp;op=login&#39;
  content_type=&#39;application/x-www-form-urlencoded&#39; method=&#39;POST&#39;&gt;
  &lt;/http&gt;
&lt;/request&gt;
</code></pre>

<p>Testing the actual rate limiting can be done as well by checking the servers
response.</p>

<h5 id="toc_11">Checking the servers response</h5>

<p>With the tag match in a <code>&lt;request&gt;</code> tag, you can check the server&#39;s response
against a given string, and do some actions depending on the result. In any
case, if it matches, this will increment the <code>match</code> counter, if it does not
match, the <code>nomatch</code> counter will be incremented.</p>

<p>The list of available actions to do is:</p>

<ul>
<li><code>continue</code>: do nothing, continue (only update <code>match</code> or <code>nomatch</code> counters)</li>
<li><code>log</code>: log the <code>request id</code>, <code>userid</code>, <code>sessionid</code>, <code>name</code> in <code>match.log</code></li>
<li><code>abort</code>: abort the session</li>
<li><code>restart</code>: restart the session. </li>
<li><code>loop</code>: repeat the request, after 5 seconds. The maximum number of loops is 20 by default.</li>
<li><code>dump</code>: dump the content of the response in a filen filename is <code>match-&lt;userid&gt;-&lt;sessionid&gt;-&lt;requestid&gt;-&lt;dumpid&gt;.dump</code></li>
</ul>

<p>To test if brute-force protection works, you can use either the <code>continue</code>
option or the <code>abort</code> option. If you use continue, check the <code>nomatch</code> counter
in the statistics. If you use the <code>abort</code> option, the test will stop when the
rate-limiting is in place and your match fails.</p>

<p>Here is an example of a login page with an <code>abort</code> if the content has the words
<code>login failed!</code>:</p>

<pre><code>&lt;request&gt;
   &lt;match do=&quot;abort&quot; when=&quot;match&quot;&gt;login failed!&lt;/match&gt;
   &lt;http url=&quot;/login.php&quot; version=&quot;1.0&quot; method=&quot;POST&quot;
         contents=&quot;username=dave&amp;amp;user_password=hunter2&quot;
         content_type=&quot;application/x-www-form-urlencoded&quot; &gt;
&lt;/request&gt;
</code></pre>

<p>You can also use <code>nomatch</code>, for example if you don&#39;t give an error when your
brute-force protection kicks in. You can then test if the <code>Welcome dear
$username</code> is not on the page.</p>

<p>The <a href="http://tsung.erlang-projects.org/user_manual/conf-advanced-features.html#checking-the-server-s-response">docs</a> have more examples, including complex conditionals and loops.</p>

<h4 id="toc_12">Closing the XML</h4>

<p>When you&#39;ve defined all your transactions and requests, you need to close the
file with the last tag:</p>

<pre><code>&lt;/tsung&gt;
</code></pre>

<p>Now you&#39;re ready to execute the loadtest.</p>

<h3 id="toc_13">Running a test</h3>

<p>With your configuration file set up, and if defined, your distributed setup working, you can start the test. During the test there is a live status web interface running on <a href="127.0.0.1:8091"><code>127.0.0.1:8091</code></a>: </p>

<p><img src="https://raymii.org/s/inc/img/tsung1.png" alt=""></p>

<p>Using the below command we can start a test. The <code>-k</code> option keeps the web
interface open even when the test is finished.</p>

<pre><code>tsung -k -f file.xml start
</code></pre>

<p>Example output:</p>

<pre><code>Starting Tsung
Log directory is: /root/.tsung/log/20170414-1609
</code></pre>

<p>When the test is finished:</p>

<pre><code>All slaves have stopped; keep controller and web dashboard alive. 
Hit CTRL-C or click Stop on the dashboard to stop.
</code></pre>

<p>If you want to abort a test while it is running, because for example your server
crashes, hit <code>CTRL+C</code> a few times.</p>

<p>During the test you get live metrics and graphs on the web interface:</p>

<p><img src="https://raymii.org/s/inc/img/tsung3.png" alt=""></p>

<p>I&#39;ll discuss two other very nice features of Tsung, the distributed setup and
the proxy recorder. The distributed setup allows you to scale up the load test
far beyond one server. We&#39;ve done tests with over ten million concurrent hits
using 50 virtual machines. Just small single core instances with gigabit
network.</p>

<p>The proxy recorder allows you to record a browsing session. Way better than
manually creating a text configuration file. Even the client can do so.</p>

<h3 id="toc_14">Distributed setup</h3>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring this site by trying out a Digital
Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get
$10 credit). (referral link)</a></p>

<p>Tsung communicates between testing nodes using SSH, so make sure your SSH keys
are installed on the servers and that you can SSH between them without a
password prompt. If you can&#39;t, generate a special SSH key for tsung, without a
password:</p>

<pre><code>ssh-keygen -C &#39;tsung&#39; -t rsa -b 2048 -N &quot;&quot; -f /root/.ssh/id_rsa.tsung
</code></pre>

<p>Output:</p>

<pre><code>Generating public/private rsa key pair.
Your identification has been saved in /root/.ssh/id_rsa.tsung.
Your public key has been saved in /root/.ssh/id_rsa.tsung.pub.
The key fingerprint is:
SHA256:eCl3Vkk/afmYAraZVQw4Y9OSnIIQas tsung
The key&#39;s randomart image is:
+---[RSA 2048]----+
|o+oo.oo= B+o     |
|                 |
+----[SHA256]-----+
</code></pre>

<p>Place the key on the server you are using for tsung:</p>

<pre><code>ssh-copy-id root@1.2.3.4
</code></pre>

<p>Add the server to your SSH config and specify to use the key we just generated:</p>

<pre><code>vim ~/.ssh/config
</code></pre>

<p>Add:</p>

<pre><code>Host ts1
 Hostname 1.2.3.4
 User root
 IdentityFile ~/.ssh/id_rsa.tsung
 Port 22
</code></pre>

<p>Also add them to your <code>/etc/hosts</code> file:</p>

<pre><code>1.2.3.4 ts1
4.3.2.1 ts2
</code></pre>

<p>Test to see if you can login without a password:</p>

<pre><code>ssh root@ts1
</code></pre>

<p>Repeat this for all the other nodes.</p>

<p>You must use a hostname (ssh hostname or actual hostname), otherwise you will
get an error:</p>

<pre><code>ERROR: client config: &#39;host&#39; attribute must be a hostname, not an IP ! (was &quot;213.187.242.156&quot;)
</code></pre>

<p>It is important to use the same <code>erlang</code> and <code>tsung</code> version on all the servers.
I had my controller vm on CentOS 7 and the test servers on Ubuntu 16.04, with a
slightly different erlang version (<code>erts-8.2.1</code> vs <code>erts-8.3</code>) and the tests all
timed out or failed. Booting up a controller VM with 16.04 made it all work.</p>

<p>If you do experience issues with the distributed setup, you can test if the SSH
connection via erlang works. On your controller VM execute the following
command:</p>

<pre><code>erl -rsh ssh -sname foo -setcookie mycookie
</code></pre>

<p>In the prompt, give the following command, where <code>ts2</code> is the hostname of the
server to test the connection to:</p>

<pre><code>slave:start(ts2,bar,&quot;-setcookie mycookie&quot;).
</code></pre>

<p>It should return:</p>

<pre><code>{ok,bar@ts2}
</code></pre>

<p>Otherwise your setup is incorrect. <a href="http://tsung.erlang-projects.org/user_manual/faq.html#can-t-start-distributed-clients-timeout-error">See here</a> for more troubleshooting tips.</p>

<h3 id="toc_15">Proxy recorder</h3>

<p>Tsung has a proxy recorder. It allows you to record a browser session to a
configuration file. I haven&#39;t used it but for complicated browsing session it
seems quite handy.</p>

<p>The recorder has three plugins: for HTTP, WebDAV and for PostgreSQL. To start
it, run:</p>

<pre><code>tsung-recorder -p PLUGIN start
</code></pre>

<p>where PLUGIN can be <code>http</code>, <code>webdav</code> or <code>pgsql</code> for PostgreSQL. The default
plugin is <code>http</code>. The proxy is listening to port 8090. You can change the port
with <code>-L portnumber</code>.</p>

<p>To stop it, use :</p>

<pre><code>tsung-recorder stop.
</code></pre>

<p>The recorded session is created as <code>~/.tsung/tsung_recorderYYYMMDD-HH:MM.xml</code>;
if it doesn&#39;t work, take a look at <code>~/.tsung/log/tsung.log-
tsung_recorder@hostname</code>.</p>

<p><a href="http://tsung.erlang-projects.org/user_manual/proxy.html">More info</a></p>

<h3 id="toc_16">Complete example configuration</h3>

<p>Below you&#39;ll find the complete configuration file we discussed in this article.</p>

<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE tsung SYSTEM &quot;/usr/share/tsung/tsung-1.0.dtd&quot;&gt;
&lt;tsung loglevel=&quot;notice&quot; version=&quot;1.0&quot;&gt;

  &lt;clients&gt;
    &lt;client host=&quot;ts2&quot; maxusers=&quot;30000&quot;/&gt;
    &lt;client host=&quot;ts3&quot; maxusers=&quot;30000&quot;/&gt;
  &lt;/clients&gt;

  &lt;!-- Server side setup --&gt;
  &lt;servers&gt;
    &lt;server host=&quot;example.org&quot; port=&quot;443&quot; type=&quot;ssl&quot;&gt;&lt;/server&gt;
  &lt;/servers&gt;

  &lt;load&gt;
    &lt;arrivalphase phase=&quot;1&quot; duration=&quot;3&quot; unit=&quot;minute&quot;&gt;
      &lt;users arrivalrate=&quot;500&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
    &lt;/arrivalphase&gt;
    &lt;arrivalphase phase=&quot;2&quot; duration=&quot;3&quot; unit=&quot;minute&quot;&gt;
      &lt;users arrivalrate=&quot;1000&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
    &lt;/arrivalphase&gt;
    &lt;arrivalphase phase=&quot;3&quot; duration=&quot;6&quot; unit=&quot;minute&quot;&gt;
      &lt;users arrivalrate=&quot;2000&quot; unit=&quot;second&quot;&gt;&lt;/users&gt;
    &lt;/arrivalphase&gt;
  &lt;/load&gt;

  &lt;options&gt;
   &lt;option type=&quot;ts_http&quot; name=&quot;user_agent&quot;&gt;
    &lt;user_agent probability=&quot;20&quot;&gt;Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/532.0 (KHTML, like Gecko) Chrome/4.0.201.1 Safari/532.0&lt;/user_agent&gt;
    &lt;user_agent probability=&quot;30&quot;&gt;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0&lt;/user_agent&gt;
    &lt;user_agent probability=&quot;50&quot;&gt;Mozilla/5.0 (IE 11.0; Windows NT 6.3; Trident/7.0; .NET4.0E; .NET4.0C; rv:11.0) like Gecko&lt;/user_agent&gt;
  &lt;/option&gt;
&lt;/options&gt;

  &lt;sessions&gt;
    &lt;session name=&quot;zoeken&quot; weight=&quot;1&quot; type=&quot;ts_http&quot;&gt;
      &lt;setdynvars sourcetype=&quot;random_string&quot; length=&quot;13&quot;&gt;
        &lt;var name=&quot;rndstring1&quot; /&gt;
      &lt;/setdynvars&gt;
      &lt;setdynvars sourcetype=&quot;urandom_string&quot; length=&quot;20&quot;&gt;
        &lt;var name=&quot;urndstring1&quot; /&gt;
      &lt;/setdynvars&gt;
      &lt;request subst=&quot;true&quot;&gt; &lt;http url=&quot;/zoeken/?q=%%ts_user_server:get_unique_id%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
      &lt;request subst=&quot;true&quot;&gt; &lt;http url=&quot;/zoeken/?q=%%_rndstring1%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
      &lt;request subst=&quot;true&quot;&gt; &lt;http url=&quot;/zoeken/?q=%%_urndstring1%%&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
      &lt;thinktime value=&quot;20&quot; random=&quot;true&quot;&gt;&lt;/thinktime&gt;
    &lt;/session&gt;

    &lt;session name=&quot;http&quot; weight=&quot;10&quot; type=&quot;ts_http&quot;&gt;
      &lt;thinktime value=&quot;2&quot; random=&quot;true&quot;&gt;&lt;/thinktime&gt;

      &lt;transaction name=&quot;index_request&quot;&gt;
        &lt;request&gt; &lt;http url=&quot;/&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/css/custom-first.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/css/light.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;//inc/js/toc.js&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/img/resistor-50.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/css/raleway.ttf&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
      &lt;/transaction&gt;

      &lt;transaction name=&quot;article_request&quot;&gt;
        &lt;request&gt; &lt;http url=&quot;/s/blog/Burn_in_testing_for_Hypervisor_and_Storage_servers.html&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/css/custom-first.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/css/light.css&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/js/toc.js&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/img/resistor-50.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/inc/css/raleway.ttf&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/busy-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/automate-all-the-things.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/empty-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/iops-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/iops-zfs.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/busy-compute.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/busy-compute2.jpg&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
        &lt;request&gt; &lt;http url=&quot;/s/inc/img/notification-memory.png&quot; method=&quot;GET&quot; version=&quot;1.1&quot;&gt;&lt;/http&gt; &lt;/request&gt;
      &lt;/transaction&gt;
    &lt;/session&gt;
  &lt;/sessions&gt;
&lt;/tsung&gt;
</code></pre>

<h3 id="toc_17">Conclusion</h3>

<p>Load testing is a powerfull tool. We use it to optimize our clusters. You can
also do more harm than good with it, like crashing poorly setup applications. So
please make sure you always test only your own setup or a non-production setup.
A staging or preproduction environment that replicates production, or if you
must, make sure to have written permission from the client on the exact test you
are going to execute.</p>
Tags: <a href="../tags/ab.html">ab</a>
, <a href="../tags/articles.html">articles</a>
, <a href="../tags/benchmark.html">benchmark</a>
, <a href="../tags/loadtest.html">loadtest</a>
, <a href="../tags/performance.html">performance</a>
, <a href="../tags/ssl.html">ssl</a>
, <a href="../tags/testing.html">testing</a>
, <a href="../tags/tls.html">tls</a>
, <a href="../tags/tsung.html">tsung</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    