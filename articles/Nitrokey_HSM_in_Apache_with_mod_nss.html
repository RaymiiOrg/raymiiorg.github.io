
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Use the Nitrokey HSM or SmartCard-HSM with mod_nss and Apache - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Use the Nitrokey HSM or SmartCard-HSM with mod_nss and Apache</h2>
<p><small>Published: <span data-pagefind-meta='date'>21-06-2016</span> | Author: Remy van Elst | <a href="Nitrokey_HSM_in_Apache_with_mod_nss.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over seven years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Introduction</a>
</li>
<li>
<a href="#toc_1">mod_nss installation</a>
</li>
<li>
<a href="#toc_2">NSS and Certutil config</a>
</li>
<li>
<a href="#toc_3">HSM Key generation and NSS usage</a>
</li>
<li>
<a href="#toc_4">Import Root CA Chains</a>
</li>
<li>
<a href="#toc_5">Apache2 and mod_nss config</a>
</li>
<li>
<a href="#toc_6">Benchmarking 2048 bit RSA</a>
</li>
<li>
<a href="#toc_7">Benchmarking EC keys</a>
</li>
<li>
<a href="#toc_8">Benchmarking a 1024 bit RSA key</a>
</li>
<li>
<a href="#toc_9">Clustering</a>
</li>
</ul>

</div><hr><div id="contents">
<p>This is a guide on using the <a href="https://www.nitrokey.com/">Nitrokey HSM</a> with <code>mod_nss</code> and the Apache
webserver. The HSM allows you to store the private key for a SSL certificate
inside the HSM (instead of on the filesystem), so that it can never leave the
device and thus never be stolen.</p>

<p>The guide covers the installation and configuration of <code>mod_nss</code>, coupling the
HSM to NSS, generating the keys and configuring Apache, and last but not least
we also do some benchmarks on Apache with the HSM and different key sizes.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<h3 id="toc_0">Introduction</h3>

<p><img src="https://raymii.org/s/inc/img/nitrokey1.jpg" alt=""></p>

<blockquote>
<p>The Nitrokey HSM in a sealed package</p>
</blockquote>

<p>The <a href="http://nitrokey.com">Nitrokey HSM</a> is an open hardware and open software device. It is a USB
version of the <a href="http://www.smartcard-hsm.com/">SmartCard-HSM</a>. Both the <a href="http://www.smartcard-hsm.com/opensource.html">SmartCard-HSM</a> as the <a href="https://github.com/nitrokey">Nitrokey
HSM</a> have sources available and are fully supported by the <a href="https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM">OpenSC</a>
project.</p>

<p>If you are new to the NitroKey HSM/SmartCard HSM, please also <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html">read my getting
started</a> article. It explains what the HSM is, how to set it up and how to
use it with OpenSSH for example.</p>

<p>I have <a href="https://raymii.org/s/tags/nitrokey.html">multiple articles</a> on this nice device, so make sure to read the
others as well.</p>

<p><img src="https://raymii.org/s/inc/img/sc-hsm.jpg" alt=""></p>

<blockquote>
<p>The SmartCard-HSM</p>
</blockquote>

<p>In this entire tutorial I will be using slot 1 and ID 1 of the Nitrokey HSM. The
User PIN is <code>648219</code> as in all the examples. It is very important to read my
<a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html">tutorial to get started with the Nitrokey HSM first</a> as that explains a lot
of concepts and usage. The guide was tested on both Arch Linux and Ubuntu 16.04,
both with the available latest version of Apache 2.4.</p>

<p>The default <code>mod_ssl</code> of Apache has no support for the PKCS#11 protocol. PKCS#11
is the protocol HSM&#39;s use to communicate their crypto operations. Instead of the
software using the private keyfiles directly themselves, they ask the HSM things
like &quot;hey, here&#39;s some data, sign/encrypt that please with key X&quot;, which then
the HSM does that and returns the result of the requested action.</p>

<p><code>mod_ssl</code> <a href="https://httpd.apache.org/docs/current/mod/mod_ssl.html#sslcryptodevice">does support</a> the <code>SSLCryptoDevice</code>, but the documentation states
that it only <code>enables use of a cryptographic hardware accelerator board to
offload some of the SSL processing overhead</code>. The Nitrokey HSM uses the
<a href="https://github.com/OpenSC/OpenSC/">OpenSC</a> projects code, and they do have a <a href="https://github.com/OpenSC/libp11">openssl engine wrapper</a> but
I could not find any documentation and small tests resulted in nothing.</p>

<p><code>mod_nss</code> however does support PKCS#11. The website of <a href="https://fedorahosted.org/mod_nss/">mod_nss</a> tells us
that it <code>is an SSL provider derived from the mod_ssl module for the Apache web
server that uses the Network Security Services (NSS) libraries. For the most
part there is a 1-1 mapping between the capabilities of mod_nss and mod_ssl.</code></p>

<p>The management of <code>mod_nss</code> is different from the usual with <code>mod_ssl</code>. You need
to use the <code>nss</code> tools like <code>certutil</code> and <code>modutil</code> for certificate management,
no more simple files.</p>

<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Certificate_System/8.0/html/Admin_Guide/Managing_the_Certificate_Database.html">This is a</a> good guide on <code>certutil</code> and <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Reference/NSS_tools_:_certutil">here</a> is more documentation on
<code>certutil</code>. The <code>man</code> page also helps. Here is a <a href="http://firstyear.id.au/blog/html/2014/07/10/NSS-OpenSSL_Command_How_to:_The_complete_list..html">list with copy paste</a>
actions for the NSS suite.</p>

<h3 id="toc_1">mod_nss installation</h3>

<p>In Ubuntu you can install the <code>mod_nss</code> Apache module with the following
command:</p>

<pre><code>apt-get install libapache2-mod-nss apache2 libpkcs11-helper1 libengine-pkcs11-openssl libnss3-tools opensc-pkcs11
</code></pre>

<p>You enable the module with the following command:</p>

<pre><code>a2enmod nss
</code></pre>

<p>Disable <code>mod_ssl</code> with the folllowing command:</p>

<pre><code>a2dismod ssl
</code></pre>

<p>On other Linux distro&#39;s you might need to manually change config files. On my
Arch installation I had to add the following to <code>/etc/http/conf/http.conf</code>:</p>

<pre><code>Include conf/extra/nss.conf
</code></pre>

<p>I also had to install <code>mod_nss</code> from the <a href="https://aur.archlinux.org/packages/mod_nss/">AUR</a>:</p>

<pre><code>pacaur -Sy mod_nss
</code></pre>

<h3 id="toc_2">NSS and Certutil config</h3>

<p>NSS requires a certificate database. We also need to tell NSS to load the
<code>pkcs11</code> module.</p>

<p>Create the database folder:</p>

<pre><code>mkdir -p /etc/nss/db/
</code></pre>

<p>Create a new NSS database:</p>

<pre><code>certutil -N -d /etc/nss/db/
</code></pre>

<p>It will ask you for a password. Enter a secure one, or, when testing, just pres
RETURN twice. Output:</p>

<pre><code>Enter a password which will be used to encrypt your keys.
The password should be at least 8 characters long,
and should contain at least one non-alphabetic character.

Enter new password: 
Re-enter password: 
</code></pre>

<p>Add the HSM module to NSS:</p>

<pre><code>modutil -add pkcs11 -libfile /usr/lib/opensc-pkcs11.so -dbdir /etc/nss/db/
</code></pre>

<p>On Ubuntu the file is located here:</p>

<pre><code>/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so
</code></pre>

<p>Output:</p>

<pre><code>WARNING: Performing this operation while the browser is running could cause
corruption of your security databases. If the browser is currently running,
you should exit browser before continuing this operation. Type 
&#39;q &lt;enter&gt;&#39; to abort, or &lt;enter&gt; to continue: 

Module &quot;pkcs11&quot; added to database.
</code></pre>

<p>Enable the <code>pkcs11</code> module:</p>

<pre><code>modutil -enable pkcs11 -dbdir /etc/nss/db/
</code></pre>

<p>Output:</p>

<pre><code>WARNING: Performing this operation while the browser is running could cause
corruption of your security databases. If the browser is currently running,
you should exit browser before continuing this operation. Type 
&#39;q &lt;enter&gt;&#39; to abort, or &lt;enter&gt; to continue: 

Slot &quot;Virtual hotplug slot&quot; enabled.
Slot &quot;Nitrokey Nitrokey HSM (010000000000000000000000) 00 00&quot; enabled.
</code></pre>

<h3 id="toc_3">HSM Key generation and NSS usage</h3>

<p><img src="https://raymii.org/s/inc/img/hsm-icon.png" alt=""></p>

<p>Generate a 2048 bit RSA key in the HSM:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --keypairgen --key-type rsa:2048 --id 1 --label &quot;httpd hsm&quot;
</code></pre>

<p>Generate a new certificate with that key. This one is self signed. See <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html#Using_the_keys">my
tutorial on the Nitrokey if you want to generate a CSR and what to put in</a>
<code>hsm.conf</code>:</p>

<pre><code>OPENSSL_CONF=./hsm.conf openssl req -engine pkcs11 -keyform engine -new -key 1:1 -nodes -days 3560 -x509 -sha256 -out &quot;rsahsm.tst.raymii.org.pem&quot; -subj &quot;/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=rsahsm.tst.raymii.org&quot;
</code></pre>

<p>Do note that you can also generate a CSR and submit that to your certificate
provider.</p>

<p>Convert the PEM certificate into DER format, since DER is what the HSM uses:</p>

<pre><code>openssl x509 -in rsahsm.tst.raymii.org.pem -out rsahsm.tst.raymii.org.der -outform der
</code></pre>

<p>Load the DER certificate into the HSM together with the key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --write-object rsahsm.tst.raymii.org.der --type cert --id 1 --label &#39;httpdcert&#39;
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x1)
Created certificate:
Certificate Object, type = X.509 cert
  label:      httpdcert
  ID:         01
</code></pre>

<p>Find out the correct names for the HSM. The tooling is very picky about naming,
it took me quite a while to figure it out:</p>

<pre><code>modutil -dbdir /etc/nss/db/ -list pkcs11
</code></pre>

<p>We&#39;re looking for the <code>Token Name</code>. Example Output:</p>

<pre><code>-----------------------------------------------------------
Name: pkcs11
Library file: /usr/lib/opensc-pkcs11.so
Manufacturer: OpenSC (www.opensc-project.org) 
Description: Smart card PKCS#11 API          
PKCS #11 Version 2.20
Library Version: 0.0
Cipher Enable Flags: None
Default Mechanism Flags: None

Slot: Nitrokey Nitrokey HSM (010000000000000000000000) 00 00
Slot Mechanism Flags: None
Manufacturer: OpenSC (www.opensc-project.org) 
Type: Hardware
Version Number: 0.0
Firmware Version: 0.0
Status: Enabled
Token Name: SmartCard-HSM (UserPIN)         
Token Manufacturer: www.CardContact.de              
Token Model: PKCS#15 emulated
Token Serial Number: DENK0100186     
Token Version: 24.13
Token Firmware Version: 2.0
Access: NOT Write Protected
Login Type: Login required
User Pin: Initialized
</code></pre>

<p>In this case the <code>Token name</code> is: <code>SmartCard-HSM (UserPIN)</code>. Now we want to know
the exact certificate name. Find that using the following command:</p>

<pre><code>certutil -d /etc/nss/db -h &#39;SmartCard-HSM (UserPIN)&#39; -L 
</code></pre>

<p>(<code>-L</code> is list all certificates. <code>-h</code> indicats the specific token we want to
use.)</p>

<pre><code>Certificate Nickname    Trust Attributes
                        SSL,S/MIME,JAR/XPI

Enter Password or Pin for &quot;SmartCard-HSM (UserPIN)&quot;: 648219
SmartCard-HSM (UserPIN):httpdcert                          u,u,u
</code></pre>

<p>In this case the name of the certificate is: <code>SmartCard-HSM
(UserPIN):httpdcert</code>.</p>

<p>View the PEM certificate:</p>

<pre><code>certutil -d /etc/nss/db -h &#39;SmartCard-HSM (UserPIN)&#39; -L -n &quot;SmartCard-HSM (UserPIN):httpdcert&quot; -a
</code></pre>

<p>(<code>-n</code> names the specific certificate we want to list/show. <code>-a</code> enables ASCII
output.)</p>

<p>Output:</p>

<pre><code>Enter Password or Pin for &quot;SmartCard-HSM (UserPIN)&quot;: 648219
-----BEGIN CERTIFICATE-----
MIIDcjCCAloCCQCxS7T+z2D3ADANBgkqhkiG9w0BAQsFADB7MQswCQYDVQQGEwJO
TDEVMBMGA1UECAwMWnVpZCBIb2xsYW5kMRIwEAYDVQQHDAlSb3R0ZXJkYW0xGjAY
BgNVBAoMEVNwYXJrbGluZyBOZXR3b3JrMRAwDgYDVQQLDAdJVCBEZXB0MRMwEQYD
[...]
-----END CERTIFICATE-----
</code></pre>

<p>(<code>-n</code> names a specific certificate.)</p>

<p>If you omit the <code>-a</code> option you will get the regular text output:</p>

<pre><code>certutil -d /etc/nss/db -h &#39;SmartCard-HSM (UserPIN)&#39; -L -n &quot;SmartCard-HSM (UserPIN):httpdcert&quot; 
</code></pre>

<p>Output:</p>

<pre><code>Enter Password or Pin for &quot;SmartCard-HSM (UserPIN)&quot;: 648219
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
            00:b1:4b:b4:fe:cf:60:f7:00
        Signature Algorithm: PKCS #1 SHA-256 With RSA Encryption
        Issuer: &quot;CN=rsahsm.tst.raymii.org,OU=IT Dept,O=Sparkling Network,L=Rotterdam,ST=
            Zuid Holland,C=NL&quot;
        Validity:
            Not Before: Mon Jun 20 17:13:55 2016
            Not After : Fri Mar 20 17:13:55 2026
        Subject: &quot;CN=rsahsm.tst.raymii.org,OU=IT Dept,O=Sparkling Network,L=Rotterdam,ST=Zuid Holland,C=NL&quot;
[...]
</code></pre>

<p>Check the certificate chain with <code>certutil</code>:</p>

<pre><code>certutil -d /etc/nss/db -h SmartCard-HSM -O -n &quot;SmartCard-HSM (UserPIN):httpdcert&quot;
</code></pre>

<p>(<code>-O</code> prints the certificate chain.)</p>

<p>Example Output:</p>

<pre><code>Enter Password or Pin for &quot;SmartCard-HSM (UserPIN)&quot;: 648219
&quot;SmartCard-HSM (UserPIN):httpdcert&quot; [CN=rsahsm.tst.raymii.org,OU=IT Dept,O=Sparkling Network,L=Rotterdam,ST=Zuid Holland,C=NL]
</code></pre>

<p>If you use a self-signed certificate it will be just one line. If you have an
official certificate it will show the full chain:</p>

<pre><code>&quot;COMODORSAAddTrustCA&quot; [CN=COMODO RSA Certification Authority,O=COMODO CA Limited,L=Salford,ST=Greater Manchester,C=GB]

  &quot;COMODORSADomainValidationSecureServerCA&quot; [CN=COMODO RSA Domain Validation Secure Server CA,O=COMODO CA Limited,L=Salford,ST=Greater Manchester,C=GB]

    &quot;SmartCard-HSM (UserPIN):webrsa2048&quot; [CN=rsa2048hsm.tst.raymii.org,OU=PositiveSSL,OU=Domain Control Validated]
</code></pre>

<p>If it doesn&#39;t show the full chain you might need to import root certificates in
the NSS database.</p>

<h3 id="toc_4">Import Root CA Chains</h3>

<p>To make sure the correct certificate chain is sent we need to import root
certificates in our NSS database. If you use a self signed certificate then you
won&#39;t need to do this, but if you use an actual signed certificate by a CA you
need to do this.</p>

<p>The <a href="https://curl.haxx.se/docs/caextract.html">curl project</a> has a good Root CA Chain. Download it:</p>

<pre><code>mkdir ssl
cd ssl
wget https://curl.haxx.se/ca/cacert.pem
</code></pre>

<p>We need to remove all the comments from the file and just keep the chains. Use
the following command to do so:</p>

<pre><code>sed -n &#39;/-----BEGIN/,/-----END/p&#39; cacert.pem &gt; chains.pem
</code></pre>

<p>Now split the file into all seperate files:</p>

<pre><code>csplit -f cert- chains.pem &#39;/-----BEGIN CERTIFICATE-----/&#39; &#39;{*}&#39;
</code></pre>

<p>That creates a lot of files named <code>cert-###</code>.</p>

<p>Import the seperate chains with <code>certutil</code>:</p>

<pre><code>for file in ./cert-*; do 
  echo $file; 
  certutil -d /etc/nss/db -A -n &quot;${file}&quot; -t &quot;CT,,&quot; -a -i ./${file};
  sleep 1 
done
</code></pre>

<p>The <code>-t &quot;CT,,&quot;</code> flags make sure the certificates are trusted. (<code>+ T - Trusted CA
to issue client certificates, C - Trusted CA to issue server certificates</code>). The
<code>-A</code> flag adds an existing certificate to the DB. The sleep is added to make
sure everything is imported and the HSM is not overloaded.</p>

<p>If you just need to import one (PEM) certificate use the following command, this
example is for the <code>Addtrust External Root CA</code>:</p>

<pre><code>certutil -d /etc/nss/db -A -n &#39;ADDTUST&#39; -t &quot;CT,,&quot; -a -i addtrust.pem 
</code></pre>

<h3 id="toc_5">Apache2 and mod_nss config</h3>

<p>Place the PIN for the slot in this file:</p>

<pre><code>cat /etc/nss/db/pin.txt
SmartCard-HSM (UserPIN):648219
</code></pre>

<p>The format is: <code>tokenname:pin</code>.</p>

<p>Also make sure to give the correct permissions to the NSS db:</p>

<pre><code>chown -R http:root /etc/nss/db/
</code></pre>

<p>If <code>http</code> is not your apache user, change it to the correct username. Otherwise
your apache error log will fill up with errors like:</p>

<pre><code>[:error] [pid 4873:tid 139841160738688] NSS_Initialize failed. Certificate database: /etc/nss/db.
[:error] [pid 4873:tid 139841160738688] SSL Library Error: -8038 SEC_ERROR_NOT_INITIALIZED
</code></pre>

<p>Make sure you have disabled <code>mod_ssl</code> in the Apache configuration and have
enabled <code>mod_nss</code>. This is my <code>nss.conf</code> file:</p>

<pre><code># grep -v -e &quot;#&quot; -e &#39;^$&#39; /etc/httpd/conf/extra/nss.conf
LoadModule nss_module modules/libmodnss.so
Listen 8443
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl
NSSPassPhraseDialog file:/etc/nss/db/pin.txt
NSSPassPhraseHelper /usr/bin/nss_pcache
NSSEnforceValidCerts off
NSSSessionCacheTimeout 100
NSSSession3CacheTimeout 86400
NSSRandomSeed startup builtin
NSSRenegotiation off
NSSRequireSafeNegotiation off
&lt;VirtualHost _default_:8443&gt;
  DocumentRoot &quot;/etc/httpd/htdocs&quot;
  ServerName rsahsm.tst.raymii.org:8443
  ErrorLog /etc/httpd/logs/error_log
  TransferLog /etc/httpd/logs/access_log
  LogLevel info
  NSSEngine on
  NSSCipherSuite ALL
  NSSProtocol TLSv1.0,TLSv1.1,TLSv1.2
  NSSNickname &quot;SmartCard-HSM (UserPIN):httpdcert&quot;
  NSSCertificateDatabase /etc/nss/db
  &lt;Files ~ &quot;\.(cgi|shtml|phtml|php3?)$&quot;&gt;
      NSSOptions +StdEnvVars
  &lt;/Files&gt;
  &lt;Directory &quot;/var/www/cgi-bin&quot;&gt;
      NSSOptions +StdEnvVars
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;  
</code></pre>

<p>On Arch I had to comment out <code>NSSSessionCacheSize</code> and replace
<code>NSSPassPhraseHelper /usr/libexec/nss_pcache</code> with <code>NSSPassPhraseHelper
/usr/bin/nss_pcache</code>. For the testing certificate I also had to add
<code>NSSEnforceValidCerts off</code>. The rest is just the example config.</p>

<p>Make sure the certificate name is correct here:</p>

<pre><code>NSSNickname &quot;SmartCard-HSM (UserPIN):httpdcert&quot;
</code></pre>

<p>A manual test shows that it works:</p>

<pre><code>curl -kI https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>HTTP/1.1 200 OK
Date: Mon, 20 Jun 2016 19:06:03 GMT
Server: Apache/2.4.20 (Unix) mod_nss/2.4.20 NSS/3.23 Basic ECC
Last-Modified: Mon, 20 Jun 2016 19:05:33 GMT
ETag: &quot;f-535ba6383fe65&quot;
Accept-Ranges: bytes
Content-Length: 15
Content-Type: text/html
</code></pre>

<p>OpenSSL also agrees:</p>

<pre><code>echo | openssl s_client  -servername raymii.org -connect 127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>CONNECTED(00000003)
depth=0 C = NL, ST = Zuid Holland, L = Rotterdam, O = Sparkling Network, OU = IT Dept, CN = raymii.org
verify error:num=18:self signed certificate
verify return:1
depth=0 C = NL, ST = Zuid Holland, L = Rotterdam, O = Sparkling Network, OU = IT Dept, CN = raymii.org
verify return:1
---
Certificate chain
 0 s:/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=raymii.org
   i:/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=raymii.org
---
</code></pre>

<p>And below is a screenshot of a signed certificate from Comodo (via
<a href="https://xolphin.nl">Xolphin</a>), with the private key on the HSM:</p>

<p><img src="https://raymii.org/s/inc/img/hsm_httpd.png" alt=""></p>

<p>Just to show that it will work with all major browsers. No trust issues or
exceptions here.</p>

<p>Here&#39;s the command line to show that the chain is also included:</p>

<pre><code>echo | openssl s_client  -servername raymii.org -connect rsa2048hsm.tst.raymii.org:8443
</code></pre>

<p>Output:</p>

<pre><code>CONNECTED(00000003)
depth=2 C = GB, ST = Greater Manchester, L = Salford, O = COMODO CA Limited, CN = COMODO RSA Certification Authority
verify return:1
depth=1 C = GB, ST = Greater Manchester, L = Salford, O = COMODO CA Limited, CN = COMODO RSA Domain Validation Secure Server CA
verify return:1
depth=0 OU = Domain Control Validated, OU = PositiveSSL, CN = rsa2048hsm.tst.raymii.org
verify return:1
---
Certificate chain
 0 s:/OU=Domain Control Validated/OU=PositiveSSL/CN=rsa2048hsm.tst.raymii.org
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
 1 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
 2 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
---
</code></pre>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10
credit). (referral link)</a></p>

<h3 id="toc_6">Benchmarking 2048 bit RSA</h3>

<p>The Nitrokey HSM is not a fast HSM. I&#39;ve worked with HSM&#39;s that are capable of
multiple hundreds of signs per second, and this HSM is not one that can do that.
But, as we know, that&#39;s not the intended target for the device. It&#39;s meant for
safe and secure key storage, for example to encrypt files or protect SSH or
S/MIME keys. I did a few <code>siege</code> benchmarks, and as you can see it is quite
slow.</p>

<p>The page that was being loaded is a plain text file containing only the text
<code>Jeej it works!</code>.</p>

<p>A siege test with 5 concurrent users, 30 seconds:</p>

<pre><code>siege -c5 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>** SIEGE 4.0.1
** Preparing 5 concurrent users for battle.
The server is now under siege...

HTTP/1.1 200     2.95 secs:      15 bytes ==&gt; GET  /
HTTP/1.1 200     5.73 secs:      15 bytes ==&gt; GET  /
[...]

Lifting the server siege...
Transactions:             35 hits
Availability:             100.00 %
Elapsed time:             29.39 secs
Data transferred:         0.00 MB
Response time:            1.95 secs
Transaction rate:         1.19 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              2.32
Successful transactions:  35
Failed transactions:      0
Longest transaction:      4.76
Shortest transaction:     0.74
</code></pre>

<p>That&#39;s quite reasonable.</p>

<p>A siege test with 10 concurrent users, 30 seconds:</p>

<pre><code>siege -c10 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             39 hits
Availability:             100.00 %
Elapsed time:             29.54 secs
Data transferred:         0.00 MB
Response time:            4.64 secs
Transaction rate:         1.32 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              6.13
Successful transactions:  39
Failed transactions:      0
Longest transaction:      17.85
Shortest transaction:     0.75
</code></pre>

<p>It starts taking longer.</p>

<p>Comparing the above siege to a test against <code>raymii.org</code>, with all the assets
and such loaded:</p>

<pre><code>siege -c10 -d5 -t30S https://raymii.org/s/
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             258 hits
Availability:             100.00 %
Elapsed time:             29.15 secs
Data transferred:         4.42 MB
Response time:            0.73 secs
Transaction rate:         8.85 trans/sec
Throughput:               0.15 MB/sec
Concurrency:              6.45
Successful transactions:  258
Failed transactions:      0
Longest transaction:      2.25
Shortest transaction:     0.18
</code></pre>

<p>At 20 connections failures start to occur:</p>

<pre><code>siege -c20 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>[...]
[error] Failed to make an SSL connection: 5
HTTP/1.1 200     3.48 secs:      15 bytes ==&gt; GET  /
[error] Failed to make an SSL connection: 5

Transactions:             26 hits
Availability:             72.22 %
Elapsed time:             29.65 secs
Data transferred:         0.00 MB
Response time:            8.85 secs
Transaction rate:         0.88 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              7.76
Successful transactions:  26
Failed transactions:      10
Longest transaction:      19.97
Shortest transaction:     0.00
</code></pre>

<p>And at 60 concurrent connections in benchmark mode most fail:</p>

<pre><code>  siege -c60 -b -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             17 hits
Availability:             48.57 %
Elapsed time:             29.04 secs
Data transferred:         0.00 MB
Response time:            11.28 secs
Transaction rate:         0.59 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              6.60
Successful transactions:  17
Failed transactions:      18
Longest transaction:      20.67
Shortest transaction:     0.00
</code></pre>

<p>Comparing it to <code>raymii.org</code>:</p>

<pre><code>  siege -c60 -b -t30S https://raymii.org/s/
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             539 hits
Availability:             100.00 %
Elapsed time:             29.80 secs
Data transferred:         7.46 MB
Response time:            3.12 secs
Transaction rate:         18.09 trans/sec
Throughput:               0.25 MB/sec
Concurrency:              56.36
Successful transactions:  539
Failed transactions:      0
Longest transaction:      4.87
Shortest transaction:     0.27
</code></pre>

<p>As you can see, the HSM and <code>mod_nss</code> isn&#39;t that fast, but it is very secure.
The 1 second request overhead comes from the fact that every HTTP request
requires HSM access.</p>

<h3 id="toc_7">Benchmarking EC keys</h3>

<p>Let&#39;s try it with an EC key to see if that makes any difference. Generate an EC
key in the HSM, using a different ID:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login -pin 648219 --keypairgen --key-type EC:prime256v1 --id 3 --label &quot;web ecc&quot;
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x1)
Logging in to &quot;SmartCard-HSM (UserPIN)&quot;.
Key pair generated:
Private Key Object; EC
  label:      web ecc
  ID:         03
  Usage:      sign, derive
Public Key Object; EC  EC_POINT 256 bits
  EC_POINT:   044104a898bc5e554f28adc3a89df89dd074a1b169e220f1c8050498925aa056f22d69fb63fed3a7cb287b7e2db259762142ca503a3a31b8c53d75944eeb49751ffa1f
  EC_PARAMS:  06082a8648ce3d030107
  label:      web ecc
  ID:         03
  Usage:      verify
</code></pre>

<p>Generate a self signed certificate from it. See above to find out what to put in
the <code>hsm.conf</code> file. Do note that <code>id 3</code> is used:</p>

<pre><code>OPENSSL_CONF=./hsm.conf openssl req -engine pkcs11 -keyform engine -new -key 1:3 -nodes -days 3560 -x509 -sha256 -out &quot;echsm.tst.raymii.org.ec.pem&quot; -subj &quot;/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=echsm.tst.raymii.org&quot;
</code></pre>

<p>Convert the PEM file into DER, since the HSM needs a DER file:</p>

<pre><code>openssl x509 -in echsm.tst.raymii.org.pem -out echsm.tst.raymii.org.der -outform der
</code></pre>

<p>Load the DER certificate into the HSM together with the key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --write-object echsm.tst.raymii.org.der --type cert --id 3 --label &#39;webec&#39;
</code></pre>

<p>I gave the certificate object a different label. If we don&#39;t do that then
<code>certutil</code> can&#39;t differentiate between them.</p>

<p>There should be two certificates now:</p>

<pre><code>certutil -d /etc/nss/db -h &#39;SmartCard-HSM (UserPIN)&#39; -L
</code></pre>

<p>Output:</p>

<pre><code>Certificate Nickname      Trust Attributes
                          SSL,S/MIME,JAR/XPI

Enter Password or Pin for &quot;SmartCard-HSM (UserPIN)&quot;: 648219
SmartCard-HSM (UserPIN):httpdcert         u,u,u
SmartCard-HSM (UserPIN):webec             u,u,u
</code></pre>

<p>In the Apache configuration, change the name of the certificate from:</p>

<pre><code>NSSNickname &quot;SmartCard-HSM (UserPIN):httpdcert&quot;
</code></pre>

<p>To:</p>

<pre><code>NSSNickname &quot;SmartCard-HSM (UserPIN):webec&quot;
</code></pre>

<p>Also change the Ciphersuite to allow ECC ciphers:</p>

<pre><code>NSSCipherSuite +aes_128_sha_256,+aes_256_sha_256,+ecdhe_ecdsa_aes_128_gcm_sha_256,+ecdhe_ecdsa_aes_128_sha,+ecdhe_ecdsa_aes_256_gcm_sha_384,+ecdhe_ecdsa_aes_256_sha,+ecdhe_rsa_aes_128_gcm_sha_256,+ecdhe_rsa_aes_128_sha,+ecdhe_rsa_aes_256_gcm_sha_384,+ecdhe_rsa_aes_256_sha,+rsa_aes_128_gcm_sha_256,+rsa_aes_128_sha,+rsa_aes_256_gcm_sha_384,+rsa_aes_256_sha
</code></pre>

<p>Restart the webserver and you should be good to go. Except for, in my case, when
connecting it fails and this is in the <code>error_log</code>:</p>

<pre><code>[:info] [pid 25561:tid 140498883753856] Using nickname SmartCard-HSM (UserPIN):webec.
[:info] [pid 25561:tid 140498711348992] Connection to child 64 established (server echsm.tst.raymii.org:8443, client 127.0.0.1)
[:info] [pid 25561:tid 140498711348992] SSL input filter read failed.
[:error] [pid 25561:tid 140498711348992] SSL Library Error: -12192 Peer reports failure of signature verification or key exchange
</code></pre>

<p>Playing around with different settings, ciphersuites and protocols didn&#39;t help.
Time for a bugreport.</p>

<h3 id="toc_8">Benchmarking a 1024 bit RSA key</h3>

<p>A <a href="http://www.cardcontact.de/products/SmartCard-HSM_V1.1.pdf">product folder</a> mentions that the HSM should be a bit faster with smaller
keys. Now do note that it&#39;s not recommended to use a 1024 bit key in production.
But, this is just a benchmark test.</p>

<p>Generate the key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --keypairgen --key-type rsa:1024 --id 4 --label &quot;httpd hsm&quot;
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x1)
Please enter User PIN: 
Key pair generated:
Private Key Object; RSA 
  label:      httpd hsm
  ID:         04
  Usage:      decrypt, sign, unwrap
Public Key Object; RSA 1024 bits
  label:      httpd hsm
  ID:         04
  Usage:      encrypt, verify, wrap
</code></pre>

<p>Generate a certificate. See above to find out what to put in the <code>hsm.conf</code>
file. Do note that <code>id 4</code> is used:</p>

<pre><code>OPENSSL_CONF=./hsm.conf openssl req -engine pkcs11 -keyform engine -new -key 1:4 -nodes -days 3560 -x509 -sha256 -out &quot;rsa1024hsm.tst.raymii.org.pem&quot; -subj &quot;/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=rsa1024hsm.tst.raymii.org&quot;
</code></pre>

<p>Convert the certificate to DER:</p>

<pre><code>openssl x509 -in rsa1024hsm.tst.raymii.org.pem -out rsa1024hsm.tst.raymii.org.der -outform der
</code></pre>

<p>Load the DER certificate into the HSM together with the key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --write-object rsa1024hsm.tst.raymii.org.der --type cert --id 4 --label &#39;webrsa1024&#39;
</code></pre>

<p>I gave the certificate object a different label. If we don&#39;t do that then
<code>certutil</code> can&#39;t differentiate between them.</p>

<p>There should be three certificates now:</p>

<pre><code>certutil -d /etc/nss/db -h &#39;SmartCard-HSM (UserPIN)&#39; -L
</code></pre>

<p>Output:</p>

<pre><code>Certificate Nickname    Trust Attributes
                        SSL,S/MIME,JAR/XPI

Enter Password or Pin for &quot;SmartCard-HSM (UserPIN)&quot;:
SmartCard-HSM (UserPIN):httpdcert        u,u,u
SmartCard-HSM (UserPIN):webrsa1024       u,u,u
SmartCard-HSM (UserPIN):webec            u,u,u
</code></pre>

<p>In the Apache configuration, change the name of the certificate from:</p>

<pre><code>NSSNickname &quot;SmartCard-HSM (UserPIN):httpdcert&quot;
</code></pre>

<p>To:</p>

<pre><code>NSSNickname &quot;SmartCard-HSM (UserPIN):webrsa1024&quot;
</code></pre>

<p>Restart the server and you&#39;re good to go. No errors this time. Lets see how the
benchmarks compare.</p>

<p>5 concurrent users:</p>

<pre><code>siege -c5 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             51 hits
Availability:             100.00 %
Elapsed time:             29.74 secs
Data transferred:         0.00 MB
Response time:            0.54 secs
Transaction rate:         1.71 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              0.93
Successful transactions:  51
Failed transactions:      0
Longest transaction:      4.24
Shortest transaction:     0.23
</code></pre>

<p>Response time is a lot faster.</p>

<p>10 concurrent users:</p>

<pre><code>siege -c10 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             103 hits
Availability:             100.00 %
Elapsed time:             29.91 secs
Data transferred:         0.00 MB
Response time:            0.60 secs
Transaction rate:         3.44 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              2.05
Successful transactions:  103
Failed transactions:      0
Longest transaction:      2.83
Shortest transaction:     0.23
</code></pre>

<p>Faster, and holds up pretty well.</p>

<p>20 concurrent users:</p>

<pre><code>siege -c20 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             124 hits
Availability:             100.00 %
Elapsed time:             29.03 secs
Data transferred:         0.00 MB
Response time:            2.47 secs
Transaction rate:         4.27 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              10.54
Successful transactions:  124
Failed transactions:      0
Longest transaction:      7.53
Shortest transaction:     0.23
</code></pre>

<p>No failed connections as we saw with the 2048 bit key, but the response time is
higher.</p>

<p>60 benchmark mode:</p>

<pre><code>siege -c60 -b -t30S https://127.0.0.1:8443
</code></pre>

<p>Output:</p>

<pre><code>Transactions:             75 hits
Availability:             74.26 %
Elapsed time:             29.54 secs
Data transferred:         0.00 MB
Response time:            6.13 secs
Transaction rate:         2.54 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              15.57
Successful transactions:  75
Failed transactions:      26
Longest transaction:      20.54
Shortest transaction:     0.25
</code></pre>

<p>And as expected that results in failed connections. But, with a 2048 bit key we
had 48% Availability, now we have 74%.</p>

<p>As we can see the HSM is faster with a smaller keysize, which is not a strange
thing. I&#39;m sad that the EC keys didn&#39;t work, since EC is a lot less CPU
intensive.</p>

<h3 id="toc_9">Clustering</h3>

<p>If you have multiple HSM&#39;s you can use a tool like <code>haproxy</code> in TCP mode to load
balance connections. Using the HSM&#39;s DKEK backup and restore functionality you
can have the same private key on multiple devices. I only have one HSM, but my
guess is that with more HSM&#39;s the speed increase will be noticable.</p>
Tags: <a href="../tags/apache.html">apache</a>
, <a href="../tags/articles.html">articles</a>
, <a href="../tags/cryptoki.html">cryptoki</a>
, <a href="../tags/hsm.html">hsm</a>
, <a href="../tags/mod_nss.html">mod_nss</a>
, <a href="../tags/nitrokey.html">nitrokey</a>
, <a href="../tags/nitrokey-hsm.html">nitrokey-hsm</a>
, <a href="../tags/openssl.html">openssl</a>
, <a href="../tags/pkcs11.html">pkcs11</a>
, <a href="../tags/safenet.html">safenet</a>
, <a href="../tags/smartcard.html">smartcard</a>
, <a href="../tags/smartcard-hsm.html">smartcard-hsm</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    