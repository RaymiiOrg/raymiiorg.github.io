
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>HTTP Public Key Pinning Extension HPKP for Apache, NGINX and Lighttpd - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>HTTP Public Key Pinning Extension HPKP for Apache, NGINX and Lighttpd</h2>
<p><small>Published: 30-12-2014 | Author: Remy van Elst | <a href="HTTP_Public_Key_Pinning_Extension_HPKP.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7993642564731324"
                             crossorigin="anonymous"></script>
                        <!-- voorartikel -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-7993642564731324"
                             data-ad-slot="6172324376"
                             data-ad-format="auto"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        </div><br><div class='olderthanayear'><p><strong>&#10071; This post is over eight years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">HTTP Public Key Pinning Extension</a>
</li>
<li>
<a href="#toc_1">SPKI Fingerprint - Theory</a>
</li>
<li>
<a href="#toc_2">Where to Pin</a>
</li>
<li>
<a href="#toc_3">SPKI Fingerprint</a>
</li>
<li>
<a href="#toc_4">Bugs</a>
</li>
<li>
<a href="#toc_5">Webserver configuration</a>
<ul>
<li>
<a href="#toc_6">Apache</a>
</li>
<li>
<a href="#toc_7">Lighttpd</a>
</li>
<li>
<a href="#toc_8">NGINX</a>
</li>
</ul>
</li>
<li>
<a href="#toc_9">Reporting</a>
</li>
<li>
<a href="#toc_10">No Enforcment, report only</a>
</li>
</ul>

</div><hr><div id="contents">
<p><strong>Update 2018-06-12</strong></p>

<p>Chrome 68 has deprecated HPKP. <a href="https://raymii.org/s/blog/Chrome_68_is_deprecating_HPKP.html">Read more about it on my article</a></p>

<p>Public Key Pinning means that a certificate chain must include a whitelisted
public key. It ensures only whitelisted Certificate Authorities (CA) can sign
certificates for <code>*.example.com</code>, and not any CA in your browser store. This
article has background theory and configuration examples for Apache, Lighttpd
and NGINX.</p>

<p class="ad"> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<h3 id="toc_0">HTTP Public Key Pinning Extension</h3>

<p>An example might be your bank, which always have their certificate from CA
Company A. With the current certificate system, CA Company B, CA Company C and
the NSA CA can all create a certificate for your bank, which your browser will
hapily accept because those companies are also trusted root CA&#39;s.</p>

<p>If the bank implements HPKP and pin&#39;s their first intermidiate certificate (from
CA Company A), browsers will not accept certificates from CA Company B and CA
Company C, even if they have a valid trust path. HPKP also allows your browser
to report back the failure to the bank, so that they know they are under attack.</p>

<p>Public Key Pinning Extension for HTTP (HPKP) is a standard for public key
pinning for HTTP user agents that&#39;s been in development since 2011. It was
started by Google, which, even though it had implemented pinning in Chrome,
understood that manually maintaining a list of pinned sites can&#39;t scale.</p>

<p>Here is a quick feature overview of HPKP:</p>

<ul>
<li>HPKP is set at the HTTP level, using the <code>Public-Key-Pins</code> response header. </li>
<li>The policy retention period is set with the <code>max-age</code> parameter, it specifies duration in seconds. </li>
<li>The PKP header can only be used over an error-free secure encryption. </li>
<li>If multiple headers are seen, only the first one is processed. </li>
<li>Pinning can be extended to subdomains with the <code>includeSubDomains</code> parameter.</li>
<li>When a new PKP header is received, it overwrites previously stored pins and metadata. </li>
<li>A pin consists out of the hashing algorithm and an &quot;Subject Public Key Info&quot; fingerprint.</li>
</ul>

<p>This article first has some theory about the workings of HPKP, down below you&#39;ll
find the part which shows you how to get the required fingerprints and has web
server configuration.</p>

<h3 id="toc_1">SPKI Fingerprint - Theory</h3>

<p>As explained by Adam Langley in <a href="http://www.imperialviolet.org/2011/05/04/pinning.html">his post</a>, we hash a public key, not a
certificate:</p>

<blockquote>
<p>In general, hashing certificates is the obvious solution, but the wrong one.
The problem is that CA certificates are often reissued: there are multiple
certificates with the same public key, subject name etc but different extensions
or expiry dates. Browsers build certificates chains from a pool of certificates,
bottom up, and an alternative version of a certificate might be substituted for
the one that you expect.</p>

<p>For example, StartSSL has two root certificates: one signed with SHA1 and the
other with SHA256. If you wished to pin to StartSSL as your CA, which
certificate hash would you use? You would have to use both, but how would you
know about the other root if I hadn&#39;t just told you?</p>

<p>Conversely, public key hashes must be correct:</p>

<p>Browsers assume that the leaf certificate is fixed: it&#39;s always the starting
point of the chain. The leaf certificate contains a signature which must be a
valid signature, from its parent, for that certificate. That implies that the
public key of the parent is fixed by the leaf certificate. So, inductively, the
chain of public keys is fixed, modulo truncation.</p>

<p>The only sharp edge is that you mustn&#39;t pin to a cross-certifying root. For
example, GoDaddy&#39;s root is signed by Valicert so that older clients, which don&#39;t
recognise GoDaddy as a root, still trust those certificates. However, you
wouldn&#39;t want to pin to Valicert because newer clients will stop their chain at
GoDaddy.</p>

<p>Also, we&#39;re hashing the SubjectPublicKeyInfo not the public key bit string.
The SPKI includes the type of the public key and some parameters along with the
public key itself. This is important because just hashing the public key leaves
one open to misinterpretation attacks. Consider a Diffie-Hellman public key: if
one only hashes the public key, not the full SPKI, then an attacker can use the
same public key but make the client interpret it in a different group. Likewise
one could force an RSA key to be interpreted as a DSA key etc.</p>
</blockquote>

<h3 id="toc_2">Where to Pin</h3>

<p>Where should you pin? Pinning your own public key is not the best idea. The key
might change or get compromised. You might have multiple certificates in use.
The key might change because you rotate your certificates every so often. It
might key compromised because the web server was hacked.</p>

<p>The easiest, but not most secure place to pin is the first intermediate CA
certificate. The signature of that certificate is on your websites certificate
so the issuing CA&#39;s public key must always be in the chain.</p>

<p>This way you can renew your end certificate from the same CA and have no pinning
issues. If the CA issues a different root, then you have a problem, there is no
clear solution for this yet. There is one thing you can do to mitigate this:</p>

<ul>
<li>Always have a backup pin and a spare certificate from a different CA. </li>
</ul>

<p>The RFC states that you need to provide at least two pins. One of the pins must
be present in the chain used in the connection over which the pins were
received, the other pin <em>must not</em> be present.</p>

<p>This other pin is your backup public key. It can also be the SPKI fingerprint of
a different CA where you have a certificate issued.</p>

<p>An alternative and <strong>more secure</strong> take on this issue is to create at least
three seperate public keys beforehand (using OpenSSL, see <a href="https://raymii.org/s/software/OpenSSL_Command_Generator.html">this page</a> for a
Javascript OpenSSL command generator) and to keep two of those keys as a backup
in a safe place, offline and off-site.</p>

<p>You create the SPKI hashes for the three certificates and pin those. You only
use the first key as the active certificate. When it is needed, you can then use
one of the alternative keys. You do however need to let that certificate sign by
a CA to create a certificate pair and that process can take a few days depending
on the certificate.</p>

<p>This is not a problem for the HPKP because we take the SPKI hash of the public
key, and not of the certificate. Expiration or a different chain of CA signer do
not matter in this case.</p>

<p>If you have the means and procedures to create and securely save at least three
seperate keys as described above and pin those, it would also protect you from
your CA provider getting compromised and giving out a fake certificate for your
specific website.</p>

<h3 id="toc_3">SPKI Fingerprint</h3>

<p>To get the SPKI fingerprint from a certificate we can use the following OpenSSL command, as shown in <a href="https://tools.ietf.org/html/draft-ietf-websec-key-pinning-21#appendix-A">the RFC draft</a>: </p>

<pre><code>openssl x509 -noout -in certificate.pem -pubkey | \
openssl asn1parse -noout -inform pem -out public.key;
openssl dgst -sha256 -binary public.key | openssl enc -base64
</code></pre>

<p>Result:</p>

<pre><code>klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY=
</code></pre>

<p>The input <code>certificate.pem</code> file is the first certificate in the chain for this
website. (At the time of writing, <code>COMODO RSA Domain Validation Secure Server
CA</code>, Serial <code>2B:2E:6E:EA:D9:75:36:6C:14:8A:6E:DB:A3:7C:8C:07</code>.)</p>

<p>You need to also do this with your backup public key, ending up with two
fingerprints.</p>

<h3 id="toc_4">Bugs</h3>

<p>At the time of writing this article (2015-Jan) the only browser supporting HPKP
(Chrome) has a serious issue where Chrome doesn&#39;t treat the max-age and
includeSubdomains directives from HSTS and HPKP headers as mutually exclusive.
This means that if you have HSTS and HPKP with different policiesfor max-age or
includeSubdomains they will be interchanged. See this bug for more info:
<a href="https://code.google.com/p/chromium/issues/detail?id=444511">https://code.google.com/p/chromium/issues/detail?id=444511</a>. Thanks to Scott
Helme from <a href="https://scotthelme.co.uk">https://scotthelme.co.uk</a> for finding and notifying me and the
Chromium project about it.</p>

<h3 id="toc_5">Webserver configuration</h3>

<p>Below you&#39;ll find configuration instructions for the three most populair web
servers. Since this is just a HTTP header, almost all web servers will allow you
to set this. It needs to be set for the HTTPS website.</p>

<p>The example below pins the <code>COMODO RSA Domain Validation Secure Server CA</code> and
the <code>Comodo PositiveSSL CA 2</code> as a backup, with a 30 day expire time including
all subdomains.</p>

<h4 id="toc_6">Apache</h4>

<p>Edit your apache configuration file (<code>/etc/apache2/sites-enabled/website.conf</code>
or <code>/etc/apache2/httpd.conf</code> for example) and add the following to your
<code>VirtualHost</code>:</p>

<pre><code># Optionally load the headers module:
LoadModule headers_module modules/mod_headers.so

Header set Public-Key-Pins &quot;pin-sha256=\&quot;klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY=\&quot;; pin-sha256=\&quot;633lt352PKRXbOwf4xSEa1M517scpD3l5f79xMD9r9Q=\&quot;; max-age=2592000; includeSubDomains&quot;
</code></pre>

<h4 id="toc_7">Lighttpd</h4>

<p>The lighttpd variant is just as simple. Add it to your Lighttpd configuration
file (<code>/etc/lighttpd/lighttpd.conf</code> for example):</p>

<pre><code>server.modules += ( &quot;mod_setenv&quot; )
$HTTP[&quot;scheme&quot;] == &quot;https&quot; {
    setenv.add-response-header  = ( &quot;Public-Key-Pins&quot; =&gt; &quot;pin-sha256=\&quot;klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY=\&quot;; pin-sha256=\&quot;633lt352PKRXbOwf4xSEa1M517scpD3l5f79xMD9r9Q=\&quot;; max-age=2592000; includeSubDomains&quot;)
}
</code></pre>

<h4 id="toc_8">NGINX</h4>

<p>NGINX is even shorter with its config. Add this in the server block for your
HTTPS configuration:</p>

<pre><code>add_header Public-Key-Pins &#39;pin-sha256=&quot;klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY=&quot;; pin-sha256=&quot;633lt352PKRXbOwf4xSEa1M517scpD3l5f79xMD9r9Q=&quot;; max-age=2592000; includeSubDomains&#39;;
</code></pre>

<h3 id="toc_9">Reporting</h3>

<p>HPKP reporting allows the user-agent to report any failures back to you.</p>

<p>If you add an aditional <code>report-uri=&quot;http://example.org/hpkp-report&quot;</code> parameter
to the header and set up a listener there, clients will send reports if they
encounter a failure. A report is sent as a POST request to the <code>report-uri</code> with
a JSON body like this:</p>

<pre><code>{
    &quot;date-time&quot;: &quot;2014-12-26T11:52:10Z&quot;,
    &quot;hostname&quot;: &quot;www.example.org&quot;,
    &quot;port&quot;: 443,
    &quot;effective-expiration-date&quot;: &quot;2014-12-31T12:59:59&quot;,
    &quot;include-subdomains&quot;: true,
    &quot;served-certificate-chain&quot;: [
        &quot;-----BEGINCERTIFICATE-----\nMIIAuyg[...]tqU0CkVDNx\n-----ENDCERTIFICATE-----&quot;
    ],
    &quot;validated-certificate-chain&quot;: [
        &quot;-----BEGINCERTIFICATE-----\nEBDCCygAwIBA[...]PX4WecNx\n-----ENDCERTIFICATE-----&quot;
    ],
    &quot;known-pins&quot;: [
        &quot;pin-sha256=\&quot;dUezRu9zOECb901Md727xWltNsj0e6qzGk\&quot;&quot;,
        &quot;pin-sha256=\&quot;E9CqVKB9+xZ9INDbd+2eRQozqbQ2yXLYc\&quot;&quot;
    ]
}
</code></pre>

<h3 id="toc_10">No Enforcment, report only</h3>

<p>HPKP can be set up without enforcement, in reporting mode by using the <code>Public-
Key-Pins-Report-Only</code> response header.</p>

<p>This approach allows you to set up pinning without your site being unreachable
or HPKP being configured incorrectly. You can later move to enforcement by
changing the header back to <code>Public-Key-Pins</code>.</p>
Tags: <a href="../tags/apache.html">apache</a>
, <a href="../tags/articles.html">articles</a>
, <a href="../tags/hpkp.html">hpkp</a>
, <a href="../tags/https.html">https</a>
, <a href="../tags/lighttpd.html">lighttpd</a>
, <a href="../tags/nginx.html">nginx</a>
, <a href="../tags/security.html">security</a>
, <a href="../tags/ssl.html">ssl</a>
, <a href="../tags/tls.html">tls</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
     
    </main>
    </body>
    </html>
    