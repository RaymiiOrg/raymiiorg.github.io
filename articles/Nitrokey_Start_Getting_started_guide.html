
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Nitrokey Start: Getting started guide (gnuk openpgp token) - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Nitrokey Start: Getting started guide (gnuk openpgp token)</h2>
<p><small>Published: 14-08-2016 | Author: Remy van Elst | <a href="Nitrokey_Start_Getting_started_guide.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7993642564731324"
                             crossorigin="anonymous"></script>
                        <!-- voorartikel -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-7993642564731324"
                             data-ad-slot="6172324376"
                             data-ad-format="auto"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        </div><br><div class='olderthanayear'><p><strong>&#10071; This post is over six years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Initial setup</a>
</li>
<li>
<a href="#toc_1">Setting up a user PIN, an admin PIN and a reset code</a>
<ul>
<li>
<a href="#toc_2">Admin-less PIN</a>
</li>
<li>
<a href="#toc_3">Admin PIN reset</a>
</li>
</ul>
</li>
<li>
<a href="#toc_4">Initialize the Nitrokey</a>
</li>
<li>
<a href="#toc_5">A note on GPG keys and subkeys</a>
</li>
<li>
<a href="#toc_6">Generating the key and subkeys on the device</a>
</li>
<li>
<a href="#toc_7">Loading external keys into the device</a>
</li>
<li>
<a href="#toc_8">Overwriting (deleting) keys on the Nitrokey</a>
</li>
<li>
<a href="#toc_9">Usage examples with GPG</a>
</li>
<li>
<a href="#toc_10">Usage examples with OpenSSH</a>
</li>
<li>
<a href="#toc_11">Usage examples with Thunderbird</a>
</li>
</ul>

</div><hr><div id="contents">
<p>The Nitrokey Start is an OpenPGP USB token. It supports three 2048 bit GPG keys
and is based on <code>gnuk</code> version 1.0.4. Gnuk is an implementation of USB
cryptographic token for GPG. A cryptographic token is a store of private keys
and it computes cryptographic functions on the device. The main difference with
other GPG cards like the Nitrokey Pro, Yubikey or the OpenPGP card is that this
device does not use a smartcard. Whereas the other devices are basically USB
smartcard readers, the Nitrokey Start has everything in it&#39;s firmware. Therefore
it is a very cheap device ($29) and a great choice if you want token based GPG
security but don&#39;t want to spend much on an expensive other key.</p>

<p><img src="https://raymii.org/s/inc/img/nitrokey_family_start.png" alt=""></p>

<p>Compared with for example the Yubikey, the Nitrokey&#39;s big advantage is that both
the software (firmware) and the hardware are open source. If you want you can
buy the microcontroller, flash the firmware and print the case from the Cad
file.</p>

<p><img src="https://raymii.org/s/inc/img/nitrokey_start_pro.jpg" alt=""></p>

<blockquote>
<p>Two Nitrokey Pro&#39;s and the Nitrokey Start</p>
</blockquote>

<p>This article is a getting started guide where I talk about the initial setup of
the device, setting up a user PIN, an admin PIN and a reset code, generating the
key and subkeys on the device, or loading external keys into the device and
usage examples with GPG, OpenSSH and Thunderbird.</p>

<p>This article is largely compatible with other gnuk tokens and other OpenPGP
Smartcards like the Nitrokey Pro or the Yubikey.</p>

<p class="ad"> <a href="https://leafnode.nl">I'm developing a desktop monitoring app,  Leaf Node Monitoring, open source, but paid. For Windows, Linux & Android, go check it out.</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>Nitrokey has multiple models like the Start, Storage, Pro and HSM. I&#39;m
especially fond of the Nitrokey HSM. I&#39;ve written a <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html">getting started</a> article
for that as well. It explains what the HSM is, how to set it up and how to use
it with OpenSSH for example.</p>

<p>The build quality of the device is excellent. Sturdy and quality. It doesn&#39;t
feel like flimsy chinese crap at all, since it isn&#39;t that. Durable Germany made
quality here.</p>

<p>I have <a href="https://raymii.org/s/tags/nitrokey.html">multiple articles</a> on the Nitrokeys, so make sure to check out the
other articles as well.</p>

<h3 id="toc_0">Initial setup</h3>

<p>On Ubuntu, install the following packages:</p>

<pre><code>apt-get install opensc pcscd paperkey haveged gnupg2 gnupg-agent pinentry-curses libccid scdaemon libksba8 libpth20
</code></pre>

<p>On Arch linux, follow <a href="https://wiki.archlinux.org/index.php/GnuPG">the Wiki</a>.</p>

<p>If the software is installed, plug in the Nitrokey Start and execute the
following command:</p>

<pre><code>gpg --card-status
</code></pre>

<p>Output:</p>

<pre><code>Reader ...........: Nitrokey Nitrokey Start (FSIJ-1.0.4-52FF6E06) 00 00
Application ID ...: D276000124010200FFFE52FF6E060000
Version ..........: 2.0
Manufacturer .....: unmanaged S/N range
Serial number ....: 52FF6E06
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
</code></pre>

<p>The output above is of an uninitialized token. As you can see, it&#39;s a OpenPGP
Card version 2 compatible token. Three keys are supported, the max pin length is
listed and the PIN error counters are all at three (default value).</p>

<h3 id="toc_1">Setting up a user PIN, an admin PIN and a reset code</h3>

<p>The Nitrokey Start, actually <code>gnuk</code>, has a few different options when it comes
to PIN codes. There is the User PIN (PW1), which you use for day to day
operations like unlocking the token, signing and encrypting things. The minimum
length for the User pin is 6 characters.</p>

<p>The Admin PIN (PW3) is used for card/token administration, like loading keys
onto the device, generating keys or changing information like the owner data on
the card. The minimum length for the Admin PIN is 8 characters.</p>

<p>If you enter the wrong user PIN three times the card is blocked. It can then
only be reset with the Admin PIN or reset code. If you enter the wrong Admin pin
three times the card will become unusable.</p>

<p>Last is the reset code, this code can be used only to reset the user PIN. The
minimum length for the Reset Code is 8 characters. The reset code error counter
can be reset with the Admin PIN.</p>

<p>So what is the difference between the Admin PIN and reset code? If you receive a
card from, for example your employer, it will have data and keys filled in
(name, organization, public key url etc). Generally it will not be the case that
you are allowed to change that, so you will not know the Admin PIN. If you
entered the user PIN wrong three times, you cannot use the Admin PIN to reset
the User PIN. This is where the RESET CODE comes in. This code can only be used
to reset the User PIN (PW1).</p>

<p>If you give the wrong PIN two times and then the correct PIN, the error counter
is reset. (Both admin and user PIN.)</p>

<h4 id="toc_2">Admin-less PIN</h4>

<p><code>gnuk</code> has a special option that allows you to use the same PIN for user and
admin. This <a href="http://www.fsij.org/doc-gnuk/gnuk-passphrase-setting.html#set-up-pw1-pw3-and-reset-code">is in their documentation</a> and will be active if you set the
User PIN BEFORE the Admin PIN. They state that for day to day operations it&#39;s
more convinient, but it is also less secure.</p>

<p>Admin-less mode is incompatible with the official GnuPG card specification.</p>

<h4 id="toc_3">Admin PIN reset</h4>

<p>If you ever enter the admin PIN wrong three times in a row the device is
unusable. The above reset code can only be used to reset the User PIN. In a
normal GnuPG Smartcard you can send special reset ADPU commands to the smartcard
and make it usable again, although all the keys are wiped.</p>

<p>For a gnuk token like the Nitrokey the procedure is different. You need to store
a public key first and then later on, if the token is hosed, upgrade the
firmware. That public key you stored will be used to sign the update.</p>

<p>I&#39;m having some compile issues for the firmware and the key upload since all my
versions (gcc, libusb, python) are way to new. I&#39;ll create a seperate article
for this once I got it all figured out and working.</p>

<h3 id="toc_4">Initialize the Nitrokey</h3>

<p>We&#39;re going to set up the card for the first time. Fire up GPG and get started:</p>

<pre><code>gpg --card-edit
</code></pre>

<p>The same output as from <code>--card-status</code> but now it gives you an interactive
prompt:</p>

<pre><code>gpg/card&gt; 
</code></pre>

<p>Using the <code>help</code> command to see the available commands:</p>

<pre><code>quit           quit this menu
admin          show admin commands
help           show this help
list           list all available data
fetch          fetch the key specified in the card URL
passwd         menu to change or unblock the PIN
verify         verify the PIN and list all data
unblock        unblock the PIN using a Reset Code
</code></pre>

<p>We are going to set values, so switch to <code>admin</code> mode:</p>

<pre><code>gpg/card&gt; admin
Admin commands are allowed
</code></pre>

<p>There are a lot more commands available now:</p>

<pre><code>gpg/card&gt; help
quit           quit this menu
admin          show admin commands
help           show this help
list           list all available data
name           change card holder&#39;s name
url            change URL to retrieve key
fetch          fetch the key specified in the card URL
login          change the login name
lang           change the language preferences
sex            change card holder&#39;s sex
cafpr          change a CA fingerprint
forcesig       toggle the signature force PIN flag
generate       generate new keys
passwd         menu to change or unblock the PIN
verify         verify the PIN and list all data
unblock        unblock the PIN using a Reset Code
factory-reset  destroy all keys and data
</code></pre>

<p>The first thing you want to do is set the Admin PIN. Make sure it&#39;s only known
to you.</p>

<pre><code>gpg/card&gt; passwd
gpg: OpenPGP card no. D276000124010200FFFE52FF6E060000 detected

1 - change PIN
2 - unblock PIN
3 - change Admin PIN
4 - set the Reset Code
Q - quit

Your selection? 3
</code></pre>

<p>In my case a dialog box popped up to ask for the current Admin PIN (12345678).
Then it asks you twice for the new Admin PIN.</p>

<p>Set up a user PIN, choice <code>1 - change PIN</code>. Same thing, it will ask you for the
current user PIN (123456) and for a new PIN two times.</p>

<p>Finally set up a reset code, choice <code>4 - set the Reset Code</code>. It will ask you
for the current admin PIN, then two times for a new reset code.</p>

<p>We continue on to further personalize the card. Let it know your name:</p>

<pre><code>gpg/card&gt; name
Cardholder&#39;s surname: van Elst
Cardholder&#39;s given name: Remy
</code></pre>

<p>Your gender:</p>

<pre><code>gpg/card&gt; sex
Sex ((M)ale, (F)emale or space): F
</code></pre>

<p>Your preferred country code / language:</p>

<pre><code>gpg/card&gt; lang
Language preferences: nl
</code></pre>

<p>If you want, you can place your public key on a website and let people download
it:</p>

<pre><code>gpg/card&gt; url
URL to retrieve public key: https://raymii.org/s/inc/current_gpg.key 
</code></pre>

<p>At any point you can list the current data:</p>

<pre><code>gpg/card&gt; list

Reader ...........: Nitrokey Nitrokey Start (FSIJ-1.0.4-52FF6E06) 00 00
Application ID ...: D276000124010200FFFE52FF6E060000
Version ..........: 2.0
Manufacturer .....: unmanaged S/N range
Serial number ....: 52FF6E06
Name of cardholder: Remy van Elst
Language prefs ...: nl
Sex ..............: female
URL of public key : https://raymii.org/s/inc/current_gpg.key
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
</code></pre>

<p>When done, save and quit with the <code>quit</code> command. Next we will discuss GPG key
generation and some things to keep in mind when deciding to generate keys on the
card or load external keys.</p>

<h3 id="toc_5">A note on GPG keys and subkeys</h3>

<p>GnuPG keys can have attributes to limit their usage. You can have a key which
you can only use for signing data, and one that you can only use to encrypt
data, or one key that has both attributes.</p>

<p>GnuPG has the concept of subkeys. Subkeys just like normal keys, except that
they are bound to a master keypair. A subkey can be used for signing,
authentication or for encryption. Subkeys can be revoked independently of their
master keypair and can be stored seperately from the master keypair. Subkeys are
associated to your master keypair.</p>

<p>When generating a new keypair, GnuPG creates a keypair with the signing-only
attribute as the master key. It then generates a subkey with the encryption-only
attribute.</p>

<p>For key management it is extremely useful to be able to independently revoke a
subkeypair. Imagine that you do not use subkeys and your laptop gets stolen. You
didn&#39;t set up full-disk-encryption, because of time or effort required, and now
you&#39;re toast. The thief has your master GPG key and can, if they brute force
your passphrase, decrypt anything and impersonate you via the identity. You can
use your revocation certificate (which you hopefully saved) to revoke the
keypair, but now you need to visit all the people that signed your key to get a
new key signed.</p>

<p>If you generate your master keypair offline, for example, via a Debian Live CD
(<a href="https://tails.boum.org/">Tails</a>) and save it to a secure place (use <code>paperkey</code> to print it and place
it in a vault, next to an encrypted USB disk), you can later use the master
keypair to revoke your laptop-subkey and generate a new one. Your master key is
still safe in the safe and all the people that signed your key don&#39;t have to re-
sign your new key.</p>

<p>To sign other people&#39;s keys you do need to boot up your offline setup and use
your primary master keypair to sign other keypairs.</p>

<p>I also recommend to set an expiry date of a year or two on your master public
key. Do note that private keys never expire, only public keys do. You can extend
the date on a pubkey easily with <code>gpg --edit-key 0xKEY_ID</code> and then <code>expire</code>.</p>

<p>The <a href="https://wiki.debian.org/Subkeys">Debian Wiki</a> has a very extensive guide on GPG subkeys.</p>

<p>If you want to convert your current key to subkeys, <a href="http://www.macfreek.nl/memory/Convert_GPG_keys_to_subkeys">here</a> is a good guide.</p>

<h3 id="toc_6">Generating the key and subkeys on the device</h3>

<p>You can choose to generate an entirely new keypair on this device. Do note that
you cannot get the keypair out, so if the token is lost or broken, your keys are
lost. It is also possible to load an external key on the device, we&#39;ll cover
that later in the guide.</p>

<p>If you want to generate a key only on the device, make sure you use an existing
key to sign that key, and use this key to sign the existing key so that you have
a cross-signature and people know that keypair belongs to you.</p>

<p>After you&#39;ve initialised the Nitrokey we can generate a key on the device. Start
up gpg:</p>

<pre><code>gpg --card-edit
admin
generate
</code></pre>

<p>The first question is:</p>

<pre><code>Make off-card backup of encryption key? (Y/n) 
</code></pre>

<p>This will create a file on your host machine with the private key. In the
specific case you are generating keys on the device and not on your machine, you
might not want to do this.</p>

<p>It will then ask you for the Admin PIN and the User PIN. Enter those.</p>

<p>It will ask you for a key expiry date. Note that this is the public key only and
can be updated later on easily. Set an expiry of 1 year so that if you don&#39;t use
this key, it doesn&#39;t linger on the keyservers:</p>

<pre><code>Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 1y

Key expires at Mon Aug 14 08:15:42 2017 CEST

Is this correct? (y/N) y
</code></pre>

<p>Enter your user data for the GPG key:</p>

<pre><code>    GnuPG needs to construct a user ID to identify your key.

    Real name: Remy van Elst Nitrokey
    Email address: 
    Comment: Nitrokey Start Key
    You selected this USER-ID:
        &quot;Remy van Elst Nitrokey (Nitrokey Start Key) &lt;email@domain.tld&gt;&quot;

    Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
</code></pre>

<p>The on-device key generation takes a while, my key took about 4 minutes.</p>

<p>You will be asked for a passphrase for the key. Enter that twice.</p>

<p>When the generation is finished the following message appears:</p>

<pre><code>We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key 0x7237395DC5696F9F marked as ultimately trusted
gpg: revocation certificate stored as &#39;/home/remy/.gnupg/openpgp-revocs.d/D78A0B1E407EBD678435CCC77237395DC5696F9F.rev&#39;
public and secret key created and signed.
</code></pre>

<p>Using the <code>list</code> command in the <code>gpg</code> prompt you can now see the keypairs:</p>

<pre><code>[...]
Signature counter : 4
Signature key ....: D78A 0B1E 407E BD67 8435  CCC7 7237 395D C569 6F9F
      created ....: 2016-08-14 06:17:48
Encryption key....: 2E7D 26B3 5D9E B690 4C56  3174 78F9 DDE9 9FFF 73F2
      created ....: 2016-08-14 06:17:48
Authentication key: D91C 38A7 294C BD63 275F  0D87 7AC8 3DB0 C0EB 9447
      created ....: 2016-08-14 06:17:48
General key info..: pub  rsa2048/0x7237395DC5696F9F 2016-08-14 Remy van Elst Nitrokey (Nitrokey Start Key) &lt;user@domain.tld&gt;
sec&gt;  rsa2048/0x7237395DC5696F9F  created: 2016-08-14  expires: 2017-08-14
                                  card-no: FFFE 52FF6E06
ssb&gt;  rsa2048/0x7AC83DB0C0EB9447  created: 2016-08-14  expires: 2017-08-14
                                  card-no: FFFE 52FF6E06
ssb&gt;  rsa2048/0x78F9DDE99FFF73F2  created: 2016-08-14  expires: 2017-08-14
                                  card-no: FFFE 52FF6E06
</code></pre>

<p>If you want you can now sign your new key with the old key. My new key id is
<code>7237395DC5696F9F</code>. My regular key ID is <code>2B6755BD1B7F88DC</code>:</p>

<pre><code>gpg -u 2B6755BD1B7F88DC  --sign-key 7237395DC5696F9F
</code></pre>

<p>Output:</p>

<pre><code> Primary key fingerprint: D78A 0B1E 407E BD67 8435  CCC7 7237 395D C569 6F9F

     Remy van Elst Nitrokey (Nitrokey Start Key) &lt;user@domain.tld&gt;

This key is due to expire on 2017-08-14.
Are you sure that you want to sign this key with your
key &quot;Remy van Elst &lt;user@domain.tld&gt;&quot; (0x2B6755BD1B7F88DC)
</code></pre>

<p>You will then be asked for your password.</p>

<p>To cross-sign, reverse the process:</p>

<pre><code>gpg -u 7237395DC5696F9F --sign-key 2B6755BD1B7F88DC
</code></pre>

<p>Output:</p>

<pre><code> Primary key fingerprint: 4DDE 73DB 5030 B539 2681  3A50 2B67 55BD 1B7F 88DC

     Remy van Elst &lt;user@domain.tld&gt;

This key is due to expire on 2019-05-31.
Are you sure that you want to sign this key with your
key &quot;Remy van Elst Nitrokey (Nitrokey Start Key) &lt;user@domain.tld&gt;&quot; (0x7237395DC5696F9F)

Really sign? (y/N) y
</code></pre>

<p>You will be asked for your USER PIN for the Nitrokey.</p>

<p>Afterwards send both keys to the keyserver:</p>

<pre><code>gpg --send-key 7237395DC5696F9F
gpg --send-key 2B6755BD1B7F88DC
</code></pre>

<p>If, for whatever reason, you need to revoke this keypair, import the revocation
certificate that GnuPG generated for you:</p>

<pre><code>gpg: revocation certificate stored as &#39;/home/remy/.gnupg/openpgp-revocs.d/D78A0B1E407EBD678435CCC77237395DC5696F9F.rev&#39;
</code></pre>

<p>But, you need to edit the file first:</p>

<pre><code>To avoid an accidental use of this file, a colon has been inserted
before the 5 dashes below.  Remove this colon with a text editor
before importing and publishing this revocation certificate.

:-----BEGIN PGP PUBLIC KEY BLOCK-----
</code></pre>

<p>After you&#39;ve done that, import the revocation certificate:</p>

<pre><code>gpg --import /home/remy/.gnupg/openpgp-revocs.d/D78A0B1E407EBD678435CCC77237395DC5696F9F.rev
</code></pre>

<p>Output:</p>

<pre><code>gpg: key 0x7237395DC5696F9F: &quot;Remy van Elst Nitrokey (Nitrokey Start Key) &lt;user@domain.tld&gt;&quot; revocation certificate imported
gpg: Total number processed: 1
gpg:    new key revocations: 1
gpg: public key of ultimately trusted key 0xB9073AEB64937870 not found
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   3  signed:  13  trust: 0-, 0q, 0n, 0m, 0f, 3u
gpg: depth: 1  valid:  13  signed:   4  trust: 12-, 0q, 0n, 0m, 1f, 0u
gpg: next trustdb check due at 2016-09-01
</code></pre>

<p>Send the updated and revoked key to the keyservers:</p>

<pre><code>gpg --send-key 7237395DC5696F9F
</code></pre>

<h3 id="toc_7">Loading external keys into the device</h3>

<p>If you already have a keypair and subkeys, you can import those to the device.
<a href="https://blog.josefsson.org/2014/06/23/offline-gnupg-master-key-and-subkeys-on-yubikey-neo-smartcard/">This</a> is a good guide for setting up a machine for offline key generation
and subkeys. I already have my master key so I won&#39;t cover it here.</p>

<p>I will add my key with key ID <code>2B6755BD1B7F88DC</code> to the card. Fire up gpg for
this key:</p>

<pre><code>gpg --expert --edit-key 2B6755BD1B7F88DC
</code></pre>

<p>We provice <code>--expert</code> since we are going to add three different subkeys to this
key to load on the card. If you already have these subkeys, then it&#39;s not
required.</p>

<p>My master key is 4096 bit, which the Nitrokey doesn&#39;t support. Therefore we also
need to generate these specific subkeys, they must be 2048 bit.</p>

<p>Add an <code>Authentication</code> subkey:</p>

<pre><code>gpg&gt; addkey
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
Your selection? 8
</code></pre>

<p>Disable the <code>Encrypt</code> and <code>Sign</code> attributes:</p>

<pre><code>Possible actions for a RSA key: Sign Encrypt Authenticate 
Current allowed actions: Sign Encrypt 

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? S


Possible actions for a RSA key: Sign Encrypt Authenticate 
Current allowed actions: Encrypt 

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? E
</code></pre>

<p>Add the <code>Authenticate</code> attribute:</p>

<pre><code>Possible actions for a RSA key: Sign Encrypt Authenticate 
Current allowed actions: 

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? A
</code></pre>

<p>Continue on with the keysize (<code>2048</code>) and the expiry date (1 year):</p>

<pre><code>Your selection? Q
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 1y
Key expires at Mon Aug 14 09:47:19 2017 CEST
Is this correct? (y/N) y
Really create? (y/N) y
</code></pre>

<p>The key is now being generated:</p>

<pre><code>We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

sec  rsa4096/0xD4A50E9CC37ACA81
     created: 2014-09-02  expires: 2017-08-14  usage: SCA 
     trust: unknown       validity: full
ssb  rsa4096/0x107F143B25325ED6
     created: 2014-09-02  expires: 2016-09-01  usage: E   
ssb  rsa2048/0x168C7E40842796D4
     created: 2016-08-14  expires: 2017-08-14  usage: A   
[  full  ] (1). R. van Elst &lt;remy@cloudvps.com&gt;
</code></pre>

<p>Repeat the above process and generate two more keys. One with ONLY the Encrypt
(E) attribute and one with only the Sign (S) attribute. When that&#39;s done, the
<code>list</code> command should look like this:</p>

<pre><code>ssb  rsa2048/0x168C7E40842796D4
     created: 2016-08-14  expires: 2017-08-14  usage: A   
ssb  rsa2048/0x76E7BD244019228B
     created: 2016-08-14  expires: 2017-08-14  usage: E   
ssb  rsa2048/0xDB3C494B3DF91C55
     created: 2016-08-14  expires: 2017-08-14  usage: S 
</code></pre>

<p>Select the key to transfer to the card. We need to do all three the new keys. In
my case, it&#39;s key 2:</p>

<pre><code>gpg&gt; key 2
</code></pre>

<p>The key gets a <code>*</code> added:</p>

<pre><code>ssb* rsa2048/0x168C7E40842796D4
     created: 2016-08-14  expires: 2017-08-14  usage: A 
</code></pre>

<p>Transfer the key to the Nitrokey:</p>

<pre><code>gpg&gt; keytocard
</code></pre>

<p>Confirm the key position in the card:</p>

<pre><code>Please select where to store the key:
   (3) Authentication key
Your selection? 3
</code></pre>

<p>You will be asked for the key passphrase and the Admin PIN.</p>

<p>If you issue the <code>gpg --card-status</code> command in another terminal you can see
that this key is added:</p>

<pre><code>Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: 80A9 C670 8CF2 26BB 0B05  BB11 168C 7E40 8427 96D4
      created ....: 2016-08-14 07:45:16
General key info..: [none]
</code></pre>

<p>Issue the <code>key 2</code> command on the GPG prompt again to unselect this key, and
continue with the next key:</p>

<pre><code>gpg&gt; key 2
gpg&gt; key 3
</code></pre>

<p>Output:</p>

<pre><code>ssb* rsa2048/0x76E7BD244019228B
     created: 2016-08-14  expires: 2017-08-14  usage: E  
</code></pre>

<p>Place it on the Nitrokey:</p>

<pre><code>gpg&gt; keytocard
</code></pre>

<p>Output:</p>

<pre><code>Please select where to store the key:
   (2) Encryption key
Your selection? 2
</code></pre>

<p>Again you will be asked for the Key passphrase. Afterwards in another terminal,
validate that this key is loaded:</p>

<pre><code>gpg --card-status
</code></pre>

<p>Output:</p>

<pre><code>Signature counter : 0
Signature key ....: [none]
Encryption key....: CDBD 9425 CA43 1FA0 D433  9976 76E7 BD24 4019 228B
      created ....: 2016-08-14 07:49:25
Authentication key: 80A9 C670 8CF2 26BB 0B05  BB11 168C 7E40 8427 96D4
      created ....: 2016-08-14 07:45:16
General key info..: [none]
</code></pre>

<p>Repeat the process for the last key, unselect key 3 and select key 4:</p>

<pre><code>gpg&gt; key 3
gpg&gt; key 4
</code></pre>

<p>Output:</p>

<pre><code>ssb* rsa2048/0xDB3C494B3DF91C55
     created: 2016-08-14  expires: 2017-08-14  usage: S 
</code></pre>

<p>Place it on the card:</p>

<pre><code>Please select where to store the key:
   (1) Signature key
   (3) Authentication key
Your selection? 1
</code></pre>

<p>Save and quit the prompt:</p>

<pre><code>gpg&gt; save
</code></pre>

<p>Check with <code>gpg --card-status</code> that all the keys are loaded:</p>

<pre><code>Signature counter : 0
Signature key ....: 8832 C6F8 2D1C D75C 9507  25A4 DB3C 494B 3DF9 1C55
      created ....: 2016-08-14 07:50:28
Encryption key....: CDBD 9425 CA43 1FA0 D433  9976 76E7 BD24 4019 228B
      created ....: 2016-08-14 07:49:25
Authentication key: 80A9 C670 8CF2 26BB 0B05  BB11 168C 7E40 8427 96D4
      created ....: 2016-08-14 07:45:16
General key info..: sub  rsa2048/0xDB3C494B3DF91C55 2016-08-14 R. van Elst &lt;remy@cloudvps.com&gt;
sec   rsa4096/0xD4A50E9CC37ACA81  created: 2014-09-02  expires: 2017-08-14
ssb   rsa4096/0x107F143B25325ED6  created: 2014-09-02  expires: 2016-09-01
ssb&gt;  rsa2048/0x168C7E40842796D4  created: 2016-08-14  expires: 2017-08-14
                                  card-no: FFFE 52FF6E06
ssb&gt;  rsa2048/0x76E7BD244019228B  created: 2016-08-14  expires: 2017-08-14
                                  card-no: FFFE 52FF6E06
ssb&gt;  rsa2048/0xDB3C494B3DF91C55  created: 2016-08-14  expires: 2017-08-14
                                  card-no: FFFE 52FF6E06
</code></pre>

<p>Export your public key:</p>

<pre><code>gpg --export --armor D4A50E9CC37ACA81
</code></pre>

<p>Save this on your filesystem. We are going to remove the private keys from your
machine, since they are on the Nitrokey. You do need your public key later on.</p>

<p>Just to make sure, before removing any GPG keys, make a backup of your
<code>~/.gnupg</code> folder:</p>

<pre><code>cp -ar ~/.gnupg ~/.gnupg-backup-$(date +%s)
</code></pre>

<p>Unplug the Nitrokey. Then delete the secret keys for this keypair:</p>

<pre><code>gpg --delete-secret-key D4A50E9CC37ACA81
</code></pre>

<p>Confirm it a few times.</p>

<p>To use the smartcard on another PC, you first need to import the public key
first. On the current machine, to use the keys, first run:</p>

<pre><code>gpg --card-status
</code></pre>

<p>To test, create a small test file:</p>

<pre><code>echo &#39;this is a small test file&#39; &gt; test
</code></pre>

<p>Sign that with this specific key:</p>

<pre><code>gpg --sign -u D4A50E9CC37ACA81 test
</code></pre>

<p>You will be asked for the User PIN of the Nitrokey. Afterwards there is a
<code>test.gpg</code> file. You can verify that file is signed:</p>

<pre><code>gpg --verify -u 2B6755BD1B7F88DC  test.gpg 
</code></pre>

<p>Output:</p>

<pre><code>gpg: Signature made Sun Aug 14 10:56:48 2016 CEST
gpg:                using RSA key 0xDB3C494B3DF91C55
gpg: Good signature from &quot;R. van Elst &lt;remy@cloudvps.com&gt;&quot; [full]
Primary key fingerprint: 5DD7 711A F8C4 72D7 BEEF  03D0 D4A5 0E9C C37A CA81
     Subkey fingerprint: 8832 C6F8 2D1C D75C 9507  25A4 DB3C 494B 3DF9 1C55
</code></pre>

<p>If the Nitrokey is not present when you want to sign, gpg will tell you to
please insert the correct smartcard.</p>

<h3 id="toc_8">Overwriting (deleting) keys on the Nitrokey</h3>

<p>Nitrokey Start (actually gnuk) doesn&#39;t support overriding keys. Once generated
or written, you should use a Python script provided by GnuK, <a href="https://raw.githubusercontent.com/Nitrokey/nitrokey-start-firmware/master/tool/gnuk_remove_keys_libusb.py">gnuk <em>remove</em>
keys_libusb.py</a> to remove keys before trying to write a new one.</p>

<p>Do note that I got <a href="https://github.com/Nitrokey/nitrokey-start-firmware/issues/2">errors</a> while using this script. There is a non <code>libusb</code>
versio that did work for me. First make sure you have <code>pyscard</code> installed:</p>

<pre><code>pip2 install pyscard
</code></pre>

<p>Clone the git repository:</p>

<pre><code>git clone https://github.com/Nitrokey/nitrokey-start-firmware.git
cd nitrokey-start-firmware
</code></pre>

<p><strong>IF YOU EXECUTE THE BELOW SCRIPT ALL YOUR KEYS WILL BE REMOVED</strong></p>

<p>Execute the non libusb removal script:</p>

<pre><code>python2 tool/gnuk_remove_keys.py -p
</code></pre>

<p>It will ask you for the ADMIN PIN:</p>

<pre><code>Admin password: &lt;12345678&gt;
</code></pre>

<p>Output:</p>

<pre><code>Token: Nitrokey Nitrokey Start (FSIJ-1.0.4-52FF6E06) 00 00
ATR: 3B DA 11 FF 81 B1 FE 55 1F 03 00 31 84 73 80 01 80 00 90 00 E4
</code></pre>

<p>You can afterwards check that all the keys are removed:</p>

<pre><code>gpg --card-status
</code></pre>

<p>Output:</p>

<pre><code>Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
</code></pre>

<p>If you receive errors like:</p>

<pre><code>smartcard.Exceptions.CardConnectionException: Unable to connect with protocol: T0 or T1. Sharing violation.
</code></pre>

<p>Or</p>

<pre><code>  File &quot;tool/gnuk_remove_keys.py&quot;, line 54, in cmd_verify
    raise ValueError, (&quot;%02x%02x&quot; % (sw1, sw2))
ValueError: 6982
</code></pre>

<p>Then just remove and insert the key and try again.</p>

<h3 id="toc_9">Usage examples with GPG</h3>

<p>To encrypt a file for recipient with key <code>2B6755BD1B7F88DC</code>, use the following
command:</p>

<pre><code>gpg --sign --encrypt  -u D4A50E9CC37ACA81 -r 2B6755BD1B7F88DC test
</code></pre>

<p>If you want to just encrypt the file, remove the <code>--sign</code> flag. <code>-r</code> is the
recipient, <code>-u</code> is your key. If you remove the sign flag, the other person
cannot validate that the file came from you.</p>

<p>To sign a message and have the ASCII output, use the following command:</p>

<pre><code>gpg --sign --armor -u D4A50E9CC37ACA81   test
</code></pre>

<p>Enter the User PIN, and afterwards check the output:</p>

<pre><code>$ cat test.asc 
-----BEGIN PGP MESSAGE-----

owEBVAGr/pANAwAKAds8SUs9+RxVAawkYgR0ZXN0V7AzN3RoaXMgaXMgYSBzbWFs
bCB0ZXN0IGZpbGUKiQEcBAABCgAGBQJXsDM3AAoJENs8SUs9+RxV9zwH/R/CFYzt
FJ/TniMWEwUOQ8YvyM2b7Sj4mcw+7yI/db1J6jsdGuoisWrIhvs0tp3i6qtKIjWV
SrGSHcnv+Ur6k2YYqfAEpybw1ixAa/XwVZjUJaSfLm8uqYDD4pMhBupky/OVfZTl
aI/hhZuaPShAt3f8Zg6ZwqIk8OqM6HCe+eSSflC/HVDyt4WKtq0JcZtIjzKbvsGD
jfHrtabzoKdGLmG2y1GT5wrDIM8nInn66Q3uPm/jNlnEH1M93Z4DnY3/jm/+hu+3
DjJFximcSlt3H0kQ7c1y2FXNiufXP+LPmB5QooZouZ5ILSaIiQenoi28T5/aQPv4
P9BiMreZVKzZ6IQ=
=Ztv5
-----END PGP MESSAGE-----
</code></pre>

<p>If you receive an encrypted and signed message, you can decypt it with the
following command:</p>

<pre><code>gpg --decrypt test.gpg 
</code></pre>

<p>You will be asked to enter your user PIN. Output:</p>

<pre><code>gpg: encrypted with 2048-bit RSA key, ID 0x76E7BD244019228B, created 2016-08-14
      &quot;R. van Elst &lt;remy@cloudvps.com&gt;&quot;
this is a small test file
gpg: Signature made Sun Aug 14 12:12:35 2016 CEST
gpg:                using RSA key 0x2B6755BD1B7F88DC
gpg: Good signature from &quot;Remy van Elst &lt;relst@relst.nl&gt;&quot; [ultimate]
Primary key fingerprint: 4DDE 73DB 5030 B539 2681  3A50 2B67 55BD 1B7F 88DC
</code></pre>

<h3 id="toc_10">Usage examples with OpenSSH</h3>

<p>OpenSSH requires to have a subkey with the Authentication attribute. We don&#39;t
use a complicated GPG agent setup or key conversion, but we utilize <code>OpenSC</code>.
The Nitrokey Start can also be used with OpenSC just as the Nitrokey HSM.</p>

<p>Make sure the Nitrokey is plugged in. Execute the following command to add the
module to the <code>ssh-agent</code>:</p>

<pre><code>ssh-add -s opensc-pkcs11.so
</code></pre>

<p>Output:</p>

<pre><code>Enter passphrase for PKCS#11: 
Card added: opensc-pkcs11.so
</code></pre>

<p>You can check that the keys are available now with the <code>-l</code> flag:</p>

<pre><code>ssh-add -l
</code></pre>

<p>Output:</p>

<pre><code>2048 SHA256:INvUw/LHzO/loNzzAu99FYlvYpq1o3IgPgjJJuDt/FE opensc-pkcs11.so (RSA)
2048 SHA256:rb0keTL7bQFtr1C5Rii/c6hTcTIM+OYeZ/aqHWJf9+0 opensc-pkcs11.so (RSA)
2048 SHA256:QR/Wr8YAvRQW1rA6Y9UnORZvbXflFB6uG9l2PqxRS2A opensc-pkcs11.so (RSA)
</code></pre>

<p>With the <code>-L</code> flag you also get the public keys for use in
<code>~/.ssh/authorized_keys</code>:</p>

<pre><code>ssh-add -l
</code></pre>

<p>Output:</p>

<pre><code>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDuDJUnbB81eUOZ+I0FZk35Yk9S4MyAPIJIcpN5jywNUcX5DJdgXNv/k4gm2grCIAdhACMK6sxnH2jd7e23Iq3LhDLz+I8Stc3qzKqnl1agD87IG2+trCCz2Odd7nIxRr3me5eutEDhvwqLX1aXiH/UEcUOOWGQ6Vu7iDOlia2s5p5qr5F4tbiD0TwdmiTvqtgMPyiXMIk4OCttB5dLyY/7hplfBSYXGgGujQEx6Q7OaHeGc983ZbfLnWvSWqEEfHnQG4IemhgHGU4ZuPdgfc8BgYDBPBFXtcG5lv3SREpupFVnWXm5L8bh3y3j7twlZamlCA7Sk7Vf29UDsbZ/1COT opensc-pkcs11.so

ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDgfplUpYCDOGGU9hnZdiHYvetm6Fz7vflcTh/PdQl+9E20ocOXK7IEmm70ABv5Sp5wESIrzyrchUfKo1mvALdxy3Xb1Qc1WC7NQfmUOpMJ4ztNwTB8Jy+Qs2XzMRXGq6RU8RlZcrer7gj0QQIzIxkDrwLG21SByt/hyVUqSI31tQwqs/SKP9cKxcZLAIzReeu2JAqr6U2O62O6/SVYWTa5XV6HKs3PLBsNfjojfGHPYfheSEdY7tMkAZ6uaQsW0FelwdSYoVjhejk29H9AsIuz6Ivp5oscHZhIR9kesnhPj7SBZV2/CFEWSvwmuyNlH3UNr8kvZbdcWPZbLCeLlDTj opensc-pkcs11.so

ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyDuf4vqd4G0CboNKqOOV8UMsYRF/KvPnKO2bZHS46PFMOjBLz0eDQku+YFeNu9wE4uEuBN1eAkvArp5cBTEds8F+qHAoj7C6lRNGrevxBBG/i5m8N6WLl6Ser1P7SZBRv+YF7ErDWDvuHm5GzrD7DU/sVH15ZT+MUDPZ5ANL0PcCYUafxBVigBTNb1siab86sHLDsv+JqYvVyY7qwnog57WyG3C51+GfxmglwDYZeCtBVrP0FKnnaWXnsJIDiE8YlaaUmvQErEDr5NEzNQj5pKcP9Di0IXdPkjBp0AcHZE2u34nT6L0YXKreaWPcyq1eUJC83+x8YRhgQ+C9u1Yip opensc-pkcs11.so
</code></pre>

<p>But which key is the Authentication key? Find out with <code>pkcs15-tool</code>:</p>

<pre><code>pkcs15-tool --list-keys
</code></pre>

<p>Output:</p>

<pre><code>Using reader with a card: Nitrokey Nitrokey Start (FSIJ-1.0.4-52FF6E06) 00 00
Private RSA Key [Signature key]
    Object Flags   : [0x3], private, modifiable
    Usage          : [0x20C], sign, signRecover, nonRepudiation
    Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
    ModLength      : 2048
    Key ref        : 0 (0x0)
    Native         : yes
    Auth ID        : 01
    ID             : 01
    MD:guid        : 2c444dd0-08c1-0684-5f26-4eb852d0bb81

Private RSA Key [Encryption key]
    Object Flags   : [0x3], private, modifiable
    Usage          : [0x22], decrypt, unwrap
    Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
    ModLength      : 2048
    Key ref        : 1 (0x1)
    Native         : yes
    Auth ID        : 02
    ID             : 02
    MD:guid        : f4238588-7a7d-29bd-c130-27a565150066

Private RSA Key [Authentication key]
    Object Flags   : [0x3], private, modifiable
    Usage          : [0x222], decrypt, unwrap, nonRepudiation
    Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
    ModLength      : 2048
    Key ref        : 2 (0x2)
    Native         : yes
    Auth ID        : 02
    ID             : 03
    MD:guid        : d2f08102-b940-3efe-9e91-50f8d377a1d7
</code></pre>

<p>The key with ID 3 is the authentication key. Get the SSH key for that ID:</p>

<pre><code>pkcs15-tool --read-ssh-key 3
</code></pre>

<p>Output:</p>

<pre><code>Using reader with a card: Nitrokey Nitrokey Start (FSIJ-1.0.4-52FF6E06) 00 00
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyDuf4vqd4G0CboNKqOOV8UMsYRF/KvPnKO2bZHS46PFMOjBLz0eDQku+YFeNu9wE4uEuBN1eAkvArp5cBTEds8F+qHAoj7C6lRNGrevxBBG/i5m8N6WLl6Ser1P7SZBRv+YF7ErDWDvuHm5GzrD7DU/sVH15ZT+MUDPZ5ANL0PcCYUafxBVigBTNb1siab86sHLDsv+JqYvVyY7qwnog57WyG3C51+GfxmglwDYZeCtBVrP0FKnnaWXnsJIDiE8YlaaUmvQErEDr5NEzNQj5pKcP9Di0IXdPkjBp0AcHZE2u34nT6L0YXKreaWPcyq1eUJC83+x8YRhgQ+C9u1Yip Authentication key
</code></pre>

<p>Add that to a server&#39;s <code>~/.ssh/authorized_keys</code> file and you are able to login
without being asked a password:</p>

<pre><code>$ ssh root@85.222.224.108
Warning: Permanently added &#39;85.222.224.108&#39; (ECDSA) to the list of known hosts.
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

root@smartcard:~# cat /var/log/auth.log 
Aug 14 12:41:48 ubuntu sshd[1754]: Accepted password for root from 192.168.20.332 port 50330 ssh2
Aug 14 12:41:48 ubuntu sshd[1754]: pam_unix(sshd:session): session opened for user root by (uid=0)
Aug 14 12:42:06 ubuntu sshd[1754]: Received disconnect from 192.168.20.332 port 50330:11: disconnected by user
Aug 14 12:42:06 ubuntu sshd[1754]: Disconnected from 192.168.20.332 port 50330
[...]
Aug 14 12:42:08 ubuntu sshd[1776]: Postponed publickey for root from 192.168.20.332 port 50366 ssh2 [preauth]
Aug 14 12:42:09 ubuntu sshd[1776]: Accepted publickey for root from 192.168.20.332 port 50366 ssh2: RSA SHA256:QR/Wr8YAvRQW1rA6Y9UnORZvbXflFB6uG9l2PqxRS2A
Aug 14 12:42:09 ubuntu sshd[1776]: pam_unix(sshd:session): session opened for user root by (uid=0)
</code></pre>

<p>When you&#39;re done with all the sessions, close them and remove the Nitrokey from
the ssh-agent:</p>

<pre><code>ssh-add -e opensc-pkcs11.so
</code></pre>

<p>Output:</p>

<pre><code>Card removed: opensc-pkcs11.so
</code></pre>

<p><code>ssh-add -l</code> shouldn&#39;t show the keys anymore.</p>

<h3 id="toc_11">Usage examples with Thunderbird</h3>

<p>Using <a href="https://www.enigmail.net/index.php/en/">Enigmail</a> with Thunderbird is very easy. If you&#39;ve set up the
Nitrokey Start as shown above with OpenPGP, Enigmail will automatically find the
key and use it, if it&#39;s inserted, no further setup required. Here&#39;s the
smartcard information screen:</p>

<p><img src="https://raymii.org/s/inc/img/gpg_tbird_nitrokey.png" alt=""></p>

<p>When sending an email, it will automatically ask you for the PIN:</p>

<p><img src="https://raymii.org/s/inc/img/gpg_tbird_nitrokey_2.png" alt=""></p>

<p>If you receive an encrypted email, it will also automatically ask you for the
PIN and decrypt the email:</p>

<p><img src="https://raymii.org/s/inc/img/gpg_tbird_nitrokey_3.png" alt=""></p>

<p>Literally no setup required. I&#39;ve rarely seen this kind of encrypton be so
easily setup, major props to Thunderbird, Enigmail and GPG here.</p>
Tags: <a href="../tags/articles.html">articles</a>
, <a href="../tags/gnupg.html">gnupg</a>
, <a href="../tags/gpg.html">gpg</a>
, <a href="../tags/nitrokey.html">nitrokey</a>
, <a href="../tags/nitrokey-start.html">nitrokey-start</a>
, <a href="../tags/openssh.html">openssh</a>
, <a href="../tags/smartcard.html">smartcard</a>
, <a href="../tags/ssh.html">ssh</a>
, <a href="../tags/start.html">start</a>
, <a href="../tags/thunderbird.html">thunderbird</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
     
    </main>
    </body>
    </html>
    