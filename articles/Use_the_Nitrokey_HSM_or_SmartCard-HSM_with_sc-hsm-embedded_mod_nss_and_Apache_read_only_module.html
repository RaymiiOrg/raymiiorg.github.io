
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Use the Nitrokey HSM or SmartCard-HSM with sc-hsm-embedded, mod_nss and Apache (read only module) - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Use the Nitrokey HSM or SmartCard-HSM with sc-hsm-embedded, mod_nss and Apache (read only module)</h2>
<p><small>Published: 15-07-2016 | Author: Remy van Elst | <a href="Use_the_Nitrokey_HSM_or_SmartCard-HSM_with_sc-hsm-embedded_mod_nss_and_Apache_read_only_module.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7993642564731324"
                             crossorigin="anonymous"></script>
                        <!-- voorartikel -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-7993642564731324"
                             data-ad-slot="6172324376"
                             data-ad-format="auto"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        </div><br><div class='olderthanayear'><p><strong>&#10071; This post is over five years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Introduction</a>
</li>
<li>
<a href="#toc_1">Installation of the sc-hsm-embedded module</a>
</li>
<li>
<a href="#toc_2">Creating the keys and certificates</a>
</li>
<li>
<a href="#toc_3">Configuring Apache and mod_nss</a>
<ul>
<li>
<a href="#toc_4">Configuring the NSS certificate database</a>
</li>
<li>
<a href="#toc_5">Apache mod_nss configuration</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">Benchmarking 2048 bit RSA</a>
</li>
<li>
<a href="#toc_7">Benchmarking 1024 bit RSA</a>
</li>
<li>
<a href="#toc_8">Benchmarking the EC prime256v1 key</a>
</li>
<li>
<a href="#toc_9">Benchmarking with PHP and Wordpress</a>
</li>
<li>
<a href="#toc_10">Comparing and conclusion</a>
</li>
</ul>

</div><hr><div id="contents">
<p><img src="https://raymii.org/s/inc/img/nitrokey1.jpg" alt=""></p>

<blockquote>
<p>The NitroKey HSM in a sealed package</p>
</blockquote>

<p>This is a guide on using the Nitrokey HSM with sc-hsm-embedded module instead of
the PC/SC daemon and OpenSC, mod_nss and the Apache webserver. This is an
extension on the earlier guide, with new benchmarks. The sc-hsm-embedded module
is not using a global lock like OpenSC, therefore providing better performance.
The sc-hsm-embedded module is also a read only module, suitable for embedded
systems. Read only also makes it more secure when deployed, even when the user
pin leaks out an attacker cannot create new keypairs or delete the current ones.</p>

<p>The HSM allows you to store the private key for a SSL certificate inside the HSM
(instead of on the filesystem), so that it can never leave the device and thus
never be stolen.</p>

<p>The guide covers the installation of the sc-hsm-embedded module, configuration
of and benchmarks from Apache with the HSM and different key sizes.</p>

<h3 id="toc_0">Introduction</h3>

<p><img src="https://raymii.org/s/inc/img/sc-hsm.jpg" alt=""></p>

<blockquote>
<p>The SmartCard-HSM</p>
</blockquote>

<p>The <a href="http://nitrokey.com">Nitrokey HSM</a> is an open hardware and open software device. It is a USB
version of the <a href="http://www.smartcard-hsm.com/">SmartCard-HSM</a>. Both the <a href="http://www.smartcard-hsm.com/opensource.html">SmartCard-HSM</a> as the <a href="https://github.com/nitrokey">Nitrokey
HSM</a> have sources available and are fully supported by the <a href="https://github.com/OpenSC/OpenSC/wiki/SmartCardHSM">OpenSC</a>
project.</p>

<p>If you are new to the NitroKey HSM/SmartCard HSM, please also <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html">read my getting
started</a> article. It explains what the HSM is, how to set it up and how to
use it with OpenSSH for example.</p>

<p>I have <a href="https://raymii.org/s/tags/nitrokey.html">multiple articles</a> on this nice device, so make sure to read the
others as well.</p>

<p>To follow this article, I recommend you first read the <a href="https://raymii.org/s/articles/Nitrokey_HSM_in_Apache_with_mod_nss.html">article on the Nitrokey
HSM with mod_nss and Apache</a> I wrote earlier. The other article has more
explanation and examples, this article will focus on the installation of the
module and the benchmarks.</p>

<p>In a recent conversation I had with Andreas Schwier, one of the people behind
the <a href="http://www.smartcard-hsm.com/">SmardCard-HSM</a> project, I was informed about the <code>sc-hsm-embedded</code>
module. Andreas told me that they, in <a href="http://www.smartcard-hsm.com/2015/11/20/Building-a-SmartCard-HSM-Cluster.html">their load tests</a>, experienced bad
performance with OpenSC because of a global lock. Their benchmarks were done
with their own PKCS#11 module, which we are covering here in this article.</p>

<p>The <code>sc-hsm-embedded</code> is described as:</p>

<pre><code>Light-weight, read-only PKCS#11 library for using the SmartCard-HSM in embedded systems.
</code></pre>

<p>So you will not be able to create keypairs with this module or write
certificates to the HSM.</p>

<p>This guide was tested on Ubuntu 14.04 and Arch Linux with a NitroKey HSM.</p>

<p class="ad"> <a href="https://leafnode.nl">I'm developing a desktop monitoring app,  Leaf Node Monitoring, open source, but paid. For Windows, Linux & Android, go check it out.</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<h3 id="toc_1">Installation of the sc-hsm-embedded module</h3>

<p>For Arch Linux <a href="https://aur.archlinux.org/packages/sc-hsm-embedded-git/">I made an AUR package</a> of the module <a href="https://aur.archlinux.org/packages/engine_pkcs11_alternative/">and an AUR
package</a> for the OpenSSL Engine.</p>

<p>Do note that you can install this module next to the OpenSC package. They don&#39;t
conflict with one another.</p>

<p>On Ubuntu, install the development tools and pcsclite packages:</p>

<pre><code>apt-get install automake build-essential pkg-config libtool libusb-1.0-0-dev libpcsclite-dev checkinstall
</code></pre>

<p>Clone the git repository:</p>

<pre><code>git clone https://github.com/CardContact/sc-hsm-embedded.git sc-hsm-embedded-2.9
cd sc-hsm-embedded-2.9
</code></pre>

<p>Execute the following commands to generate a <code>/.configure</code> file using the
<code>autotools</code>:</p>

<pre><code>libtoolize --force
aclocal
autoheader
automake --force-missing --add-missing
autoconf
</code></pre>

<p>Continue the compilation:</p>

<pre><code>./configure
make
</code></pre>

<p>I like to create a debian package with <code>checkinstall</code> instead of a <code>make
install</code>. It&#39;s certainly not the official way to create debian packages, but it
does allow you to keep a system clean and allows for easier upgrading. Also, a
package is much more convinient if you are distributing it in a repo or with
Ansible. Create the package:</p>

<pre><code>checkinstall
</code></pre>

<p>The default settings should be OK, but change them as you like. The final output
should be along the lines of:</p>

<pre><code>**********************************************************************

 Done. The new package has been installed and saved to

 /root/repo/sc-hsm-embedded-2.9/sc-hsm-embedded_2.9-1_amd64.deb

 You can remove it from your system anytime using: 

      dpkg -r sc-hsm-embedded

**********************************************************************
</code></pre>

<p>On any other distro, use their native way to build a package (hi <code>PKGBUILD</code>) or
just do a plain simple <code>make install</code>.</p>

<p>There should now be a new library on your system:</p>

<pre><code>file /usr/local/lib/libsc-hsm-pkcs11.so
/usr/local/lib/libsc-hsm-pkcs11.so: ELF 64-bit LSB  shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=1ede3f07f0094711931f5e25d9716622742356da, stripped
</code></pre>

<p>On Arch:</p>

<pre><code>file /usr/lib/libsc-hsm-pkcs11.so
/usr/lib/libsc-hsm-pkcs11.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=3854bdd3a096b19c927817a486140bc2750555f8, stripped
</code></pre>

<p>Later in the article, place the correct path to this <code>.so</code> file in the
configuration. Or, if you want to be able to copy and paste the commands, create
a symlink:</p>

<pre><code>ln -s /usr/lib/libsc-hsm-pkcs11.so /usr/local/lib/libsc-hsm-pkcs11.so
</code></pre>

<p>You can test the new module with their own test tool or <code>pkcs11-tool</code>:</p>

<pre><code>pkcs11-tool --module libsc-hsm-pkcs11.so --login --pin 648219 --show-info
</code></pre>

<p>Output:</p>

<pre><code>Cryptoki version 2.20
Manufacturer     CardContact (www.cardcontact.de)
Library          SmartCard-HSM R/O with PC/SC (ver 2.8)
Using slot 1 with a present token (0x5)
</code></pre>

<p>Compared with the <code>opensc-pkcs11</code> module:</p>

<pre><code> pkcs11-tool --module opensc-pkcs11.so --login --show-info --pin 648219
</code></pre>

<p>Output:</p>

<pre><code>Cryptoki version 2.20
Manufacturer     OpenSC Project
Library          OpenSC smartcard framework (ver 0.16)
Using slot 1 with a present token (0x4)
</code></pre>

<p>You will notice that most operations with <code>pkcs11-tool</code>, like creating a
keypair, will fail:</p>

<pre><code>pkcs11-tool --module libsc-hsm-pkcs11.so --login --pin 648219 --keypairgen --key-type rsa:1024 --id 1 --label &quot;HSM RSA Key Remy&quot;
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x5)
error: Generate RSA mechanism not supported

Aborting.
</code></pre>

<p>This is expected since it&#39;s a read only module. Read only also makes it more
secure when deployed, even when the user pin leaks out an attacker cannot create
new keypairs or delete the current ones.</p>

<p>A delete operation will not give any error messages:</p>

<pre><code>pkcs11-tool --module libsc-hsm-pkcs11.so --login --pin 648219 --delete-object --type privkey --id 3
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x5)
</code></pre>

<p>But, if you list the objects before and after you will see that the key you
tried to delete is still there.</p>

<p>Just listing data does work:</p>

<pre><code>pkcs11-tool --module libsc-hsm-pkcs11.so --login --pin 648219 --list-objects --id 01
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x5)
Public Key Object; RSA 2048 bits
  label:      1024cert
  ID:         03
  Usage:      encrypt, verify
Certificate Object, type = X.509 cert
  label:      1024cert
  ID:         03
</code></pre>

<p>Reading the data does work as well:</p>

<pre><code>pkcs11-tool --module libsc-hsm-pkcs11.so --login --pin 648219 --read-object --id 1 --type cert | base64
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x5)
MIIDcjCCAloCCQDIi8zcoGtnejANBgkqhkiG9w0BAQsFADB7MQswCQYDVQQGEwJOTDEVMBMGA1UE
[...]
qJ49qqLd5I24yKXxh9qTYrXDxHPAExqXHnwydXiDRQ==
</code></pre>

<h3 id="toc_2">Creating the keys and certificates</h3>

<p>We will now start with creating the keypairs in the HSM and generating the
certificates.</p>

<p>Please do read the <a href="https://raymii.org/s/articles/Nitrokey_HSM_in_Apache_with_mod_nss.html">article on the Nitrokey HSM with mod_nss and Apache</a> to
find out how to fully configure the NitroKey HSM/SmartCard HSM with <code>mod_nss</code>.
This is a more compact version without all the explanation.</p>

<p>I did create three test keypairs, one <code>RSA 1024</code> bit, one <code>RSA 2048</code> bit and one
<code>EC</code> pair. They have ID 1, 2 and, suprisingly, 3. If you want to follow along,
also create the keys. Start with the 1024 bit key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --keypairgen --key-type rsa:1024 --id 1 --label &quot;httpd1024&quot; 
</code></pre>

<p>Output:</p>

<pre><code>Key pair generated:
Private Key Object; RSA 
  label:      httpd1024
  ID:         01
  Usage:      decrypt, sign, unwrap
Public Key Object; RSA 1024 bits
  label:      httpd1024
  ID:         01
  Usage:      encrypt, verify, wrap
</code></pre>

<p>2048 bit key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --keypairgen --key-type rsa:2048 --id 2 --label &quot;httpd2048&quot; 
</code></pre>

<p>Output:</p>

<pre><code>Key pair generated:
Private Key Object; RSA 
  label:      httpd2048
  ID:         02
  Usage:      decrypt, sign, unwrap
Public Key Object; RSA 2048 bits
  label:      httpd2048
  ID:         02
  Usage:      encrypt, verify, wrap
</code></pre>

<p>And the EC key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --keypairgen --key-type EC:prime256v1 --id 3 --label &quot;httpdECprime256v1&quot;
</code></pre>

<p>Output:</p>

<pre><code>Private Key Object; EC
  label:      httpdECprime256v1
  ID:         03
  Usage:      sign, derive
Public Key Object; EC  EC_POINT 256 bits
  EC_POINT:   044104ca3ff52e48bd85f3878ef8e1b59498c9fcc7741a1e547f2849ff4a5f716d96ea49ab8f25c61e7b4ad899fd3df8996767e70672ceb9297758695810fbc30ba660
  EC_PARAMS:  06082a8648ce3d030107
  label:      httpdECprime256v1
  ID:         03
  Usage:      verify
</code></pre>

<p>We need to generate (self signed) certificates for all of these keypairs. We
will use OpenSSL with a configfile do to that. See <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html#Using_the_keys">my tutorial on the Nitrokey
if you want to generate a CSR and what to put in</a> <code>hsm.conf</code>.</p>

<p>I did have some issues when providing the slot and ID, OpenSSL gave errors like
these:</p>

<pre><code>engine &quot;pkcs11&quot; set.
Invalid slot number: 1
PKCS11_get_private_key returned NULL
cannot load Private Key from engine
140378622912152:error:26096080:engine routines:ENGINE_load_private_key:failed loading private key:eng_pkey.c:124:
unable to load Private Key
</code></pre>

<p>Turns out, I was using the wrong slot number:</p>

<pre><code>pkcs11-tool --list-slots
</code></pre>

<p>Output:</p>

<pre><code>Available slots:
Slot 0 (0x0): Lenovo Integrated Smart Card Reader 00 00
  (empty)
Slot 1 (0x4): Nitrokey Nitrokey HSM (010000000000000000000000) 01 00
  token label        : SmartCard-HSM (UserPIN)
  token manufacturer : www.CardContact.de
  token model        : PKCS#15 emulated
  token flags        : rng, login required, PIN initialized, token initialized
  hardware version   : 24.13
  firmware version   : 2.0
  serial num         : DENK0100186
</code></pre>

<p>I was using slot 1, but that did not work. Slot 4 (<code>0x4</code>) did work. You can
provide the slot and ID to OpenSSL in multiple formats:</p>

<pre><code>supported formats: &lt;id&gt;, &lt;slot&gt;:&lt;id&gt;, id_&lt;id&gt;, slot_&lt;slot&gt;-id_&lt;id&gt;, label_&lt;label&gt;, slot_&lt;slot&gt;-label_&lt;label&gt;
where &lt;slot&gt; is the slot number as normal integer,
and &lt;id&gt; is the id number as hex string.
and &lt;label&gt; is the textual key label string.
</code></pre>

<p>Generate the 1024 bit RSA certificate with ID 1:</p>

<pre><code>OPENSSL_CONF=./hsm.conf openssl req -engine pkcs11 -keyform engine -new -key slot_4-id_1 -nodes -days 3560 -x509 -sha256 -out &quot;rsa1024.tst.raymii.org.pem&quot; -subj &quot;/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=rsa1024.tst.raymii.org&quot;
</code></pre>

<p>The 2048 bit RSA certificate with ID 2:</p>

<pre><code>OPENSSL_CONF=./hsm.conf openssl req -engine pkcs11 -keyform engine -new -key slot_4-id_2 -nodes -days 3560 -x509 -sha256 -out &quot;rsa2048.tst.raymii.org.pem&quot; -subj &quot;/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=rsa2048.tst.raymii.org&quot;
</code></pre>

<p>The EC certificate:</p>

<pre><code>OPENSSL_CONF=./hsm.conf openssl req -engine pkcs11 -keyform engine -new -key slot_4-id_3 -nodes -days 3560 -x509 -sha256 -out &quot;httpdECprime256v1.tst.raymii.org.pem&quot; -subj &quot;/C=NL/ST=Zuid Holland/L=Rotterdam/O=Sparkling Network/OU=IT Dept/CN=httpdECprime256v1.tst.raymii.org&quot;
</code></pre>

<p>Do note that you can also generate a CSR and submit that to your certificate
provider The getting started article covers that as well.</p>

<p>Convert the PEM certificates into DER format, since DER is what the HSM uses:</p>

<pre><code>openssl x509 -in rsa1024.tst.raymii.org.pem -out rsa1024.tst.raymii.org.der -outform der

openssl x509 -in rsa2048.tst.raymii.org.pem -out rsa2048.tst.raymii.org.der -outform der

openssl x509 -in httpdECprime256v1.tst.raymii.org.pem -out httpdECprime256v1.tst.raymii.org.der -outform der
</code></pre>

<p>Load the DER certificates into the HSM together with the keys:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --write-object rsa1024.tst.raymii.org.der --type cert --id 1 --label &#39;rsa1024&#39;
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x4)
Created certificate:
Certificate Object, type = X.509 cert
  label:      rsa1024
  ID:         01
</code></pre>

<p>THe 2048 bit RSA key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --write-object rsa2048.tst.raymii.org.der --type cert --id 2 --label &#39;rsa2048&#39;
</code></pre>

<p>Output:</p>

<pre><code>Created certificate:
Certificate Object, type = X.509 cert
  label:      rsa2048
  ID:         02
</code></pre>

<p>The EC key:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --write-object httpdECprime256v1.tst.raymii.org.der --type cert --id 3 --label &#39;ECprime256v1&#39;
</code></pre>

<p>Output:</p>

<pre><code>Created certificate:
Certificate Object, type = X.509 cert
  label:      ECprime256v1
  ID:         03
</code></pre>

<p>My HSM now has the following configuration:</p>

<pre><code>pkcs11-tool --module opensc-pkcs11.so --login --pin 648219 --list-objects 
</code></pre>

<p>Output:</p>

<pre><code>Using slot 1 with a present token (0x4)
Private Key Object; RSA 
  label:      rsa1024
  ID:         01
  Usage:      decrypt, sign, unwrap
Certificate Object, type = X.509 cert
  label:      rsa1024
  ID:         01
Public Key Object; RSA 1024 bits
  label:      rsa1024
  ID:         01
  Usage:      encrypt, verify
Certificate Object, type = X.509 cert
  label:      rsa2048
  ID:         02
Public Key Object; RSA 1024 bits
  label:      rsa2048
  ID:         02
  Usage:      encrypt, verify
Private Key Object; RSA 
  label:      rsa2048
  ID:         02
  Usage:      decrypt, sign, unwrap
Private Key Object; EC
  label:      ECprime256v1
  ID:         03
  Usage:      sign, derive
Certificate Object, type = X.509 cert
  label:      ECprime256v1
  ID:         03
Public Key Object; RSA 1024 bits
  label:      ECprime256v1
  ID:         03
  Usage:      encrypt, verify
</code></pre>

<h3 id="toc_3">Configuring Apache and mod_nss</h3>

<p>Make sure that you have Apache and <code>mod_nss</code> installed:</p>

<pre><code>apt-get install apache2 libapache2-mod-nss
</code></pre>

<p>Enable mod_nss with the following command:</p>

<pre><code>a2enmod nss
</code></pre>

<p>Disable <code>mod_ssl</code>:</p>

<pre><code>a2dismod ssl
</code></pre>

<p>On other Linux distro&#39;s you might need to manually change config files. On my
Arch installation I had to add the following to <code>/etc/http/conf/http.conf</code>:</p>

<pre><code>Include conf/extra/nss.conf
</code></pre>

<h4 id="toc_4">Configuring the NSS certificate database</h4>

<p>NSS requires a certificate database. We also need to tell NSS to load the
<code>pkcs11</code> module.</p>

<p>Create the database folder:</p>

<pre><code>mkdir -p /etc/nss/db/
</code></pre>

<p>Create a new NSS database:</p>

<pre><code>certutil -N -d /etc/nss/db/
</code></pre>

<p>It will ask you for a password. Enter a secure one, or, when testing, just pres
RETURN twice. Output:</p>

<pre><code>Enter a password which will be used to encrypt your keys.
The password should be at least 8 characters long,
and should contain at least one non-alphabetic character.

Enter new password: 
Re-enter password: 
</code></pre>

<p>Add the HSM module to NSS. This is where things differ from the other tutorial.
We add the <code>sc-hsm-embedded</code> module here and give it a different name:</p>

<pre><code>modutil -add hsm -libfile /usr/lib/libsc-hsm-pkcs11.so -dbdir /etc/nss/db/
</code></pre>

<p>Enable the module:</p>

<pre><code>modutil -enable hsm -dbdir /etc/nss/db/
</code></pre>

<p>The other module we named <code>pkcs11</code>. If you want to, you could add them both and
switch if needed.</p>

<p>We need the <code>Token Name</code> to put in the <code>mod_nss</code> configuration. Find it:</p>

<pre><code>modutil -dbdir /etc/nss/db/ -list 
</code></pre>

<p>Output, snipped:</p>

<pre><code>  2. hsm
  library name: /usr/lib/libsc-hsm-pkcs11.so
   slots: 2 slots attached
  status: loaded

   slot: Nitrokey Nitrokey HSM (010000000000000000000000) 01 00
  token: SmartCard-HSM
-----------------------------------------------------------
</code></pre>

<p>The name in this case is <code>SmartCard-HSM</code>. List all the certificates with the
<code>certutil</code> command:</p>

<pre><code>certutil -d /etc/nss/db/ -h &#39;SmartCard-HSM&#39; -L 
</code></pre>

<p>Output:</p>

<pre><code>SmartCard-HSM:ECprime256v1                                   u,u,u
SmartCard-HSM:rsa2048                                        u,u,u
SmartCard-HSM:rsa1024                                        u,u,u
</code></pre>

<p>You can view the certificates with the following command:</p>

<pre><code>certutil -d /etc/nss/db -h &#39;SmartCard-HSM&#39; -L -n &quot;SmartCard-HSM:rsa1024&quot; 
</code></pre>

<p>Output:</p>

<pre><code>Enter Password or Pin for &quot;SmartCard-HSM&quot;: 648219
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
            00:ab:93:b2:05:d0:f7:70:6e
        Signature Algorithm: PKCS #1 SHA-256 With RSA Encryption
        Issuer: &quot;CN=rsa1024.tst.raymii.org,OU=IT Dept,O=Sparkling Network,L=R
            otterdam,ST=Zuid Holland,C=NL&quot;
        Validity:
            Not Before: Fri Jul 15 07:38:14 2016
            Not After : Tue Apr 14 07:38:14 2026
        Subject: &quot;CN=rsa1024.tst.raymii.org,OU=IT Dept,O=Sparkling Network,L=
            Rotterdam,ST=Zuid Holland,C=NL&quot;
</code></pre>

<p>(<code>-n</code> names the specific certificate we want to list/show. <code>-a</code> enables ASCII
output.)</p>

<p>Place the PIN for the slot in this file:</p>

<pre><code>cat /etc/nss/db/pin.txt
SmartCard-HSM:648219
</code></pre>

<p>The format is: <code>tokenname:pin</code>.</p>

<p>Also make sure to give the correct permissions to the NSS db:</p>

<pre><code>chown -R http:root /etc/nss/db/
</code></pre>

<h4 id="toc_5">Apache mod_nss configuration</h4>

<p>Make sure you have disabled <code>mod_ssl</code> in the Apache configuration and have
enabled <code>mod_nss</code>. This is my <code>nss.conf</code> file:</p>

<pre><code># grep -v -e &quot;#&quot; -e &#39;^$&#39; /etc/httpd/conf/extra/nss.conf
LoadModule nss_module modules/libmodnss.so
Listen 8443
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl
NSSPassPhraseDialog file:/etc/nss/db/pin.txt
NSSPassPhraseHelper /usr/bin/nss_pcache
NSSEnforceValidCerts off
NSSSessionCacheTimeout 100
NSSSession3CacheTimeout 86400
NSSRandomSeed startup builtin
NSSRenegotiation off
NSSRequireSafeNegotiation off
&lt;VirtualHost _default_:8443&gt;
  DocumentRoot &quot;/etc/httpd/htdocs&quot;
  ServerName rsa1024.tst.raymii.org:8443
  ErrorLog /etc/httpd/logs/error_log
  TransferLog /etc/httpd/logs/access_log
  LogLevel info
  NSSEngine on
  NSSCipherSuite ALL
  NSSProtocol TLSv1.0,TLSv1.1,TLSv1.2
  NSSNickname &quot;SmartCard-HSM:rsa1024&quot;
  NSSCertificateDatabase /etc/nss/db
  &lt;Files ~ &quot;\.(cgi|shtml|phtml|php3?)$&quot;&gt;
      NSSOptions +StdEnvVars
  &lt;/Files&gt;
  &lt;Directory &quot;/var/www/cgi-bin&quot;&gt;
      NSSOptions +StdEnvVars
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;  
</code></pre>

<p>On Arch I had to comment out <code>NSSSessionCacheSize</code> and replace
<code>NSSPassPhraseHelper /usr/libexec/nss_pcache</code> with <code>NSSPassPhraseHelper
/usr/bin/nss_pcache</code>. For the testing certificate I also had to add
<code>NSSEnforceValidCerts off</code>. The rest is just the example config.</p>

<p>Make sure the certificate name is correct here:</p>

<pre><code>NSSNickname &quot;SmartCard-HSM (UserPIN):httpdcert&quot;
</code></pre>

<p>For the two other keys, change the two variables when testing the different keys</p>

<pre><code>  ServerName rsa1024.tst.raymii.org:8443
  NSSNickname &quot;SmartCard-HSM:rsa1024&quot;
</code></pre>

<p>Respectively to their other names.</p>

<p>Restart the webserver to make the configuration active.</p>

<h3 id="toc_6">Benchmarking 2048 bit RSA</h3>

<p>The Nitrokey HSM is not a fast HSM. I&#39;ve worked with HSM&#39;s that are capable of
multiple hundreds of signs per second, and this HSM is not one that can do that.
But, as we know, that&#39;s not the intended target for the device. It&#39;s meant for
safe and secure key storage, for example to encrypt files or protect SSH or
S/MIME keys. I did a few <code>siege</code> benchmarks, and as you can see it is quite
slow.</p>

<p>The page that was being loaded is a plain text file containing only the text
<code>Jeej it works!</code>.</p>

<p>Remember to update your httpd config if needed:</p>

<pre><code>ServerName rsa2048.tst.raymii.org:8443
NSSNickname &quot;SmartCard-HSM:rsa2048&quot;
</code></pre>

<p>A siege test with 5 concurrent users, 30 seconds:</p>

<pre><code>siege -c5 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             36 hits
Availability:             100.00 %
Elapsed time:             29.10 secs
Data transferred:         0.00 MB
Response time:            1.63 secs
Transaction rate:         1.24 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              2.02
Successful transactions:  36
Failed transactions:      0
Longest transaction:      5.13
Shortest transaction:     0.73
</code></pre>

<p>10 concurrent users:</p>

<pre><code>siege -c10 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             38 hits
Availability:             100.00 %
Elapsed time:             29.97 secs
Data transferred:         0.00 MB
Response time:            4.57 secs
Transaction rate:         1.27 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              5.80
Successful transactions:  38
Failed transactions:      0
Longest transaction:      11.15
Shortest transaction:     0.74
</code></pre>

<p>20 concurrent users:</p>

<pre><code>siege -c20 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             37 hits
Availability:             100.00 %
Elapsed time:             29.22 secs
Data transferred:         0.00 MB
Response time:            9.62 secs
Transaction rate:         1.27 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              12.18
Successful transactions:  37
Failed transactions:      0
Longest transaction:      20.47
Shortest transaction:     1.65
</code></pre>

<p>60 benchmark mode:</p>

<pre><code>siege -c60 -b -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<p>This specific test failed, where the NSS log has the following errors:</p>

<pre><code>Broken pipe: SSL library error -5992 writing data
SSL input filter read failed.
SSL Library Error: -8023 Unknown
AH01382: Request header read timeout
</code></pre>

<h3 id="toc_7">Benchmarking 1024 bit RSA</h3>

<p>A <a href="http://www.cardcontact.de/products/SmartCard-HSM_V1.1.pdf">product folder</a> mentions that the HSM should be a bit faster with smaller
keys. Now do note that it&#39;s not recommended to use a 1024 bit key in production.
But, this is just a benchmark test.</p>

<p>A siege test with 5 concurrent users, 30 seconds:</p>

<pre><code>siege -c5 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Lifting the server siege...
Transactions:             49 hits
Availability:             100.00 %
Elapsed time:             29.38 secs
Data transferred:         0.00 MB
Response time:            0.30 secs
Transaction rate:         1.67 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              0.50
Successful transactions:  49
Failed transactions:      0
Longest transaction:      1.09
Shortest transaction:     0.22
</code></pre>

<p>10 concurrent users:</p>

<pre><code>siege -c10 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             109 hits
Availability:             100.00 %
Elapsed time:             29.57 secs
Data transferred:         0.00 MB
Response time:            0.56 secs
Transaction rate:         3.69 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              2.06
Successful transactions:  109
Failed transactions:      0
Longest transaction:      2.39
Shortest transaction:     0.22
</code></pre>

<p>20 concurrent users:</p>

<pre><code>siege -c20 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             134 hits
Availability:             100.00 %
Elapsed time:             29.41 secs
Data transferred:         0.00 MB
Response time:            2.02 secs
Transaction rate:         4.56 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              9.19
Successful transactions:  134
Failed transactions:      0
Longest transaction:      8.12
Shortest transaction:     0.23
</code></pre>

<p>60 benchmark mode:</p>

<pre><code>siege -c60 -b -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             86 hits
Availability:             66.15 %
Elapsed time:             29.09 secs
Data transferred:         0.00 MB
Response time:            11.14 secs
Transaction rate:         2.96 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              32.94
Successful transactions:  86
Failed transactions:      44
Longest transaction:      22.15
Shortest transaction:     0.87
</code></pre>

<h3 id="toc_8">Benchmarking the EC prime256v1 key</h3>

<p>A siege test with 5 concurrent users, 30 seconds:</p>

<pre><code>siege -c5 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:                     55 hits
Availability:                 100.00 %
Elapsed time:                  29.26 secs
Data transferred:               0.00 MB
Response time:                  0.32 secs
Transaction rate:               1.88 trans/sec
Throughput:                     0.00 MB/sec
Concurrency:                    0.60
Successful transactions:          55
Failed transactions:               0
Longest transaction:            1.18
Shortest transaction:           0.22
</code></pre>

<p>10 concurrent users:</p>

<pre><code>siege -c10 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             96 hits
Availability:             100.00 %
Elapsed time:             29.04 secs
Data transferred:         0.00 MB
Response time:            0.76 secs
Transaction rate:         3.31 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              2.52
Successful transactions:  96
Failed transactions:      0
Longest transaction:      3.15
Shortest transaction:     0.25
</code></pre>

<p>20 concurrent users:</p>

<pre><code>siege -c20 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             117 hits
Availability:             100.00 %
Elapsed time:             29.98 secs
Data transferred:         0.00 MB
Response time:            2.57 secs
Transaction rate:         3.90 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              10.02
Successful transactions:  117
Failed transactions:      0
Longest transaction:      7.42
Shortest transaction:     0.49
</code></pre>

<p>30 concurrent users:</p>

<pre><code>siege -c30 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             108 hits
Availability:             91.53 %
Elapsed time:             29.09 secs
Data transferred:         0.00 MB
Response time:            5.09 secs
Transaction rate:         3.71 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              18.90
Successful transactions:  108
Failed transactions:      10
Longest transaction:      19.20
Shortest transaction:     0.51
</code></pre>

<p>40 concurrent users:</p>

<pre><code>siege -c40 -d5 -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             105 hits
Availability:             98.13 %
Elapsed time:             29.52 secs
Data transferred:         0.00 MB
Response time:            6.43 secs
Transaction rate:         3.56 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              22.86
Successful transactions:  105
Failed transactions:      2
Longest transaction:      20.14
Shortest transaction:     0.50
</code></pre>

<p>60 benchmark mode:</p>

<pre><code>siege -c60 -b -t30S https://127.0.0.1:8443
</code></pre>

<p>Result:</p>

<pre><code>Lifting the server siege...
Transactions:             58 hits
Availability:             56.31 %
Elapsed time:             29.42 secs
Data transferred:         0.00 MB
Response time:            10.78 secs
Transaction rate:         1.97 trans/sec
Throughput:               0.00 MB/sec
Concurrency:              21.25
Successful transactions:  58
Failed transactions:      45
Longest transaction:      19.18
Shortest transaction:     2.12
</code></pre>

<h3 id="toc_9">Benchmarking with PHP and Wordpress</h3>

<p>I setup a default PHP (7), MariaDB and Wordpress install with this mod_nss
Apache and ran the some benchmarks on that as well to show how a &#39;real&#39; site
performs. This with the EC key we also used above. Just using the site, browsing
with firefox/chrome and updating/editing posts also works fine, feels snappy
enough.</p>

<p>20 concurrent users:</p>

<pre><code>siege -c20 -d5 -t30S &#39;https://127.0.0.1:8443/wordpress/&#39;
</code></pre>

<p>Result:</p>

<pre><code>Transactions:             132 hits
Availability:             92.96 %
Elapsed time:             29.64 secs
Data transferred:         1.13 MB
Response time:            3.83 secs
Transaction rate:         4.45 trans/sec
Throughput:               0.04 MB/sec
Concurrency:              17.05
Successful transactions:  132
Failed transactions:      10
Longest transaction:      8.15
Shortest transaction:     0.44
</code></pre>

<h3 id="toc_10">Comparing and conclusion</h3>

<p>Most of the benchmarks are comparable to the benchmarks with the OpenSC module.
Except for the EC keypair, since that failed with the OpenSC module. I did try
to switch to the other NSS certificate DB (with the opensc module) but that
failed. So, if you want to use an EC keypair, you need to use this module.</p>

<p>As said in the other article, the HSM is not a fast HSM, but that is not the
target. It&#39;s target is to enable everyone to have secure key storage for a
reasonable price, instead of thousands of dollars for a big-company-name HSM.</p>

<p>This read only module is very nice if you are deploying this HSM in untrusted
places, for example at a client or in a datacenter. It also seperates the HSM
management from the actual usage by the webserver. If you need to renew the
certificate or generate a new keypair, you need to take the device to a machine
with OpenSC and all the tools installed (which can be an offline machine),
instead of the webserver being able to do this. If the webserver ever gets
compromised, they will not be able to edit/delete or otherwise write to the HSM.</p>

<p>One of the next articles will be about a HSM cluster with multiple HSM&#39;s, which
will result in a speed increase.</p>
Tags: <a href="../tags/apache.html">apache</a>
, <a href="../tags/articles.html">articles</a>
, <a href="../tags/cryptoki.html">cryptoki</a>
, <a href="../tags/hsm.html">hsm</a>
, <a href="../tags/mod_nss.html">mod_nss</a>
, <a href="../tags/nitrokey.html">nitrokey</a>
, <a href="../tags/nitrokey-hsm.html">nitrokey-hsm</a>
, <a href="../tags/openssl.html">openssl</a>
, <a href="../tags/pkcs11.html">pkcs11</a>
, <a href="../tags/safenet.html">safenet</a>
, <a href="../tags/sc-hsm-embedded.html">sc-hsm-embedded</a>
, <a href="../tags/smartcard.html">smartcard</a>
, <a href="../tags/smartcard-hsm.html">smartcard-hsm</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
     
    </main>
    </body>
    </html>
    