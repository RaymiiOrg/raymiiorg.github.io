
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Execute a command and get both output and exit status in C++ (Windows & Linux) - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Execute a command and get both output and exit status in C++ (Windows & Linux)</h2>
<p><small>Published: <span data-pagefind-meta='date'>07-06-2021</span> | Author: Remy van Elst | <a href="Execute_a_command_and_get_both_output_and_exit_code.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over three years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">The stackoverflow example using fgets</a>
</li>
<li>
<a href="#toc_1">fread vs fgets</a>
</li>
<li>
<a href="#toc_2">Command execution including output and exit code</a>
<ul>
<li>
<a href="#toc_3">A note on Windows</a>
</li>
</ul>
</li>
<li>
<a href="#toc_4">Nullbytes in output example:</a>
</li>
<li>
<a href="#toc_5">Complete code</a>
</li>
</ul>

</div><hr><div id="contents">
<p>Recently I had to parse some command line output inside a C++ program. Executing a command and getting just the exit status is easy using <code>std::system</code>, but  also getting output is a bit harder and OS specific. By using <code>popen</code>, a POSIX <code>C</code> function we can get both the exit status as well as the output of a given command. On Windows I&#39;m using <code>_popen</code>, so the code should be cross platform, except for the exit status on Windows is alway 0, that concept does not exist there. This article starts off with a stack overflow example to  get just the output of a command and builds on that to a safer version (null-byte handling) that returns both the exit status as well as the command output. It also involves a lot of detail on <code>fread</code> vs <code>fgets</code> and how to handle binary data.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!</a><br><br> </p>

<p>The complete code example with usage examples can be found on <a href="https://github.com/RaymiiOrg/cpp-command-output">github here</a>
or at the bottom of this page. A working example is compiled <a href="https://github.com/RaymiiOrg/cpp-command-output/actions">on github actions</a>
for different platforms (windows &amp; linux).</p>

<p>Normally I would advise against parsing command line output. It is error-prone,
you&#39;re dependent on the language selected by the user, different versions might
have different flags (<code>OS X</code> vs <code>Linux</code>) and much more. If you have the option 
to use a native library, you should use that. An example could be parsing <code>curl</code> 
output to get some data from an API. There are probably a metric ton of <code>http</code> 
libraries available for your favorite programming language to use instead of 
parsing the <code>curl</code> or <code>wget</code> or <code>fetch</code> output. </p>

<p>In my case I have to use an old program to parse a closed-source file to get
some binary output. This is a temporary situation, a native parsing library
is also under development. The binary is under my control as well as the system 
settings, language, other tools and such, so for this specific use case the 
solution to parse command line output was acceptable for the time being.</p>

<p>Do note that in this post I&#39;ll interchange the term nullbyte, null character,
null termination  and null-terminated. They all mean the same, <a href="https://en.wikipedia.org/wiki/Null_character">the null-byte
character</a> used to end a C string (<code>\0</code>, or <code>^@</code>, <code>U+0000</code> or <code>0x00</code>, you
get the gist).</p>

<p>If you need more features, more cross-platform or async execution, <a href="https://www.boost.org/doc/libs/1_76_0/doc/html/process.html">boost.Process</a>
is a great alternative. I however can&#39;t use boost on the environment this code
is going to run due to compiler and size constraints.</p>

<h3 id="toc_0">The stackoverflow example using fgets</h3>

<p>On <a href="http://web.archive.org/web/20210607112805/https://stackoverflow.com/questions/478898/how-do-i-execute-a-command-and-get-the-output-of-the-command-within-c-using-po/478960">stackoverflow</a> the example given is a good base to build on, however,
to get the exit code and the output, it must be modified. Because we want to
also grab the exit code, we cannot use the example which uses the 
<code>std::unique_ptr</code>. Which in itself is a great example of using a <code>unique_ptr</code> with
a custom deleter (<code>cmd</code> is a <code>const char*</code> with the command to execute:</p>

<pre><code>std::unique_ptr&lt;FILE, decltype(&amp;pclose)&gt; pipe(popen(cmd, &quot;r&quot;), pclose);
</code></pre>

<p>The code is copied below:</p>

<pre><code>std::string exec(const char* cmd) {
    char buffer[128];
    std::string result = &quot;&quot;;
    FILE* pipe = popen(cmd, &quot;r&quot;);
    if (!pipe) throw std::runtime_error(&quot;popen() failed!&quot;);
    try {
        while (fgets(buffer, sizeof buffer, pipe) != NULL) 
            result += buffer;
        }
    } catch (...) {
        pclose(pipe);
        throw;
    }
    pclose(pipe);
    return result;
}
</code></pre>

<p>This example does what it states, but with a few gotchas. It uses a <code>FILE*</code>
(pointer), <code>char</code> buffer allocation and manually closing the <code>FILE*</code> when
something goes wrong (<code>catch</code>). The <code>unique_ptr</code> example is more modern, due
to not having to handle the exception and using a <code>std::array&lt;char, 128&gt;</code>
instead of a C-style <code>char*</code> buffer. Exception throwing is a whole other 
issue, but let&#39;s not get into that today. What we are going to get into 
today is C style code to read from <code>FILE*</code> and how binary data is handled.</p>

<p>The stackoverflow example is probably just fine if you only need textual output
into a <code>std::string</code>. My usecase however was a bit more complex, as you&#39;ll
find out while reading the rest of this artice.</p>

<h3 id="toc_1">fread vs fgets</h3>

<p>Code style aside, my biggest issue was that using <code>fgets</code> in this way combined
with adding a <code>const char*</code> to a <code>std::string</code> stops when it encounters a
<code>nullyte</code> (<code>\0</code>). For regular string output that often is not an issue, most
commands just output a few strings and call it a day. My output returns a
binary blob, which might include nullbytes. <code>fread</code> reads an amount of bytes
and returns how much it has read successfully, which we can use when
adding the output to our <code>std::string</code> including the nullbytes.</p>

<p>The example above does <code>result += buffer</code>, adding a <code>const char*</code> to a <code>std::string</code>,
in this case according to <a href="https://en.cppreference.com/w/cpp/string/basic_string">cppreference on operator+= on std::string</a>:
<code>Appends the null-terminated character string pointed to by s.</code></p>

<p>The problem therein lies that the characters after the nullbyte should be
added as well in my case. <code>fgets</code> does not give back the amount of data it
read. Using <code>fgets</code> and a buffer of 128, if I have a nullbyte at 10 and a
newline at 40, then the first 10 bytes plus what is after 40 bytes will be
returned. Effectively we&#39;re loosing everything in between the nullbyte and the
newline, or until the end of the buffer (128) if there is no newline in
between.</p>

<p><code>fread</code> does return the amount of bytes it has read. Combining that with a
constructor of <code>std::string</code> that takes a <code>const char*</code> and a <code>size_t</code> we can
force the entire contents inside the string. This is safe, since a
<code>std::string</code> knows its size, it does not rely on a null-termination
character. However, other code that uses <code>const char*</code> will not be able
to work with these nullbytes, keep that in mind.</p>

<p><a href="http://web.archive.org/web/20210607145050/https://cs50.stackexchange.com/questions/21350/does-fread-really-read-from-the-disc-the-size-and-the-number-of-times-as-it-is">This stackoverflow post</a> was very helpful for me to understand <code>fread</code>, 
as well as help from a co-worker that dreams in <code>C</code>, he explained a lot
of the inner workings.</p>

<p>And if, after all of this, you&#39;re wondering why I&#39;m shoehorning binary data
inside a <code>std::string</code>, great question. I&#39;ll probably go into that another
time since that would require a longer post than this entire article.</p>

<h3 id="toc_2">Command execution including output and exit code</h3>

<p>My code checks the exit status of the executed binary (for error handling) and 
uses the data returned for further processing. To keep this all in one handy
dandy place, lets start with defining a struct to hold that data. It will hold
the result of a <code>command</code>, so the name <code>CommandResult</code> sounds descriptive enough.</p>

<p>Below you&#39;ll find the struct code, including an equality operator as well as a 
stream output operator.</p>

<pre><code>struct CommandResult {
    std::string output;
    int exitstatus;

    friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;os, const CommandResult &amp;result) {
        os &lt;&lt; &quot;command exitstatus: &quot; &lt;&lt; result.exitstatus &lt;&lt; &quot; output: &quot; &lt;&lt; result.output;
        return os;
    }
    bool operator==(const CommandResult &amp;rhs) const {
        return output == rhs.output &amp;&amp;
               exitstatus == rhs.exitstatus;
    }
    bool operator!=(const CommandResult &amp;rhs) const {
        return !(rhs == *this);
    }
};
</code></pre>

<p>The meat and potatoes of the struct are of course the <code>output</code> and <code>exitstatus</code>. I&#39;m
using an <code>int</code> for the exit status <a href="http://web.archive.org/web/20210607185349/https://unix.stackexchange.com/questions/418784/what-is-the-min-and-max-values-of-exit-codes-in-linux">because of reasons</a>. </p>

<p>The next part is the <code>Command</code> class itself, here is that code:</p>

<pre><code>class Command {

public:
    /**
     * Execute system command and get STDOUT result.
     * Like system() but gives back exit status and stdout.
     * @param command system command to execute
     * @return CommandResult containing STDOUT (not stderr) output &amp; exitstatus
     * of command. Empty if command failed (or has no output). If you want stderr,
     * use shell redirection (2&amp;&gt;1).
     */
    static CommandResult exec(const std::string &amp;command) {
        int exitcode = 255;
        std::array&lt;char, 1048576&gt; buffer {};
        std::string result;
#ifdef _WIN32
#define popen _popen
#define pclose _pclose
#define WEXITSTATUS
#endif
        FILE *pipe = popen(command.c_str(), &quot;r&quot;);
        if (pipe == nullptr) {
            throw std::runtime_error(&quot;popen() failed!&quot;);
        }
        try {
            std::size_t bytesread;
            while ((bytesread = fread(buffer.data(), sizeof(buffer.at(0)), sizeof(buffer), pipe)) != 0) {
                result += std::string(buffer.data(), bytesread);
            }
        } catch (...) {
            pclose(pipe);
            throw;
        }
        exitcode = WEXITSTATUS(pclose(pipe));
        return CommandResult{result, exitcode};
    }
}
</code></pre>

<p>The <code>fread</code> command will run until there are no more bytes returned from the
command output. I know the kind of output I&#39;m working with so my buffer is 1
MiB, which is probably too large for your data. In my case I benchmarked it
and between 10KiB and 1 MiB was the fastest on the target architecture. 128 or
8192 is just fine as well probably, but you should benchmark that for
yourself. A rather simple test is to output some enormous file with <code>cat</code> and
take the execution time plus cpu and memory usage. Don&#39;t print the result,
just look at those three things and choose what ratio is acceptable for you.</p>

<p>Why not also initialize the <code>std::string</code> with 1 MiB of characters? <code>std::strings</code>
cannot be allocated for a given size at construction, other than by filling them or
afterwards calling <code>.reserve()</code>, my benchmarks did not show any meaningful speed
or performance boost by doing either.</p>

<p>Using the above code is easy. Since it&#39;s a static function, you don&#39;t need a 
class instance to use it. Here is an example:</p>

<pre><code>std::cout &lt;&lt; Command::exec(&quot;echo &#39;Hello you absolute legends!&#39;&quot;) &lt;&lt; std::endl;
</code></pre>

<p>Which results in:</p>

<pre><code>command exitstatus: 0 output: Hello you absolute legends!
</code></pre>

<p>Since we&#39;re going through a shell, redirection works as well. Redirecting <code>stdout</code> 
to <code>stderr</code> results in no output, just an exit status:</p>

<pre><code>std::cout &lt;&lt; Command::exec(&quot;echo &#39;Hello you absolute legends!&#39; 1&gt;&amp;2&quot;) &lt;&lt; std::endl;
</code></pre>

<p>The output is on <code>stderr</code> in my shell however, which is expected: </p>

<p><img src="/s/inc/img/stderr.png" alt="stderr"></p>

<p>If you do need to capture <code>stderr</code> then you redirect output the other way around, like
so:</p>

<pre><code>std::cout &lt;&lt; Command::exec(&quot;/bin/bash --invalid  2&gt;&amp;1&quot;) &lt;&lt; std::endl;
</code></pre>

<p>Pipes work as well as in your shell, but do note that this is all using <code>sh</code> and you
have no control over environment variables or the default shell. Read more on the 
<a href="http://web.archive.org/web/20210607193329/https://pubs.opengroup.org/onlinepubs/9699919799/functions/popen.html">POSIX page on <code>popen</code></a> to find out why that is.</p>

<h4 id="toc_3">A note on Windows</h4>

<p>Here is an example for Windows, where we <a href="http://web.archive.org/web/20210607191758/https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/popen-wpopen?view=msvc-160">must use <code>_popen</code> and <code>_pclose</code></a>:</p>

<pre><code>std::cout &lt;&lt; &quot;Windows example:&quot; &lt;&lt; std::endl;
std::cout &lt;&lt; Command::exec(&quot;dir * /on /p&quot;) &lt;&lt; std::endl;
</code></pre>

<p>The exit code will always be zero since that concept does not translate to
windows. There is <code>%ErrorLevel%</code>, but that is only an environment variable 
for console applications, not the actual exit status.</p>

<p>The microsoft page also notes that <code>_popen</code> will not work with GUI applications,
just console programs. If you need that, use <a href="https://www.boost.org/doc/libs/1_76_0/doc/html/process.html">Boost.process</a> or <code>system</code>.</p>

<h3 id="toc_4">Nullbytes in output example:</h3>

<p>In the example code on github you&#39;ll also see a <code>execFgets</code> function, I&#39;ve left that
in there to show the difference in nullbyte handling. For reference I&#39;ll show an
example here as well. The relevant part of command using <code>fgets</code>:</p>

<pre><code>while (std::fgets(buffer.data(), buffer.size(), pipe) != nullptr)
    result += buffer.data();
</code></pre>

<p>The part using <code>fread</code>:</p>

<pre><code>std::size_t bytesread;
while ((bytesread = fread(buffer.data(), sizeof(buffer.at(0)), sizeof(buffer), pipe)) != 0)         
    result += std::string(buffer.data(), bytesread);
</code></pre>

<p>The test command, including a clang-tidy warning exclusion (<code>// NOLINT</code>):</p>

<pre><code>int main() {
    using namespace raymii;

    std::string expectedOutput(&quot;test\000abc\n&quot;, 9); //NOLINT
    commandResult nullbyteCommand = command::exec(&quot;/usr/bin/printf &#39;test\\000abc\\n&#39;&quot;); // NOLINT(bugprone-string-literal-with-embedded-nul)
    commandResult fgetsNullbyteCommand = command::execFgets(&quot;/usr/bin/printf &#39;test\\000abc\\n&#39;&quot;); // NOLINT(bugprone-string-literal-with-embedded-nul)

    std::cout &lt;&lt; &quot;Expected output: &quot; &lt;&lt; expectedOutput &lt;&lt; std::endl;
    std::cout &lt;&lt; &quot;Output using fread: &quot; &lt;&lt; nullbyteCommand &lt;&lt; std::endl;
    std::cout &lt;&lt; &quot;Output using fgets: &quot; &lt;&lt; fgetsNullbyteCommand &lt;&lt; std::endl;
    return 0;
}
</code></pre>

<p>Output:</p>

<pre><code>Expected output: test\0abc
A command with nullbytes using fread: exitstatus: 0 output: test\0abc
A command with nullbytes using fgets: exitstatus: 0 output: test
</code></pre>

<p>The nullbyte character is substituted with <code>\0</code> in the above output. Here is a screenshot showing
how it looks in my terminal:</p>

<p><img src="/s/inc/img/nullbytes.png" alt="screenshot"></p>

<p>Once again do note that this is safe to use with <code>std::strings</code>, methods that take a <code>string_view</code> or
a <code>const char*</code> probably will not react very well to nullbytes. For my use case this is safe, your
milage may vary.</p>

<p>Try playing with the <code>buffer</code> size and then looking at the output. If you set it to 4, the output
with <code>fgets</code> is <code>testbc</code>. Funny right? I like such things.</p>

<h3 id="toc_5">Complete code</h3>

<p>Below you can find the header file <code>command.h</code>. It is also on <a href="https://github.com/RaymiiOrg/cpp-command-output">my github</a>. If you want
usage examples you can find them in the github project <code>main.cpp</code> file.</p>

<pre><code>#command.h
#ifndef COMMAND_H
#define COMMAND_H
// Copyright (C) 2021 Remy van Elst
//
//     This program is free software: you can redistribute it and/or modify
//     it under the terms of the GNU General Public License as published by
//     the Free Software Foundation, either version 3 of the License, or
//     (at your option) any later version.
//
//     This program is distributed in the hope that it will be useful,
//     but WITHOUT ANY WARRANTY; without even the implied warranty of
//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//     GNU General Public License for more details.
//
//     You should have received a copy of the GNU General Public License
//     along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
#include &lt;array&gt;
#include &lt;ostream&gt;
#include &lt;string&gt;
#ifdef _WIN32
#include &lt;stdio.h&gt;
#endif

namespace raymii {

    struct CommandResult {
        std::string output;
        int exitstatus;
        friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;os, const CommandResult &amp;result) {
            os &lt;&lt; &quot;command exitstatus: &quot; &lt;&lt; result.exitstatus &lt;&lt; &quot; output: &quot; &lt;&lt; result.output;
            return os;
        }
        bool operator==(const CommandResult &amp;rhs) const {
            return output == rhs.output &amp;&amp;
                   exitstatus == rhs.exitstatus;
        }
        bool operator!=(const CommandResult &amp;rhs) const {
            return !(rhs == *this);
        }
    };

    class Command {
    public:
        /**
             * Execute system command and get STDOUT result.
             * Regular system() only gives back exit status, this gives back output as well.
             * @param command system command to execute
             * @return commandResult containing STDOUT (not stderr) output &amp; exitstatus
             * of command. Empty if command failed (or has no output). If you want stderr,
             * use shell redirection (2&amp;&gt;1).
             */
        static CommandResult exec(const std::string &amp;command) {
            int exitcode = 0;
            std::array&lt;char, 1048576&gt; buffer {};
            std::string result;
#ifdef _WIN32
#define popen _popen
#define pclose _pclose
#define WEXITSTATUS
#endif
            FILE *pipe = popen(command.c_str(), &quot;r&quot;);
            if (pipe == nullptr) {
                throw std::runtime_error(&quot;popen() failed!&quot;);
            }
            try {
                std::size_t bytesread;
                while ((bytesread = std::fread(buffer.data(), sizeof(buffer.at(0)), sizeof(buffer), pipe)) != 0) {
                    result += std::string(buffer.data(), bytesread);
                }
            } catch (...) {
                pclose(pipe);
                throw;
            }
            exitcode = WEXITSTATUS(pclose(pipe));
            return CommandResult{result, exitcode};
        }

    };

}// namespace raymii
#endif//COMMAND_H
</code></pre>
Tags: <a href="../tags/articles.html">articles</a>
, <a href="../tags/c++.html">c++</a>
, <a href="../tags/commandline.html">commandline</a>
, <a href="../tags/cpp.html">cpp</a>
, <a href="../tags/development.html">development</a>
, <a href="../tags/linux.html">linux</a>
, <a href="../tags/printf.html">printf</a>
, <a href="../tags/system.html">system</a>
, <a href="../tags/windows.html">windows</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    