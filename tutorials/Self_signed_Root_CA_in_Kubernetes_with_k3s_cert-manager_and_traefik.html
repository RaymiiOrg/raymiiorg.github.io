
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Self-signed Root CA in Kubernetes with k3s, cert-manager and traefik. Bonus howto on regular certificates - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Self-signed Root CA in Kubernetes with k3s, cert-manager and traefik. Bonus howto on regular certificates</h2>
<p><small>Published: <span data-pagefind-meta='date'>17-07-2024 04:22</span> | Author: Remy van Elst | <a href="Self_signed_Root_CA_in_Kubernetes_with_k3s_cert-manager_and_traefik.txt">Text only version of this article</a>
</small></p>
<br><div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">But why not Let&#39;s Encrypt?</a>
</li>
<li>
<a href="#toc_1">Installing cert-manager</a>
</li>
<li>
<a href="#toc_2">A warning on security and <code>nameConstraints</code></a>
</li>
<li>
<a href="#toc_3">Create the self signed root CA</a>
</li>
<li>
<a href="#toc_4">Create the intermediate CA</a>
</li>
<li>
<a href="#toc_5">Testing the certificates</a>
</li>
<li>
<a href="#toc_6">Ingress (Service) Certificate</a>
</li>
<li>
<a href="#toc_7">Using an existing regular certificate (not self signed)</a>
</li>
</ul>

</div><hr><div id="contents">
<p>Now that I&#39;m learning Kubernetes for a few weeks, I&#39;m finally at the point where I was 20 years ago with regular boring old tech, being able to <a href="/s/tutorials/Kubernetes_k3s_Ingress_for_different_domains_like_virtual_hosts.html">host multiple domains</a>, <a href="/s/tutorials/Password_protect_web_services_in_Kubernetes_k3s_traefik_with_basic_auth.html">password protection</a> and <a href="/s/tutorials/High_Available_k3s_kubernetes_cluster_with_keepalived_galera_and_longhorn.html">high available clusters</a>. It seems we have to re-invent the wheel every time but in the end, it&#39;s just resume-driven development, the underlying stack costs more, is way more complex but for the user, nothing changes, they see the same website as always. <a href="https://luddites.latenightlinux.com/">Not all change is progress</a>. Enough of being a curmudgeon, time to continue with Kubernetes. In this episode of &#39;Remy discovers Kubernetes&#39;, I&#39;m setting up <code>cert-manager</code>, <strong>not with Lets Encrypt</strong>, but with a self-signed certificate authority. I&#39;ll also show you how to set up a regular certificate, one you&#39;ve for example bought somewhere. I&#39;ll also cover <code>nameConstraints</code> to make the risk of compromise of your trusted root ca lower. </p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below. It means the world to me if you  show your appreciation and you'll help pay the server costs:</b><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">GitHub Sponsorship</a><br><br> <a href="https://pcbway.com/g/e7yQRg">PCBWay referral link (You get $5, I get $20 after you've placed an order)</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocea referral link  ($200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!)</a><br><br> </p>

<p>Here&#39;s what we&#39;ll end up with, a trusted local Root CA, Intermediate CA and
Leaf Certificate for a web service:</p>

<p><img src="/s/inc/img/k3s-cert-1.png" alt="end result"></p>

<p>I&#39;m using Kubernetes / k3s version <code>v1.30.2+k3s1</code>.</p>

<h3 id="toc_0">But why not Let&#39;s Encrypt?</h3>

<p>Not that I&#39;m not a huge fan of Let&#39;s Encrypt, <a href="/s/articles/Lets_Encrypt_Directadmin.html">8 years ago I wrote a guide on
using it with DirectAdmin</a>, but
<a href="/s/tutorials/My_First_Kubernetes_k3s_cluster_on_3_Orange_Pi_Zero_3s_including_k8s_dashboard_hello-node_and_failover.html">my Kubernetes cluster</a>
is local only, not reachable from the internet. </p>

<p>That means I cannot use the <code>HTTP-01</code> <a href="https://web.archive.org/web/20240715160300/https://letsencrypt.org/docs/challenge-types/">challenge</a>
and my domain provider has no plugin for the <code>DNS-01</code> challenge. So no
automated certificates for me, since I&#39;m not exposing this setup to the
internet.</p>

<p>Kubernetes <a href="https://web.archive.org/web/20240703163618/https://cert-manager.io/">cert-manager</a> is a
native application that automates the management and issuance of TLS
certificates within Kubernetes clusters. It provides a set of custom
resources to issue certificates, attach them to services, and simplifies the
process of obtaining, renewing, and using those certificates.</p>

<p>In my case, it is possible to use <a href="https://web.archive.org/web/20240715160644/https://cert-manager.io/docs/configuration/ca/">your own CA</a>
and get the benefit of automated issuance, secret management and renewal.</p>

<p>I can simply trust the self signed root certificate and all certificates
issued by that CA will be trusted in my browser. </p>

<p>You can also buy a certificate, for example, an extended validation (EV) cert
and set that up. I&#39;ll cover that later on in this guide as well.</p>

<h3 id="toc_1">Installing cert-manager</h3>

<p>I&#39;m using <code>Helm</code> to install <code>cert-manager</code>. In <a href="/s/tutorials/My_First_Kubernetes_k3s_cluster_on_3_Orange_Pi_Zero_3s_including_k8s_dashboard_hello-node_and_failover.html">my first article</a>
I covered the admin workstation setup so I assume you have <code>kubectl</code> set up.
I&#39;ll also assume you have a <a href="/s/tutorials/Kubernetes_k3s_Ingress_for_different_domains_like_virtual_hosts.html">domain name for your cluster</a>
to use in the certificate. I&#39;m continuing with the <code>echoapp</code> from<a href="/s/tutorials/Kubernetes_k3s_Ingress_for_different_domains_like_virtual_hosts.html">that guide</a>.</p>

<p>Use the following commands to add the Helm repo:</p>

<pre><code>helm repo add jetstack https://charts.jetstack.io
helm repo update
</code></pre>

<p>Install <code>cert-manager</code> with Helm:</p>

<pre><code>helm install \
  cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.15.1 \
  --set crds.enabled=true \
  --set webhook.timeoutSeconds=4 \
  --set replicaCount=2 \
  --set podDisruptionBudget.enabled=true \
  --set podDisruptionBudget.minAvailable=1
</code></pre>

<p>Output:</p>

<pre><code>cert-manager v1.15.1 has been deployed successfully!

In order to begin issuing certificates, you will need to set up a ClusterIssuer
or Issuer resource (for example, by creating a &#39;letsencrypt-staging&#39; issuer).

More information on the different types of issuers and how to configure them
can be found in our documentation:

https://cert-manager.io/docs/configuration/

For information on how to configure cert-manager to automatically provision
Certificates for Ingress resources, take a look at the `ingress-shim`
documentation:

https://cert-manager.io/docs/usage/ingress/
</code></pre>

<p>Create a folder for your yaml files:</p>

<pre><code>mkdir certmanager
cd certmanager
</code></pre>

<h3 id="toc_2">A warning on security and <code>nameConstraints</code></h3>

<p>You are at risk if the Root CA key is compromised. If the key is stolen, it can be 
used to create trusted certificates for everything. Luckily there is something 
we can do, using <code>nameConstraints</code> to limit the scope of the Root Certificate to, 
in our case, a single domain (<code>k3s.homelab.mydomain.org</code>). This means that if 
your key would be compromised, it would only be able to issue certificates for 
anything under that domain, not your bank for example.</p>

<p><a href="https://tools.ietf.org/html/rfc5280">RFC 5280</a> provides for something called
<code>Name Constraints</code>, which allow an X.509 CA to have a scope limited to
certain names, including the parent domains of the certificates issued by the
CA. For example, a host constraint of <code>.example.com</code> allows the CA to issue
certificates for anything under <code>.example.com</code>, but not any other host. For
other hosts, clients will fail to validate the chain. <a href="https://web.archive.org/web/20240415204151/http://www.pkiglobe.org/name_constraints.html">More info here</a>.</p>

<p><strong>See <a href="/s/tutorials/nameConstraints_on_your_Self_Signed_Root_CA_in_Kubernetes_with_cert_manager.html">my guide on nameConstraints</a>
to set that up along with this guide.</strong></p>

<h3 id="toc_3">Create the self signed root CA</h3>

<p>The topmost certificate in our certificate chain will be a self signed
certificate authority, the so called <code>Root CA</code>.  The Root CA signs one or
more intermediate CA&#39;s, which in turn sign leaf certificates. For example,
for <code>raymii.org</code>, the Root CA is <code>USERTrust RSA Certification Authority</code>. The
intermediate CA is <code>Sectigo RSA Domain Validation Secure Server CA</code> and the
leaf certificate is for this site, <code>raymii.org</code>:</p>

<p><img src="/s/inc/img/k3s-cert-2.png" alt="raymii chain"></p>

<p>For an actual trusted root CA, the root certificate would be offline in a <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html">HSM
(hardware security module)</a> 
and is only used to sign intermediate CA&#39;s once in a while. </p>

<p>For our setup, this <code>Root CA</code> certificate is the only certificate you have to
import in your OS / browser to make all issued certificates trusted.</p>

<p>Create a file to describe this resource:</p>

<pre><code>vim spnw-root-ca.yaml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: spnw-root-ca-issuer-selfsigned
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: spnw-root-ca
  namespace: cert-manager
spec:
  isCA: true
  commonName: spnw-root-ca
  secretName: spnw-root-ca-secret
  duration: 87600h # 10y
  renewBefore: 78840h # 9y
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: spnw-root-ca-issuer-selfsigned
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: spnw-root-ca-issuer
spec:
  ca:
    secretName: spnw-root-ca-secret
</code></pre>

<p>Things to note are the <code>isCA</code> attribute, the <code>duration</code> and the <code>renewBefore</code>.
For a Root CA you want those to be long.</p>

<p>Apply it:</p>

<pre><code>kubectl -n cert-manager apply -f spnw-root-ca.yaml
</code></pre>

<p>Output:</p>

<pre><code>clusterissuer.cert-manager.io/spnw-root-ca-issuer-selfsigned created
certificate.cert-manager.io/spnw-root-ca created
clusterissuer.cert-manager.io/spnw-root-ca-issuer created
</code></pre>

<p>Check if creation worked and view info about the root certificate:</p>

<pre><code>kubectl describe ClusterIssuer -n cert-manager
</code></pre>

<p>Output:</p>

<pre><code>Name:         spnw-root-ca-issuer
Namespace:
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  cert-manager.io/v1
Kind:         ClusterIssuer
Metadata:
  Creation Timestamp:  2024-07-16T03:56:25Z
  Generation:          1
  Resource Version:    2329384
  UID:                 70[...]59
Spec:
  Ca:
  Secret Name:  spnw-root-ca-secret
Status:
  Conditions:
  Last Transition Time:  2024-07-16T03:56:25Z
  Message:               Signing CA verified
  Observed Generation:   1
  Reason:                KeyPairVerified
  Status:                True
  Type:                  Ready
Events:
  Type    Reason           Age                From                         Message
  ----    ------           ----               ----                         -------
  Normal  KeyPairVerified  37s (x2 over 37s)  cert-manager-clusterissuers  Signing CA verified


Name:         spnw-root-ca-issuer-selfsigned
Namespace:
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  cert-manager.io/v1
Kind:         ClusterIssuer
Metadata:
  Creation Timestamp:  2024-07-16T03:56:25Z
  Generation:          1
  Resource Version:    2329379
  UID:                 9e[...]e
Spec:
  Self Signed:
Status:
  Conditions:
  Last Transition Time:  2024-07-16T03:56:25Z
  Observed Generation:   1
  Reason:                IsReady
  Status:                True
  Type:                  Ready
Events:                    &lt;none&gt;
</code></pre>

<p>You can query the <code>Secret</code> to fetch the <code>Certificate</code> which in turn can be
 fed into <code>openssl</code> to see the attributes:</p>

<pre><code>kubectl get secret spnw-root-ca-secret -n cert-manager -o jsonpath=&#39;
{.data.tls\.crt}&#39; |  base64 --decode | openssl x509 -noout -text
</code></pre>

<p>The secret has multiple filenames, <code>tls.crt</code> contains the certificate,
<code>tls.key</code> contains the private key.</p>

<p>Output:   </p>

<pre><code>Certificate:
  Data:
    Version: 3 (0x2)
    Serial Number:
      86:9[...]d:e8
    Signature Algorithm: ecdsa-with-SHA256
    Issuer: CN = spnw-root-ca
    Validity
      Not Before: Jul 16 04:04:23 2024 GMT
      Not After : Jul 14 04:04:23 2034 GMT
    Subject: CN = spnw-root-ca
    Subject Public Key Info:
      Public Key Algorithm: id-ecPublicKey
        Public-Key: (256 bit)
        pub:
          04:8[...]f5
        ASN1 OID: prime256v1
        NIST CURVE: P-256
    X509v3 extensions:
      X509v3 Key Usage: critical
        Digital Signature, Key Encipherment, Certificate Sign
      X509v3 Basic Constraints: critical
        CA:TRUE
      X509v3 Subject Key Identifier:
        70:[...]:45
  Signature Algorithm: ecdsa-with-SHA256
</code></pre>

<p>Note the <code>Not After</code> date being 10 years later than the <code>Not Before</code> date. For
a root certificate you want long validity.</p>

<h3 id="toc_4">Create the intermediate CA</h3>

<p>This intermediate CA will sign the certificates for our services. The YAML
looks a lot like the root ca, but it&#39;s missing the <code>SelfSigned</code> issuer and
the actual <code>Issuer</code> is our freshly created root ca.</p>

<pre><code>vim spnw-intermediate-ca1.yaml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: spnw-intermediate-ca1
  namespace: cert-manager
spec:
  isCA: true
  commonName: spnw-intermediate-ca1
  secretName: spnw-intermediate-ca1-secret
  duration: 43800h # 5y
  renewBefore: 35040h # 4y
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: spnw-root-ca-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: spnw-intermediate-ca1-issuer
spec:
  ca:
    secretName: spnw-intermediate-ca1-secret
</code></pre>

<p>This intermediate CA has a shorter validity. You can get information on the CA
the same way as before:</p>

<pre><code>kubectl describe ClusterIssuer -n cert-manager
</code></pre>

<p>Output:</p>

<pre><code>Name:         spnw-intermediate-ca1-issuer
Namespace:
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
API Version:  cert-manager.io/v1
Kind:         ClusterIssuer
Metadata:
  Creation Timestamp:  2024-07-16T04:15:03Z
  Generation:          1
  Resource Version:    2334652
  UID:                 b[...]9e04
Spec:
  Ca:
  Secret Name:  spnw-intermediate-ca1-secret
Status:
  Conditions:
  Last Transition Time:  2024-07-16T04:15:28Z
  Message:               Signing CA verified
  Observed Generation:   1
  Reason:                KeyPairVerified
  Status:                True
  Type:                  Ready
</code></pre>

<p>And as before, you can query the <code>Secret</code> to get the certificate data in OpenSSL:</p>

<pre><code>kubectl get secret spnw-intermediate-ca1-secret -n cert-manager -o
jsonpath=&#39;{.data.tls\.crt}&#39; |  base64 --decode | openssl
x509 -noout -text
</code></pre>

<p>Output:</p>

<pre><code>Certificate:
  Data:
    Version: 3 (0x2)
    Serial Number:
      bc:09:f4:5e:75:92:11:c3:af:68:81:45:30:22:06:76
    Signature Algorithm: ecdsa-with-SHA256
    Issuer: CN = spnw-root-ca
    Validity
      Not Before: Jul 16 04:15:08 2024 GMT
      Not After : Jul 15 04:15:08 2029 GMT
    Subject: CN = spnw-intermediate-ca1
</code></pre>

<p>You can also use <code>openssl</code> to test that the intermediate CA was actually
signed by the Root CA:</p>

<pre><code> openssl verify -CAfile &lt;(kubectl -n cert-manager get secret
 spnw-root-ca-secret -o jsonpath=&#39;{.data.tls\.crt}&#39; | base64 --decode) &lt;
 (kubectl -n cert-manager get secret spnw-intermediate-ca1-secret -o
 jsonpath=&#39;{.data.tls\.crt}&#39; | base64 --decode)
</code></pre>

<p>This commands queries the two secrets for the public keys, then passes the
output of that as a file to <code>openssl</code>, using the <code>&lt;()</code> <a href="https://web.archive.org/web/20240716174815/https://superuser.com/questions/1059781/what-exactly-is-in-bash-and-in-zsh/1060002#1060002">process substitution syntax</a>.</p>

<p>Output:</p>

<pre><code>/dev/fd/62: OK
</code></pre>

<p>If you get an error like below:</p>

<pre><code>error 20 at 0 depth lookup: unable to get local issuer certificate
error /dev/fd/62: verification failed
</code></pre>

<p>Then something went wrong. <code>openssl x509</code> is your friend when debugging.</p>

<p>If you want to remove and re-issue all the above, you must also delete the
secrets associated. This will not happen automatically if you <code>kubectl
delete -f .</code> the resources:</p>

<pre><code>kubectl -n cert-manager delete secret spnw-root-ca-secret spnw-intermediate-ca1-secret
</code></pre>

<p>Otherwise you might notice that your certificates have not changed, even
though you thought you re-issued them.</p>

<h3 id="toc_5">Testing the certificates</h3>

<p>This step is optional, but might help you troubleshoot any issues. We&#39;re going
to issue a test certificate, which we&#39;ll test with the <code>openssl</code> command line
tooling to validate our certificate and chain.</p>

<p>Create a yaml file:</p>

<pre><code>vim test-cert.yaml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: cert-test
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: test-server
  namespace: cert-test
spec:
  secretName: test-server-secret
  isCA: false
  usages:
    - server auth
    - client auth
  dnsNames:
  - &quot;test-server.cert-test.svc.cluster.local&quot;
  - &quot;test-server&quot;
  issuerRef:
    name:  spnw-intermediate-ca1-issuer
    kind: ClusterIssuer
</code></pre>

<p>Apply:</p>

<pre><code>kubectl apply -f test-cert.yaml
</code></pre>

<p>Output:</p>

<pre><code>namespace/cert-test created
certificate.cert-manager.io/test-server created
</code></pre>

<p>Use the <code>openssl verify</code> command to check the chain. The first parameter is
<code>-CAFile</code>, with the <code>&lt;()</code> shell construct to get the output of the <code>kubectl</code>
command which gets the <code>Secret</code> for the Root CA. The second parameter,
<code>-untrusted</code>, contains our intermediate CA in the same way and the last,
unnamed, parameter contains our leaf certificate:</p>

<pre><code>openssl verify -CAfile &lt;(kubectl -n cert-manager get secret
spnw-root-ca-secret -o jsonpath=&#39;{.data.tls\.crt}&#39; |
base64 --decode) -untrusted  &lt;(kubectl -n cert-manager get secret
spnw-intermediate-ca1-secret -o jsonpath=&#39;{.data.tls\.crt}&#39; |
base64 --decode) &lt;(kubectl -n cert-test get secret test-server-secret -o
jsonpath=&#39;{.data.tls\.crt}&#39; | base64 --decode)
</code></pre>

<p>Output:</p>

<pre><code>/dev/fd/61: OK
</code></pre>

<p>See <a href="http://web.archive.org/web/20240716044328/https://stackoverflow.com/questions/25482199/verify-a-certificate-chain-using-openssl-verify/26520714#26520714">this link</a> 
for more info on why we must provide the intermediate CA via the <code>-untrusted</code> parameter.</p>

<p>You can also use this shell command to feed all certificates in the <code>Secret</code>
to <code>openssl</code>. The <code>sed</code> magic is there because <code>openssl</code> only parses the
first certificate in the output, and there might be multiple. </p>

<pre><code>OLDIFS=$IFS; IFS=&#39;:&#39; certificates=$(kubectl get secret
test-server-secret -n cert-test -o json | jq -r &#39;.data[&quot;tls.crt&quot;]&#39; |
base64 --decode | sed -n &#39;/-----BEGIN/,/-----END/{/-----BEGIN/ s/^/:/;
p}&#39;); for certificate in ${certificates#:}; do echo $certificate |
openssl x509 -noout  -ext subjectAltName -subject -issuer; echo;
done; IFS=$OLDIFS
</code></pre>

<p>Output:</p>

<pre><code>X509v3 Subject Alternative Name: critical
  DNS:test-server.cert-test.svc.cluster.local, DNS:test-server
subject=
issuer=CN = spnw-intermediate-ca1

No extensions in certificate
subject=CN = spnw-intermediate-ca1
issuer=CN = spnw-root-ca
</code></pre>

<p>Same for the CA as known by our issued test certificate. This file has only 1
certificate in my case, but it&#39;s good practice to make sure the command goes
well if in the future there might be multiple certificates in such output:</p>

<pre><code>OLDIFS=$IFS; IFS=&#39;:&#39; certificates=$(kubectl get secret
test-server-secret -n cert-test -o json | jq -r &#39;.data[&quot;ca.crt&quot;]&#39; |
base64 --decode | sed -n &#39;/-----BEGIN/,/-----END/{/-----BEGIN/ s/^/:/;
p}&#39;); for certificate in ${certificates#:}; do echo $certificate |
openssl x509 -noout  -ext subjectAltName -subject -issuer; echo &quot;---&quot;;
done; IFS=$OLDIFS
</code></pre>

<p>Output:</p>

<pre><code>No extensions in certificate
subject=CN = spnw-root-ca
issuer=CN = spnw-root-ca
</code></pre>

<p>After testing you can delete the test certificates and namespace:</p>

<pre><code>kubectl delete -f test-certificate.yaml
</code></pre>

<p>Output:</p>

<pre><code>namespace &quot;cert-test&quot; deleted
certificate.cert-manager.io &quot;test-server&quot; deleted
</code></pre>

<h3 id="toc_6">Ingress (Service) Certificate</h3>

<p>After all that hard setup and testing we can finally use our self signed CA to
automatically issue a certificate for our <code>echo</code> app.</p>

<p>In <a href="/s/tutorials/Kubernetes_k3s_Ingress_for_different_domains_like_virtual_hosts.html">my other article on how to host multiple domains</a>,
I set up an <code>echo</code> app service as a simple test and coupled a hostname to
that app (<code>echo.k3s.homelab.mydomain.org</code>). I assume you have that setup as
well.</p>

<p>Edit (or create) the <code>Ingress</code>:</p>

<pre><code>vim echoapp-ingress.yaml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-ingress
  namespace: echoapp
  annotations:
    cert-manager.io/cluster-issuer: spnw-intermediate-ca1-issuer
    cert-manager.io/common-name: &quot;echo.k3s.homelab.mydomain.org&quot;
spec:
  ingressClassName: traefik
  rules:
  - host: echo.k3s.homelab.mydomain.org
    http:
      paths:
        - pathType: Prefix
        path: &quot;/&quot;
        backend:
          service:
            name: echo-service
            port:
              number: 80
  tls:
  - hosts:
    - echo.k3s.homelab.mydomain.org
  secretName: echo-cert-secret
</code></pre>

<p>Things to note in this file are the <code>annotations</code> and the <code>tls</code> part.</p>

<pre><code>annotations:
  cert-manager.io/cluster-issuer: spnw-intermediate-ca1-issuer
  cert-manager.io/common-name: &quot;echo.k3s.homelab.mydomain.org&quot;
</code></pre>

<p>The annotation <code>cluster-issuer</code> tells <code>ingress-shim</code> which <code>ClusterIssuer</code> to
use and for backwards compatibility I&#39;ve included the annotation
<code>common-name</code>. If you omit the latter annotation, you will be issued a
<code>Certificate</code> with an empty <code>Subject</code>. This is not a <a href="https://web.archive.org/web/20240716170039/https://github.com/caddyserver/caddy/issues/3755">bad thing</a>
but not all software understands <code>Subject Alternative Names</code> and not all
software can handle an empty <code>Subject</code>. </p>

<p>The sub-component <code>ingress-shim</code> watches <code>Ingress</code> resources across your
cluster. If it observes an <code>Ingress</code> with annotations described in
<a href="https://web.archive.org/web/20240716165737/https://cert-manager.io/docs/usage/ingress/">the Supported Annotations</a>
section, it will ensure a <code>Certificate</code> resource with the name provided in
the <code>tls.secretName</code> field and configured as described on the <code>Ingress</code>
exists in the <code>Ingress&#39;s</code> namespace.</p>

<p>As you can see, the <code>tls</code> section contains the hostname and a <code>Secret</code> to use:</p>

<pre><code>  tls:
  - hosts:
    - echo.k3s.homelab.mydomain.org
  secretName: echo-cert-secret
</code></pre>

<p>If this secret already exists, it will use <code>tls.crt</code>, <code>ca.crt</code> and <code>tls.key</code>
respectively. If the secret does not exist, <code>ingress-shim</code> will make sure a
new <code>Certificate</code> is issued. </p>

<p>Apply the config:</p>

<pre><code>kubectl -n echoapp apply -f echoapp-ingress.yaml
</code></pre>

<p>Output:</p>

<pre><code>ingress.networking.k8s.io/echo-ingress created  
</code></pre>

<p>You can check if the <code>Certificate</code> was issued correctly:</p>

<pre><code>kubectl describe Certificate -n echoapp
</code></pre>

<p>Output:</p>

<pre><code>Name:         echo-cert-secret
Namespace:    echoapp
API Version:  cert-manager.io/v1
Kind:         Certificate
Metadata:     
  Kind:                  Ingress
  Name:                  echo-ingress
  [...]
Spec:
  Common Name:  echo.k3s.homelab.mydomain.org
  Dns Names:
  echo.k3s.homelab.mydomain.org
  Issuer Ref:
  Group:      cert-manager.io
  Kind:       ClusterIssuer
  Name:       spnw-intermediate-ca1-issuer
  Secret Name:  echo-cert-secret
  Usages:
  digital signature
  key encipherment
Status:
  Conditions:
  Last Transition Time:  2024-07-16T04:57:57Z
  Message:               Certificate is up to date and has not expired
  Observed Generation:   1
  Reason:                Ready
  Status:                True
  Type:                  Ready
  Not After:               2024-10-14T04:57:56Z
  Not Before:              2024-07-16T04:57:56Z
  Renewal Time:            2024-09-14T04:57:56Z
Events:                    &lt;none&gt;
</code></pre>

<p>As we did above, you can get the contents of the <code>Certificate</code> and pipe that
into <code>openssl</code> to see more info:</p>

<pre><code>kubectl get secret echo-cert -n echoapp  -o jsonpath=&#39;{.data.tls\.crt}&#39; |
base64 --decode | openssl x509 -noout -ext
subjectAltName -subject -issuer
</code></pre>

<p>Output:</p>

<pre><code>X509v3 Subject Alternative Name:
  DNS:echo.k3s.homelab.mydomain.org
subject=CN = echo.k3s.homelab.mydomain.org
issuer=CN = spnw-intermediate-ca1
</code></pre>

<p>After importing the root CA (as a <code>.crt</code> file containing the PEM contents) in
Windows via <code>certmgr.msc</code> as a  <code>Trusted Root Certificate Authority</code>:</p>

<p><img src="/s/inc/img/k3s-cert-3.png" alt="certmgr"></p>

<p>All browsers trust sites with a certificate issued by our Root CA:</p>

<p><img src="/s/inc/img/k3s-cert-1.png" alt="full chain"></p>

<h3 id="toc_7">Using an existing regular certificate (not self signed)</h3>

<p>If you have bought a certificate somewhere (like <code>Sectigo</code>), or a certificate
issues by another internal CA (not in Kubernetes) and want to use that on
your cluster, you can create a secret manually and use it in your <code>Ingress</code>.
You must omit the <code>cert-manager.io</code> <code>annotations</code> in your <code>Ingress</code> and
reference the existing <code>Secret</code> in your  <code>tls</code> section. </p>

<p>Place the PEM encoded certificate you received from your CA in a file named
<code>tls.crt</code>. Append the (entire) intermediate chain to that file, so at the top
you have your certificate and below, in order, the certificate chain.</p>

<p>Place your PEM encoded private key in a file named <code>tls.key</code>. Execute the
following command to create a <code>Secret</code>. Note that it is a <code>generic</code> secret,
not a <code>tls</code> type secret. <code>tls</code> type secrets are handled by <code>cert-manager</code> and
we don&#39;t want that in this case.</p>

<pre><code> kubectl create secret generic
 echo-cert-official --from-file=tls.crt=tls.crt --from-file=tls.key=tls.key
 -n echoapp
</code></pre>

<p>Output:   </p>

<pre><code>secret/echo-cert-official created
</code></pre>

<p>In your <code>Ingress</code> yaml file, you must refer to the secret by name:</p>

<pre><code>tls:
  [...]
  secretName: echo-cert-official
</code></pre>

<p>Apply the <code>Ingress</code> and after a few seconds, your site will serve
the &quot;official&quot; certificate.     </p>
Tags: <a href="../tags/aarch64.html">aarch64</a>
, <a href="../tags/apache.html">apache</a>
, <a href="../tags/arm.html">arm</a>
, <a href="../tags/armbian.html">armbian</a>
, <a href="../tags/certificates.html">certificates</a>
, <a href="../tags/chain.html">chain</a>
, <a href="../tags/cloud.html">cloud</a>
, <a href="../tags/helm.html">helm</a>
, <a href="../tags/k3s.html">k3s</a>
, <a href="../tags/k8s.html">k8s</a>
, <a href="../tags/kubernetes.html">kubernetes</a>
, <a href="../tags/linux.html">linux</a>
, <a href="../tags/openssl.html">openssl</a>
, <a href="../tags/orange-pi.html">orange-pi</a>
, <a href="../tags/pki.html">pki</a>
, <a href="../tags/private-key.html">private-key</a>
, <a href="../tags/public-key.html">public-key</a>
, <a href="../tags/raspberry-pi.html">raspberry-pi</a>
, <a href="../tags/s_client.html">s_client</a>
, <a href="../tags/ssl.html">ssl</a>
, <a href="../tags/tutorials.html">tutorials</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    