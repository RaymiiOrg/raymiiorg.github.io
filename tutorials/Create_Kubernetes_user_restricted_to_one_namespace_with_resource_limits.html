
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Create Kubernetes user restricted to one namespace with resource limits - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Create Kubernetes user restricted to one namespace with resource limits</h2>
<p><small>Published: <span data-pagefind-meta='date'>29-07-2024 04:39</span> | Author: Remy van Elst | <a href="Create_Kubernetes_user_restricted_to_one_namespace_with_resource_limits.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over one years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Creating a Namespace with a <code>ResourceQuota</code></a>
</li>
<li>
<a href="#toc_1">Create a Deployment with resource limits</a>
</li>
<li>
<a href="#toc_2">Creating a user restricted to one namespace</a>
</li>
<li>
<a href="#toc_3">Creating a kubeconfig file for the user</a>
</li>
</ul>

</div><hr><div id="contents">
<p>This guide shows you how to use Role-based access control (RBAC) to create a user account that only has rights for one specific namespace. I&#39;ll also show you how to limit the resource usage of that  <code>Namespace</code>.  Last but not least, I&#39;ll also show you how to create a <code>kubeconfig</code> file for that specific user.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below. It means the world to me if you  show your appreciation and you'll help pay the server costs:</b><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">GitHub Sponsorship</a><br><br> <a href="https://pcbway.com/g/e7yQRg">PCBWay referral link (You get $5, I get $20 after you've placed an order)</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocea referral link  ($200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!)</a><br><br> </p>

<p>You can use this guide to set up a limited resource for one team for example,
to make sure they cannot mess up other parts of the cluster or slow down
other stuff due to claiming too many resources. My sysadmin / devops
experience tells me that no matter what, if there are no limits or guard
rails, developers (especially web and PHP developers, they are the worst
kind, see <a href="https://it-notes.dragas.net/2024/07/04/from-cloud-chaos-to-freebsd-efficiency/#lessons-learned">this article for example, a hacked cluster and all the
web-developers did was scale up due to &quot;performance&quot;. An actually skilled
developer would look into the problem, do profiling and fix pain points
before scaling out (and have their basic security in order).</a>)
will mess up operations, no matter how well intended. Better to protect them
against themselves than to be woken up in the middle of the night.</p>

<p><img src="/s/inc/img/k3s-namespace-2.png" alt="dashboard"></p>

<blockquote>
<p>The Kubernetes Dashboard for this one user with permissions in only that namespace</p>
</blockquote>

<p><img src="/s/inc/img/k3s-namespace-1.png" alt="resource quotas"></p>

<blockquote>
<p>Resource limits in the namespace</p>
</blockquote>

<p>To read all my <a href="/s/tags/kubernetes.html">Kubernetes posts, click here</a>. I&#39;m
using Kubernetes / k3s version <code>v1.30.2+k3s1</code> and for the purposes of this
guide I assume you have <code>kubectl</code> set up and working with an admin user.</p>

<p>The <a href="https://web.archive.org/web/20240729082142/https://kubernetes.io/docs/reference/access-authn-authz/rbac/">official documentation</a>
is a great resource which explains this stuff in more detail. This is a
practical guide for a single purpose (namely to create a namespace for a user
with resource limits and denying the user access to further namespaces). </p>

<p>Make sure to also read up on <a href="https://web.archive.org/web/20240729102458/https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping">privilege escalation</a>
in Kubernetes.</p>

<p>A few terms require some more explanation: </p>

<ul>
<li><code>Role</code>: A role contains rules that represent a set of permissions. A role is
used to grant access to resources within a namespace. Permissions are
purely additive (there are no &quot;deny&quot; rules). A <code>Role</code> is always Namespaced
(as opposed to a <code>ClusterRole</code>)</li>
<li><code>RoleBinding</code>: A role binding is used to grant the permissions defined in a
role to a user or set of users. It holds a list of subjects (users, groups,
or service accounts), and a reference to the role being granted</li>
<li><code>Service Account</code>: account meant for processes, which run in pods
(something that talks to Kubernetes). Or in our case, <code>kubeconfig</code></li>
</ul>

<p>Create a folder in which we will put all the <code>yaml</code> files:</p>

<pre><code>mkdir user-demo
cd user-demo
</code></pre>

<h3 id="toc_0">Creating a Namespace with a <code>ResourceQuota</code></h3>

<p>Create a file for your namespace:</p>

<pre><code>vim namespace.yml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: user-demo
</code></pre>

<p>Apply it:</p>

<pre><code>kubectl apply -f namespace.yml
</code></pre>

<p>Output:</p>

<pre><code>namespace/user-demo created
</code></pre>

<p>Create a file with the resource limits for this namespace:</p>

<pre><code>vim resource-quota.yml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: v1
kind: ResourceQuota
metadata:
  name: user-demo-quota
  namespace: user-demo
spec:
  hard:
  requests.cpu: &quot;1&quot;
  requests.memory: 1Gi
  limits.cpu: &quot;2&quot;
  limits.memory: 2Gi
</code></pre>

<p>Apply the quota:</p>

<pre><code>kubectl apply -f resource-quota.yml
</code></pre>

<p>The above  <code>ResourceQuota</code> places these requirements on the <code>user-demo</code> namespace:</p>

<ul>
<li>For every Pod in the namespace, each container must have a memory request,
memory limit, cpu request, and cpu limit.</li>
<li>The memory request total for all Pods in that namespace must not exceed 800
MiB. The memory limit total for all Pods in that namespace must not exceed
950 MiB.</li>
<li>The CPU request total for all Pods in that namespace must not exceed 1 cpu.</li>
<li>The CPU limit total for all Pods in that namespace must not exceed 2 cpu.</li>
</ul>

<p>This means that in your <code>Deployment</code> yaml files you must make sure there are
resource limits. Below is an example.</p>

<h3 id="toc_1">Create a Deployment with resource limits</h3>

<p>We&#39;ll create two deployments, one of which will succeed and one of which will
fail due to resource limitations.</p>

<p>Create a file for our test deployments:</p>

<pre><code>vim deployment.yml
</code></pre>

<p>Contents:</p>

<pre><code>  ---
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: echo-1
    namespace: user-demo
  spec:
    replicas: 1
    selector:
    matchLabels:
      app: echo-1
    template:
    metadata:
      labels:
      app: echo-1
    spec:
      containers:
      - name: echo-1
        image: ealen/echo-server:latest
        ports:
        - containerPort: 80
        livenessProbe:
        httpGet:
          path: /?echo_code=200
          port: 80
        readinessProbe:
        httpGet:
          path: /?echo_code=200
          port: 80
        resources:
        limits:
          cpu: 800m
          memory: 600Mi
        requests:
          cpu: 600m
          memory: 400Mi
  ---

  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: echo-2
    namespace: user-demo
  spec:
    replicas: 1
    selector:
    matchLabels:
      app: echo-2
    template:
    metadata:
      labels:
      app: echo-2
    spec:
      containers:
      - name: echo-2
        image: ealen/echo-server:latest
        ports:
        - containerPort: 80
        livenessProbe:
        httpGet:
          path: /?echo_code=200
          port: 80
        readinessProbe:
        httpGet:
          path: /?echo_code=200
          port: 80
        resources:
        limits:
          cpu: 800m
          memory: 600Mi
        requests:
          cpu: 600m
          memory: 400Mi
</code></pre>

<p>You might wonder what <code>cpu:600m</code> means. In our case the limit is <code>1</code> and this sort of means, <code>0.6</code>. I&#39;ve used the <a href="/s/tutorials/Kubernetes_k3s_Ingress_for_different_domains_like_virtual_hosts.html">echo-server</a>
in earlier guides.</p>

<p>Apply the file:</p>

<pre><code>kubectl  apply -f deployment.yml
</code></pre>

<p>Output    </p>

<pre><code>deployment.apps/echo-1 created
deployment.apps/echo-2 created
</code></pre>

<p>If you query the status of the deployments you&#39;ll see the first being created
successfully, the second is not:</p>

<pre><code>kubectl -n user-demo get deployments
</code></pre>

<p>Output:   </p>

<pre><code>NAME     READY   UP-TO-DATE   AVAILABLE   AGE
echo-1   1/1     1            1           54s
echo-2   0/1     0            0           54s
</code></pre>

<p>To figure out why, query the <code>Deployment</code>:</p>

<pre><code>kubectl -n user-demo describe deployment echo-2
</code></pre>

<p>Output, trimmed:</p>

<pre><code>Conditions:
  Type             Status  Reason
  ----             ------  ------
  Progressing      True    NewReplicaSetCreated
  Available        False   MinimumReplicasUnavailable
  ReplicaFailure   True    FailedCreate
</code></pre>

<p>Something is wrong with our <code>ReplicaSet</code>. Let&#39;s query that:</p>

<pre><code>$ kubectl -n user-demo get replicaset
</code></pre>

<p>Output:   </p>

<pre><code>NAME                DESIRED   CURRENT   READY   AGE
echo-1-777547b855   1         1         1       2m11s
echo-2-6fbd7564f7   1         0         0       2m11s
</code></pre>

<p>Query the second <code>ReplicaSet</code>:</p>

<pre><code>kubectl -n user-demo describe replicaset echo-2-6fbd7564f7
</code></pre>

<p>Output, trimmed:</p>

<pre><code>Name:           echo-2-6fbd7564f7
Namespace:      user-demo
[...]
Replicas:       0 current / 1 desired
Pods Status:    0 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  [...]
  Limits:
    cpu:     800m
    memory:  600Mi
  Requests:
    cpu:         600m
    memory:      400Mi
  [...]
Conditions:
  Type             Status  Reason
  ----             ------  ------
  ReplicaFailure   True    FailedCreate
Events:
  Type     Reason        Age                  From                   Message
  ----     ------        ----                 ----                   -------
  Warning  FailedCreate  2m31s                replicaset-controller  Error creating: pods &quot;echo-2-6fbd7564f7-bbnld&quot; is forbidden: exceeded quota: user-demo-quota, requested: requests.cpu=600m, used: requests.cpu=600m, limited: requests.cpu=1
  Warning  FailedCreate  2m31s                replicaset-controller  Error creating: pods &quot;echo-2-6fbd7564f7-vhfdk&quot; is forbidden: exceeded quota: user-demo-quota, requested: requests.cpu=600m, used: requests.cpu=600m, limited: requests.cpu=1
  Warning  FailedCreate  2m31s                replicaset-controller  Error creating: pods &quot;echo-2-6fbd7564f7-6qpht&quot; is forbidden: exceeded quota: user-demo-quota, requested: requests.cpu=600m, used: requests.cpu=600m, limited: requests.cpu=1
  [...]
</code></pre>

<p>The error is quite clear, we&#39;re out of resources! Exactly what we want. There is more info on resource limits in the documentation, you can also limit <a href="https://web.archive.org/web/20240727083328/https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/">the amount of Pods</a> and <a href="https://web.archive.org/web/20240729085730/https://kubernetes.io/docs/concepts/policy/resource-quotas/">here you can find other limits, for Storage or Ingress or Services</a> for example.</p>

<p>Here is the example resource quota extended with storage, services and ingresses:</p>

<pre><code>spec:
  hard:
  requests.cpu: &quot;1&quot;
  requests.memory: &quot;1Gi&quot;
  limits.cpu: &quot;2&quot;
  limits.memory: &quot;2Gi&quot;
  services.loadbalancers: &quot;2&quot;
  count/ingresses.networking.k8s.io: &quot;2&quot;
  persistentvolumeclaims: &quot;4&quot;
  requests.storage: &quot;8Gi&quot;
</code></pre>

<p>Then, when creating more <code>Loadbalancers</code> or <code>Ingresses</code>, you will receive an
error like so:</p>

<pre><code>Error from server (Forbidden): error when creating &quot;deployment.yml&quot;: services &quot;echo-2-service-2&quot; is forbidden: exceeded quota: user-demo-quota, requested: services.loadbalancers=1, used: services.loadbalancers=2, limited: services.loadbalancers=2
Error from server (Forbidden): error when creating &quot;deployment.yml&quot;: ingresses.networking.k8s.io &quot;echo-2-ingress-2&quot; is forbidden: exceeded quota: user-demo-quota, requested: count/ingresses.networking.k8s.io=1, used: count/ingresses.networking.k8s.io=2, limited: count/ingresses.networking.k8s.io=2
</code></pre>

<p>Delete the test deployments to free up our resources:</p>

<pre><code>kubectl -n user-demo delete -f deployment.yml
</code></pre>

<h3 id="toc_2">Creating a user restricted to one namespace</h3>

<p>Now that we have a namespace with resource limits, we can create a user bound to that namespace. </p>

<p>As we stated earlier, you need a few pieces, not &quot;just&quot; a user. Start with the
<code>ServiceAccount</code>, this is comparable to your &quot;User&quot;. I&#39;m assuming your
namespace <code>user-demo</code> is already created, if not, see the top of this page.
I&#39;m going to use the term <code>User</code> interchangeably with <code>ServiceAccount</code> in the
rest of this guide.</p>

<p>Create a file for the user:</p>

<pre><code>vim user1-servivceaccount.yml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: user1
  namespace: user-demo
</code></pre>

<p>Apply the file to create the service account:</p>

<pre><code>kubectl apply -f user1-serviceaccount.yml
</code></pre>

<p>Output:</p>

<pre><code>serviceaccount/user1 created
</code></pre>

<p>Next up is the <code>Role</code>, this file describes the specific permissions for the
<code>Role</code>. The role will be later bound to the <code>ServiceAccount</code>. That is a
separate process because one role can be bound to more than one user.</p>

<pre><code>vim namespace-admin-role.yml
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: namespace-admin
  namespace: user-demo
  rules:
- apiGroups: [&quot;&quot;, &quot;extensions&quot;, &quot;apps&quot;]
  resources: [&quot;*&quot;]
  verbs: [&quot;*&quot;]
- apiGroups: [&quot;batch&quot;]
  resources:
  - jobs
  - cronjobs
  verbs: [&quot;*&quot;]
</code></pre>

<p>This role grants permissions to perform almost all actions within the
namespace an Admin User would do.</p>

<p>You might want to have a more limited profile, for example, just a
<code>Deployment</code> admin user:</p>

<pre><code>[...]
  name: deployment-admin
rules:
- apiGroups: [&quot;&quot;, &quot;extensions&quot;, &quot;apps&quot;]
  resources: [&quot;deployments&quot;, &quot;replicasets&quot;, &quot;pods&quot;, &quot;services&quot;, &quot;ingresses&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;] 
</code></pre>

<p>Apply the file:   </p>

<pre><code>kubectl apply -f namespace-admin-role.yml
</code></pre>

<p>Output:</p>

<pre><code>role.rbac.authorization.k8s.io/namespace-admin created
</code></pre>

<p>Last step in user / role creation is the <code>RoleBinding</code>. This is what couples the <code>Role</code> to the User.</p>

<pre><code>vim namespace-admin-rolebinding.yml
</code></pre>

<p>Contents:</p>

<pre><code>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: namespace-admin-rolebinding
  namespace: user-demo
subjects:
- kind: ServiceAccount
  name: user1
  namespace: user-demo
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: namespace-admin
</code></pre>

<p>You can have multiple <code>subjects</code> but for our example we only need one. Apply the file:</p>

<pre><code>kubectl  apply -f namespace-admin-rolebinding.yml
</code></pre>

<p>Output:</p>

<pre><code>rolebinding.rbac.authorization.k8s.io/namespace-admin-rolebinding created
</code></pre>

<p>One more step remaining to actually use the new user.   </p>

<h3 id="toc_3">Creating a kubeconfig file for the user</h3>

<p>To use the new user with permissions, the last step is to create a
<code>kubeconfig</code> file. You can give that file to someone and they then can use
<code>kubectl</code> within that namespace, or create a token for the dashboard for
example.</p>

<p>Start by creating a long-lived token (10 years) for the user. Update the
duration to suite your needs.</p>

<pre><code>kubectl create token user1 -n user-demo --duration=87600h
</code></pre>

<p>Output:</p>

<pre><code>eyJhbGciOiJ[...]VwRTkA
</code></pre>

<p>Create a <code>user1-kubeconfig</code> file:</p>

<pre><code>vim user1-kubeconfig
</code></pre>

<p>Contents:</p>

<pre><code>apiVersion: v1
kind: Config
clusters:
- cluster:
  certificate-authority-data: &lt;base64-encoded-CA-cert&gt; 
  server: https://&lt;your-cluster-endpoint&gt; 
  name: default
contexts:
- context:
  cluster: default
  namespace: user-demo
  user: user1
  name: user1-context
current-context: user1-context
users:
- name: user1
  user: 
  token: &lt;your-token&gt;  
</code></pre>

<p>The <code>cluster.server</code> can be found using this command:</p>

<pre><code>kubectl cluster-info
</code></pre>

<p>Output:</p>

<pre><code>Kubernetes control plane is running at https://192.0.2.60:6443
</code></pre>

<p>The token you just created should be pasted into <code>user.token</code>. The last
part, <code>certificate-authority-data</code> can be (from Kubernetes 1.24 and up)
queried from a <code>configMap</code>:</p>

<pre><code>kubectl get configmap kube-root-ca.crt -n kube-public -o jsonpath=&quot;{[&#39;data&#39;][&#39;ca\\.crt&#39;]}&quot; | base64 -w 0
</code></pre>

<p>Output:   </p>

<pre><code>LS0[...]tLS0K
</code></pre>

<p>You can now use this file with <code>kubectl</code> by providing the <code>--kubeconfig</code> parameter:</p>

<pre><code>kubectl  --kubeconfig ./kubeconfig.yaml -n user-demo get pods
</code></pre>

<p>If you try to list another namespace for which the account has no permissions, you will receive errors:</p>

<pre><code> kubectl  --kubeconfig ./kubeconfig.yaml -n default get all
</code></pre>

<p>Output:</p>

<pre><code>Error from server (Forbidden): pods is forbidden: User &quot;system:serviceaccount:user-demo:user1&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;
Error from server (Forbidden): replicationcontrollers is forbidden: User &quot;system:serviceaccount:user-demo:user1&quot; cannot list resource &quot;replicationcontrollers&quot; in API group &quot;&quot; in the namespace &quot;default&quot;
</code></pre>

<p>You can also create the deployment (from earlier in this article) as this user:</p>

<pre><code>kubectl  --kubeconfig ./kubeconfig.yaml -n user-demo apply -f deployment.yml
</code></pre>

<p>Output:</p>

<pre><code>deployment.apps/echo-1 created
deployment.apps/echo-2 created
</code></pre>

<p>Querying, deleting and scaling works as you would expect:</p>

<pre><code>kubectl  --kubeconfig ./kubeconfig.yaml -n user-demo get deployment
</code></pre>

<p>Output:</p>

<pre><code>NAME     READY   UP-TO-DATE   AVAILABLE   AGE
echo-1   1/1     1            1           40s
echo-2   0/1     0            0           40s

kubectl  --kubeconfig ./kubeconfig.yaml -n user-demo get pods
</code></pre>

<p>Output:</p>

<pre><code>NAME                      READY   STATUS    RESTARTS   AGE
echo-1-777547b855-ftzzk   1/1     Running   0          41s

kubectl  --kubeconfig ./kubeconfig.yaml -n user-demo delete deployment echo-2
</code></pre>

<p>Output:</p>

<pre><code>deployment.apps &quot;echo-2&quot; deleted

kubectl  --kubeconfig ./kubeconfig.yaml -n user-demo scale deployment echo-1 --replicas 2
</code></pre>

<p>Output:</p>

<pre><code>deployment.apps/echo-1 scaled
</code></pre>

<p>You can use the token to login to the Kubernetes Dashboard as well, but you
cannot port-forward:</p>

<pre><code>kubectl  --kubeconfig ./kubeconfig.yaml -n kubernetes-dashboard  port-forward svc/kubernetes-dashboard-kong-proxy 8443:443
</code></pre>

<p>Output:</p>

<pre><code>Error from server (Forbidden): services &quot;kubernetes-dashboard-kong-proxy&quot; is forbidden: User &quot;system:serviceaccount:user-demo:user1&quot; cannot get resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;kubernetes-dashboard&quot;
</code></pre>

<p>This is expected because we do not have permissions in any other namespace.
Set up an Ingress or NodePort for the dashboard in a trusted environment and
you can use the token to login.</p>
Tags: <a href="../tags/armbian.html">armbian</a>
, <a href="../tags/cloud.html">cloud</a>
, <a href="../tags/k3s.html">k3s</a>
, <a href="../tags/k8s.html">k8s</a>
, <a href="../tags/kubernetes.html">kubernetes</a>
, <a href="../tags/linux.html">linux</a>
, <a href="../tags/permissions.html">permissions</a>
, <a href="../tags/rbac.html">rbac</a>
, <a href="../tags/resourcequota.html">resourcequota</a>
, <a href="../tags/role.html">role</a>
, <a href="../tags/rolebinding.html">rolebinding</a>
, <a href="../tags/tutorials.html">tutorials</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    