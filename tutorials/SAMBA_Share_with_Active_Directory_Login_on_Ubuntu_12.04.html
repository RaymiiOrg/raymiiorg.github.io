
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Samba Shares with Active Directory Login on Ubuntu 12.04 - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Samba Shares with Active Directory Login on Ubuntu 12.04</h2>
<p><small>Published: 27-06-2013 | Author: Remy van Elst | <a href="SAMBA_Share_with_Active_Directory_Login_on_Ubuntu_12.04.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7993642564731324"
                             crossorigin="anonymous"></script>
                        <!-- voorartikel -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-7993642564731324"
                             data-ad-slot="6172324376"
                             data-ad-format="auto"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        </div><br><div class='olderthanayear'><p><strong>&#10071; This post is over nine years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Introduction</a>
</li>
<li>
<a href="#toc_1">Overview</a>
</li>
<li>
<a href="#toc_2">Install Packages</a>
</li>
<li>
<a href="#toc_3">Configure NTP &amp; DNS</a>
</li>
<li>
<a href="#toc_4">Configure Kerberos</a>
</li>
<li>
<a href="#toc_5">Configure nsswitch</a>
</li>
<li>
<a href="#toc_6">Configure Samba (#1)</a>
</li>
<li>
<a href="#toc_7">Join the domain</a>
</li>
<li>
<a href="#toc_8">Configure Samba (#2): Shares</a>
</li>
<li>
<a href="#toc_9">Testing it</a>
</li>
</ul>

</div><hr><div id="contents">
<p>This tutorial shows you how to set up a SAMBA server which authenticates all
users to an Active Directory, including group based permissions. It uses Samba,
Winbind, Kerberos and nsswitch. This allows you to have a Linux machine serving
files via SMB, where your authentication and autorization for the files and
folders is done via Active Directory.</p>

<p class="ad"> <a href="https://leafnode.nl">I'm developing a desktop monitoring app,  Leaf Node Monitoring, open source, but paid. For Windows, Linux & Android, go check it out.</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>We are actually doing two things, we bind a Linux machine to the Active
Directory (but we disable shell access for the users), and we then configure
Samba to accept these users to the shares we set up.</p>

<h3 id="toc_0">Introduction</h3>

<p>The data used in this tutorial:</p>

<ul>
<li>Active Directory Domain: example.org</li>
<li>Realm/workgroup: example</li>
<li>Active Directory Server IP: 10.0.23.1 (Also DNS and NTP)</li>
<li>Share 1: Marketing 

<ul>
<li>Allowed AD group: marketing</li>
</ul></li>
<li>Share 2: Research 

<ul>
<li>Allowed AD groups: research, development</li>
</ul></li>
<li>Share 3: Dropbox 

<ul>
<li>Allowed AD groups: Everyone with a domain account, Domain Users.</li>
</ul></li>
<li>Share 4: CEO 

<ul>
<li>Allowed AD users: CEO.</li>
</ul></li>
</ul>

<p>This setup is tested with the following software:</p>

<ul>
<li>Ubuntu 12.04</li>
<li>Samba 3.6.3</li>
<li>Active Directory on Windows Server 2008 mixed with Windows Server 2012.</li>
<li>Active Directory on Windows Server 2003 mixed with Windows Server 2008.</li>
</ul>

<h3 id="toc_1">Overview</h3>

<p>A summary of the steps we are going to do:</p>

<ul>
<li>Install Packages</li>
<li>Configure NTP &amp; DNS</li>
<li>Configure Kerberos</li>
<li>Configure nsswitch</li>
<li>Configure Samba</li>
<li>Join the Domain</li>
<li>Configure Samba shares</li>
<li>Test the setup</li>
</ul>

<p>You need to have a privileged account to join the Active Directory Domain.</p>

<h3 id="toc_2">Install Packages</h3>

<p>On a freshly installed Ubuntu Server 12.04 we need to install the following
packages to get started:</p>

<pre><code>apt-get install ntp krb5-user samba smbfs smbclient winbind
</code></pre>

<p>krb5, Kerberos will ask some questions about your domain and a privileged user.
You can enter through this, we are going to put our own config files.</p>

<h3 id="toc_3">Configure NTP &amp; DNS</h3>

<p>Active Directory (Kerberos in general) is very picky about the system time, so
configure NTP to sync the time against your Active Directory NTP server. Edit
<code>/etc/ntp.conf</code>:</p>

<pre><code>server 10.0.23.1
</code></pre>

<p>Now also edit your <code>/etc/resolv.conf</code> (or <code>/etc/network/interfaces</code>) file and
change the DNS to your Active Directory DNS servers:</p>

<pre><code># /etc/resolv.conf
nameserver 10.0.23.1
search example.org

# /etc/network/interfaces
iface eth0 inet static
    [...]
    dns-nameservers 10.0.23.1
    dns-search example.org
</code></pre>

<p>We do this because Active Directory uses DNS for a lot of things. You can also
setup your standard DNS servers to use an Active Directory DNS server as first
upstream.</p>

<h3 id="toc_4">Configure Kerberos</h3>

<p>What is Kerberos?</p>

<pre><code>Kerberos is a computer network authentication protocol which works on the basis of &quot;tickets&quot; to allow nodes communicating over a non-secure network to prove their identity to one another in a secure manner. Its designers aimed it primarily at a clientserver model and it provides mutual authenticationboth the user and the server verify each other&#39;s identity.
</code></pre>

<p><a href="http://technet.microsoft.com/en-us/library/bb742516.aspx">A good article on how Kerberos is used in Active Directory can be found here:
http://technet.microsoft.com/en-us/library/bb742516.aspx</a></p>

<p>We need to set up Kerberos so that we can bind our machine against Active
Directory and let users access the Samba share via the AD. Edit the
<code>/etc/krb5.conf</code> file, remove everything and place the following in it, changing
the <code>EXAMPLE.ORG</code> domain to your own Active Directory Domain:</p>

<pre><code>[libdefaults]
  ticket_lifetime = 24h
  default_realm = EXAMPLE.ORG
  forwardable = true

[realms]
  EXAMPLE.ORG = {
    kdc = 10.0.23.1
    default_domain = EXAMPLE.ORG
  }

[domain_realm]
  .example.org = EXAMPLE.ORG
  example.org = EXAMPLE.ORG

[kdc]
  profile = /etc/krb5kdc/kdc.conf

[appdefaults]
  pam = {
    debug = false
    ticket_lifetime = 36000
    renew_lifetime = 36000
    forwardable = true
    krb4_convert = false
  }

[logging]
  kdc = FILE:/var/log/krb5kdc.log
  admin_server = FILE:/var/log/kadmin.log
  default = FILE:/var/log/krb5lib.log
</code></pre>

<p>We are now going to test Kerberos by getting a ticket for the Active Directory
Administrator User. Make sure you have the password ready:</p>

<pre><code>kinit Administrator
Password for Administrator@EXAMPLE.ORG:
</code></pre>

<p>Now we check if we got a valid ticket:</p>

<pre><code>klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: Administrator@EXAMPLE.ORG

Valid starting    Expires           Service principal
27/06/2013 07:17  27/06/2013 17:17  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG
        renew until 28/06/2013 07:17
</code></pre>

<p>If this is not correct, check your Kerberos and DNS and NTP (time) settings and
try again.</p>

<h3 id="toc_5">Configure nsswitch</h3>

<p>nsswitch is used to tell the system that the Active Directory users are also
valid users. We are going to configure it to also accept winbind users, which is
what Samba uses after it has bound to the domain.</p>

<p>Edit the <code>/etc/nsswitch.conf</code> and change the <code>passwd</code>, <code>shadow</code> and <code>group</code>
lines to look like this:</p>

<pre><code>passwd:         compat winbind
group:          compat winbind
shadow:         compat winbind
</code></pre>

<p>Note that this might not work for you. If you have issues with the users later
on, change these lines to this:</p>

<pre><code> passwd:            files winbind
 shadow:            files winbind
 group:             files winbind
</code></pre>

<p><a href="http://www.daemon-systems.org/man/nsswitch.conf.5.html">The NetBSD man page explains more than the Ubuntu man page: http://www.daemon-
systems.org/man/nsswitch.conf.5.html</a></p>

<h3 id="toc_6">Configure Samba (#1)</h3>

<p>Now we need to set up Samba to also support the domain. Edit
<code>/etc/samba/smb.conf</code> and remove everything, then place the following in it:</p>

<pre><code>[global]
    # No .tld
    workgroup = EXAMPLE
    # Active Directory System
    security = ads
    # With .tld
    realm = EXAMPLE.ORG
    # Just a member server
    domain master = no
    local master = no
    preferred master = no
    # Disable printing error log messages when CUPS is not installed.
    printcap name = /etc/printcap
    load printers = no
    # Works both in samba 3.2 and 3.6.        
    idmap backend = tdb
    idmap uid = 10000-99999
    idmap gid = 10000-99999
    # no .tld
    idmap config EXAMPLE:backend = rid
    idmap config EXAMPLE:range = 10000-9999
    winbind enum users = yes
    winbind enum groups = yes
    # This way users log in with username instead of username@example.org
    winbind use default domain = yes
    # Inherit groups in groups
    winbind nested groups = yes
    winbind refresh tickets = yes
    winbind offline logon = true
    # Becomes /home/example/username
    template homedir = /home/%D/%U
    # No shell access
    template shell = /bin/false
    client use spnego = yes
    client ntlmv2 auth = yes
    encrypt passwords = yes
    restrict anonymous = 2
    log file = /var/log/samba/samba.log
    log level = 2
</code></pre>

<p>Save the file and restart all the daemons:</p>

<pre><code>/etc/init.d/winbind restart
/etc/init.d/nmbd restart
/etc/init.d/smbd restart
</code></pre>

<h3 id="toc_7">Join the domain</h3>

<p>Make sure you still have a valid Kerberos ticket. If not, do a new <code>kinit
Administrator</code>. Then execute the following command:</p>

<pre><code>net ads join -U administrator
</code></pre>

<p>Output is like this:</p>

<pre><code>Enter Administrator&#39;s password:
Using short domain name -- EXAMPLE
Joined &#39;HOSTNAME&#39; to realm &#39;Example.org&#39;
DNS Update for hostname.example.org failed: ERROR_DNS_GSS_ERROR
DNS update failed!
</code></pre>

<p>The DNS error can be ignored, make sure you create an A record and a PTR record
manually.</p>

<p>Restart all the daemons again:</p>

<pre><code>/etc/init.d/winbind restart
/etc/init.d/nmbd restart
/etc/init.d/smbd restart
</code></pre>

<p>Also update PAM:</p>

<pre><code>pam-auth-update
</code></pre>

<p>Now see if you can list the domain users and groups:</p>

<pre><code>wbinfo -u # lists all the users in the domain
wbinfo -g # lists all the groups in the domain
</code></pre>

<p>And also check if winbind and nsswitch are correctly working:</p>

<pre><code>getent passwd # should return a list with all users on the local system and from the active directory
getent group # should return a list with all groups and their members, both from the local system and the active directory
</code></pre>

<p>If this does not work, go back to the nsswitch configuration section and change
the <code>compat</code> to <code>files</code>.</p>

<h3 id="toc_8">Configure Samba (#2): Shares</h3>

<p>This setup reflects an average business. Two departments with their own share,
and one dump folder for everyone. And a folder for the CEO so that he feels
special. Do note that it is a good idea to clean the Dropbox every night with a
cronjob, but let your users know that that happens.</p>

<p>We are going to create the shares. First create the folders on the system:</p>

<pre><code>mkdir -p /sharing/{marketing,research,ceo,dropbox}
chmod -R 0770 /sharing/
chgrp -R &quot;Domain Users&quot; /sharing/
</code></pre>

<p>Add the shares to <code>/etc/samba/smb.conf</code>:</p>

<pre><code>[Marketing]
    comment = Marketing
    path = /sharing/marketing/
    valid users = @EXAMPLE\marketing
    force group = marketing
    writable = yes
    read only = no
    force create mode = 0660
    create mask = 0777
    directory mask = 0777
    force directory mode = 0770
    access based share enum = yes
    hide unreadable = yes

[Research]
    comment = Research
    path = /sharing/research
    valid users = @EXAMPLE\development, @EXAMPLE\research
    force group = &quot;domain users&quot;
    writable = yes
    read only = no
    force create mode = 0660
    create mask = 0777
    directory mask = 0777
    force directory mode = 0770
    access based share enum = yes
    hide unreadable = yes

[Dropbox]
    comment = Daily Emptied Dropbox
    path = /sharing/dropbox
    valid users = &quot;@EXAMPLE\Domain Users&quot;
    force group = &quot;domain users&quot;
    writable = yes
    read only = no
    force create mode = 0660
    create mask = 0777
    directory mask = 0777
    force directory mode = 0770
    access based share enum = yes
    hide unreadable = yes

[CEO]
    comment = CEO Only
    path = /sharing/ceo
    valid users = EXAMPLE\ceo
    force group = &quot;domain users&quot;
    writable = yes
    read only = no
    force create mode = 0660
    create mask = 0777
    directory mask = 0777
    force directory mode = 0770
    access based share enum = yes
    hide unreadable = yes
</code></pre>

<p>As you can see, an active directory group is defined with an <code>@</code>, and a user
without. Also, when there are spaces in the groupname, you escape that with
quotes: <code>&quot;@EXAMPLE\Domain Users&quot;</code>.</p>

<p><a href="https://www.samba.org/samba/docs/man/manpages-3/smb.conf.5.html">You can find a lot of information on the smb.conf file in the man page:
https://www.samba.org/samba/docs/man/manpages-3/smb.conf.5.html</a></p>

<p><a href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/AccessControls.html#id2615334">Why do we force the mode on files and folders? Because of problems with MS
word, according to the Samba documentation: https://www.samba.org/samba/docs/man
/Samba-HOWTO-Collection/AccessControls.html#id2615334</a></p>

<p>Afterwards restart samba:</p>

<pre><code>/etc/init.d/smbd restart
</code></pre>

<h3 id="toc_9">Testing it</h3>

<p>Create a few accounts in the groups used (set expiry date to 1 day so you don&#39;t
forget to remove them) and use those accounts to test the shares. Create files
and folders as one user, try to edit and remove them as another user. Also try
to access the shares with a non-privileged user.</p>

<p>If you run into errors, check your log files in <code>/var/log/samba</code>. Make sure that
the capitalization and spelling is correct in the <code>valid users</code> part of the
samba config file, and also check the permissions on the folders themselves with
<code>ls -la</code>. You can set <code>valid users = any</code> to make check if there are errors or
not. The <code>testparm</code> command is also very helpful for the samba config file part.</p>
Tags: <a href="../tags/active-directory.html">active-directory</a>
, <a href="../tags/kerberos.html">kerberos</a>
, <a href="../tags/ldap.html">ldap</a>
, <a href="../tags/microsoft.html">microsoft</a>
, <a href="../tags/nsswitch.html">nsswitch</a>
, <a href="../tags/samba.html">samba</a>
, <a href="../tags/smb.html">smb</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/ubuntu.html">ubuntu</a>
, <a href="../tags/winbind.html">winbind</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
     
    </main>
    </body>
    </html>
    