
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Build a FreeBSD 11.0-release Openstack Image with bsd-cloudinit - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
        <link rel="stylesheet" href="/s/inc/css/cookieconsent.css" media="print" onload="this.media='all'">
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Build a FreeBSD 11.0-release Openstack Image with bsd-cloudinit</h2>
<p><small>Published: 14-11-2016 | Author: Remy van Elst | <a href="FreeBSD_11.0-release_Openstack_Image.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                                <script type="text/plain" data-cookiecategory="ads" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7993642564731324"
                             crossorigin="anonymous"></script>
                        <!-- voorartikel -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-7993642564731324"
                             data-ad-slot="6172324376"
                             data-ad-format="auto"></ins>
                        <script type="text/plain" data-cookiecategory="ads">
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        </div><br><div class='olderthanayear'><p><strong>&#10071; This post is over six years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Command Line tools</a>
</li>
<li>
<a href="#toc_1">Openstack Overview</a>
<ul>
<li>
<a href="#toc_2">Compute (Nova)</a>
</li>
<li>
<a href="#toc_3">Block Storage (Cinder)</a>
</li>
<li>
<a href="#toc_4">Images (Glance)</a>
</li>
<li>
<a href="#toc_5">ISO Installation</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">Upload the ISO to glance</a>
</li>
<li>
<a href="#toc_7">Create the volume</a>
</li>
<li>
<a href="#toc_8">Boot a VM with an ISO and extra volume</a>
</li>
<li>
<a href="#toc_9">Install FreeBSD 11.0</a>
</li>
<li>
<a href="#toc_10">Stop the install VM</a>
</li>
<li>
<a href="#toc_11">Boot a new VM with the volume as root disk</a>
</li>
<li>
<a href="#toc_12">Prepare FreeBSD for Cloud Init</a>
</li>
<li>
<a href="#toc_13">Login Users</a>
</li>
<li>
<a href="#toc_14">Expand root filesystem</a>
</li>
<li>
<a href="#toc_15">bsd-cloudinit install</a>
</li>
<li>
<a href="#toc_16">Compress the image</a>
</li>
</ul>

</div><hr><div id="contents">
<p>We are going to prepare a FreeBSD image for Openstack deployment. We do this by
creating a FreeBSD 11.0-RELEASE instance, installing it and converting it using
<a href="http://pellaeon.github.io/bsd-cloudinit/">bsd-cloudinit</a>. We&#39;ll use the <a href="https://cloudvps.com">CloudVPS</a> public Openstack cloud for this.
Create an account there and install the Openstack command line tools, like
<code>nova</code>, <code>cinder</code> and <code>glance</code>.</p>

<p>A FreeBSD image with Cloud Init will automatically resize the disk to the size
of the flavor and it will add your SSH key right at boot. You can use <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-cloud-config-scripting">Cloud
Config</a> to execute <a href="https://raymii.org/s/tutorials/Automating_Openstack_with_Cloud_init_run_a_script_on_VMs_first_boot.html">a script at first boot</a>, for example, to bootstrap
your system into Puppet or Ansible. If you <a href="https://raymii.org/s/tutorials/Ansible_-_create_OpenStack_servers_with_os_server.html">use Ansible</a> to manage OpenStack
instances you can integrate it without manually logging in or doing anything
manually.</p>

<p>You can see all my <a href="https://raymii.org/s/tags/openstack.html">Openstack related articles here</a>. For example, how to use
<a href="https://raymii.org/s/tutorials/Encrypted_Duplicity_Backups_to_Openstack_Swift_Objectstore.html">Duplicity to create Encrypted backups to the Openstack Swift Object Store</a></p>

<p class="ad"> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>This tutorial is available for:</p>

<ul>
<li><a href="https://raymii.org/s/tutorials/FreeBSD_10.0-release_Openstack_Image.html">FreeBSD 10.0-RELEASE.</a></li>
<li><a href="https://raymii.org/s/tutorials/FreeBSD_10.1-release_Openstack_Image.html">FreeBSD 10.1-RELEASE.</a></li>
<li><a href="https://raymii.org/s/tutorials/FreeBSD_10.3-release_Openstack_Image.html">FreeBSD 10.3-RELEASE.</a></li>
<li><a href="https://raymii.org/s/tutorials/FreeBSD_11.0-release_Openstack_Image.html">FreeBSD 11.0-RELEASE.</a></li>
</ul>

<h3 id="toc_0">Command Line tools</h3>

<p>Make sure you have the Openstack command line tools installed. Follow the
official openstack guide <a href="http://docs.openstack.org/user-guide/content/install_clients.html">here</a>. If you have <code>pip</code> installed you can use
that to install the tools:</p>

<pre><code>pip install python-novaclient
pip install python-cinderclient
pip install python-glanceclient
pip install python-keystoneclient
pip install python-neutronclient
pip install python-swiftclient
</code></pre>

<p>Save yourself some time and create a file named <code>computerc</code> with the below
contents:</p>

<pre><code>export OS_AUTH_URL=&quot;https://identity.stack.cloudvps.com/v2.0&quot;
export OS_TENANT_NAME=&quot;&lt;tenant name&gt;&quot;
export OS_USERNAME=&quot;&lt;username&gt;&quot;
export OS_PASSWORD=&quot;&lt;password&gt;&quot;
export OS_TENANT_ID=&quot;&lt;tenant id&gt;&quot;
</code></pre>

<p>When you are going to do stuff with the Openstack command line clients, load
this file:</p>

<pre><code>source computerc
</code></pre>

<p>That way, your authentication data are loaded and you don&#39;t have to give
parameters like <code>-os-username</code> and such.</p>

<h3 id="toc_1">Openstack Overview</h3>

<p>Openstack is a datacenter virtualization plaform consisting out of many
different tools and services. For this tutorial it is important to know the
following ones.</p>

<h4 id="toc_2">Compute (Nova)</h4>

<p>This is the virtualization service. It works with a hypervisor to create and
manage virtual machines. You can create a VM based on a specific &quot;Flavour&quot;,
which is just a definition of specs like disk, cpu and ram.</p>

<h4 id="toc_3">Block Storage (Cinder)</h4>

<p>This is the service which makes block devices (volumes) available to services. A
flavour can not be changed, just resized. If you want extra storage you need to
create a volume, attach it to the VM and mount it there for use.</p>

<h4 id="toc_4">Images (Glance)</h4>

<p>This is the service which holds all the images. Images can be used to boot a VM
from. Images can be prepared with tools like <code>cloud-init</code> to make them behave
better in a cloud environment, for example, setting an SSH key or password at
boot.</p>

<h4 id="toc_5">ISO Installation</h4>

<p>Booting from an ISO with a disk attached is quite tricky in Openstack. This
FreeBSD tutorial can be used for any ISO which needs to be installed. The
process is as following:</p>

<ul>
<li>Boot an instance from an ISO image with an extra volume attached.</li>
<li>Install the software on that volume.</li>
<li>Stop the install VM.</li>
<li>Start a new VM with the volume as root disk. (To test, prepare and configure the installation).</li>
<li>Stop and destory that VM.</li>
<li>Convert the volume to an image.</li>
</ul>

<p>You then have an image with your own installation available to boot new vm&#39;s
from.</p>

<p>Lets get started.</p>

<h3 id="toc_6">Upload the ISO to glance</h3>

<p>Start by uploading the FreeBSD 11.0-RELEASE ISO to Openstack using the Glance
client:</p>

<pre><code>glance image-create --name &quot;FreeBSD-11.0-RELEASE-amd64-dvd1.iso&quot; --disk-format iso --container-format bare --copy-from &quot;ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/ISO-IMAGES/11.0/FreeBSD-11.0-RELEASE-amd64-bootonly.iso&quot;
</code></pre>

<p>Note that we download the 300 MB boot only image instead of the full DVD. You
can also use that, but it will take longer to download/upload.</p>

<p>If your Openstack provider does not support the <code>--copy-from</code> parameter you will
have to download the ISO yourself:</p>

<pre><code>wget ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/ISO-IMAGES/11.0/FreeBSD-11.0-RELEASE-amd64-bootonly.iso
</code></pre>

<p>And upload it as an image. That can take a while:</p>

<pre><code>glance image-create --file Downloads/FreeBSD-11.0-RELEASE-amd64-dvd1.iso --name &quot;FreeBSD-11.0-RELEASE-amd64-bootonlyiso&quot; --disk-format iso --container-format bare --progress
</code></pre>

<p>The result of the glance command should be something like below:</p>

<pre><code>+------------------+-----------------------------------------+
| Property         | Value                                   |
+------------------+-----------------------------------------+
| checksum         | f0f49e5d50195ef3a70a5aa7b73a8d71        |
| container_format | bare                                    |
| created_at       | 2016-11-14T09:06:39                     |
| deleted          | False                                   |
| deleted_at       | None                                    |
| disk_format      | iso                                     |
| id               | a7f36877-8dc5-4ae9-bcf4-a7484552a887    |
| is_public        | False                                   |
| min_disk         | 0                                       |
| min_ram          | 0                                       |
| name             | FreeBSD-11.0-RELEASE-amd64-bootonly.iso |
| owner            | e8[...]e4                               |
| protected        | False                                   |
| size             | 298821632                               |
| status           | active                                  |
| updated_at       | 2016-11-14T09:07:09                     |
| virtual_size     | None                                    |
+------------------+-----------------------------------------+
</code></pre>

<p>Note down the ISO ID, in our case <code>5b74bee7-c05e-4102-9dd2-349dec4adee2</code>.</p>

<h3 id="toc_7">Create the volume</h3>

<p>Create the root volume for our FreeBSD preparation install:</p>

<pre><code>cinder create --display-name &quot;FreeBSD-11.0-root&quot; --availability-zone=NL1 16
</code></pre>

<p>This creates an 16 GB volume, on which we will install FreeBSD. The result of
the command is like below:</p>

<pre><code>+---------------------+--------------------------------------+
|       Property      |                Value                 |
+---------------------+--------------------------------------+
|     attachments     |                  []                  |
|  availability_zone  |                 NL1                  |
|       bootable      |                false                 |
|      created_at     |      2016-11-14T09:10:21.570845      |
| display_description |                 None                 |
|     display_name    |          FreeBSD-11.0-root           |
|      encrypted      |                False                 |
|          id         | fc4d6110-6d21-4fa9-80c1-e6916d1c2daf |
|       metadata      |                  {}                  |
|         size        |                  16                  |
|     snapshot_id     |                 None                 |
|     source_volid    |                 None                 |
|        status       |               creating               |
|     volume_type     |                 None                 |
+---------------------+--------------------------------------+
</code></pre>

<p>Again, note down the ID, in our case <code>f00fdea0-37ea-4a0e-9a1d-403d39ce8320</code>.</p>

<h3 id="toc_8">Boot a VM with an ISO and extra volume</h3>

<p>Boot a new instance from the ISO, attaching the volume we just created as well:</p>

<pre><code>nova boot --image &lt;freebsd iso image id&gt; --poll --flavor &quot;Standard 1&quot; --availability-zone NL1 --nic net-id=00000000-0000-0000-0000-000000000000 --block-device-mapping &quot;vdb=&lt;volume freebsd-10-root id&gt;:::0&quot; &quot;FreeBSD-11.0-RELEASE-install&quot;
</code></pre>

<ul>
<li><code>--image</code> is the FreeBSD ISO image ID</li>
<li><code>--flavor</code> is the Openstack VM Flavour, this can be different at another Openstack provider</li>
<li><code>--availability-zone</code> is also Openstack provider specific. It is the datacenter/logic region where the VM starts. The volume needs to be in the same availability zone.</li>
<li><code>--nic net-id</code> is the Openstack network. In this case it is the CloudVPS public network.</li>
<li><code>--block-device-mapping</code> maps the volume we created as a second disk for the VM. The <code>:::0</code> makes sure it does not get deleted when the VM is terminated.</li>
</ul>

<p>Your output will be like below:</p>

<pre><code>+--------------------------------------+--------------------------------------------------------------------------------+
| Property                             | Value                                                                          |
+--------------------------------------+--------------------------------------------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL                                                                         |
| OS-EXT-AZ:availability_zone          | NL2                                                                            |
| OS-EXT-STS:power_state               | 0                                                                              |
| OS-EXT-STS:task_state                | scheduling                                                                     |
| OS-EXT-STS:vm_state                  | building                                                                       |
| OS-SRV-USG:launched_at               | -                                                                              |
| OS-SRV-USG:terminated_at             | -                                                                              |
| accessIPv4                           |                                                                                |
| config_drive                         |                                                                                |
| created                              | 2016-11-14T09:11:09Z                                                           |
| flavor                               | Standard 1 (111)                                                               |
| hostId                               |                                                                                |
| id                                   | 7f399f7b-c96e-46c8-b70d-047783f7037d                                           |
| image                                | FreeBSD-11.0-RELEASE-amd64-bootonly.iso (a7f36877-8dc5-4ae9-bcf4-a7484552a887) |
| key_name                             | -                                                                              |
| metadata                             | {}                                                                             |
| name                                 | FreeBSD-11-install                                                             |
| os-extended-volumes:volumes_attached | [{&quot;id&quot;: &quot;fc4d6110-6d21-4fa9-80c1-e6916d1c2daf&quot;}]                               |
| progress                             | 0                                                                              |
| security_groups                      | default                                                                        |
| status                               | BUILD                                                                          |
| tenant_id                            | e8[...]e4                                                                      |
| updated                              | 2016-11-14T09:11:10Z                                                           |
+--------------------------------------+--------------------------------------------------------------------------------+
</code></pre>

<p>Note down the ID like usual, in our case: <code>7f399f7b-c96e-46c8-b70d-
047783f7037d</code>.</p>

<h3 id="toc_9">Install FreeBSD 11.0</h3>

<p>Do a standard install of FreeBSD 10. Use the Openstack console to do that.</p>

<p>These are my simple install settings:</p>

<ul>
<li>default keymap</li>
<li>hostname: freebsd.public.cloudvps.com</li>
<li>Just lib32 and ports, no doc, games or src (If you have the bootonly DVD you need to configure networking (dhcp) to download the other packages. Settings are a below under <code>Network:</code>.)</li>
<li>Manual Partition Layout: 

<ul>
<li>vtbd0 GPT</li>
<li>vtbd0p1 64KB freebsd-boot (boot)</li>
<li>vtbd0p2 16GB freebsd-ufs mountpoint / (root)</li>
<li>The root partition must be the last partition on the drive so that it can expand at run time to the disk size that your instance type provides. Also note that bsd-cloudinit currently has a hard-coded bug/assumption that this is the second partition. This is also the reason we do not use ZFS-on-root, sadly.</li>
</ul></li>
<li>Root password P@ssw0rd</li>
<li>Network: 

<ul>
<li>adapter: vtnet0</li>
<li>ipv4: dhcp</li>
<li>ipv6: slaac</li>
<li>search: public.cloudvps.com</li>
</ul></li>
<li>UTC: no, timezone 8 EUROPE 34 NETHERLANDS</li>
<li>Services at boot: 

<ul>
<li>sshd</li>
<li>ntpd</li>
<li>moused</li>
<li>dumpd</li>
<li>local_unbound</li>
</ul></li>
<li>System Hardening: 

<ul>
<li>This is up to you, but in my case everything is turned on:</li>
<li>Hide processes running as [other users | other groups]</li>
<li>Disable [reading kernel message buffer | proces debugging features] for unprivileged users</li>
<li>Randomize the PID of newly created processes</li>
<li>Insert stack guard page ahead of the growable segments</li>
<li>Clean the /tmp filesystem on system startup</li>
<li>Disable opening Syslogd network socket (disables remote logging)</li>
<li>Disable Sendmail service</li>
<li>Note that all of the above can still be changed later on.</li>
</ul></li>
<li>Extra users: no</li>
<li>Exit, open a shell.</li>
</ul>

<p>Below is a picture of the running installation:</p>

<p><img src="https://raymii.org/s/inc/img/freebsd-11-install-1.png" alt="freebsdinstall"></p>

<h3 id="toc_10">Stop the install VM</h3>

<p>Shut the instance from FreeBSD using <code>shutdown -p now</code> and after that via nova:</p>

<pre><code>nova stop &lt;install vm id&gt;
</code></pre>

<p>Detach the volume:</p>

<pre><code>nova volume-detach &lt;install vm id&gt; &lt;install root volume id&gt;
</code></pre>

<p>When the volume is detached you can delete the installation VM. We don&#39;t need it
anymore:</p>

<pre><code>nova delete &lt;install vm id&gt;
</code></pre>

<p>The volume will not be destroyed when the VM is deleted.</p>

<h3 id="toc_11">Boot a new VM with the volume as root disk</h3>

<p>Boot a new instance with the volume freebsd was installed on as the root disk:</p>

<pre><code>nova boot --block-device source=volume,id=&lt;root volume id&gt;,dest=volume,shutdown=preserve,bootindex=0 --poll --flavor &quot;Standard 1&quot; --availability-zone NL1 --nic net-id=00000000-0000-0000-0000-000000000000 --key-name &lt;ssh key&gt; FreeBSD-11.0-RELEASE-configure
</code></pre>

<p>Here we use <code>--block-device</code> to specify that the only disk attached to the
instance should be the volume <code>source=volume,id=&lt;volume id&gt;</code>. This can also be
an image as source. The destination is also a volume, this can also be local.</p>

<p>If you have more block devices specified here you should make sure there is only
1 with the <code>bootindex 0</code>, that is the disk the VM will try to boot from.</p>

<h3 id="toc_12">Prepare FreeBSD for Cloud Init</h3>

<p>If you get a mountroot error from the bootloader, enter the following:</p>

<pre><code>    ufs:/dev/vtbd0p3.
</code></pre>

<p>Change <code>/etc/fstab</code> after the fact, change <code>ada0</code> to <code>vtbd0</code> for VirtIO support.
If you don&#39;t get an error then change nothing.</p>

<p>Bootstrap the packaging system (<code>pkg</code>) so we can install some stuff required for
<code>bsd-cloudinit</code>:</p>

<pre><code>pkg
</code></pre>

<p>Enter y.</p>

<p>Install vim and py27-setuptools (for bsd-cloudinit):</p>

<pre><code>pkg install vim-lite py27-setuptools ca_root_nss
</code></pre>

<p>The ca <em>root</em> nss is required by fetch to do certificate validation.</p>

<h3 id="toc_13">Login Users</h3>

<p>By default cloudinit will create a user named <code>freebsd</code> which has sudo
privileges without password. However, if you want to enable root login directly,
you need to add your SSH key, enable root login and add some extra configuration
later on for cloud-init.</p>

<p>If you want root login, add your SSH key:</p>

<pre><code>mkdir /root/.ssh
chmod 700 /root/.ssh
echo &quot;ssh-rsa AAAA[...] user@example.com&quot; &gt; /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
</code></pre>

<p>Enable root login via ssh:</p>

<pre><code>vim /etc/ssh/sshd_config
PermitRootLogin yes
</code></pre>

<h3 id="toc_14">Expand root filesystem</h3>

<p>Since <a href="https://www.freebsd.org/releases/10.2R/relnotes.html#userland-rc">FreeBSD 10.2-RELEASE</a> there is an <code>rc</code> script which, when the file
<code>/firstboot</code> exists, expands the root filesystem to the full disk. While <code>bsd-
cloudinit</code> does this as well, if you don&#39;t need the whole <code>cloudinit</code> stack,
(when you use a static ssh key for example), you can <code>touch</code> that file to make
sure the disk is expanded at the first boot:</p>

<pre><code>touch /firstboot
</code></pre>

<h3 id="toc_15">bsd-cloudinit install</h3>

<p>Install python modules for bsd-cloudinit:</p>

<pre><code>rehash
easy_install eventlet
easy_install iso8601
</code></pre>

<p>Add the following to <code>/boot/loader.conf</code> to make sure the console works:</p>

<pre><code>console=&quot;comconsole,vidconsole&quot;
autoboot_delay=&quot;15&quot;
</code></pre>

<p>This sets console output to go to the serial console, which is displayed by nova
consolelog, and the video console for sites with VNC or Spice configured.</p>

<p>Now do any other customizations you want to have in your image.</p>

<p>Do the bsd-cloudinit install:</p>

<pre><code>fetch https://raw.github.com/pellaeon/bsd-cloudinit-installer/master/installer.sh
chmod +x installer.sh
</code></pre>

<p>The default username will be <code>freebsd</code>, bsd-cloudinit will create it if it does
not exists. The freebsd user will also be able to <code>sudo</code> without a password by
default, <code>bsd-cloudinit</code> will handle that by default.</p>

<p>Before you start the installer, make sure you do any other configuration you
want. After the installer has started and you reboot, cloudinit will prepare the
vm for use.</p>

<p>Start the installer:</p>

<pre><code>./installer.sh
</code></pre>

<p>Answer yes to the questions and remove the installer file afterwards:</p>

<pre><code>rm installer.sh
</code></pre>

<p>Delete all history:</p>

<pre><code>set history = 0
history -c
</code></pre>

<p>Zero out all the free space:</p>

<pre><code>dd if=/dev/zero of=/bla
rm /bla
</code></pre>

<p>We do that so that the image compresses better later.</p>

<p>Turn the machine off:</p>

<pre><code>shutdown -p now
</code></pre>

<p>Terminate the machine, otherwise you cannot detach the volume (<code>ERROR: Can&#39;t
detach root device volume (HTTP 403)</code>):</p>

<pre><code>nova delete &lt;id of freebsd-configure vm&gt;
</code></pre>

<p>Convert the volume to an image:</p>

<pre><code>cinder upload-to-image &lt;freebsd-10-root volume id&gt; FreeBSD-11.0-RELEASE-CloudInit
</code></pre>

<p>This might take a while.</p>

<p>Set the min-disk and min-ram requirements, plus some more properties for the
image:</p>

<pre><code>glance image-update --min-disk 8 --min-ram 1024 --property architecture=x86_64 --property image_supports_keypair=true --property image_supports_password=true --property supported=false &lt;id from the converted volume image&gt;
</code></pre>

<p>If needed, make it public:</p>

<pre><code>glance --name &quot;UNSUPPORTED: FreeBSD-11.0-RELEASE&quot; --is-public True &lt;id from the converted volume image&gt;
</code></pre>

<p>That&#39;s it. You are done and have a good workable freebsd image.</p>

<p>Boot a new instance from your newly created image:</p>

<pre><code>nova boot --image &lt;id from the converted volume image&gt; --flavor &quot;Standard 4&quot; --availability-zone NL1 --nic net-id=00000000-0000-0000-0000-000000000000 --key-name &lt;your ssh key&gt; FreeBSD-11.0-RELEASE-cloudinit
</code></pre>

<p>When the instance has spawned you can login as the freebsd user,
freebsd@ipaddress.</p>

<h3 id="toc_16">Compress the image</h3>

<p>If your Openstack provider does not compress the images converted from volumes
you might need to do that yourself. You want to do that because storing 475 MB
costs you less qouta/money than 16 GB.</p>

<p>First, use glance to download the image:</p>

<pre><code>glance image-download --file bsd.raw &lt;freebsd image uuid&gt;
</code></pre>

<p>Convert and compress the image to qcow2 with <code>qemu-img</code>:</p>

<pre><code>qemu-img convert -c -f raw -O qcow2 bsd.raw bsd.qcow2
</code></pre>

<p>You will get the best compression if you&#39;ve zero&#39;d out the image as listed
above.</p>

<p>Upload this new smaller image to Openstack:</p>

<pre><code>glance image-create --name FreeBSD-11.0 --disk-format qcow2 --container-format bare --min-disk 16 --min-ram 1024  --property architecture=x86_64 --property image_supports_keypair=true --property image_supports_password=true --property os_type=linux --property supported=false --file ./bsd.qcow2 
</code></pre>

<p>In my case the converted volume was 16 GB and the compressed image was 475MB.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10
credit). (referral link)</a></p>
Tags: <a href="../tags/cloud.html">cloud</a>
, <a href="../tags/cloudinit.html">cloudinit</a>
, <a href="../tags/compute.html">compute</a>
, <a href="../tags/freebsd.html">freebsd</a>
, <a href="../tags/image.html">image</a>
, <a href="../tags/openstack.html">openstack</a>
, <a href="../tags/python.html">python</a>
, <a href="../tags/tutorials.html">tutorials</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script type="text/plain" data-cookiecategory="analytics" async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script type="text/plain" data-cookiecategory="analytics">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>



    <script defer src="/s/inc/js/cookieconsent.js"></script>
    <script defer src="/s/inc/js/cookieconsent-init.js"></script>

     
    </main>
    </body>
    </html>
    