
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Netboot (PXE) Armbian on an Orange Pi Zero 3 from SPI with NFS root filesystem - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Netboot (PXE) Armbian on an Orange Pi Zero 3 from SPI with NFS root filesystem</h2>
<p><small>Published: <span data-pagefind-meta='date'>25-06-2024 22:30</span> | Author: Remy van Elst | <a href="Netboot_PXE_Armbian_on_an_Orange_Pi_Zero_3_from_SPI_with_NFS_root_filesystem.txt">Text only version of this article</a>
</small></p>
<br><div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Setup Orange Pi 3 SPI and u-boot</a>
</li>
<li>
<a href="#toc_1">Update u-boot environment</a>
</li>
<li>
<a href="#toc_2">Install TFTP &amp; NFS server</a>
</li>
<li>
<a href="#toc_3">Preparing the rootfs over NFS</a>
</li>
<li>
<a href="#toc_4">DHCP server setup</a>
</li>
<li>
<a href="#toc_5">Test</a>
</li>
<li>
<a href="#toc_6">NFS Benchmark vs Micro SD Card</a>
</li>
</ul>

</div><hr><div id="contents">
<p>Because I wanted to experiment with Kubernetes I bought a few cheap SBC&#39;s and a Power over Ethernet switch to run <code>k3s</code>. Since Kubernetes is very resource intensive I wanted to try to boot the boards via the network without causing wear on the Micro SD card. The boards have built-in SPI flash from which it can boot <code>u-boot</code> and Armbian works quite well with a root filesystem over NFS. This guide will help you with netbooting an Orange Pi Zero 3 running Armbian.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!</a><br><br> </p>

<p><code>k3s</code> is a lightweight version of Kubernetes. Production ready, easy to
install, half the memory, all in a binary less than 100 MB and suitable for
ARM. A follow up article will be available soon to document my first adventure
with Kubernetes on this cluster.</p>

<p>The SBC&#39;s are the <a href="https://web.archive.org/web/20240623200133/http://www.orangepi.org/html/hardWare/computerAndMicrocontrollers/details/Orange-Pi-Zero-3.html">Orange Pi Zero 3</a>
with an Allwinner H618 Quad-Core Cortex-A53, gigabit Ethernet and 4GB of RAM,
the latter being required for Kubernetes.</p>

<p>Meet &quot;The Cluster&quot; and notice there are no Micro SD cards inserted:</p>

<p><img src="/s/inc/img/k8s-cluster-hardware.png" alt="orange pies"></p>

<p>The PoE switch provides power and the splitters turn it in to USB-C and
Ethernet. It&#39;s the cheapest PoE switch I could find on AliExpress.</p>

<p>You need console access via UART once to set a <code>u-boot</code> environment variable.
This can be either an <a href="https://web.archive.org/web/20240625181226/https://nl.farnell.com/ftdi/ttl-232r-3v3/cable-usb-to-ttl-level-serial/dp/1329311">FTDI TTL-232R-3V3</a>
cable or you can plug in a screen via (micro) HDMI and a keyboard.</p>

<p>You need to have an NFS and TFTP server to serve the files and root
filesystem. This guide will help you set that up.</p>

<p>You need to be able to configure your DHCP server to provide certain options
for TFTP. Most home routers cannot do that, but OpenWRT, Pi-Hole (<code>dnsmasq</code>) and
Synology DHCP server can do it.</p>

<h3 id="toc_0">Setup Orange Pi 3 SPI and u-boot</h3>

<p>I&#39;m using
<code>Armbian_community_24.8.0-trunk.139_Orangepizero3_bookworm_current_6.6.31_minimal.img.xz</code>
but you can get the latest Debian 12 image <a href="https://www.armbian.com/orange-pi-zero-3/">from the Armbian website</a>.</p>

<p>Install Armbian to your Micro SD card and boot up your Orange Pi. The first
part of the setup must be done from within Armbian booted via an SD card. </p>

<p>Add the following lines to <code>/boot/armbianEnv.txt</code> to enable SPI:</p>

<pre><code>param_spidev_spi_bus=0
overlays=spidev0_0
</code></pre>

<p>Reboot and check for the SPI device:</p>

<pre><code>ls -l /dev/spi*
crw------- 1 root root 153, 0 Jun 22 17:56 /dev/spidev0.0
</code></pre>

<p>The next step is to flash <code>u-boot</code> to the SPI flash. First we&#39;ll create an
image that matches the exact size of the SPI-NOR flash, write <code>u-boot</code> to
that file and then write that file to the flash chip. The size must match
exactly, therefore  we&#39;re using such a convoluted method. </p>

<p>Create working directory:</p>

<pre><code>mkdir spiflash &amp;&amp; cd spiflash
</code></pre>

<p>Create an empty image which matches the SPI flash size:</p>

<pre><code>dd if=/dev/zero count=16777216 bs=1 | tr &#39;\000&#39; &#39;\377&#39; &gt; spi.img
</code></pre>

<p>Output:</p>

<pre><code>16777216+0 records in
16777216+0 records out
16777216 bytes (17 MB, 16 MiB) copied, 42.8787 s, 391 kB/s  
</code></pre>

<p>Find the  <code>u-boot</code> binary on the local filesystem:</p>

<pre><code>ls -al /usr/lib/linux-u-boot-*/*.bin 
</code></pre>

<p>Output:</p>

<pre><code>-rw-rw-r-- 1 root root 844437 May 20 00:47 /usr/lib/linux-u-boot-current-orangepizero3/u-boot-sunxi-with-spl.bin
</code></pre>

<p>Write <code>u-boot</code> to SPI file: </p>

<pre><code>dd if=/usr/lib/linux-u-boot-current-orangepizero3/u-boot-sunxi-with-spl.bin of=spi.img bs=1k conv=notrunc 
</code></pre>

<p>Output:</p>

<pre><code>824+1 records in
824+1 records out
844437 bytes (844 kB, 825 KiB) copied, 0.0421872 s, 20.0 MB/s
</code></pre>

<p>If needed, install <code>flashrom</code>:</p>

<pre><code>apt install flashrom
</code></pre>

<p>Write flash file with <code>u-boot</code> to SPI:</p>

<pre><code>flashrom -p linux_spi:dev=/dev/spidev0.0 -w spi.img   
</code></pre>

<p>Output:</p>

<pre><code>  flashrom unknown on Linux 6.6.31-current-sunxi64 (aarch64)
  flashrom is free software, get the source code at https://flashrom.org

  Using clock_gettime for delay loops (clk_id: 1, resolution: 1ns).
  Using default 2000kHz clock. Use &#39;spispeed&#39; parameter to override.
  ===
  SFDP has autodetected a flash chip which is not natively supported by flashrom yet.
  All standard operations (read, verify, erase and write) should work, but to support all possible features we need to add them manually.
  You can help us by mailing us the output of the following command to flashrom@flashrom.org:
  &#39;flashrom -VV [plus the -p/--programmer parameter]&#39;
  Thanks for your help!
  ===
  Found Unknown flash chip &quot;SFDP-capable chip&quot; (16384 kB, SPI) on linux_spi.
  ===
  This flash part has status UNTESTED for operations: WP
  The test status of this chip may have been updated in the latest development
  version of flashrom. If you are running the latest development version,
  please email a report to flashrom@flashrom.org if any of the above operations
  work correctly for you with this flash chip. Please include the flashrom log
  file for all operations you tested (see the man page for details), and mention
  which mainboard or programmer you tested in the subject line.
  Thanks for your help!
  Reading old flash chip contents...
</code></pre>

<p>This takes a while, in my case about 5 minutes. Output continues:</p>

<pre><code>  Reading old flash chip contents... done.
  Erasing and writing flash chip... Erase/write done.
  Verifying flash... VERIFIED.
</code></pre>

<p>You can now <code>poweroff</code> the board and remove the Micro SD card. The bootloader
will not boot from SPI if a Micro-SD card is inserted.</p>

<h3 id="toc_1">Update u-boot environment</h3>

<p>I had to enable <code>netretry</code> otherwise my boards would be to fast trying PXE before DHCP
was finished, and not retry again. </p>

<p><strong>You must have flashed u-boot to the SPI and reboot without Micro SD card</strong></p>

<p>Either use a UART serial cable or plug in a monitor and keyboard. </p>

<p>Power up the board and stop autoboot:</p>

<pre><code>Autoboot in 1 seconds, press &lt;Space&gt; to stop
</code></pre>

<p>On the u-boot prompt, enter the following commands (without <code>=&gt;</code>):</p>

<pre><code>  =&gt; setenv netretry yes
  =&gt; saveenv
</code></pre>

<p>Output:</p>

<pre><code>  Saving Environment to SPIFlash... Erasing SPI flash...Writing to SPI flash...done
  OK
</code></pre>

<p>Now try booting with the <code>boot</code> command, or <code>reset</code>, whatever you prefer.</p>

<p>I haven&#39; t figured out how to update this before flashing u-boot to the SPI
flash, if you know how please contact me! Installing <code>libubootenv-tool</code> to
use <code>fw_printenv</code> fails, no matter what offsets I provide in the
configuration file.</p>

<p>Without the <code>netretry</code> option turned on, PXE would try to load the config
files without having an IP address:</p>

<pre><code>  Device 0: unknown device
  ethernet@5020000 Waiting for PHY auto negotiation to complete......... TIMEOUT !
  The remote end did not respond in time.missing environment variable: pxeuuid
  Retrieving file: pxelinux.cfg/01-02-00-2e-12-34-56
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/00000000
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/0000000
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/000000
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/00000
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/0000
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/000
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/00
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/0
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/default-arm-sunxi-sunxi
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/default-arm-sunxi
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/default-arm
  *** ERROR: `serverip&#39; not set
  Retrieving file: pxelinux.cfg/default
  *** ERROR: `serverip&#39; not set
  Config file not found
</code></pre>

<p>After that the following lines would show up:</p>

<pre><code>  BOOTP broadcast 1
  DHCP client bound to address 192.0.2.60 (68 ms)
</code></pre>

<p>It then would not retry PXE boot but just hang with these lines:</p>

<pre><code>  No EFI system partition
  No EFI system partition
  Failed to persist EFI variables
  No UEFI binary known at 0x40080000
</code></pre>

<p>With <code>netretry</code> turned on it still does the above, but after it has got an IP
via DHCP, it tries again and succeeds.</p>

<h3 id="toc_2">Install TFTP &amp; NFS server</h3>

<p>If you have a Synology NAS you can use that for the NFS and TFTP part. Or you
can create new Debian 12 VM / container on your network and install a TFTP
and NFS server:</p>

<pre><code>apt install nfs-kernel-server tftpd-hpa
</code></pre>

<p>Note down the MAC address of the Orange Pi Zero 3. Look in your router&#39;s DHCP
server or execute the following shell command in Armbian:</p>

<pre><code>ip link
</code></pre>

<p>Output:</p>

<pre><code>  [...]
  2: end0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
    link/ether 02:00:2e:12:34:56 brd ff:ff:ff:ff:ff:ff
</code></pre>

<p>In our case the MAC is:</p>

<pre><code>  02-00-2e-12-34-56
</code></pre>

<p><strong>Make sure the Orange Pi 3 has a static IP address (I assign mine via DHCP
  but they are always the same)</strong></p>

<p>Create a folder for the kernel and files which will be shared over NFS:</p>

<pre><code>mkdir -p /srv/exports/02-00-2e-12-34-56
</code></pre>

<p>(Use the MAC address of your Orange Pi board as the last part of the folder name.)  </p>

<p>Edit the following file: </p>

<pre><code>vim /etc/exports
</code></pre>

<p>Add the folder we just made:</p>

<pre><code>/srv/exports/02-00-2e-12-34-56 192.0.2.60/32(rw,no_root_squash,async,insecure,no_subtree_check,crossmnt)
</code></pre>

<p>Replace <code>192.0.2.60/32</code> by the IP of the Orange Pi and also update the MAC
address. If you have multiple boards, create a folder and line in this file
for each board.</p>

<p>After each change, make the exports active with the following command:</p>

<pre><code>exportfs -arv
</code></pre>

<p>Create a config file for TFTP:</p>

<pre><code>  mkdir /srv/tftp/pxelinux.cfg
  vim /srv/tftp/pxelinux.cfg/01-02-00-2e-12-34-56
</code></pre>

<p><strong>Note that the MAC address is prefixed with 01-</strong>. </p>

<p>This is because <code>u-boot</code> in my case tried that file, not one without <code>01-</code>:</p>

<pre><code>Retrieving file: pxelinux.cfg/01-02-00-2e-12-34-56 # u-boot output
</code></pre>

<p>Not sure why, but without the prefix it would not work.</p>

<p>Add the following to that file:</p>

<pre><code>  LABEL linux
  KERNEL vmlinuz-6.6.31-current-sunxi64
  FDTDIR dtb-6.6.31-current-sunxi64
  APPEND root=/dev/nfs initrd=uInitrd-6.6.31-current-sunxi64 nfsroot=192.168.1.60:/srv/exports/02-00-2e-12-34-56 ip=dhcp rw rootwait
  DEFAULT linux
</code></pre>

<p>If your Armbian is newer, make sure to update the kernel version and also do
not forget to set the <code>nfsroot</code> IP to your NFS server. You can find your
kernel version by checking the <code>/boot</code> folder on your Orange Pi.</p>

<p>For each board you have you must create a file based on the MAC address.
Remember to update the NFS root path as well.</p>

<p>Download <code>syslinux</code> for the <code>pxeboot.0</code> file:</p>

<pre><code>wget  https://www.kernel.org/pub/linux/utils/boot/syslinux/syslinux-6.03.tar.gz
</code></pre>

<p>Extract the archive:</p>

<pre><code>tar -xf syslinux-6.03.tar.gz
</code></pre>

<p>Copy the file:</p>

<pre><code>cp syslinux-6.03/bios/core/pxelinux.0 /srv/tftp/
</code></pre>

<p>This might not be needed for other board, my <code>u-boot</code> version failed to boot
without it.</p>

<h3 id="toc_3">Preparing the rootfs over NFS</h3>

<p>Download the Armbian image you used to flash your Micro-SD card to the server
that will host your NFS.</p>

<p>Copy all files from the Armbian image to the NFS folder. First find the
correct offset to mount the IMG file using <code>fdisk -lu</code>:</p>

<pre><code>fdisk -lu Armbian_community_24.8.0-trunk.6_Orangepizero3_bookworm_current_6.6.31_minimal.img
</code></pre>

<p>Output:</p>

<pre><code>  Disk Armbian_community_24.8.0-trunk.6_Orangepizero3_bookworm_current_6.6.31_minimal.img: 1.32 GiB, 1417674752 bytes, 2768896 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes
  Disklabel type: dos
  Disk identifier: 0xe1f58a1d

  Device                                                                              Boot Start     End Sectors  Size Id Type
  Armbian_community_24.8.0-trunk.6_Orangepizero3_bookworm_current_6.6.31_minimal.img1       8192 2768895 2760704  1.3G 83 Linu
</code></pre>

<p>You must multiply the <code>Start</code> sector by the <code>Sector Size</code> to get the correct
byte offset, in our case:</p>

<pre><code>8192*512 = 4194304
</code></pre>

<p>Mount the IMG file with that offset:</p>

<pre><code>  mkdir /mnt/armbian
  mount -o offset=4194304 Armbian_community_24.8.0-trunk.6_Orangepizero3_bookworm_current_6.6.31_minimal.img /mnt/armbian
</code></pre>

<p>Copy over all the files, preserving ownership (via the <code>-rp</code> flag):</p>

<pre><code>cp -rp /mnt/armbian/* /srv/exports/02-00-2e-12-34-56/
</code></pre>

<p>Update <code>fstab</code> to make sure the Orange Pi does not try to mount the SD card (which is missing):</p>

<pre><code>vim /srv/exports/02-00-2e-12-34-56/etc/fstab
</code></pre>

<p>Comment out the topmost line since that is now available via NFS:</p>

<pre><code>  #UUID=a117-[...]-51 / ext4 defaults,noatime,commit=600,errors=remount-ro 0 1
  tmpfs /tmp tmpfs defaults,nosuid 0 0
</code></pre>

<p>You need to repeat the above steps for every board you have, make sure
to update the MAC address in <code>/etc/exports</code> and folder names.</p>

<p>Last but not least, copy the kernel and initrd files from the NFS folder to the TFTP folder:</p>

<pre><code>cp -rp /srv/exports/02-00-2e-12-34-56/boot/* /srv/tftp/
</code></pre>

<p>You need to update those files only once or when they change. Not for every
different board like you had to do with the NFS root folder / exports.   </p>

<h3 id="toc_4">DHCP server setup</h3>

<p>You must setup your local DHCP server to include
the PXE server IP and the filename (<code>pxelinux.0</code>). </p>

<p>You can use <code>dnsmasq</code> or <code>OpenWRT</code> but configuring those
is out of scope for this article. For testing I setup a separate network
with a Synology NAS acting as the DHCP server, this is the configuration there:</p>

<p><img src="/s/inc/img/k8s-dhcp.png" alt="synology DHCP"></p>

<p>In OpenWRT you can edit this file:</p>

<pre><code>vi /etc/config/dhcp
</code></pre>

<p>Add below config to the bottom</p>

<pre><code>  config boot &#39;linux&#39;
    option filename &#39;/pxelinux.0&#39;
    option serveraddress &#39;192.0.2.100&#39;
</code></pre>

<h3 id="toc_5">Test</h3>

<p>Hook up your console cable or monitor and reboot the Orange Pi board without a Micro-SD card inserted. It should start to download the kernel via TFTP:</p>

<pre><code>  Using ethernet@5020000 device  
  TFTP from server 192.0.2.100; our IP address is 192.0.2.60
  Filename &#39;pxelinux.cfg/01-02-00-2e-12-34-56&#39;.
  Load address: 0x4fd00000
  Loading: #
       19.5 KiB/s
  done
  Bytes transferred = 220 (dc hex)
  Config file &#39;pxelinux.0&#39; found 
  1:      linux
  Retrieving file: vmlinuz-6.6.31-current-sunxi64
  Using ethernet@5020000 device  
  TFTP from server 192.0.2.100; our IP address is 192.0.2.60
  Filename &#39;vmlinuz-6.6.31-current-sunxi64&#39;.
  Load address: 0x40080000
  Loading: #################################################################
  [...]
  ######################################
       122.1 KiB/s
  done
  Bytes transferred = 23445512 (165c008 hex)
  Retrieving file: uInitrd-6.6.31-current-sunxi64
  Using ethernet@5020000 device
  TFTP from server 192.0.2.100; our IP address is 192.0.2.60
  Filename &#39;uInitrd-6.6.31-current-sunxi64&#39;.
  Load address: 0x4ff00000
  Loading: #################################################################
       #################################################################
       #############################
       117.2 KiB/s
  done 
  Bytes transferred = 10910324 (a67a74 hex)
  append: root=/dev/nfs initrd=uInitrd-6.6.31-current-sunxi64 nfsroot=192.0.2.100:/srv/exports/02-00-2e-12-34-56 ip=dhcp rw   
  Retrieving file: dtb-6.6.31-current-sunxi64/allwinner/sun50i-h618-orangepi-zero3.dtb
  Using ethernet@5020000 device
  TFTP from server 192.0.2.100; our IP address is 192.0.2.60
  Filename &#39;dtb-6.6.31-current-sunxi64/allwinner/sun50i-h618-orangepi-zero3.dtb&#39;.
  Load address: 0x4fa00000
  Loading: ###
       109.4 KiB/s
  done 
  Bytes transferred = 32981 (80d5 hex)
  Moving Image from 0x40080000 to 0x40200000, end=418f0000
  ## Loading init Ramdisk from Legacy Image at 4ff00000 ...
     Image Name:   uInitrd
     Image Type:   AArch64 Linux RAMDisk Image (gzip compressed)
     Data Size:    10910260 Bytes = 10.4 MiB
     Load Address: 00000000
     Entry Point:  00000000
     Verifying Checksum ... OK
  ## Flattened Device Tree blob at 4fa00000
     Booting using the fdt blob at 0x4fa00000
  Working FDT set to 4fa00000
     Loading Ramdisk to 49598000, end 49fffa34 ... OK
</code></pre>

<p>Then it should boot up the kernel:</p>

<pre><code>Starting kernel ...

  [    0.000000] Booting Linux on physical CPU 0x0000000000 [0x410fd034]
  [    0.000000] Linux version 6.6.31-current-sunxi64 (armbian@next) (aarch64-linux-gnu-gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0, GNU ld (GNU Binutils for Ubuntu) 2.38) #1 SMP Fri May 17 10:02:40 UTC 2024
  [    0.000000] KASLR disabled due to lack of seed
  [    0.000000] Machine model: OrangePi Zero3
  [...]
  [    0.000000] Kernel command line: root=/dev/nfs initrd=uInitrd-6.6.31-current-sunxi64 nfsroot=192.0.2.100:/srv/exports/02-00-2e-12-34-56 ip=dhcp rw rootwait
  [    0.000000] Unknown kernel command line parameters &quot;nfsroot=192.0.2.100:/srv/exports/02-00-2e-12-34-56&quot;, will be passed to user space.
</code></pre>

<p>When booting is finished you can see that your root file system is now via NFS
by executing the <code>mount</code> command and looking for the <code>/</code> filesystem:</p>

<pre><code>  192.0.2.100:/srv/exports/02-00-2e-12-34-56 on / type nfs
  (rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,nolock,proto=tcp,port=2049,timeo=600,retrans=10,sec=sys,local_lock=all,addr=192.0.2.100)
</code></pre>

<h3 id="toc_6">NFS Benchmark vs Micro SD Card</h3>

<p>The following simple quick benchmark was done with the NFS server on a
Raspberry Pi 4 booted from an SSD, plugged in the other gigabit port in the
same PoE switch:</p>

<pre><code>  dd if=/dev/zero of=./test1.img bs=20M count=1 oflag=dsync
  1+0 records in
  1+0 records out
  20971520 bytes (21 MB, 20 MiB) copied, 1.86941 s, 11.2 MB/s
  root@opz3-2-midden-nfs:~# 
</code></pre>

<p>The same command when booted via a Micro SD card:</p>

<pre><code>  root@opz3-1-onder:~# dd if=/dev/zero of=./test1.img bs=20M count=1 oflag=dsync
  1+0 records in
  1+0 records out
  20971520 bytes (21 MB, 20 MiB) copied, 1.37473 s, 15.3 MB/s
</code></pre>

<p>NFS could be faster if the NFS server is faster but I have not yet noticed any
slowness or other issues when running this setup.  </p>

<p>The follow up article on my kubernetes adventure does note some problems with NFS as root filesystem
but that mostly has to do with <code>overlayfs</code>.</p>
Tags: <a href="../tags/armbian.html">armbian</a>
, <a href="../tags/debian.html">debian</a>
, <a href="../tags/dhcp.html">dhcp</a>
, <a href="../tags/k8s.html">k8s</a>
, <a href="../tags/kubernetes.html">kubernetes</a>
, <a href="../tags/linux.html">linux</a>
, <a href="../tags/netboot.html">netboot</a>
, <a href="../tags/network.html">network</a>
, <a href="../tags/nfs.html">nfs</a>
, <a href="../tags/orange-pi.html">orange-pi</a>
, <a href="../tags/pxe.html">pxe</a>
, <a href="../tags/raspberry-pi.html">raspberry-pi</a>
, <a href="../tags/tftp.html">tftp</a>
, <a href="../tags/tutorials.html">tutorials</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    