
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Set up a federated XMPP Chat Network with ejabberd, your own Google Talk Hangouts alternative - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  אֶשָּׂא עֵינַי אֶל־הֶהָרִים מֵאַיִן יָבֹא עֶזְרִֽי׃<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/static/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Set up a federated XMPP Chat Network with ejabberd, your own Google Talk Hangouts alternative</h2>
<p><small>Published: <span data-pagefind-meta='date'>11-06-2013</span> | Author: Remy van Elst | <a href="Set_up_a_federated_XMPP_Chat_Network_with_ejabberd.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over twelve years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Why set up your own XMPP server</a>
</li>
<li>
<a href="#toc_1">Information</a>
</li>
<li>
<a href="#toc_2">Single node / master node ejabberd installation</a>
<ul>
<li>
<a href="#toc_3">Installing Ejabberd</a>
</li>
<li>
<a href="#toc_4">Configuring ejabberd</a>
</li>
</ul>
</li>
<li>
<a href="#toc_5">Clustering ejabberd</a>
<ul>
<li>
<a href="#toc_6">Prepare the master node</a>
</li>
<li>
<a href="#toc_7">Prepare the slave nodes</a>
</li>
</ul>
</li>
<li>
<a href="#toc_8">Errors when clustering</a>
</li>
<li>
<a href="#toc_9">DNS SRV Records and Federation</a>
</li>
<li>
<a href="#toc_10">Final testing</a>
</li>
</ul>

</div><hr><div id="contents">
<p>This tutorial shows you how to set up your own federated chat network using
ejabberd. It covers a basic single node ejabberd server and also the setup of an
ejabberd cluster, including errors and DNS SRV record examples. Last but not
least federation is also covered.</p>

<p class="ad"> <!--<b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below. It means the world to me if you  show your appreciation and you'll help pay the server costs:</b><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">GitHub Sponsorship</a><br><br> <a href="https://pcbway.com/g/e7yQRg">PCBWay referral link (You get $5, I get $20 after you've placed an order)</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocea referral link  ($200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!)</a><br><br>--> </p>

<h3 id="toc_0">Why set up your own XMPP server</h3>

<p>There are a few reasons to set up your own XMPP server.</p>

<p>You might use Google Talk or as it now is named Hangouts. Google&#39;s service
recently changed and it is going to drop XMPP compatibility. If you have non-
gmail chat contacts you can keep chatting to them. And still use an open
protocol which is widely supported, not being locked in to google specific
software and hardware.</p>

<p>Or you might want to have more control over the logging of your data. Turn of
ejabberd logging and use <a href="http://otr.cypherpunks.ca/">Off The Record</a> which gives you full privacy (and
perfect forward secrecy).</p>

<p>You might want to use awesome multi-account chatting applications like
<a href="http://pidgin.im/">Pidgin</a>, <a href="http://psi-im.org/">Psi+</a>, <a href="https://live.gnome.org/Empathy">Empathy</a>, <a href="http://adium.im/">Adium</a>, iChat/Messages or Miranda IM.
And on Android you can use <a href="http://www.xabber.com/">Xabber</a>, <a href="http://beem-project.com/">Beem</a> or <a href="http://oneteam.im/">OneTeam</a>. Did you know
that big players like Facebook, WhatsApp and Google (used) to use XMPP as their
primary chat protocol?</p>

<p>Or you might be a sysadmin in need of an internal chat solution. I&#39;ve got a
ejabberd cluster running for a client consisting of 4 Debian 7 VM&#39;s (2GB RAM
each) spread over 3 sites and 1 datacenter, serving 12000 total users and most
of the time 6000 concurrently.</p>

<p>XMPP is an awesome and extendible protocol, on which you can find more here:
<a href="https://en.wikipedia.org/wiki/XMPP">https://en.wikipedia.org/wiki/XMPP</a></p>

<h3 id="toc_1">Information</h3>

<p>This setup is tested on Debian 7, Ubuntu 12.04 and 10.04 and OS X 10.8 Server,
all running <code>ejabberd</code> installed via the package manager, either <code>apt</code> or
<code>ports</code>. It also works on Windows Server 2012 with the <code>ejabberd</code> compiled from
the <code>erlang</code> source but that is not covered in this tutorial.</p>

<p>This tutorial uses the <code>example.org</code> domain as the chat domain, and the server
<code>chat.example.org</code> as the xmpp server domain. For the clustering part the
servers <code>srv1.example.org</code> and <code>srv2.example.org</code> are used. Replace these values
for your setup.</p>

<h3 id="toc_2">Single node / master node ejabberd installation</h3>

<p>If you want to set up a single node installation of ejabberd, e.g. no
clustering, then follow only this part and the DNS part of the tutorial. If you
want to set up a cluster, then also follow this part and continue with the next
part.</p>

<h4 id="toc_3">Installing Ejabberd</h4>

<p>This is simple, use your package manager to install ejabberd:</p>

<pre><code>apt-get install ejabberd
</code></pre>

<p>You will also install a few dependencies for the erlang runtime.</p>

<h4 id="toc_4">Configuring ejabberd</h4>

<p>We are going to configure the <code>ejabberd</code> service. First stop it:</p>

<pre><code>/etc/init.d/ejabberd stop
</code></pre>

<p>Now use your favorite text editor to edit the config files. The ejabberd config
is erlang config, so comments are not <code>#</code> but <code>%%</code>. Also, every config option
ends with a dot <code>(.)</code>.</p>

<pre><code>vim /etc/ejabberd/ejabberd.cfg
</code></pre>

<p>First we are going to add our chat domain name:</p>

<pre><code>{hosts, [&quot;example.org&quot;]}.
</code></pre>

<p>If you want more domains then you add them as shown below:</p>

<pre><code>{hosts, [&quot;sparklingclouds.nl&quot;, &quot;raymii.org&quot;, &quot;sparklingnetwork.nl&quot;]}.
</code></pre>

<p>This domain name is not the name of the servers you are adding.</p>

<p>Next we define an admin user:</p>

<pre><code>{acl, admin, {user, &quot;remy&quot;, &quot;example.org&quot;}}.
</code></pre>

<p><code>remy</code> corresponds with the part before the <code>@</code> in the XMPP ID, and
<code>example.org</code> with the part after. If you need more admin users, add another ACL
line.</p>

<p>Now if you want people to be able to register via their XMPP client enable in
band registration:</p>

<pre><code>{access, register, [{allow, all}]}.
</code></pre>

<p>If you are using MySQL or LDAP authentication then you wouldn&#39;t enable this.</p>

<p>I like to have a shared roster with roster groups, and some clients of mine use
a shared roster with everybody so that nobody has to add contacts but they see
all online users, enable the mod <em>shared</em> roster:</p>

<pre><code>%% Do this in the modules block
  {mod_shared_roster,[]},
</code></pre>

<p>If you are pleased with the config file, save it and restart ejabberd:</p>

<pre><code>/etc/init.d/ejabberd restart
</code></pre>

<p>We now need to register a user to test our setup. If you&#39;ve enabled in-band
registration you can use your XMPP client, and if you did not enable in-band
registration you can use the <code>ejabberdctl</code> command:</p>

<pre><code>ejabberdctl register remy example.org &#39;passw0rd&#39;
</code></pre>

<p>Now test it using an XMPP client like Pidgin, Psi+ or Empathy. If you can
connect, then you can continue with the tutorial. If you cannot connect, check
your ejabberd logs, firewall setting and such to troubleshoot it.</p>

<h3 id="toc_5">Clustering ejabberd</h3>

<p>Note that you have to have a correctly working master node to continue with the
ejabberd clustering. If your master node is not working then fix that first.</p>

<p>Important: the modules you use should be the same on every cluster node. If you
use LDAP/MySQL authentication, or a shared_roster, or special MUC settings, or
offline messaging, for the clustering this does not matter as long as it is on
all nodes.</p>

<p>So lets get started. We are first going to configure the master node, and then
the slave nodes.</p>

<h4 id="toc_6">Prepare the master node</h4>

<p>Stop the ejabberd server on the master and edit the <code>/etc/default/ejabberd</code>
file:</p>

<pre><code>vim /etc/default/ejabberd
</code></pre>

<p>Uncomment the hostname option and change it to a FQDN hostname:</p>

<pre><code>ERLANG_NODE=ejabberd@srv1.example.org
</code></pre>

<p>And add the external (public) IP addres as a tuple (no dots but comma&#39;s):</p>

<pre><code>INET_DIST_INTERFACE={20,30,10,5}
</code></pre>

<p>If you use ejabberd internally then use the primary NIC address.</p>

<p>We are going to remove all the mnesia tables. They will be rebuilt with an
ejabberd restart. This is way easier then changing the mnesia data itself. Don&#39;t
do this on a already configured node without backing up the erlang cookie.</p>

<p>First backup the erlang cookie:</p>

<pre><code>cp /var/lib/ejabberd/.erlang.cookie ~/
</code></pre>

<p>Then remove the mnesia database:</p>

<pre><code>rm /var/lib/ejabberd/*
</code></pre>

<p>And restore the erlang cookie:</p>

<pre><code>cp ~/.erlang.cookie /var/lib/ejabberd/.erlang.cookie
</code></pre>

<p>To make sure all erlang processes are stopped kill all processes from the
ejabberd user. This is not needed but the <code>epmd</code> supervisor process might still
be running:</p>

<pre><code>killall -u ejabberd
</code></pre>

<p>And start ejabberd again:</p>

<pre><code>/etc/init.d/ejabberd start 
</code></pre>

<p>If you can still connect and chat, then continue with the next part, configuring
the slave nodes.</p>

<h4 id="toc_7">Prepare the slave nodes</h4>

<p>*A slave node should first be configured and working as described in the first part of this tutorial. You can copy the config files from the master node. *</p>

<p>Stop the ejabberd server:</p>

<pre><code>/etc/init.d/ejabberd stop
</code></pre>

<p>Stop the ejabberd server on the master and edit the <code>/etc/default/ejabberd</code>
file:</p>

<pre><code>vim /etc/default/ejabberd
</code></pre>

<p>Uncomment the hostname option and change it to a FQDN hostname:</p>

<pre><code>ERLANG_NODE=ejabberd@srv2.example.org
</code></pre>

<p>And add the external (public) IP addres as a tuple (no dots but comma&#39;s):</p>

<pre><code>INET_DIST_INTERFACE={30,40,20,6}
</code></pre>

<p>If you use ejabberd internally then use the primary NIC address.</p>

<p>Now remove all the mnesia tables:</p>

<pre><code>rm /var/lib/ejabberd/*
</code></pre>

<p>Copy the cookie from the ejabberd master node, either by <code>cat</code> and <code>vim</code> or via
<code>scp</code>:</p>

<pre><code># On the master node
cat /var/lib/ejabberd/.erlang.cookie
HFHHGYYEHF362GG1GF

# On the slave node
echo &quot;HFHHGYYEHF362GG1GF&quot; &gt; /var/lib/ejabberd/.erlang.cookie
chown ejabberd:ejabberd /var/lib/ejabberd/.erlang.cookie
</code></pre>

<p>We are now going to add and compile an erlang module, the easy_cluster module.
This is a very small module which adds an erlang shell command to make the
cluster addition easier. You can also execute the commands in the erlang
functions itself on an erlang debug shell, but I find this easier and it gives
less errors:</p>

<pre><code>vim /usr/lib/ejabberd/ebin/easy_cluster.erl
</code></pre>

<p>Add the following contents:</p>

<pre><code>-module(easy_cluster).

-export([test_node/1,join/1]).

test_node(MasterNode) -&gt;
    case net_adm:ping(MasterNode) of &#39;pong&#39; -&gt;
        io:format(&quot;server is reachable.~n&quot;);
    _ -&gt;
        io:format(&quot;server could NOT be reached.~n&quot;)
    end.

join(MasterNode) -&gt;
    application:stop(ejabberd),
    mnesia:stop(),
    mnesia:delete_schema([node()]),
    mnesia:start(),
    mnesia:change_config(extra_db_nodes, [MasterNode]),
    mnesia:change_table_copy_type(schema, node(), disc_copies),
    application:start(ejabberd).
</code></pre>

<p>Save it and compile it into a working erlang module:</p>

<pre><code>cd /usr/lib/ejabberd/ebin/
erlc easy_cluster.erl
</code></pre>

<p>Now check if it succeeded:</p>

<pre><code>ls | grep easy_cluster.beam
</code></pre>

<p>If you see the file it worked. You can find more info on the module here:
<a href="https://github.com/chadillac/ejabberd-easy_cluster/">https://github.com/chadillac/ejabberd-easy_cluster/</a></p>

<p>We are now going to join the cluster node to the master node. Make sure the
master is working and running. Also make sure the erlang cookies are
synchronized.</p>

<p>On the slave node, start an ejabberd live shell:</p>

<pre><code>/etc/init.d/ejabberd live
</code></pre>

<p>This will start an erlang shell and it will give some output. If it stops
outputting then you can press <code>ENTER</code> to get a prompt. Enter the following
command to test if the master node can be reached:</p>

<pre><code>easy_cluster:test_node(&#39;ejabberd@srv1.example.org&#39;).
</code></pre>

<p>You should get the following response: <code>server is reachable</code>. If so, continue.</p>

<p>Enter the following command to actually join the node:</p>

<pre><code>easy_cluster:join(&#39;ejabberd@srv1.example.org&#39;).
</code></pre>

<p>Here&#39;s example output from a successful test and join join:</p>

<pre><code>/etc/init.d/ejabberd live
*******************************************************
* To quit, press Ctrl-g then enter q and press Return *
*******************************************************

Erlang R15B01 (erts-5.9.1) [source] [async-threads:0] [kernel-poll:false]

Eshell V5.9.1  (abort with ^G)

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.39.0&gt;:cyrsasl_digest:44) : FQDN used to check DIGEST-MD5 SASL authentication: &quot;srv2.example.org&quot;

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.576.0&gt;:ejabberd_listener:166) : Reusing listening port for 5222

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.577.0&gt;:ejabberd_listener:166) : Reusing listening port for 5269

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.578.0&gt;:ejabberd_listener:166) : Reusing listening port for 5280

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.39.0&gt;:ejabberd_app:72) : ejabberd 2.1.10 is started in the node &#39;ejabberd@srv2.example.org&#39;
easy_cluster:test_node(&#39;ejabberd@srv1.example.org&#39;).
server is reachable.
ok
(ejabberd@srv2.example.org)2&gt; easy_cluster:join(&#39;ejabberd@srv1.example.org&#39;).

=INFO REPORT==== 10-Jun-2013::20:38:51 ===
I(&lt;0.39.0&gt;:ejabberd_app:89) : ejabberd 2.1.10 is stopped in the node &#39;ejabberd@srv2.example.org&#39;

=INFO REPORT==== 10-Jun-2013::20:38:51 ===
    application: ejabberd
    exited: stopped
    type: temporary

=INFO REPORT==== 10-Jun-2013::20:38:51 ===
    application: mnesia
    exited: stopped
    type: permanent

=INFO REPORT==== 10-Jun-2013::20:38:52 ===
I(&lt;0.628.0&gt;:cyrsasl_digest:44) : FQDN used to check DIGEST-MD5 SASL authentication: &quot;srv2.example.org&quot;

=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.1026.0&gt;:ejabberd_listener:166) : Reusing listening port for 5222

=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.1027.0&gt;:ejabberd_listener:166) : Reusing listening port for 5269

=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.1028.0&gt;:ejabberd_listener:166) : Reusing listening port for 5280
ok
(ejabberd@srv2.example.org)3&gt;
=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.628.0&gt;:ejabberd_app:72) : ejabberd 2.1.10 is started in the node &#39;ejabberd@srv2.example.org&#39;
</code></pre>

<p>Exit your erlang shell by pressing <code>CTRL+C</code> twice. Now stop ejabberd and start
it again:</p>

<pre><code>/etc/init.d/ejabberd restart
</code></pre>

<p>You can now check in the admin webinterface if the cluster join succeeded:</p>

<pre><code>http://srv1.example.org:5280/admin/nodes/
</code></pre>

<p><img src="https://raymii.org/s/inc/img/ejabberd1.png" alt="Ejabberd nodes"></p>

<p>If it shows the other node you are finished. If not, see if the steps worked and
check the below section on troubleshooting.</p>

<p>Repeat the above steps for every node you want to add. You can add as many nodes
as you want.</p>

<h3 id="toc_8">Errors when clustering</h3>

<p>When setting up your cluster you might run into errors. Below are my notes for
the errors I found.</p>

<ul>
<li><p>ejabberd restart does not restart epmd (erlang daemon)</p>

<ul>
<li>overkill solution: killall -u ejabberd</li>
</ul></li>
<li><p>ejabberd gives hostname errors</p>

<ul>
<li>make sure the hostname is set correctly (<code>hostname srv1.example.com</code>)</li>
</ul></li>
<li><p>ejabberd gives inconsistent database errors</p>

<ul>
<li>backup the erlang cookie (<code>/var/lib/ejabberd/.erlang.cookie</code>) and then remove the contents of the <code>/var/lib/ejabberd</code> folder so that mnesia rebuilds its tables.</li>
</ul></li>
<li><p>ejabberd reports &quot;Connection attempt from disallowed node&quot;</p>

<ul>
<li>make sure the erlang cookie is correct (<code>/var/lib/ejabberd/.erlang.cookie</code>). Set vim in insert mode before pasting...</li>
</ul></li>
</ul>

<h3 id="toc_9">DNS SRV Records and Federation</h3>

<p>The DNS SRV Record is used both by chat clients to find the right server address
as well as by other XMPP servers for federation. Example: Alice configures her
XMPP clients with the email address alice@example.org. Her chat client looks up
the SRV record and knows the chat server to connect to is <code>chat.example.org</code>.
Bob sets up his client with the address <code>bob@bobsbussiness.com</code>, and adds Alice
as a contact. The XMPP server at <code>bobsbussiness.com</code> looks up the SRV record and
knows that it should initiate a server2server connection to <code>chat.example.org</code>
to federate and let Bob connect with Alice.</p>

<p>The BIND 9 config looks like this:</p>

<pre><code>; XMPP
_xmpp-client._tcp                       IN SRV 5 0 5222 chat.example.org.
_xmpp-server._tcp                       IN SRV 5 0 5269 chat.example.org.
_jabber._tcp                            IN SRV 5 0 5269 chat.example.org.
</code></pre>

<p>It is your basic SRV record, both the client port and the server2server port,
and legacy Jabber. If you have hosted DNS then either enter it in your panel or
consult your service provider.</p>

<p>You can use the following <code>dig</code> query to verify your SRV records:</p>

<pre><code>dig _xmpp-client._tcp.example.org SRV
dig _xmpp-server._tcp.example.org SRV
</code></pre>

<p>Or if you are on Windows and have to use <code>nslookup</code>:</p>

<pre><code>nslookup -querytype=SRV _xmpp-client._tcp.example.org
nslookup -querytype=SRV _xmpp-server._tcp.example.org
</code></pre>

<p>If you get a result like this then you are set up correctly:</p>

<pre><code>;; QUESTION SECTION:
;_xmpp-client._tcp.raymii.org.  IN      SRV

;; ANSWER SECTION:
_xmpp-client._tcp.raymii.org. 3600 IN   SRV     5 0 5222 chat.raymii.org.
</code></pre>

<p>The actual record for <code>chat.raymii.org</code> in my case are multiple A records:</p>

<pre><code>;; ADDITIONAL SECTION:
chat.raymii.org.        3600    IN      A       84.200.77.167
chat.raymii.org.        3600    IN      A       205.185.117.74
chat.raymii.org.        3600    IN      A       205.185.124.11
</code></pre>

<p>But if you run a single node this can also be a CNAME or just one A/AAAA record.</p>

<h3 id="toc_10">Final testing</h3>

<p>To test if it all worked you can add the Duck Duck Go XMPP bot. If this works
flawlessly and you can add it and chat to it, then you have done everything
correctly. The email address to add is <code>im@ddg.gg</code>.</p>
Tags: <a href="../tags/chat.html">chat</a>
, <a href="../tags/dns.html">dns</a>
, <a href="../tags/ejabberd.html">ejabberd</a>
, <a href="../tags/erlang.html">erlang</a>
, <a href="../tags/federation.html">federation</a>
, <a href="../tags/google-talk.html">google-talk</a>
, <a href="../tags/jabber.html">jabber</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/xmpp.html">xmpp</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    