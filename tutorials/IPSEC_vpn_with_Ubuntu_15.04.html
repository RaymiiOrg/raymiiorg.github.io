
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>IPSEC VPN on Ubuntu 15.04 with StrongSwan - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>IPSEC VPN on Ubuntu 15.04 with StrongSwan</h2>
<p><small>Published: 20-12-2015 | Author: Remy van Elst | <a href="IPSEC_vpn_with_Ubuntu_15.04.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7993642564731324"
                             crossorigin="anonymous"></script>
                        <!-- voorartikel -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-7993642564731324"
                             data-ad-slot="6172324376"
                             data-ad-format="auto"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        </div><br><div class='olderthanayear'><p><strong>&#10071; This post is over six years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Why a VPN?</a>
</li>
<li>
<a href="#toc_1">No L2TP?</a>
</li>
<li>
<a href="#toc_2">Overview</a>
</li>
<li>
<a href="#toc_3">Install Strongswan</a>
</li>
<li>
<a href="#toc_4">Certificates</a>
<ul>
<li>
<a href="#toc_5">Client certificate</a>
</li>
<li>
<a href="#toc_6">Revoking a certificate</a>
</li>
</ul>
</li>
<li>
<a href="#toc_7">IPSEC Configuration</a>
</li>
<li>
<a href="#toc_8">VPN user accounts and secrets</a>
</li>
<li>
<a href="#toc_9">Firewall &amp; Packet Routing</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_10">Persistent settings via /etc/rc.local</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_11">Start the VPN</a>
</li>
<li>
<a href="#toc_12">Client Configuration</a>
</li>
<li>
<a href="#toc_13">Sources</a>
</li>
</ul>

</div><hr><div id="contents">
<p>This is a guide on setting up an IPSEC VPN server on Ubuntu 15.04 using
StrongSwan as the IPsec server and for authentication. It has a detailed
explanation with every step. We choose the IPSEC protocol stack because of
vulnerabilities found in pptpd VPNs and because it is supported on all recent
operating systems by default.</p>

<h3 id="toc_0">Why a VPN?</h3>

<p>More than ever, your freedom and privacy when online is under threat.
Governments and ISPs want to control what you can and can&#39;t see while keeping a
record of everything you do, and even the shady-looking guy lurking around your
coffee shop or the airport gate can grab your bank details easier than you may
think. A self hosted VPN lets you surf the web the way it was intended:
anonymously and without oversight.</p>

<p>A VPN (virtual private network) creates a secure, encrypted tunnel through which
all of your online data passes back and forth. Any application that requires an
internet connection works with this self hosted VPN, including your web browser,
email client, and instant messaging program, keeping everything you do online
hidden from prying eyes while masking your physical location and giving you
unfettered access to any website or web service no matter where you happen to
live or travel to.</p>

<p>This tutorial is available for the following platforms:</p>

<ul>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_on_a_Raspberry_Pi_with_Arch_Linux.html">Raspberry Pi with Arch Linux ARM</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_vpn_with_CentOS_7.html">CentOS 7, Scientific Linux 7 or Red Hat Enterprise Linux 7 (IKEv2,no L2TP)</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_on_CentOS_-_Red_Hat_Enterprise_Linux_or_Scientific_-_Linux_6.html">CentOS 6, Scientific Linux 6 or Red Hat Enterprise Linux 6</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_vpn_with_Ubuntu_16.04.html">Ubuntu 16.04, (IKEv2,no L2TP)</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_vpn_with_Ubuntu_15.10.html">Ubuntu 15.10, (IKEv2,no L2TP)</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_vpn_with_Ubuntu_15.04.html">Ubuntu 15.04, (IKEv2,no L2TP)</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_14.04.html">Ubuntu 14.04 LTS</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_13.10.html">Ubuntu 13.10</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_13.04.html">Ubuntu 13.04</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.10.html">Ubuntu 12.10</a></p></li>
<li><p><a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html">Ubuntu 12.04 LTS</a></p></li>
</ul>

<p class="ad"> <a href="https://leafnode.nl">I'm developing a desktop monitoring app,  Leaf Node Monitoring, open source, but paid. For Windows, Linux & Android, go check it out.</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>IPSEC encrypts your IP packets to provide encryption and authentication, so no
one can decrypt or forge data between your clients and your server. It also
provides a tunnel to send data to the server.</p>

<p>This VPN setup is called a road-warrior setup, because clients can connect from
anywhere. Another much used VPN setup is called site-to-site, where two VPN
servers connect two networks with one another. In a road warrior setup your
local network isn&#39;t shared, but you do get access to the server&#39;s network.</p>

<p>To work trough this tutorial you should have:</p>

<ul>
<li>1 Ubuntu 15.04 server with at least 1 public IP address and root access</li>
<li>1 (or more) clients running an OS that support IPsec IKEv2 vpns (Ubuntu, Mac OS, Windows 7+, Android 4+).</li>
<li>Ports 4500/UDP, 500/UDP, 51/UDP and 50/UDP opened in the firewall.</li>
</ul>

<p>I do all the steps as the root user. You should do to, but only via <code>sudo -i</code> or
<code>su -</code>.</p>

<h3 id="toc_1">No L2TP?</h3>

<p>The previous tutorials all used L2TP to set up the VPN tunnel and use IPSEC only
for the encryption. With the IKEv2 protocol and newer operating systems (like OS
X 10.8+, Android 4+, iOS 6+ and Windows 7+) supporting IKEv2 we can also use
IPSEC to set up the tunnel, before we used IPSEC to do that.</p>

<p>This VPN will therefore not work out of the box on older operating systems. See
my other tutorials with L2TP on how to do that.</p>

<h3 id="toc_2">Overview</h3>

<p>The tutorial consists out of the following steps:</p>

<ul>
<li>Install packages</li>
<li>Generate certificates</li>
<li>Configure IPSEC</li>
<li>Configure Firewall</li>
</ul>

<p>Android and Windows client configuration is covered at the end of the tutorial.</p>

<h3 id="toc_3">Install Strongswan</h3>

<p>StrongSwan is a descendant of FreeS/WAN, just like Openswan or LibreSwan.
Strongswan however is actively developed, whereas the other ones, except
LibreSwan are less. StrongSwan is in default in the Ubuntu repositories. You can
read more about Strongswan on <a href="http://en.wikipedia.org/wiki/StrongSwan">wikipedia</a> or their <a href="http://strongswan.org">website</a>.</p>

<pre><code>apt-get install strongswan strongswan-plugin-af-alg strongswan-plugin-agent strongswan-plugin-certexpire strongswan-plugin-coupling strongswan-plugin-curl strongswan-plugin-dhcp strongswan-plugin-duplicheck strongswan-plugin-eap-aka strongswan-plugin-eap-aka-3gpp2 strongswan-plugin-eap-dynamic strongswan-plugin-eap-gtc strongswan-plugin-eap-mschapv2 strongswan-plugin-eap-peap strongswan-plugin-eap-radius strongswan-plugin-eap-tls strongswan-plugin-eap-ttls strongswan-plugin-error-notify strongswan-plugin-farp strongswan-plugin-fips-prf strongswan-plugin-gcrypt strongswan-plugin-gmp strongswan-plugin-ipseckey strongswan-plugin-kernel-libipsec strongswan-plugin-ldap strongswan-plugin-led strongswan-plugin-load-tester strongswan-plugin-lookip strongswan-plugin-ntru strongswan-plugin-pgp strongswan-plugin-pkcs11 strongswan-plugin-pubkey strongswan-plugin-radattr strongswan-plugin-sshkey strongswan-plugin-systime-fix strongswan-plugin-whitelist strongswan-plugin-xauth-eap strongswan-plugin-xauth-generic strongswan-plugin-xauth-noauth strongswan-plugin-xauth-pam strongswan-pt-tls-client 
</code></pre>

<h3 id="toc_4">Certificates</h3>

<p>The VPN server will identify itself with a certificate to the clients. The
clients can use a certificate to authenticate themself, this tutorial however
keeps it simple and sets up username and password authentication as well.</p>

<p>On Android with the StrongSwan Application you can just import the <code>.p12</code> we are
going to create later on. On Windows 7, we&#39;ll use <code>EAP</code> to configure a username
and password for our client.</p>

<p>You might want to install <code>haveged</code> to speed up the key generation process:</p>

<pre><code>apt-get install haveged
systemctl enable haveged
systemctl start haveged
</code></pre>

<p>Haveged provides a constant source of entropy and randomness.</p>

<p>Start by creating a self singed root CA private key:</p>

<pre><code>cd /etc/ipsec.d/
mkdir private
mkdir cacerts
mkdir certs
mkdir p12
ipsec pki --gen --type rsa --size 4096 --outform der &gt; private/strongswanKey.der
chmod 600 private/strongswanKey.der
</code></pre>

<p>Generate a self signed root CA certificate of that private key:</p>

<pre><code>ipsec pki --self --ca --lifetime 3650 --in private/strongswanKey.der --type rsa --dn &quot;C=NL, O=Example Company, CN=strongSwan Root CA&quot; --outform der &gt; cacerts/strongswanCert.der
</code></pre>

<p>You can view the certificate properties with the following command:</p>

<pre><code>ipsec pki --print --in cacerts/strongswanCert.der
</code></pre>

<p>Example output:</p>

<pre><code>cert:      X509
subject:  &quot;C=NL, O=Example Company, CN=strongSwan Root CA&quot;
issuer:   &quot;C=NL, O=Example Company, CN=strongSwan Root CA&quot;
validity:  not before Dec 20 08:12:27 2015, ok
           not after  Dec 17 08:12:27 2025, ok (expires in 3649 days)
serial:    1f:8e:0c:08:c4:a2:5b:1f
flags:     CA CRLSign self-signed 
authkeyId: d1:ad:f7:76:ad:10:02:7f:1d:04:e1:80:46:9d:b2:c7:fb:4d:d3:bb
subjkeyId: d1:ad:f7:76:ad:10:02:7f:1d:04:e1:80:46:9d:b2:c7:fb:4d:d3:bb
pubkey:    RSA 4096 bits
keyid:     88:ef:88:13:7f:da:5a:28:13:77:4b:4c:81:df:ee:db:fb:5c:69:54
subjkey:   d1:ad:f7:76:ad:10:02:7f:1d:04:e1:80:46:9d:b2:c7:fb:4d:d3:bb
</code></pre>

<p>Generate the VPN Host key. This is the keypair the VPN server host will use to
authenticate itself to clients. First the private key:</p>

<pre><code>ipsec pki --gen --type rsa --size 4096 --outform der &gt; private/vpnHostKey.der
chmod 600 private/vpnHostKey.der
</code></pre>

<p>Generate the public key and use our earlier created root ca to sign the public
key:</p>

<pre><code>ipsec pki --pub --in private/vpnHostKey.der --type rsa | ipsec pki --issue --lifetime 730 --cacert cacerts/strongswanCert.der --cakey private/strongswanKey.der --dn &quot;C=NL, O=Example Company, CN=vpn.example.org&quot; --san vpn.example.com --san vpn.example.net --san 185.3.211.43  --san @185.3.211.43 --flag serverAuth --flag ikeIntermediate --outform der &gt; certs/vpnHostCert.der
</code></pre>

<p>The domain name or IP address of your VPN server, which is later entered in the
clients connection properties, MUST be contained either in the subject
Distinguished Name (CN) and/or in a subject Alternative Name (<code>--san</code>). If this
does not match the clients will fail to connect.</p>

<p>The built in Windows 7 VPN client needs the <code>serverAuth</code> extended key usage flag
in your host certificate as shown above, or the client will refuse to connect.
In addition, OS X 10.7.3 or older requires the <code>ikeIntermediate</code> flag, which we
also add here.</p>

<p>We add the IP address twice, one with an <code>@</code> in front so that it gets added as
an <code>subjectAltName</code> of the <code>DNSName</code> type and one of the <code>IPAddess</code> type.</p>

<p>Let&#39;s view the certificate:</p>

<pre><code>ipsec pki --print --in certs/vpnHostCert.der
</code></pre>

<p>Output:</p>

<pre><code>cert:      X509
subject:  &quot;C=NL, O=Example Company, CN=vpn.example.org&quot;
issuer:   &quot;C=NL, O=Example Company, CN=strongSwan Root CA&quot;
validity:  not before Dec 20 08:15:22 2015, ok
           not after  Dec 19 08:15:22 2017, ok (expires in 729 days)
serial:    aa:31:ac:fd:4b:fa:41:5d
altNames:  vpn.example.com, vpn.example.net, 185.3.211.43, 185.3.211.43
flags:     serverAuth iKEIntermediate 
authkeyId: d1:ad:f7:76:ad:10:02:7f:1d:04:e1:80:46:9d:b2:c7:fb:4d:d3:bb
subjkeyId: 27:c7:87:de:83:38:6c:f7:56:57:c2:b3:1f:05:11:ca:b9:2f:89:d4
pubkey:    RSA 4096 bits
keyid:     f8:03:95:ad:eb:a1:76:93:5f:8d:b8:77:5e:60:dc:ce:78:42:3b:dd
subjkey:   27:c7:87:de:83:38:6c:f7:56:57:c2:b3:1f:05:11:ca:b9:2f:89:d4
</code></pre>

<p>You can also use OpenSSL to see the contents, here is an excerpt:</p>

<pre><code>openssl x509 -inform DER -in certs/vpnHostCert.der -noout -text
</code></pre>

<p>Output:</p>

<pre><code>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 12263773464207966557 (0xaa31acfd4bfa415d)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: C=NL, O=Example Company, CN=strongSwan Root CA
        Validity
            Not Before: Dec 20 07:15:22 2015 GMT
            Not After : Dec 19 07:15:22 2017 GMT
        Subject: C=NL, O=Example Company, CN=vpn.example.org
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                [...]
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Authority Key Identifier: 
                keyid:D1:AD:F7:76:AD:10:02:7F:1D:04:E1:80:46:9D:B2:C7:FB:4D:D3:BB

            X509v3 Subject Alternative Name: 
                DNS:vpn.example.com, DNS:vpn.example.net, IP Address:185.3.211.43, DNS:185.3.211.43
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, 1.3.6.1.5.5.8.2.2
    Signature Algorithm: sha1WithRSAEncryption
</code></pre>

<p>The private key (<code>/etc/ipsec.d/private/strongswanKey.der</code>) of the CA should be
moved somewhere safe, possibly to a special signing host without access to the
Internet. Theft of this master signing key would completely compromise your
public key infrastructure. Use it only to generate client certificates when
needed.</p>

<h4 id="toc_5">Client certificate</h4>

<p>Any client will require a personal certificate in order to use the VPN. The
process is analogous to generating a host certificate, except that we identify a
client certificate by the clients e-mail address rather than a hostname.</p>

<p>We create a keypair for the example user &quot;John&quot;.</p>

<p>Private key:</p>

<pre><code>ipsec pki --gen --type rsa --size 2048 --outform der &gt; private/JohnKey.der
chmod 600 private/JohnKey.der
</code></pre>

<p>Public key, signed by our root ca we generated:</p>

<pre><code>ipsec pki --pub --in private/JohnKey.der --type rsa | ipsec pki --issue --lifetime 730 --cacert cacerts/strongswanCert.der --cakey private/strongswanKey.der --dn &quot;C=NL, O=Example Company, CN=john@example.org&quot; --san &quot;john@example.org&quot; --san &quot;john@example.net&quot; --san &quot;john@185.3.211.43&quot; --outform der &gt; certs/JohnCert.der
</code></pre>

<p>A VPN client needs a client certificate, its corresponding private key, and the
signing CA certificate. The most convenient way is to put everything in a single
signed PKCS#12 file and export it with a paraphrase.</p>

<p>Convert the required keys to PEM formt before converting to a .p12:</p>

<pre><code>openssl rsa -inform DER -in private/JohnKey.der -out private/JohnKey.pem -outform PEM

openssl x509 -inform DER -in certs/JohnCert.der -out certs/JohnCert.pem -outform PEM

openssl x509 -inform DER -in cacerts/strongswanCert.der -out cacerts/strongswanCert.pem -outform PEM
</code></pre>

<p>Construct the .p12:</p>

<pre><code>openssl pkcs12 -export -inkey private/JohnKey.pem -in certs/JohnCert.pem -name &quot;John&#39;s VPN Certificate&quot; -certfile cacerts/strongswanCert.pem -caname &quot;strongSwan Root CA&quot; -out p12/John.p12
</code></pre>

<p>Enter a passphrase twice, then you have a .p12. You can send <code>John.p12</code> and its
export paraphrase to the person who is going to install it onto the client. In
some cases (iOS for example) you have to separately include the CA certificate
<code>cacerts/strongswanCert.pem</code>.</p>

<p>Transport this <code>John.p12</code> file and the password over seperate channels to a
client.</p>

<p>If you need any more user certificates, repeat the above steps with other user
data. You can also do this later on.</p>

<h4 id="toc_6">Revoking a certificate</h4>

<p>If a certificate is lost or stolen, it must be revoked so nobody can use it to
connect to your VPN server. Assuming the certificate from the previous step got
stolen, we revoke it with:</p>

<pre><code>cd /etc/ipsec.d/
ipsec pki --signcrl --reason key-compromise \
    --cacert cacerts/strongswanCert.der \
    --cakey private/strongswanKey.der \
    --cert certs/JohnCert.der \
    --outform der &gt; crls/crl.der
</code></pre>

<p>Restart ipsec afterwards:</p>

<pre><code>ipsec restart
</code></pre>

<p>This generates the new certificate revocation list (CRL) <code>crls/crl.der</code>. When
someone tries to authenticate with the stolen certificate, he&#39;ll receive an
authentication credentials error message, and your log file will contain
something like:</p>

<pre><code>04[CFG] using trusted certificate &quot;C=NL, O=Example Company, CN=strongSwan Root CA&quot;
04[CFG]   crl correctly signed by &quot;C=NL, O=Example Company, CN=strongSwan Root CA&quot;
04[CFG] certificate was revoked on Dec 20 14:51:24 UTC 2015, reason: key compromise
</code></pre>

<p>To add another revoked certificate to the same list, we need to copy the
existing list into a temporary file:</p>

<pre><code>cd /etc/ipsec.d/
cp crls/crl.der crl.der.tmp
ipsec pki --signcrl --reason key-compromise \
  --cacert cacerts/strongswanCert.der \
  --cakey private/strongswanKey.der \
  --cert certs/OtherStolenCert.der \
  --lastcrl crl.der.tmp \
  --outform der &gt; crls/crl.der
rm crl.der.tmp
</code></pre>

<p>Restart ipsec afterwards:</p>

<pre><code>ipsec restart
</code></pre>

<h3 id="toc_7">IPSEC Configuration</h3>

<p>The main <code>ipsec</code> configuration file is located in <code>/etc/strongswan.d/</code>. We are
going to edit it:</p>

<pre><code>vim /etc/strongswan.d/VPN.conf
</code></pre>

<p>Place the following contents:</p>

<pre><code># ipsec.conf - strongSwan IPsec configuration file

config setup
    charondebug=&quot;ike 4, knl 4, cfg 4, net 4, esp 4, dmn 4,  mgr 4&quot;

conn %default
    keyexchange=ikev2
    ike=aes128-sha1-modp1024,aes128-sha1-modp1536,aes128-sha1-modp2048,aes128-sha256-ecp256,aes128-sha256-modp1024,aes128-sha256-modp1536,aes128-sha256-modp2048,aes256-aes128-sha256-sha1-modp2048-modp4096-modp1024,aes256-sha1-modp1024,aes256-sha256-modp1024,aes256-sha256-modp1536,aes256-sha256-modp2048,aes256-sha256-modp4096,aes256-sha384-ecp384,aes256-sha384-modp1024,aes256-sha384-modp1536,aes256-sha384-modp2048,aes256-sha384-modp4096,aes256gcm16-aes256gcm12-aes128gcm16-aes128gcm12-sha256-sha1-modp2048-modp4096-modp1024,3des-sha1-modp1024!
    esp=aes128-aes256-sha1-sha256-modp2048-modp4096-modp1024,aes128-sha1,aes128-sha1-modp1024,aes128-sha1-modp1536,aes128-sha1-modp2048,aes128-sha256,aes128-sha256-ecp256,aes128-sha256-modp1024,aes128-sha256-modp1536,aes128-sha256-modp2048,aes128gcm12-aes128gcm16-aes256gcm12-aes256gcm16-modp2048-modp4096-modp1024,aes128gcm16,aes128gcm16-ecp256,aes256-sha1,aes256-sha256,aes256-sha256-modp1024,aes256-sha256-modp1536,aes256-sha256-modp2048,aes256-sha256-modp4096,aes256-sha384,aes256-sha384-ecp384,aes256-sha384-modp1024,aes256-sha384-modp1536,aes256-sha384-modp2048,aes256-sha384-modp4096,aes256gcm16,aes256gcm16-ecp384,3des-sha1!
    dpdaction=clear
    dpddelay=300s
    rekey=no
    left=%any
    leftid=vpn.example.org
    leftsubnet=0.0.0.0/0
    leftcert=vpnHostCert.der
    right=%any
    rightsourceip=10.42.42.0/24,2002:25f7:7489:3::/112
    rightdns=8.8.8.8,2001:4860:4860::8888

conn IPSec-IKEv2
    keyexchange=ikev2
    leftauth=pubkey
    rightauth=pubkey
    leftsendcert=always
    auto=add

conn IPSec-IKEv2-EAP
    keyexchange=ikev2
    leftauth=pubkey
    leftsendcert=always
    rightauth=eap-mschapv2
    rightsendcert=never
    eap_identity=%any
    auto=add

conn CiscoIPSec
    keyexchange=ikev1
    rightauth=pubkey
    rightauth2=xauth
    auto=add
</code></pre>

<p>Remove the <code>/etc/ipsec.conf</code> file and create a symlink:</p>

<pre><code>rm /etc/ipsec.conf
ln -s /etc/strongswan.d/VPN.conf /etc/ipsec.conf
</code></pre>

<p>This configuration has settings for three types of VPN services: IKEv2 + RSA
certificate, IKEv2 + EAP and IKEv1 + Xauth, thus providing compatibility for a
wide range of recent IPsec clients.</p>

<p>Apple added support for IKEv2 in iOS 8, but it needs to be configured using a
<a href="https://wiki.strongswan.org/projects/strongswan/wiki/AppleIKEv2Profile">custom configuration profile</a>.</p>

<p>OS X does not support IKEv2 (not on 10.10 or lower).</p>

<p>For iOS 9+ and OS X 10.10+ you need to make sure the <code>leftid=</code> is the same as
the <code>CN</code> in your certificate. You also need to enter that on the devices,
otherwise you&#39;ll get a <code>no matching peer config found</code> log error.</p>

<p>Android 4+ and Windows 7+ support IKEv2.</p>

<p>Clients will get the Google DNS servers and an IP address in the <code>10.42.42.0/24</code>
range. We use a strong ciphersuite.</p>

<p>The <code>leftcert=vpnHostCert.der</code> expands to the path
<code>/etc/ipsec.d/certs/vpnHostCert.der</code>.</p>

<h3 id="toc_8">VPN user accounts and secrets</h3>

<p>The users are configured in the <code>/etc/ipsec.secrets</code> file.</p>

<pre><code>vim /etc/ipsec.secrets
</code></pre>

<p>Example content:</p>

<pre><code>: RSA vpnHostKey.der
: PSK 0sv+NkxY9LLZvwj4qCC2o/gGrWDF2d21jL

alice : EAP &quot;YzCgnveYuL429fH&quot; 
bob : EAP &quot;E23pOjvW8z248iAp&quot; 
hipster: XAUTH &quot;xauth_ikev1_example_password&quot;
</code></pre>

<p>In the example above the RSA private key file vpnHostKey.der stored in the
<code>/etc/openswan.d/private/</code> directory is not protected by symmetric encryption (a
password).</p>

<p>The PSK for IKEv1 connections is also defined.</p>

<p>The format of the EAP MSCHAPv2 user credentials is:</p>

<pre><code>[&lt;domain&gt;\]&lt;username&gt; : EAP &quot;&lt;plaintext password&gt;&quot; 
</code></pre>

<p>Add as many users as you like there. The first line allows all users with a
valid certificate to use the VPN, the other lines allow users without a
certificate to login with a username and password. The space between the
username, the colon (:) and EAP needs to be there.</p>

<p>I strongly suggest adding NO users here, and setting NO PSK. Use certificates,
they are much more secure.</p>

<p>Whenever you edit <code>/etc/ipsec.secrets</code> while strongSwan is running, you must
reload the file:</p>

<pre><code>ipsec rereadsecrets
</code></pre>

<p>If you need to generate password, OpenSSL can help you there:</p>

<pre><code> openssl rand -base64 24
 jzHMIj6sqBbSI6LFmXINrwZWkXG9O8GW
</code></pre>

<h3 id="toc_9">Firewall &amp; Packet Routing</h3>

<p>Configure the iptables firewall to allow vpn traffic and to forward packets:</p>

<pre><code># for ISAKMP (handling of security associations)
iptables -A INPUT -p udp --dport 500 --j ACCEPT
# for NAT-T (handling of IPsec between natted devices)
iptables -A INPUT -p udp --dport 4500 --j ACCEPT
# for ESP payload (the encrypted data packets)
iptables -A INPUT -p esp -j ACCEPT
# for the routing of packets on the server
iptables -t nat -A POSTROUTING -j SNAT --to-source %SERVERIP% -o eth+
</code></pre>

<p>Replace %SERVERIP% with the external IP of your VPS. If your external interface
is not named ethX (<code>+</code> is a wildcard) then rename appropriately.</p>

<p>Execute the below commands to enable kernel IP packet forwarding and disable ICP
redirects.</p>

<pre><code>echo &quot;net.ipv4.ip_forward = 1&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.all.accept_redirects = 0&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.all.send_redirects = 0&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.default.rp_filter = 0&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.default.accept_source_route = 0&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.default.send_redirects = 0&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.icmp_ignore_bogus_error_responses = 1&quot; |  tee -a /etc/sysctl.conf
</code></pre>

<p>Set these settings for other network interfaces:</p>

<pre><code>for vpn in /proc/sys/net/ipv4/conf/*; do echo 0 &gt; $vpn/accept_redirects; echo 0 &gt; $vpn/send_redirects; done
</code></pre>

<p>Apply them:</p>

<pre><code>sysctl -p
</code></pre>

<h5 id="toc_10">Persistent settings via /etc/rc.local</h5>

<p>To make sure this keeps working at boot you might want to add the following to
/etc/rc.local:</p>

<pre><code>for vpn in /proc/sys/net/ipv4/conf/*; do echo 0 &gt; $vpn/accept_redirects; echo 0 &gt; $vpn/send_redirects; done
iptables -t nat -A POSTROUTING -j SNAT --to-source %SERVERIP% -o eth+
iptables -A INPUT -p udp --dport 500 --j ACCEPT
iptables -A INPUT -p udp --dport 4500 --j ACCEPT
iptables -A INPUT -p esp -j ACCEPT
</code></pre>

<p>Add it before the <code>exit 0</code> line and replace %SERVERIP% with the external IP of
your VPS.</p>

<h3 id="toc_11">Start the VPN</h3>

<p>All the configuration on the server is now done. Enable the VPN at startup:</p>

<pre><code>systemctl enable strongswan
</code></pre>

<p>And start it:</p>

<pre><code>systemctl start strongswan
</code></pre>

<p>If you get a permission denied error, stroke the files with apparmor:</p>

<pre><code>apparmor_parser -R /etc/apparmor.d/usr.lib.ipsec.charon
apparmor_parser -R /etc/apparmor.d/usr.lib.ipsec.stroke
</code></pre>

<p>Check the status of the service:</p>

<pre><code>ipsec status
</code></pre>

<p>Output:</p>

<pre><code>Security Associations (0 up, 0 connecting):
  none
</code></pre>

<p>And a more elaborate status:</p>

<pre><code>ipsec statusall
</code></pre>

<p>Output:</p>

<pre><code>Status of IKE charon daemon (strongSwan 5.1.2, Linux 3.19.0-41-generic, x86_64):
  uptime: 94 seconds, since Dec 20 08:27:24 2015
  malloc: sbrk 1859584, mmap 266240, used 693200, free 1166384
  worker threads: 11 of 16 idle, 5/0/0/0 working, job queue: 0/0/0/0, scheduled: 0
  loaded plugins: charon test-vectors curl unbound ldap pkcs11 aes rc2 sha1 sha2 md4 md5 random nonce x509 revocation constraints pubkey pkcs1 pkcs7 pkcs8 pkcs12 pgp sshkey ipseckey pem openssl gcrypt af-alg fips-prf gmp xcbc cmac hmac ctr ccm gcm ntru attr kernel-netlink resolve socket-default farp stroke updown eap-identity eap-aka eap-aka-3gpp2 eap-gtc eap-mschapv2 eap-dynamic eap-radius eap-tls eap-ttls eap-peap xauth-generic xauth-eap xauth-noauth tnc-imc tnc-tnccs tnccs-20 tnccs-11 tnccs-dynamic dhcp whitelist lookip error-notify certexpire led duplicheck radattr addrblock
Listening IP addresses:
  10.41.170.21
Connections:
Security Associations (0 up, 0 connecting):
  none
</code></pre>

<h3 id="toc_12">Client Configuration</h3>

<p>See the <a href="https://wiki.strongswan.org/projects/strongswan/wiki/Windows7">Strongswan Wiki</a> for guides on configuring Windows and <a href="https://wiki.strongswan.org/projects/strongswan/wiki/IOS_(Apple)">OS X/iOS
clients</a></p>

<h3 id="toc_13">Sources</h3>

<p>Thanks to:</p>

<ul>
<li><a href="https://wiki.strongswan.org/projects/strongswan">StrongSwan Wiki</a> and the </li>
<li><a href="https://wiki.strongswan.org/projects/strongswan/wiki/IpsecConf">StrongSwan ipsec.conf reference</a> for most of the configuration.</li>
<li><a href="https://www.zeitgeist.se/2013/11/22/strongswan-howto-create-your-own-vpn/">zeitgeist</a> for the certificate setup.</li>
</ul>
Tags: <a href="../tags/debian.html">debian</a>
, <a href="../tags/ikev2.html">ikev2</a>
, <a href="../tags/ipsec.html">ipsec</a>
, <a href="../tags/openswan.html">openswan</a>
, <a href="../tags/openvpn.html">openvpn</a>
, <a href="../tags/pptp.html">pptp</a>
, <a href="../tags/strongswan.html">strongswan</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/ubuntu.html">ubuntu</a>
, <a href="../tags/vpn.html">vpn</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
     
    </main>
    </body>
    </html>
    