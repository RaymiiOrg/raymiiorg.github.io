
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Use Ubuntu behind a Microsoft ForeFront TMG proxy with cntlm - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Use Ubuntu behind a Microsoft ForeFront TMG proxy with cntlm</h2>
<p><small>Published: <span data-pagefind-meta='date'>27-10-2018</span> | Author: Remy van Elst | <a href="Use_Ubuntu_behind_a_Microsoft_ForeFront_TMG_proxy_with_cntlm.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over five years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Installing cntlm</a>
</li>
<li>
<a href="#toc_1">Configuring cntlm</a>
</li>
<li>
<a href="#toc_2">Testing cntlm</a>
<ul>
<li>
<a href="#toc_3">Testing with curl</a>
</li>
<li>
<a href="#toc_4">Testing with cntlm</a>
</li>
</ul>
</li>
<li>
<a href="#toc_5">Systemwide proxy configuration</a>
</li>
</ul>

</div><hr><div id="contents">
<p><img src="https://raymii.org/s/inc/img/tmg.png" alt=""></p>

<p>Recently I had to deploy a few machines in a network where outgoing network
access was forced through a Microsoft Forefront TMG proxy. For all the Windows
clients this went automatically due to domain policies, for Linux this has to be
set up manually. Defining the proxy in <code>/etc/environment</code> was not enough since
NTML authentication is required, which is not supported by default. I found
<code>cntlm</code>, a piece of software which acts as a local proxy, translating all
requests to authenticated NTLM requests to your upstream proxy. This guide
covers the (offline) installation, setup, getting the correct password hash and
system-wide configuration. It should work on a desktop as well, but I did not
test that.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p>This guide was tested on both Ubuntu 16.04 and 18.04. You need a user account
with the correct permissions for the proxy. The account will be locked, so make
sure you have access the the Active Directory to unlock it when needed.</p>

<h3 id="toc_0">Installing cntlm</h3>

<p>If you can get a temporary exeption for the machine, you can use your favorite
package manager to install cntlm:</p>

<pre><code>apt-get install cntlm
</code></pre>

<p>If you have no network access, download the package from <a href="https://packages.ubuntu.com/xenial/cntlm">the ubuntu packages
site</a>. The <code>dpkg</code> file has no dependencies other than <code>libc</code>.</p>

<p>Place it on the server and install it:</p>

<pre><code>dpkg -i cntlm*.deb
</code></pre>

<p>Make sure the service is not started yet:</p>

<pre><code>systemctl stop cntlm
</code></pre>

<h3 id="toc_1">Configuring cntlm</h3>

<p>The configuration file lives in <code>/etc/cntlm.conf</code> and is very simple. You can
setup cntlm as a proxy for other servers, but that is not in the scope of this
guide. For me, I used Ansible to configure these few servers.</p>

<p>You can put the password as plaintext in the configuration file, but we are not
going to do that since the software supports placing the ntlm hash directly.</p>

<p>First we use the commandline to figure out which type of hash is used. Use the
<code>-M</code> (magic) parameter with a username and password to autodetect the correct
settings:</p>

<pre><code>cntlm -u $USERNAME@$ADDOMAIN -M http://raymii.org proxy.$ADDOMAIN.EXT 8080
Password: 
</code></pre>

<p>Example output:</p>

<pre><code>Config profile  1/4... OK (HTTP code: 200)
----------------------------[ Profile  0 ]------
Auth            NTLMv2
PassNTLMv2      AAAAAAABBBBBBBBBXXXXXXX99999AAAA
------------------------------------------------
</code></pre>

<p>The username format is <code>$USERNAME@$domain</code>. The password is your domain
account&#39;s password. The last two parameters are the proxy hostname/ip and port.</p>

<p>In this case we have the NTLMv2 hash and the output format. In other cases,
there might be an NTLM hash, an NT hash, an LM hash or any combination.</p>

<p>In the configuration file, abide to the following rules:</p>

<ul>
<li>Auth is NT: use only PassNT</li>
<li>Auth is LM: use only PassLM</li>
<li>Auth is NTLM: use both PassLM and PassNT</li>
<li>Auth is NTLMv2: use only PassNTLMv2</li>
</ul>

<p>If you cannot connect right away or need to generate the hash offline, cntlm can
do that as well:</p>

<pre><code>echo &quot;P@ssw0rd&quot; | cntlm -H -u $USERNAME -d $ADDOMAIN 
</code></pre>

<p>Output:</p>

<pre><code>Password: 
PassLM          xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
PassNT          yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
PassNTLMv2      AAAAAAABBBBBBBBBXXXXXXX99999AAAA    # Only for user &#39;$USERNAME&#39;, domain &#39;$ADDOMAIN&#39;
</code></pre>

<p>Use your favorite editor to place these values in the configuration file.</p>

<pre><code>vim /etc/cntlm.conf
</code></pre>

<p>The file is self-explanatory, but read through it if you want to setup a
gateway. Here is the config we need for the above setup:</p>

<pre><code>Username    $USERNAME
Domain      $ADDOMAIN
PassNTLMv2  AAAAAAABBBBBBBBBXXXXXXX99999AAAA
Auth        NTLMv2
Workstation $SERVER_HOSTNAME
Proxy       proxy.$ADDOMAIN.EXT:8080
NoProxy     localhost, 127.0.0.*, 10.*, 192.168.*
Listen      3128
</code></pre>

<p><code>WorkStation</code> is optional, by default the system hostname is used. The other
values like <code>Proxy</code> and <code>Listen</code> are self-explanatory as well.</p>

<p>When your configuration file is done, make sure only root can read it:</p>

<pre><code>chmod 600 /etc/cntlm.conf
</code></pre>

<p>Start the service:</p>

<pre><code>systemctl start cntlm
</code></pre>

<h3 id="toc_2">Testing cntlm</h3>

<p>Use either cntlm itself with debug on, or a tool like curl with the proxy
configured to test the local proxy.</p>

<h4 id="toc_3">Testing with curl</h4>

<p>curl has the <code>-x</code> option to provide a proxy. Since <code>cntlm</code> is configured and
listening on <code>127.0.0.1:3128</code> we can use it to test with curl:</p>

<pre><code>curl -v -x http://127.0.0.1:3128/ http://raymii.org
</code></pre>

<p>Example output:</p>

<pre><code>* Rebuilt URL to: raymii.org/
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
&gt; GET http://raymii.org/ HTTP/1.1
&gt; Host: raymii.org
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
[...]
&lt; HTTP/1.1 200 OK
&lt; Via: 1.1 proxy
&lt; Connection: Keep-Alive
&lt; Proxy-Connection: Keep-Alive
&lt; Content-Length: 376
[...]
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 3.2//EN&quot;&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta name=&quot;generator&quot; content=&quot;newspeak.py&quot;&gt;
&lt;title&gt;Raymii.org&lt;/title&gt;
&lt;meta http-equiv=&quot;REFRESH&quot; content=&quot;0; url=https://raymii.org/s/&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
You should be redirected to &lt;a href=&quot;https://raymii.org/s/&quot;&gt;https://raymii.org/s/. If that is not the case, please click here to continue.&lt;/a&gt;
&lt;/body&gt;
* Connection #0 to host 127.0.0.1 left intact
</code></pre>

<p>As you can see, the proxy is used and working. If it is not, the output will
include something like below:</p>

<pre><code># lots of html
 407 Proxy Authentication Required. Forefront TMG requires authorization to fulfill the request. Access to the Web Proxy filter is denied. (12209).
</code></pre>

<p>Your password hash could be wrong, the account might be locked out or the other
authentication credentials are wrong.</p>

<h4 id="toc_4">Testing with cntlm</h4>

<p>Using the <code>-v</code> option, for verbose with the <code>-M</code> option as before, we can test
the connection.</p>

<pre><code>cntlm -fv -c /etc/cntlm.conf -M http://raymii.org
</code></pre>

<p>Output:</p>

<pre><code>section: global, Username = &#39;$USERNAME&#39;
section: global, Domain = &#39;$ADDOMAIN&#39;
section: global, PassNTLMv2 = &#39;AAAAAAABBBBBBBBBXXXXXXX99999AAAA&#39;
section: global, Auth = &#39;NTLMv2&#39;
section: global, Workstation = &#39;$SERVER_HOSTNAME&#39;
section: global, Proxy = &#39;proxy.$ADDOMAIN.EXT:8080&#39;
section: global, NoProxy = &#39;localhost, 127.0.0.*, 10.*, 192.168.*&#39;
section: global, Listen = &#39;3128&#39;
cntlm: Proxy listening on 127.0.0.1:3128
Adding no-proxy for: &#39;localhost&#39;
Adding no-proxy for: &#39;127.0.0.*&#39;
Adding no-proxy for: &#39;10.*&#39;
Adding no-proxy for: &#39;192.168.*&#39;
cntlm: Using proxy proxy.$ADDOMAIN.EXT:8080
cntlm: Resolving proxy proxy.$ADDOMAIN.EXT...
Config profile  1/4... Resolve proxy.$ADDOMAIN.EXT:
  -&gt; 192.0.2.10
NTLM Request:
       Domain: $ADDOMAIN
     Hostname: $SERVER_HOSTNAME
        Flags: 0xA208B205

Sending PROXY auth request...
Proxy-Connection               =&gt; keep-alive
Host                           =&gt; raymii.org
Proxy-Authorization            =&gt; NTLM xxxx
Content-Length                 =&gt; 0

Reading PROXY auth response...
HEAD: HTTP/1.1 407 Proxy Authentication Required ( Access is denied.  )
Via                            =&gt; 1.1 proxy
Proxy-Authenticate             =&gt; NTLM xxxx
Connection                     =&gt; Keep-Alive
Proxy-Connection               =&gt; Keep-Alive
Pragma                         =&gt; no-cache
Cache-Control                  =&gt; no-cache
Content-Type                   =&gt; text/html
Content-Length                 =&gt; 0
NTLM Challenge:
    Challenge: xxx (len: 208)
        Flags: 0xA2898205
    NT domain: $ADDOMAIN
       Server: proxy
       Domain: $ADDOMAIN.EXT
         FQDN: proxy.$ADDOMAIN.EXT
          TLD: $ADDOMAIN.EXT
            7: 
        TBofs: 66
        TBlen: 142
        ttype: 0
NTLMv2:
        Nonce: xxxxxxxxxxxxxxxxxx
    Timestamp: 131850205990000000
NTLM Response:
     Hostname: &#39;$SERVER_HOSTNAME&#39;
       Domain: &#39;$ADDOMAIN&#39;
     Username: &#39;$USERNAME&#39;
     Response: &#39;xxxx&#39; (190)
     Response: &#39;xxxx&#39; (24)
HEAD: HTTP/1.1 200 OK
OK (HTTP code: 200)
----------------------------[ Profile  0 ]------
Auth            NTLMv2
PassNTLMv2      AAAAAAABBBBBBBBBXXXXXXX99999AAAA
------------------------------------------------
cntlm: Terminating with 0 active threads
</code></pre>

<p>The <code>200 OK</code> is what we&#39;re looking for. Stuff like below is wrong, just as
above, check your credentials and config:</p>

<pre><code>HEAD: HTTP/1.1 407 Proxy Authentication Required ( Forefront TMG requires authorization to fulfill the request. Access to the Web Proxy filter is denied.  )
Credentials rejected

Wrong credentials, invalid URL or proxy doesn&#39;t support NTLM nor BASIC.
</code></pre>

<p>The account will be locked, so make sure you have access the the Active
Directory to unlock it.</p>

<h3 id="toc_5">Systemwide proxy configuration</h3>

<p>When the proxy is working, you make it available for the entire system. Most
software will understand this, but make sure to check the specific manpages if
software is not working for you.</p>

<p>Edit the following file:</p>

<pre><code>vim /etc/environment
</code></pre>

<p>Append the following:</p>

<pre><code>http_proxy=&quot;http://127.0.0.1:3128/&quot;
https_proxy=&quot;http://127.0.0.1:3128/&quot;
ftp_proxy=&quot;http://127.0.0.1:3128/&quot;
no_proxy=&quot;localhost,127.0.0.1,localaddress,.localdomain.com&quot;

HTTP_PROXY=&quot;http://127.0.0.1:3128/&quot;
HTTPS_PROXY=&quot;http://127.0.0.1:3128/&quot;
FTP_PROXY=&quot;http://127.0.0.1:3128/&quot;
NO_PROXY=&quot;localhost,127.0.0.1,localaddress,.localdomain.com&quot;
</code></pre>

<p>Save it and logout. Log back in to make it active.</p>

<p>For <code>apt-get</code>, you need to edit the following file:</p>

<pre><code>vim /etc/apt/apt.conf
</code></pre>

<p>Append the following:</p>

<pre><code>Acquire::http::proxy &quot;http://127.0.0.1:3128/&quot;;
Acquire::ftp::proxy &quot;ftp://127.0.0.1:3128/&quot;;
Acquire::https::proxy &quot;https://127.0.0.1:3128/&quot;;
</code></pre>

<p>After logging out and in, test it with curl once again, but now without the <code>-x</code>
option (so no proxy is specified, but the system proxy is used):</p>

<pre><code>curl -v raymii.org
</code></pre>

<p>Output:</p>

<pre><code>* Rebuilt URL to: raymii.org/
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
&gt; GET http://raymii.org/ HTTP/1.1
&gt; Host: raymii.org
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Via: 1.1 proxy
&lt; Connection: Keep-Alive
</code></pre>
Tags: <a href="../tags/cntlm.html">cntlm</a>
, <a href="../tags/microsoft.html">microsoft</a>
, <a href="../tags/ntlm.html">ntlm</a>
, <a href="../tags/proxy.html">proxy</a>
, <a href="../tags/server.html">server</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/ubuntu.html">ubuntu</a>
, <a href="../tags/windows.html">windows</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    