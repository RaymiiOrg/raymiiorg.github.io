
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Semi-accurate live stream viewer count (hls/rtmp/restreamer) on the command line - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Semi-accurate live stream viewer count (hls/rtmp/restreamer) on the command line</h2>
<p><small>Published: <span data-pagefind-meta='date'>25-11-2020</span> | Author: Remy van Elst | <a href="Semi-accurate_live_stream_viewer_count.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over four years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">A rant on YouTube and Google</a>
</li>
<li>
<a href="#toc_1">Measuring live viewers?</a>
<ul>
<li>
<a href="#toc_2">Google Analytics in Clappr</a>
</li>
<li>
<a href="#toc_3">Bandwidth interpolation</a>
</li>
<li>
<a href="#toc_4">Log analytics</a>
</li>
<li>
<a href="#toc_5">Measuring established connections</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">Conclusion</a>
</li>
<li>
<a href="#toc_7">Munin plugin</a>
</li>
</ul>

</div><hr><div id="contents">
<p>Due to all the working-from-home in the past few months I had to setup a live stream.
At first the stream went directly to YouTube, but after they&#39;ve screwed up multiple 
times, we decided to not be dependent on them. Using <a href="https://datarhei.github.io/restreamer/">restreamer</a>, a piece of open 
source software to live stream both to your own server and to another (YouTube) at the same time, we have
more control over the stream and are not surprised by YouTube doing stupid stuff unannounced.</p>

<p>Restreamer provides a simple web player that works on all major platforms and streams to 
YouTube, but one thing it lacks is a live viewer count. That&#39;s a hard problem to solve
correctly and accurately, in this article I&#39;ll show you how to do it semi-accurately
via multiple ways, including graphs like this:</p>

<p><img src="/s/inc/img/stream-kijkers.png" alt="stream munin graph"></p>

<p>This article contains a rant on YouTube breaking stuff and the commands used to get a
live viewer count. </p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $200 credit for 60 days. Spend $25 after your credit expires and I'll get $25!</a><br><br> </p>

<p>Do note that this article is about the open source <a href="https://datarhei.github.io/restreamer/">Restreamer</a> software,
not the paid for restreamer.io website. I did <a href="https://github.com/datarhei/restreamer/pull/217">contribute</a> to restreamer
since it&#39;s such a great piece of software.</p>

<h3 id="toc_0">A rant on YouTube and Google</h3>

<p>First a new version of YouTube live was released, <a href="http://web.archive.org/web/20201013075225/https://support.google.com/YouTube/thread/62717937">resetting our stream key,
without notifications</a>. Now they also require you to open the live control
room web page, <a href="http://web.archive.org/web/20201124080807/https://support.google.com/YouTube/thread/74512210?hl=en">otherwise your stream won&#39;t start</a>, again, without any
notification or help. The live stream is quite critical due to a limit on how
many people can physically be on location. </p>

<p>The workflow was simple before, click the button &quot;Start Streaming&quot; in OBS. Now
it involves logging in to an account with 2 factor authentication, opening up
a web page, getting a few dialogs on title and options, then clicking start in 
OBS and checking if everything on YouTube works. Way more error-prone and more
ways to, by accident, make mistakes.</p>

<p>Using <a href="https://datarhei.github.io/restreamer/">Restreamer</a>, we have more control over the live stream. It&#39;s on our
own server, [a $5 droplet at Digital Ocean][99], which can easily support 120
concurrent viewers with a 5 mbit stream.</p>

<p>We don&#39;t want to break existing work flows for our viewers (as opposed to what 
Google does), so we stream to YouTube as well (via restreamer). For the people
that are used to YouTube, they can keep watching as they&#39;re used to. But, if 
for whatever reason, something breaks, our own server and stream are available. 
Continuity is guaranteed even with the incoherent stupidity and breaking changes
of YouTube.</p>

<p>Now we have that rant out of the way, lets continue on with something productive 
for which you came here, measuring live stream view count.</p>

<h3 id="toc_1">Measuring live viewers?</h3>

<p>First and foremost, there is a <a href="https://github.com/datarhei/restreamer/issues/100">feature request</a> over at Restreamer to implement
a viewer count, so be sure to check that issue as it might be more up to date than
this page.</p>

<p>There are multiple ways to measure viewers, with different levels of privacy invasion
and accuracy. You can use Google Analytics, write some custom javascript with a
unique id and track that page, use log analysis, bandwidth interpolation or 
count established connections.</p>

<p>We ended up using connection measurement and bandwidth interpolation because 
that is accurate enough for our use case. I&#39;ll not cover the custom javascript
option, only Google Analytics, bandwidth interpolation and connection counting.</p>

<p>All of our analytics show that we had about 13 viewers on the live stream,
with 9 that watched almost the entire stream and 4 that watched a bit.</p>

<h4 id="toc_2">Google Analytics in Clappr</h4>

<p>The the most accurate measurement in my experience is to <a href="https://github.com/playmedia/clappr-ga-events-plugin">use Google analytics
with the clappr web player</a>, which gives you a count of every event, start,
stop, pause, etc:</p>

<p><img src="/s/inc/img/stream-ga.jpg" alt="clappr Google analytics"></p>

<p>(This graph is from a friend of mine with a larger live stream audience)</p>

<p>However, this is very privacy invasive, sends all that sweet data to Google and
allow you to track every event back to a single person inside the analytics console. 
Although the measurements were the most accurate, we decided it was to privacy invasive
for our intended goal.</p>

<h4 id="toc_3">Bandwidth interpolation</h4>

<p>Our stream has a set bitrate of 5 mbit. Restreamer does not do encoding, so every
5 mbit out in that time should correspond to one stream viewer. Using the graphs
[Digital Ocean][99] provides, we can do a simple division:</p>

<pre><code>55 mbit out / 5 mbit in = 11 viewers
</code></pre>

<p>Here is the graph of Digital Ocean:</p>

<p><img src="/s/inc/img/stream-traffic.png" alt="stream bandwidth"></p>

<p>If your provider does not provide such graphs, you can use your own monitoring 
tools, like the command line <code>vnstat</code> utility:</p>

<pre><code>vnstat --top10 --style 1
</code></pre>

<p>Output:</p>

<pre><code> eth0  /  top 10

   #      day          rx      |     tx      |    total
-------------------------------+-------------+---------------------------------
   1   11/15/20       3.38 GiB |   35.21 GiB |   38.58 GiB  %%::::::::::::::::
   2   11/22/20       3.82 GiB |   30.89 GiB |   34.71 GiB  %%::::::::::::::
   3   10/18/20       6.54 GiB |   17.61 GiB |   24.15 GiB  %%%::::::::
   4   11/01/20       3.48 GiB |    3.68 GiB |    7.17 GiB  %::
   5   10/16/20       1.82 GiB |    2.31 GiB |    4.13 GiB  :
   6   10/28/20       2.03 GiB |    2.03 GiB |    4.07 GiB  %
   7   11/08/20       1.14 GiB |    2.82 GiB |    3.96 GiB  :
   8   10/15/20       1.38 GiB |  891.15 MiB |    2.26 GiB  %
   9   10/14/20     857.32 MiB |    1.37 GiB |    2.21 GiB  :
  10   11/12/20     686.86 MiB |    1.09 GiB |    1.76 GiB
-------------------------------+-------------+---------------------------------
</code></pre>

<p>5 mbit/s for 90 minutes in gigabyte is 27 Gb (gigabit), is 3.375 GB
(gigabytes) for one full time stream viewer. 30.89 GB / 3.375 GB equals 9.15 full time viewers. Not everyone
watches the full length stream, as you can see on the graph as well.</p>

<h4 id="toc_4">Log analytics</h4>

<p>In the web server log we can check how many IP&#39;s connected to the <code>.m3u8</code> file (the stream)
during the time we want to analyze. A tool like <code>goacces</code> can give you a visual overview,
in the below picture you can see every visitor sorted by traffic, 7 on this page and 2 on the next
page have downloaded over 2 GB of traffic, we can safely assume that are stream viewers, 
giving us 9 viewers and 2 that watched half the stream according to the amount of traffic.</p>

<p><img src="/s/inc/img/stream-bw2.png" alt="goaccess log"></p>

<p>The picture was filtered by date and by the filename of the stream <code>live.m3u8</code>.</p>

<p>On the command line you can use a bit of <code>awk</code> to sum up all traffic for requests
per IP.</p>

<pre><code>zcat /var/log/nginx/access.log.3.gz | \ 
awk &#39; { total[$1] += $10 } \
END {  for (x in total) { printf &quot;%s : %9.2f Mb\n&quot;, x, total[x]/1024/1024 } } &#39; | sort -k2
</code></pre>

<p>Output:</p>

<pre><code>86..... :    748.54 Mb
84......:   1438.23 Mb
86......:   2560.98 Mb
85......:   2634.83 Mb
2001:...:   2745.76 Mb
86..... :   2827.64 Mb
212.... :   3018.51 Mb
212.... :   3076.66 Mb
2001:...:   3196.46 Mb
85..... :   3220.37 Mb
86......:   3347.41 Mb
</code></pre>

<p>(I&#39;ve filtered out the IP addresses but you get the gist)</p>

<p>In the NCSA log format (what nginx and Apache use) the first item is the visiting IP (or hostname)
and the tenth item is the amount of bytes that request took. </p>

<p>Using awk we count up each request amount of bytes for the IP (<code>{ total[$1] +=
$10 }</code>), then print that divided back to Mb (<code>END {  for (x in total) {
printf &quot;%s....</code>), sorting by column 2 (<code>sort -k2</code>).</p>

<p>Here we can see 9 full stream viewers and two that watched for a bit. By adding 
a few grep commands you can filter some more on the input, for example,
on status code (<code>grep &#39; 200 &#39;</code>) or split up the user agents. </p>

<h4 id="toc_5">Measuring established connections</h4>

<p>In <a href="/s/snippets/Get_number_of_incoming_connections_on_specific_ports_with_ss.html">this article</a> I described how you can measure the amount of
established connections. HTTP normally does not work very well with this
technique since they are not long running connections. HLS however, is a
longer running connection, since segments of the stream are downloaded, which
in turn counts as a long established connection for my way of measuring.</p>

<p>Using the following command we can get a count of currently established
connections to port 443 (which is an nginx reverse proxy in front of 
restreamer).</p>

<pre><code>ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | wc -l
</code></pre>

<p>However, that also gets you the one off HTTP hits that might be established on 
that exact second you execute the command. Not super accurate, most often giving
almost double the amount that I expected were watching the stream.</p>

<p>But since we&#39;re on the command line, we have another tool to the rescue.
You&#39;re probably familiar with <code>diff</code>, a command that shows the differences
between to files. In this case we need the exact opposite of that, I want to
execute the command twice and see which IP&#39;s are still here, they are probably
watching the stream. </p>

<p>You might not expect it, but the tool to do that is named <code>comm</code>. It finds the 
lines that are the same in two files (as opposed to <code>diff</code>). </p>

<p>The last command line trick up my sleeve is to surround a command with a 
less then sign and parentheses to get it&#39;s output directly into a temp file, 
like so:</p>

<pre><code>&lt;(command)
echo &lt;(w)
</code></pre>

<p>Output:</p>

<pre><code>/dev/fd/63
</code></pre>

<p>Combining all that into one large line, filtering out everything except for
the IP addresses from <code>ss</code>, sleeping 5 seconds and then executing the same
<code>ss</code> command again, into <code>comm</code> with a line count at the end results in this
line:</p>

<pre><code>comm -1 -2 &lt;(ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | awk &#39;{print $5}&#39; | awk -F:  &#39;NF{--NF};1&#39;) &lt;(sleep 5; ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | awk &#39;{print $5}&#39; | awk -F:  &#39;NF{--NF};1&#39;) | wc -l
</code></pre>

<p>We can put this into a munin plugin (at the end of this page is the code) to graph it automatically every minute, giving us the result 
over time, here is that graph zoomed in on the stream time:</p>

<p><img src="/s/inc/img/stream-kijkers.png" alt="stream watchers"></p>

<p>Also, 9 viewers.</p>

<p>If you don&#39;t want to use munin for graphs, you can put this on <code>watch</code> to get
a live count during your stream:</p>

<pre><code>watch comm -1 -2 &lt;(ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | awk &#39;{print $5}&#39; | awk -F:  &#39;NF{--NF};1&#39; ) &lt;(sleep 5; ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | awk &#39;{print $5}&#39; | awk -F:  &#39;NF{--NF};1&#39; ) | wc -l
</code></pre>

<h3 id="toc_6">Conclusion</h3>

<p>Measuring live viewers without sending all their data to Google and thus 
being very privacy invasive is hard. In this article I&#39;ve shown you a few
ways to get reasonably accurate measurements using tools on the linux
command line. All of them agreed on the amount of viewers but do require
manual interpretation. Not a bad thing, but not as magical and automatic
as just a counter on a web page that handles it for you.</p>

<h3 id="toc_7">Munin plugin</h3>

<p>For your convenience, here is the munin plugin I use for the graphs shown
in this article.</p>

<pre><code>cat /etc/munin/plugins/hls-long.sh 
</code></pre>

<p>Output:</p>

<pre><code>#!/bin/bash
# -*- bash -*-

: &lt;&lt; =cut

=head1 NAME

HLSStreamViewers - Plugin to measure stream viewers

=head1 NOTES

Service usage and uptime under your control.

=head1 AUTHOR

Contributed by Remy van Elst

=head1 LICENSE

GPLv2

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf

=cut

. $MUNIN_LIBDIR/plugins/plugin.sh

if [ &quot;$1&quot; = &quot;autoconf&quot; ]; then
        echo yes
        exit 0
fi
if [ &quot;$1&quot; = &quot;config&quot; ]; then

        echo &#39;graph_title Stream Viewers&#39;
        echo &#39;graph_args --base 1000 -l 0 &#39;
        echo &#39;graph_scale no&#39;
        echo &#39;graph_vlabel HTTP Established Connections &gt; 5 sec&#39;
        echo &#39;graph_category stream&#39;
        echo &#39;v1.label Connections&#39; 
        exit 0
fi

echo &quot;v1.value  $(comm -1 -2 &lt;(ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | awk &#39;{print $5}&#39; | awk -F:  &#39;NF{--NF};1&#39;) &lt;(sleep 5; ss --all --numeric --no-header state established  &#39;( sport = :443 )&#39; | awk &#39;{print $5}&#39; | awk -F:  &#39;NF{--NF};1&#39;) | wc -l)&quot;
</code></pre>
Tags: <a href="../tags/analytics.html">analytics</a>
, <a href="../tags/docker.html">docker</a>
, <a href="../tags/hls.html">hls</a>
, <a href="../tags/live-stream.html">live-stream</a>
, <a href="../tags/restreamer.html">restreamer</a>
, <a href="../tags/rtmp.html">rtmp</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/video.html">video</a>
, <a href="../tags/youtube.html">youtube</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    