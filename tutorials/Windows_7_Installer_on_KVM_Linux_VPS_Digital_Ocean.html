
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Windows 7 installer on a KVM Linux VPS (Windows on Digital Ocean) - Raymii.org</title>
        <style> *, ::before, ::after {background-repeat: no-repeat;-webkit-box-sizing: border-box;box-sizing: border-box;}::before, ::after {text-decoration: inherit;vertical-align: inherit;}html {cursor: default;font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.15;-moz-tab-size: 4;-o-tab-size: 4;tab-size: 4;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;word-break: break-word;}body {background-color: white;margin: 0;}h1 {font-size: 2em;margin: 0.67em 0;}hr {height: 0;overflow: visible;}main {display: block;}nav ol, nav ul {list-style: none;}pre {font-family: Roboto Mono, Menlo, Consolas, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}a {background-color: transparent;}abbr[title] {text-decoration: underline;-webkit-text-decoration: underline dotted;text-decoration: underline dotted;}b, strong {font-weight: bolder;}code, kbd, samp {font-family: Menlo, Consolas, Roboto Mono, Ubuntu Monospace, Noto Mono, Oxygen Mono, Liberation Mono, monospace;font-size: 1em;}small {font-size: 80%;}::-moz-selection {background-color: #b3d4fc;color: #000;text-shadow: none;}::selection {background-color: #b3d4fc;color: #000;text-shadow: none;}audio, canvas, iframe, img, svg, video {vertical-align: middle;}audio, video {display: inline-block;}audio:not([controls]) {display: none;height: 0;}img {border-style: none;}svg:not([fill]) {fill: currentColor;}svg:not(:root) {overflow: hidden;}table {border-collapse: collapse;}button, input, select, textarea {font-family: inherit;font-size: inherit;line-height: inherit;}button, input, select {margin: 0;}button {overflow: visible;text-transform: none;}button, [type="button"], [type="reset"], [type="submit"] {-webkit-appearance: button;}fieldset {padding: 0.35em 0.75em 0.625em;}input {overflow: visible;}legend {color: inherit;display: table;max-width: 100%;white-space: normal;}progress {display: inline-block;vertical-align: baseline;}select {text-transform: none;}textarea {margin: 0;overflow: auto;resize: vertical;}[type="checkbox"], [type="radio"] {padding: 0;}[type="search"] {-webkit-appearance: textfield;outline-offset: -2px;}::-webkit-inner-spin-button, ::-webkit-outer-spin-button {height: auto;}::-webkit-input-placeholder {color: inherit;opacity: 0.54;}::-webkit-search-decoration {-webkit-appearance: none;}::-webkit-file-upload-button {-webkit-appearance: button;font: inherit;}::-moz-focus-inner {border-style: none;padding: 0;}:-moz-focusring {outline: 1px dotted ButtonText;}details {display: block;}dialog {background-color: white;border: solid;color: black;display: block;height: -moz-fit-content;height: -webkit-fit-content;height: fit-content;left: 0;margin: auto;padding: 1em;position: absolute;right: 0;width: -moz-fit-content;width: -webkit-fit-content;width: fit-content;}dialog:not([open]) {display: none;}summary {display: list-item;}canvas {display: inline-block;}template {display: none;}a, area, button, input, label, select, summary, textarea, [tabindex] {-ms-touch-action: manipulation;touch-action: manipulation;}[hidden] {display: none;}[aria-busy="true"] {cursor: progress;}[aria-controls] {cursor: pointer;}[aria-disabled="true"], [disabled] {cursor: not-allowed;}[aria-hidden="false"][hidden]:not(:focus) {clip: rect(0, 0, 0, 0);display: inherit;position: absolute;}main, header, footer, article, section, aside, details, summary {margin: 0 auto;margin-bottom: 16px;width: 100%;}main {display: block;margin: 0 auto;max-width: 1000px;padding: 0 16px 16px;}footer {border-top: 1px solid rgba(0, 0, 0, 0.12);padding: 16px 0;text-align: left;}footer p {margin-bottom: 0;}hr {border: 0;border-top: 1px solid rgba(0, 0, 0, 0.12);display: block;margin-top: 16px;margin-bottom: 16px;width: 100%;-webkit-box-sizing: content-box;box-sizing: content-box;height: 0;overflow: visible;}img {height: auto;max-width: 100%;vertical-align: baseline;}@media screen and (max-width: 400px) {article, section, aside {clear: both;display: block;max-width: 100%;}img {margin-right: 16px;}}embed, iframe, video {border: 0;}body {color: rgba(0, 0, 0, 0.8);font-family: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";font-size: 16px;line-height: 1.5;}p {margin: 0;margin-bottom: 16px;}h1, h2, h3, h4, h5, h6 {color: inherit;font-family: inherit;line-height: 1.2;font-weight: 500;}h1 {font-size: 40px;margin: 20px 0 16px;}h2 {font-size: 32px;margin: 20px 0 16px;}h3 {color: #75cc00;font-size: 28px;margin: 16px 0 4px;}h4 {color: #75cc00;font-size: 24px;margin: 16px 0 4px;}h5 {color: #75cc00;font-size: 20px;margin: 16px 0 4px;}h6 {color: #75cc00;font-size: 16px;margin: 16px 0 4px;}small {color: rgba(0, 0, 0, 0.54);vertical-align: bottom;}pre {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);display: block;font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;margin: 16px 0;padding: 16px;white-space: pre-wrap;overflow-wrap: break-word;}code {background: #f7f7f9;color: rgba(0, 0, 0, 0.8);font-family: "Roboto Mono", Menlo, Monaco, Consolas, "Courier New", monospace;font-size: 16px;line-height: inherit;margin: 0;vertical-align: baseline;word-break: break-all;word-wrap: break-word;}a {color: #75cc00;text-decoration: none;background-color: transparent;}a:hover, a:focus {color: #0062cc;font-weight: bolder;text-decoration: underline;}dl {margin-bottom: 16px;}dd {margin-left: 40px;}ul, ol {margin-bottom: 8px;padding-left: 40px;vertical-align: baseline;}blockquote {border-left: 2px solid rgba(0, 0, 0, 0.8);font-family: Georgia, Times, "Times New Roman", serif;font-style: italic;margin: 16px 0;padding-left: 16px;}figcaption {font-family: Georgia, Times, "Times New Roman", serif;}u {text-decoration: underline;}s {text-decoration: line-through;}sup {font-size: 14px;vertical-align: super;}sub {font-size: 14px;vertical-align: sub;}mark {background: #ffeb3b;}input[type="text"], input[type="password"], input[type="email"], input[type="url"], input[type="date"], input[type="month"], input[type="time"], input[type="datetime"], input[type="datetime-local"], input[type="week"], input[type="number"], input[type="search"], input[type="tel"], select, textarea {background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}input[type="color"] {background: #fff;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;display: inline-block;vertical-align: middle;}input:not([type]) {-webkit-appearance: none;background: #fff;background-clip: padding-box;border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 4px;color: rgba(0, 0, 0, 0.8);display: block;width: 100%;padding: 8px 16px;line-height: 1.5;-webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;text-align: left;}input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="url"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime"]:focus, input[type="datetime-local"]:focus, input[type="week"]:focus, input[type="number"]:focus, input[type="search"]:focus, input[type="tel"]:focus, input[type="color"]:focus, select:focus, textarea:focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input:not([type]):focus {background-color: #fff;border-color: #80bdff;outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);}input[type="file"]:focus, input[type="radio"]:focus, input[type="checkbox"]:focus {outline: 1px thin rgba(0, 0, 0, 0.12);}input[type="text"][disabled], input[type="password"][disabled], input[type="email"][disabled], input[type="url"][disabled], input[type="date"][disabled], input[type="month"][disabled], input[type="time"][disabled], input[type="datetime"][disabled], input[type="datetime-local"][disabled], input[type="week"][disabled], input[type="number"][disabled], input[type="search"][disabled], input[type="tel"][disabled], input[type="color"][disabled], select[disabled], textarea[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input:not([type])[disabled] {background-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);cursor: not-allowed;opacity: 1;}input[readonly], select[readonly], textarea[readonly] {border-color: rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.54);}input:focus:invalid, textarea:focus:invalid, select:focus:invalid {border-color: #ea1c0d;color: #f44336;}input[type="file"]:focus:invalid:focus, input[type="radio"]:focus:invalid:focus, input[type="checkbox"]:focus:invalid:focus {outline-color: #f44336;}select {border: 1px solid rgba(0, 0, 0, 0.12);vertical-align: sub;}select:not([size]):not([multiple]) {height: -webkit-calc(2.25rem + 2px);height: calc(2.25rem + 2px);}select[multiple] {height: auto;}label {display: inline-block;line-height: 2;}fieldset {border: 0;margin: 0;padding: 8px 0;}legend {border-bottom: 1px solid rgba(0, 0, 0, 0.12);color: rgba(0, 0, 0, 0.8);display: block;margin-bottom: 8px;padding: 8px 0;width: 100%;}textarea {overflow: auto;resize: vertical;}input[type=checkbox], input[type=radio] {-webkit-box-sizing: border-box;box-sizing: border-box;padding: 0;display: inline;}input[type=submit], input[type=reset], input[type=button], button {background-color: #75cc00;border: #75cc00;border-radius: 4px;color: #fff;padding: 8px 16px;display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1rem;line-height: 1.5;-webkit-transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;}input[type=submit]::-moz-focus-inner, input[type=reset]::-moz-focus-inner, input[type=button]::-moz-focus-inner, button::-moz-focus-inner {padding: 0;}input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, button:hover {background-color: #0069d9;border-color: #0062cc;color: #fff;}input[type=submit]:not(:disabled):active, input[type=reset]:not(:disabled):active, input[type=button]:not(:disabled):active, button:not(:disabled):active {background-color: #0062cc;border-color: #005cbf;color: #fff;}input[type=submit]:focus, input[type=reset]:focus, input[type=button]:focus, button:focus {outline: 0;-webkit-box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);}input[type=submit]:disabled, input[type=reset]:disabled, input[type=button]:disabled, button:disabled {opacity: .65;cursor: not-allowed;background-color: #75cc00;border-color: #75cc00;color: #fff;}table {border-top: 1px solid rgba(0, 0, 0, 0.12);margin-bottom: 16px;}caption {padding: 8px 0;}thead th {border: 0;border-bottom: 2px solid rgba(0, 0, 0, 0.12);text-align: left;}tr {margin-bottom: 8px;}th, td {border-bottom: 1px solid rgba(0, 0, 0, 0.12);padding: 16px;white-space: nowrap;vertical-align: inherit;}tfoot tr {text-align: left;}tfoot td {color: rgba(0, 0, 0, 0.54);font-size: 8px;font-style: italic;padding: 16px 4px;}a.skip-main {left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999;}a.skip-main:focus, a.skip-main:active {color: #fff;background-color:#000;left: auto;top: auto;width: 30%;height: auto;overflow:auto;margin: 10px 35%;padding:5px;border-radius: 15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999;}@font-face {font-family: 'Raleway';font-style: normal;font-weight: 600;src: url('/s/inc/css/raleway-v18-latin-600.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-600.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-600.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-600.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-600.svg#Raleway') format('svg');}@font-face {font-family: 'Raleway';font-style: italic;font-weight: 400;src: url('/s/inc/css/raleway-v18-latin-italic.eot');src: local(''), url('/s/inc/css/raleway-v18-latin-italic.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/raleway-v18-latin-italic.woff2') format('woff2'), url('/s/inc/css/raleway-v18-latin-italic.woff') format('woff'), url('/s/inc/css/raleway-v18-latin-italic.ttf') format('truetype'), url('/s/inc/css/raleway-v18-latin-italic.svg#Raleway') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 400;src: url('/s/inc/css/roboto-mono-v12-latin-regular.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-regular.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-regular.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-regular.svg#RobotoMono') format('svg');}@font-face {font-family: 'Roboto Mono';font-style: normal;font-weight: 600;src: url('/s/inc/css/roboto-mono-v12-latin-600.eot');src: local(''), url('/s/inc/css/roboto-mono-v12-latin-600.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/roboto-mono-v12-latin-600.woff2') format('woff2'), url('/s/inc/css/roboto-mono-v12-latin-600.woff') format('woff'), url('/s/inc/css/roboto-mono-v12-latin-600.ttf') format('truetype'), url('/s/inc/css/roboto-mono-v12-latin-600.svg#RobotoMono') format('svg');}@font-face {font-family: 'Ubuntu';font-style: normal;font-weight: 400;src: url('/s/inc/css/ubuntu-v15-latin-regular.eot');src: local(''), url('/s/inc/css/ubuntu-v15-latin-regular.eot?#iefix') format('embedded-opentype'), url('/s/inc/css/ubuntu-v15-latin-regular.woff2') format('woff2'), url('/s/inc/css/ubuntu-v15-latin-regular.woff') format('woff'), url('/s/inc/css/ubuntu-v15-latin-regular.ttf') format('truetype'), url('/s/inc/css/ubuntu-v15-latin-regular.svg#Ubuntu') format('svg');}@font-face {font-family:'Raleway2';font-style:normal;font-weight:normal;src:url('/s/inc/css/raleway.eot');src:local('Raleway2'),local('Raleway2'),url('/s/inc/css/raleway.ttf') }.headheader {font-family:"Raleway2"!important }.headheader a {color:#000;text-decoration:none }.headheader a:hover {color:#000;text-decoration:none!important }#toc ul {list-style: none;margin: 0;padding: 0;}#toc h3 {color:black;}</style>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />         
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Raymii.org Logo">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>                 
                </small><br/><p>
                <link href="/s/_pagefind/pagefind-ui.css" rel="stylesheet">
                <script src="/s/_pagefind/pagefind-ui.js" type="text/javascript"></script>
                <div id="search" style="min-width:400px;max-width:1080px;"></div>
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        new PagefindUI({ element: "#search" });
                    });
                </script>
                </p>
            </header>
          
    <main data-pagefind-body><h2 class='headheader' data-pagefind-meta='title' id='main'>Windows 7 installer on a KVM Linux VPS (Windows on Digital Ocean)</h2>
<p><small>Published: <span data-pagefind-meta='date'>01-07-2018</span> | Author: Remy van Elst | <a href="Windows_7_Installer_on_KVM_Linux_VPS_Digital_Ocean.txt">Text only version of this article</a>
</small></p>
<br><div class='olderthanayear'><p><strong>&#10071; This post is over five years old. It may no longer be up to date. Opinions may have changed.</strong></p></div>
<div id="toc">
<h3>Table of Contents</h3>
<ul>
<li>
<a href="#toc_0">Summary and requirements</a>
</li>
<li>
<a href="#toc_1">Chainloading Windows 7 ISO</a>
</li>
<li>
<a href="#toc_2">Online shrink root partition with pivot_root</a>
</li>
<li>
<a href="#toc_3">Create fat32 partition</a>
</li>
<li>
<a href="#toc_4">Copy Windows installation files to new partition</a>
</li>
<li>
<a href="#toc_5">GRUB2 entry</a>
</li>
</ul>

</div><hr><div id="contents">
<p>For fun I wanted to install Windows 7 on a KVM Linux VPS (on <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a>)
but it should work for any KVM or XEN-HVM VPS with console access). I was
experimenting with Grub2 and ISO booting, since grub2 can natively boot a linux
ISO. For Windows this is not possible, the installer needs to be extracted on a
FAT32 partition from which you boot. On a normal system I would repartition the
disk using a live CD, but on a VPS where an ISO cannot be booted this is
troublesome. If I could boot from an ISO I would use that to install Windows,
but where&#39;s the fun in that? I had to figure out how to shrink an EXT4
filesystem from a running Ubuntu VPS, which is possible, however very risky,
with pivot_root. Next the partiton table can be converted to MBR, the partition
can be resized, a FAT32 partiton and filesystem can be created, the Windows
Installer files copied onto that, some Grub config and a reboot later, you&#39;re in
the Windows 7 Installer. TL;DR, the installer cannot complete due to missing
VirtIO drivers, which is a project for another time.</p>

<p class="ad"> <b>Recently I removed all Google Ads from this site due to their invasive tracking, as well as Google Analytics. Please, if you found this content useful, consider a small donation using any of the options below:</b><br><br> <a href="https://leafnode.nl">I'm developing an open source monitoring app called  Leaf Node Monitoring, for windows, linux & android. Go check it out!</a><br><br> <a href="https://github.com/sponsors/RaymiiOrg/">Consider sponsoring me on Github. It means the world to me if you show your appreciation and you'll help pay the server costs.</a><br><br> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">You can also sponsor me by getting a Digital Ocean VPS. With this referral link you'll get $100 credit for 60 days. </a><br><br> </p>

<p><img src="https://raymii.org/s/inc/img/do_win2.png" alt=""></p>

<blockquote>
<p>The finished result, Windows 7 on Digital Ocean</p>
</blockquote>

<h3 id="toc_0">Summary and requirements</h3>

<p>Why Windows on a Linux VPS and why Windows 7? Because it&#39;s fun. I learned new
stuff about partitioning schemes and how to do harddisk maintenance on a running
Linux system. I won&#39;t be using the Windows VPS, in fact I removed it already,
but the journey to get there was quite the ride.</p>

<p>Requirements:</p>

<ul>
<li>Windows 7 installer ISO</li>
<li>KVM VPS with console access, at least 2 GB RAM (I used <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a>).</li>
</ul>

<p>The VPS needs 2 GB of ram to create the temporary root filesystem in it. 1 GB is
too small for my Ubuntu test system. Windows itself will also not run very well
with such a small amount of RAM.</p>

<p>I&#39;ll be using a trial version of Windows 7. I have not tested this with Server
2016 or Windows 10, but the steps should be fairly similar. Remember this is
just a fun experiment.</p>

<p>The steps involved are the following:</p>

<ul>
<li>Create a VPS with Ubuntu 16.04 and 2 GB of RAM (I used <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a>).</li>
<li>Resize the root filesystem while the VPS is running (since we cannot boot a live CD)</li>
<li>Resize the root partition while the VPS is running</li>
<li>Convert the partition table from GPT to MBR</li>
<li>Create a fat32 partition</li>
<li>Copy the Windows 7 ISO installer files on the new partition</li>
<li>Edit Grub2, add the Windows 7 partition</li>
<li>Reboot </li>
<li>???</li>
<li>Profit!</li>
</ul>

<p>Depending on the VPS provider the partition layout might be different. The
Digital Ocean VPS has one large root partition as the first partition, no LVM or
extended partitions:</p>

<pre><code>root@w:~# lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
vda     253:0    0   50G  0 disk
|-vda1  253:1    0 49.9G  0 part /
|-vda14 253:14   0    4M  0 part
`-vda15 253:15   0  106M  0 part /boot/efi
</code></pre>

<h3 id="toc_1">Chainloading Windows 7 ISO</h3>

<p>Grub2 <a href="https://help.ubuntu.com/community/Grub2/ISOBoot">can load Linux ISO files directly</a>. None of the pages mentioned
anything about Windows, so I tried a few GRUB2 entries to load the Windows 7 ISO
from <code>/win7.iso</code>:</p>

<pre><code>menuentry &quot;Win7 1&quot; {
  set isofile=&quot;/win7.iso&quot;
  loopback loop $isofile
  chainloader (loop)
}

  menuentry &quot;Win7 2&quot; {
    insmod ntfs
    insmod ntldr
    set isofile=&quot;/win7.iso&quot;
    loopback loop $isofile
    ntldr (loop)/bootmgr
    boot
}
</code></pre>

<p>None worked, both resulted in a Windows boot which directly errored with
<code>Windows BCD boot error 0xc0000225</code>:</p>

<pre><code> Windows failed to start. A recent hardware or software change might be the cause. To fix the problem: 

1. Insert your Windows installation disc and restart your computer. 
2. Choose your language settings, and then click &quot;Next.&quot; 
3. Click &quot;Repair your computer.&quot; 

If you do not have this disc, contact your system administrator or computer manufacturer for assistance.

Status: 0xc0000225
Info: An unexpected error has occurred.
</code></pre>

<p>I found <a href="https://web.archive.org/web/20180701063248/https://volatilesystems.org/booting-multiple-isos-with-grub2-from-one-single-usb-stick.html">one article</a> that suggested Windows needed to be booted from a FAT32
partition where all the files were extracted.</p>

<h3 id="toc_2">Online shrink root partition with pivot_root</h3>

<p>An EXT4 partition can be grown without reboots or downtime (using <code>resize2fs</code>).
Shrinking is not possible while the partition is mounted. Using <code>pivot_root</code> we
create a bare root filesystem in RAM, pivot the linux system in there, unmount
the actual disk (since we&#39;re running from RAM) and shrink the partition.</p>

<p>Via <a href="https://web.archive.org/web/20180701063259/https://unix.stackexchange.com/questions/226872/how-to-shrink-root-filesystem-without-booting-a-livecd/227318">this stackoverflow post</a>, a brief summary of steps to do an online
resize. This is dangerous and might destroy your system, don&#39;t try it on a
production system. It works 99% of the time, but make sure you have working out
of band access.</p>

<p>Set a root password first so you can access the console:</p>

<pre><code>passwd
</code></pre>

<p>Output:</p>

<pre><code>Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
</code></pre>

<p>Make it a strong password, you never know who will brute force it.</p>

<p>Install software we need:</p>

<pre><code>apt-get install gdisk cfdisk dosfstools grub-pc
</code></pre>

<p>Unmount all filesystems not in use. Ignore any warnings:</p>

<pre><code>umount -a
</code></pre>

<p>Create the temporary root filesystem in RAM and copy over essential files:</p>

<pre><code>mkdir /tmp/tmproot
mount -t tmpfs none /tmp/tmproot
mkdir /tmp/tmproot/{proc,sys,dev,run,usr,var,tmp,oldroot,root}
cp -ax /{bin,etc,mnt,sbin,lib,lib64} /tmp/tmproot/
cp -ax /usr/{bin,sbin,lib,lib64} /tmp/tmproot/usr/
cp -ax /var/{account,empty,lib,local,lock,nis,opt,preserve,run,spool,tmp,yp} /tmp/tmproot/var/
# don&#39;t forget your SSH key:
cp -axr /root/.ssh /tmp/tmproot/root/
</code></pre>

<p>Pivot into the new RAM root:</p>

<pre><code>mount --make-rprivate / 
pivot_root /tmp/tmproot /tmp/tmproot/oldroot
for i in dev proc sys run; do mount --move /oldroot/$i /$i; done
</code></pre>

<p>Quoting from the article, it explains what were doing:</p>

<pre><code>systemd causes mounts to allow subtree sharing by default (as with mount --make-shared), and this causes pivot_root to fail. Hence, we turn this off globally with mount --make-rprivate /. System and temporary filesystems are moved wholesale into the new root. This is necessary to make it work at all; the sockets for communication with systemd, among other things, live in /run, and so there&#39;s no way to make running processes close it.
</code></pre>

<p>The next step is to close all running processes in the old root. First, restart
OpenSSH:</p>

<pre><code>systemctl restart sshd
systemctl status sshd
</code></pre>

<p>Now, don&#39;t close this terminal. First, open a new one and SSH into the VPS. If
that works, close the old tab. I forgot to copy over my SSH key in the new root
so I had to reboot and start again, since I did close the tab before checking.</p>

<p>Whe&#39;n you&#39;re setup in the new shell, use <code>lsof</code> or <code>fuser</code> on <code>/oldroot/</code> to see
which files are open and used:</p>

<pre><code>fuser -vm /oldroot/
</code></pre>

<p>Output:</p>

<pre><code>                     USER        PID ACCESS COMMAND
/oldroot:            root     kernel mount /oldroot
                     root          1 ....m systemd
                     root        624 ....m systemd-journal
                     root        672 ....m lvmetad
                     root        703 f...m systemd-udevd
                     systemd-timesync    881 ....m systemd-timesyn
                     root       1367 ....m iscsid
                     root       1368 ....m iscsid
                     root       1375 ....m systemd-logind
                     root       1379 ....m cron
                     root       1382 ....m accounts-daemon
                     messagebus   1383 ....m dbus-daemon
                     daemon     1393 ....m atd
                     root       1401 ....m acpid
                     root       1407 ....m lxcfs
                     syslog     1415 F...m rsyslogd
                     root       1425 ....m snapd
                     root       1463 ....m polkitd
                     root       1496 ....m mdadm
                     root       1524 ....m agetty
                     root       1529 ....m agetty
                     root       1613 ....m sshd
                     root       1822 ....m systemd
                     root       1824 ....m (sd-pam
                     root       1859 ....m sshd
                     root       1891 ....m bash
</code></pre>

<p>Either <code>kill $PID</code> or <code>systemctl stop $service</code> all the items in that list. Here
are the items I had to stop:</p>

<pre><code>systemctl stop rsyslog
systemctl stop snapd
systemctl stop systemd-journald
systemctl stop systemd-logind
systemctl stop systemd-timesyncd
systemctl stop cron
systemctl stop atd
systemctl stop dbus
systemctl stop lxcfs
systemctl stop accounts-daemon
systemctl stop mdadm
systemctl stop iscsid
</code></pre>

<p>The rest of the list was killed via <code>kill $PID</code>:</p>

<pre><code>root@w:~# fuser -vm /oldroot
                     USER        PID ACCESS COMMAND
/oldroot:            root     kernel mount /oldroot
                     root        676 ....m lvmetad
                     root        702 f...m systemd-udevd
                     messagebus   1362 ....m dbus-daemon
                     root       1388 ....m acpid
                     root       1428 ....m mdadm
                     root       1433 ....m polkitd
                     root       1481 ....m agetty
                     root       1483 ....m agetty
                     root       1529 ....m systemd
                     root       1531 ....m (sd-pam

root@w:~# kill 676 702 1362 1388 1428 1433 1481 1483 1529 1531

root@w:~# fuser -vm /oldroot
                     USER        PID ACCESS COMMAND
/oldroot:            root     kernel mount /oldroot
root@w:~#
</code></pre>

<p>Don&#39;t kill PID 1, systemd. Use this systemd command:</p>

<pre><code>systemctl daemon-reexec
</code></pre>

<p>The list should now be empty. No other filesystems should be mounted as well:</p>

<pre><code>root@w:~# mount
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
udev on /dev type devtmpfs (rw,nosuid,relatime,size=1017012k,nr_inodes=254253,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=204824k,mode=755)
tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/lib/systemd/systemd-cgroups-agent,name=systemd)
none on / type tmpfs (ro,relatime)
</code></pre>

<p>Unmount the device now:</p>

<pre><code>umount /oldroot
</code></pre>

<p>Run a check on the disk:</p>

<pre><code>fsck -Cfy /dev/vda1
</code></pre>

<p>Output:</p>

<pre><code>fsck from util-linux 2.31.1
e2fsck 1.44.1 (24-Mar-2018)
cloudimg-rootfs: recovering journal
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information
Free blocks count wrong (11805884, counted=11805839).
Fix? yes

Free inodes count wrong (6390026, counted=6390025).
Fix? yes


cloudimg-rootfs: ***** FILE SYSTEM WAS MODIFIED *****
cloudimg-rootfs: 61175/6451200 files (0.0% non-contiguous), 1272940/13078779 blocks
</code></pre>

<p>Resize the filesystem. In my case the VPS has 40 GB of disk, the FAT32 partition
needs to be at least 4 GB to fit the extracted Windows 7 file. I resized the
root partition to 35 GB:</p>

<pre><code>resize2fs /dev/vda1 35G
</code></pre>

<p>Output:</p>

<pre><code>resize2fs 1.44.1 (24-Mar-2018)
Resizing the filesystem on /dev/vda1 to 9175040 (4k) blocks.
The filesystem on /dev/vda1 is now 9175040 (4k) blocks long.
</code></pre>

<p>While you&#39;re at it, continue on and modify the partitions.</p>

<h3 id="toc_3">Create fat32 partition</h3>

<p>Windows 7 doesn&#39;t seem <a href="https://wiki.archlinux.org/index.php/Dual_boot_with_Windows#Windows_UEFI_vs_BIOS_limitations">to boot from an GPT/EFI disk</a>. I tested my setup in
VirtualBox first, where it worked fine. On DigitalOcean, the GPT partition table
gave me some trouble, in the end I decided to convert it back to MBR. And of
course there is a tool for that already.</p>

<p>While we&#39;re doing all these destructive things to the disk, lets convert the
partition table from GPT back to MBR to get Windows 7 to boot.</p>

<p>Use the <code>gdisk</code> tool on <code>/dev/vda</code>:</p>

<pre><code>gdisk /dev/vda
</code></pre>

<p>Output:</p>

<pre><code>Command (? for help): r
</code></pre>

<p>Enter <code>r</code>.</p>

<pre><code>Recovery/transformation command (? for help): g
</code></pre>

<p>Enter <code>g</code>:</p>

<pre><code>MBR command (? for help): p
</code></pre>

<p>Enter <code>p</code> to print the converted MBR partition layout:</p>

<pre><code>** NOTE: Partition numbers do NOT indicate final primary/logical status,
** unlike in most MBR partitioning tools!

** Extended partitions are not displayed, but will be generated as required.

Disk size is 104857600 sectors (50.0 GiB)
MBR disk identifier: 0x00000000
MBR partitions:

                                                   Can Be   Can Be
Number  Boot  Start Sector   End Sector   Status   Logical  Primary   Code
   1                227328      4612062   primary              Y      0x83
  14                  2048        10239   logical     Y        Y      0xEF
  15                 10240       227327   primary              Y      0x07
</code></pre>

<p>Enter <code>w</code>:</p>

<pre><code>MBR command (? for help): w

Converted 3 partitions. Finalize and exit? (Y/N): y
</code></pre>

<p>Enter <code>Y</code>:</p>

<pre><code>GPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
</code></pre>

<p>Reinstall GRUB to the partition, otherwise the VPS won&#39;t boot. Mount the disk:</p>

<pre><code>mount /dev/vda1 /mnt
</code></pre>

<p>Install GRUB:</p>

<pre><code>grub-install --root-directory=/mnt /dev/vda
</code></pre>

<p>Output:</p>

<pre><code>Installing for i386-pc platform.
Installation finished. No error reported.
</code></pre>

<p>I use <code>cfdisk</code>, a console UI to manage partitions. Delete the linux partition
and re-create it with a smaller size. In my case, 36 GB (to make sure the
filesystem fits). Then create a new fat32 partition in the free space. Set the
Linux partiton as bootable.</p>

<p><img src="https://raymii.org/s/inc/img/do_part.png" alt=""></p>

<p>You can use <code>parted</code> or <code>fdisk</code>, note the start and end numbers of the
partition. I prefer <code>cfdisk</code>.</p>

<p>After creating the partitions, reboot the machine. Either via:</p>

<pre><code>echo b &gt; /proc/sysrq-trigger
</code></pre>

<p>or via the VPS provider&#39;s control panel. SSH back in to your VPS afterwards and
create the FAT filesystem:</p>

<pre><code>mkfs.vfat /dev/vda2
</code></pre>

<p>Output:</p>

<pre><code>mkfs.fat 3.0.28 (2015-05-16)
</code></pre>

<p>The block device layout now looks like this:</p>

<pre><code>lsblk
</code></pre>

<p>Output:</p>

<pre><code>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
vda     253:0    0   50G  0 disk
|-vda1  253:1    0   36G  0 part /
|-vda2  253:2    0 13.9G  0 part
|-vda14 253:14   0    4M  0 part
`-vda15 253:15   0  106M  0 part /boot/efi
</code></pre>

<p>Mount the partition:</p>

<pre><code>mount /dev/vda2 /mnt
</code></pre>

<p>The next step is to copy over the Windows ISO.</p>

<h3 id="toc_4">Copy Windows installation files to new partition</h3>

<p>Copy over your Windows ISO to your VPS:</p>

<pre><code>$ scp Win7_Pro_SP1_English_x32.iso root@192.0.2.10:
Win7_Pro_SP1_English_x32.iso         [it took a while]  100% 2446MB   3.2MB/s   12:36
</code></pre>

<p>Create a folder to mount it on:</p>

<pre><code>mkdir /w
</code></pre>

<p>Mount the ISO:</p>

<pre><code>mount -o loop /root/Win7_Pro_SP1_English_x32.iso /w
</code></pre>

<p>Output:</p>

<pre><code>mount: /dev/loop0 is write-protected, mounting read-only
</code></pre>

<p>Copy over the files. I use rsync to get a progress indicator:</p>

<pre><code> rsync -avz --progress /w/* /mnt/
</code></pre>

<p>Output:</p>

<pre><code>sending incremental file list
autorun.inf
             43 100%    0.00kB/s    0:00:00 (xfr#1, ir-chk=1042/1043)
bootmgr
        383,786 100%    9.15MB/s    0:00:00 (xfr#2, ir-chk=1041/1043)
setup.exe
        112,400 100%    2.28MB/s    0:00:00 (xfr#3, ir-chk=1040/1043)
boot/
boot/bcd
        262,144 100%    4.90MB/s    0:00:00 (xfr#4, ir-chk=1034/1043)
[...]
upgrade/netfx/netfxupdate.exe
         73,728 100%  155.84kB/s    0:00:00 (xfr#877, to-chk=0/1077)

sent 2,436,207,244 bytes  received 17,955 bytes  17,463,979.92 bytes/sec
total size is 2,582,383,757  speedup is 1.06
</code></pre>

<p>This might take some time. Open another terminal and continue with the Grub
editing.</p>

<h3 id="toc_5">GRUB2 entry</h3>

<p>Edit the Grub boot loader configuration to boot from your FAT32 partition with
the Windows Installer.</p>

<pre><code>vim /boot/grub/grub.cfg
</code></pre>

<p>No need to use the normal way since this disk is going to be wiped. Change the
<code>timeout</code> to 300, that way you can use the console of your provider instead of
pressing SHIFT to get the grub boot menu. Remove the <code>timeout_style=hidden</code>
option if you find it.</p>

<p>Add the following at the bottom of the file:</p>

<pre><code>menuentry &quot;Windows Installer&quot; {
    insmod ntfs
    search --set=root --file /bootmgr
    ntldr /bootmgr
    boot
}
</code></pre>

<p>When the ISO is copied over, reboot and select the Windows option:</p>

<p><img src="https://raymii.org/s/inc/img/do_win.png" alt=""></p>

<p>Now you should see the Windows 7 installer starting up:</p>

<p><img src="https://raymii.org/s/inc/img/do_win2.png" alt=""></p>

<p>A suprise in the end is that Windows 7 doesn&#39;t have a VirtIO Driver, so the
installation is unable to continue on Digital Ocean.</p>

<p>Let&#39;s try it some other time with a newer version of Windows, 10 maybe.</p>
Tags: <a href="../tags/gdisk.html">gdisk</a>
, <a href="../tags/gpt.html">gpt</a>
, <a href="../tags/grub.html">grub</a>
, <a href="../tags/mbr.html">mbr</a>
, <a href="../tags/microsoft.html">microsoft</a>
, <a href="../tags/openstack.html">openstack</a>
, <a href="../tags/partitioning.html">partitioning</a>
, <a href="../tags/server.html">server</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/ubuntu.html">ubuntu</a>
, <a href="../tags/vps.html">vps</a>
, <a href="../tags/windows.html">windows</a>
</div></main>
<br/>
<footer>
<br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small>
                </p>
    
    </footer>
    <script data-goatcounter="https://raymii.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>

    <script defer src="/s/inc/js/instant.5.2.0.js"  type="module" ></script>

     
    </main>
    </body>
    </html>
    